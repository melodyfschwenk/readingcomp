<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIAT-2 Reading Comprehension Study</title>
    <style>
  /* ================================
     Fixed Dark Theme - Drop-in CSS
     ================================ */

  /* Minimal token set that matches your existing class usage */
  :root {
    /* Surfaces */
    --bg: #0b0e11;            /* page background */
    --bg-secondary: #12161c;  /* cards, panels */
    --bg-tertiary: #0e141b;   /* subtle sections and strips */
    --bg-card: #12161c;

    /* Text */
    --text-primary: #e8eef6;   /* main text */
    --text-secondary: #c8d3e0; /* headings and subheads */
    --text-muted: #9fb0c0;     /* helper text */
    --text-on-dark: #ffffff;

    /* Brand and states */
    --primary-600: #8b5cf6;
    --primary-500: #a78bfa;
    --primary-400: #c4b5fd;

    --success-600: #22c55e;
    --success-500: #34d399;

    --warning-600: #f59e0b;
    --warning-100: #1a1200;   /* darkened background chip for warnings */

    --danger-500: #ef4444;
    --danger-400: #f87171;

    /* Neutrals and borders */
    --border-primary: #1f2630;
    --border-secondary: #2a3240;
    --border-focus: #8b5cf6;

    /* Shadows */
    --shadow-sm: rgba(0, 0, 0, 0.25);
    --shadow-md: rgba(0, 0, 0, 0.35);
    --shadow-lg: rgba(0, 0, 0, 0.45);
    --shadow-xl: rgba(0, 0, 0, 0.6);
  }

  /* Base reset */
  * { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
  font-size: 18.67px;    /* = 14pt */
  background:
    radial-gradient(1000px 700px at 20% 0%, #121622 0%, #0b0e11 60%),
    #0b0e11;
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.7;      /* a touch more spacing for readability */
}


  /* Global focus ring for keyboard nav */
  :focus-visible {
    outline: 3px solid var(--border-focus);
    outline-offset: 2px;
  }

  a { color: var(--primary-400); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* Layout wrappers */
  .wrap, .container {
    max-width: 860px;
    margin: 0 auto;
    padding: 24px;
  }

  .card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 12px 40px var(--shadow-xl);
    margin: 14px 0;
  }

  /* Headings */
  h1 {
    font-size: 1.9rem;
    font-weight: 650;
    color: var(--text-secondary);
    margin-bottom: 10px;
    letter-spacing: 0.2px;
  }
  h2 {
    font-size: 1.35rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 10px;
  }
  h3 { font-size: 1.1rem; color: var(--text-secondary); }

  .subtitle, .muted { color: var(--text-muted); }

  /* Info and instruction blocks */
  .instructions {
    background: var(--bg-tertiary);
    border-left: 3px solid var(--primary-600);
    border-radius: 10px;
    padding: 14px 16px;
    margin: 16px 0 24px;
  }

  .warning-box {
    background: var(--warning-100);
    border: 1px solid var(--warning-600);
    border-radius: 10px;
    padding: 12px 14px;
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .warning-icon { font-size: 20px; color: var(--warning-600); }
  .warning-text { color: var(--text-primary); }

  /* Buttons */
  button {
    -webkit-tap-highlight-color: transparent;
    border: 0;
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 1rem;
    font-weight: 650;
    letter-spacing: 0.2px;
    cursor: pointer;
    transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease, opacity 120ms ease;
    color: var(--text-on-dark);
    min-height: 44px;
  }

  button.primary, button:not([class]) {
    background: linear-gradient(180deg, var(--primary-600), var(--primary-500));
    box-shadow: 0 8px 24px var(--shadow-md);
  }
  button.primary:hover, button:not([class]):hover { transform: translateY(-1px); box-shadow: 0 12px 30px var(--shadow-lg); }
  button.primary:active, button:not([class]):active { transform: translateY(0); }

  button.secondary {
    background: transparent;
    color: var(--primary-500);
    border: 2px solid var(--primary-600);
  }
  button.secondary:hover { background: rgba(139, 92, 246, 0.12); }

  button.danger {
    background: linear-gradient(180deg, var(--danger-500), var(--danger-400));
    box-shadow: 0 8px 24px var(--shadow-md);
  }

  button.success-button {
    background: linear-gradient(180deg, var(--success-600), var(--success-500));
    box-shadow: 0 8px 24px var(--shadow-md);
  }

  button:disabled {
    background: #202735 !important;
    color: var(--text-muted) !important;
    opacity: 0.6;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* Inputs */
  input[type="text"], select, textarea {
    width: 100%;
    background: #0f141b;
    color: var(--text-primary);
    border: 1px solid var(--border-secondary);
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 1rem;
    transition: border-color 120ms ease, box-shadow 120ms ease, background 120ms ease;
  }
  input[type="text"]:hover, select:hover, textarea:hover { border-color: var(--border-focus); }
  input[type="text"]:focus, select:focus, textarea:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.25);
    outline: none;
  }

  input[type="checkbox"], input[type="radio"] {
    width: 18px; height: 18px;
    accent-color: var(--primary-600);
    cursor: pointer;
  }

  label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 600; }

  .row { display: flex; gap: 16px; margin: 14px 0; }
  .row > div { flex: 1; }

  /* Radio groups */
  .radio-group { display: grid; gap: 10px; }
  .radio-group label {
    display: flex; align-items: center; gap: 10px;
    background: #0f141b;
    border: 1px solid var(--border-secondary);
    border-radius: 10px;
    padding: 12px 14px;
    cursor: pointer;
    transition: border-color 120ms ease, background 120ms ease, transform 120ms ease;
  }
  .radio-group label:hover { border-color: var(--border-focus); background: #101724; transform: translateX(2px); }
  .radio-group input[type="radio"]:checked + span { color: var(--primary-400); font-weight: 700; }
  /* :has is supported in current Chrome and Firefox, ignored elsewhere without breaking layout */
  .radio-group label:has(input:checked) {
    border-color: var(--primary-600);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.18);
    background: #101724;
  }

  /* Status boxes */
  .status-box {
    background: #0f141b;
    border: 1px solid var(--border-secondary);
    color: var(--text-primary);
    border-radius: 10px;
    padding: 12px 14px;
    margin: 14px 0;
  }
  .status-box.success { border-color: var(--success-600); }
  .status-box.error   { border-color: var(--danger-500); }

  /* Item header and timer */
  .item-header {
    display: flex; justify-content: space-between; align-items: center;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 10px;
    padding: 10px 12px;
    margin-bottom: 14px;
  }
  .item-info { color: var(--text-secondary); }
  .timer-display { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; color: var(--primary-400); font-weight: 800; }

  /* Recording indicator */
  .recording-indicator {
    position: fixed; top: 16px; right: 16px;
    display: flex; align-items: center; gap: 8px;
    background: var(--danger-500);
    color: #fff;
    padding: 8px 12px;
    border-radius: 999px;
    box-shadow: 0 8px 24px var(--shadow-lg);
  }
  .recording-dot { width: 10px; height: 10px; background: #fff; border-radius: 999px; animation: blink 1s infinite; }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

  /* Reading Passage Styles */
 .reading-passage {
  background: #0f141b;
  border: 1px solid var(--border-secondary);
  border-radius: 12px;
  padding: 28px;
  margin: 24px 0;
  font-size: 1.2rem;      /* slightly larger than base (≈16.8pt if base = 14pt) */
  line-height: 1.9;
  color: var(--text-primary);
  /* removed max-height and overflow so it no longer scrolls */
}


  .reading-passage h3 {
    color: var(--primary-400);
    margin-bottom: 16px;
    font-size: 1.3rem;
  }

  .reading-passage em {
    color: var(--text-muted);
    font-style: italic;
    display: block;
    margin-bottom: 16px;
  }

  .reading-passage p {
    margin-bottom: 16px;
  }

  .reading-passage .underlined {
    text-decoration: underline;
    text-decoration-color: var(--primary-600);
    text-underline-offset: 3px;
    font-weight: 600;
  }

  .reading-passage table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
  }

  .reading-passage th {
    background: var(--bg-tertiary);
    color: var(--primary-400);
    padding: 12px;
    text-align: left;
    border: 1px solid var(--border-secondary);
  }

  .reading-passage td {
    padding: 12px;
    border: 1px solid var(--border-secondary);
  }

        /* Global underline token (matches passage look) */
.underlined {
  text-decoration: underline;
  text-decoration-color: var(--primary-600);
  text-underline-offset: 3px;
  font-weight: 600;
}

/* Also treat <u> like our token, in case you prefer <u> */
u {
  text-decoration-color: var(--primary-600);
  text-underline-offset: 3px;
  font-weight: 600;
}

  /* Q blocks */
  .q-block {
    background: #0f141b;
    border: 1px solid var(--border-secondary);
    border-radius: 10px;
    padding: 14px;
    margin: 14px 0;
      font-size: 1.1rem;   /* ~10% larger than base */

  }
  .q-block label { margin-bottom: 8px; }
  .q-block textarea { min-height: 110px; resize: vertical; }

   
  /* Helper chips and tips */
  .tip-box {
    background: var(--bg-tertiary);
    border: 1px solid var(--primary-600);
    border-radius: 10px;
    padding: 12px 14px;
    color: var(--text-primary);
    margin-bottom: 12px;
  }
  .tip-box ul { margin: 8px 0 0 18px; color: var(--text-muted); }
  .kbd {
    font: 600 12px ui-monospace, SFMono-Regular, Menlo, monospace;
    padding: 2px 6px; border-radius: 6px;
    background: #0b0f16; border: 1px solid var(--border-secondary); color: var(--text-secondary);
  }

  /* Read aloud and setup panels */
  .read-aloud-box {
    background: #0f141b;
    border: 1px solid var(--border-secondary);
    border-radius: 10px;
    padding: 14px;
    margin: 12px 0 16px;
  }

  .video-preview-wrapper { text-align: center; }
  .video-preview {
    width: 100%; max-width: 520px; height: auto; background: #000;
    border: 2px solid var(--primary-600);
    border-radius: 12px;
    box-shadow: 0 16px 40px var(--shadow-md);
  }

  /* Admin panel and connection status */
  .admin-panel {
    position: fixed; bottom: 12px; right: 12px;
    background: #0f141b;
    border: 1px solid var(--border-secondary);
    border-radius: 10px;
    padding: 10px 12px;
    color: var(--text-muted);
    font: 600 12px ui-monospace, SFMono-Regular, Menlo, monospace;
    display: none;
  }
  body.admin-mode .admin-panel { display: block; }

  .connection-status {
    position: fixed; bottom: 12px; left: 12px;
    background: #0f141b;
    border: 2px solid var(--border-secondary);
    border-radius: 999px;
    padding: 8px 14px;
    color: var(--text-muted);
    font-weight: 700;
  }
  .connection-status.connected { border-color: var(--success-600); color: var(--success-600); }
  .connection-status.error     { border-color: var(--danger-500); color: var(--danger-500); }

        /* ================================
   Large Print Mode (accessible)
   ================================ */
.lp-toggle {
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 1100;
}

/* When ON, bump the base rem size for the whole app */
body.large-print {
  font-size: 26.67px;    /* = 20pt base */
  line-height: 1.7;
}

/* Make key reading elements scale a bit more for comfort */
body.large-print .reading-passage { font-size: 1.3rem; } /* ≈ 26pt passage text */
body.large-print .q-block { font-size: 1.2rem; }         /* ≈ 24pt questions */

/* Keep sizes large on mobile too */
@media (max-width: 768px) {
  body.large-print .reading-passage { font-size: 1.3rem; padding: 18px; }
}

/* Print fallback */
@media print {
  body.large-print { font-size: 14pt !important; } /* keep print legible without blowing layout */
}

  /* Utilities */
  .hidden { display: none !important; }
  .center { text-align: center; }
  .sr-only {
    position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
    overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
  }

  /* Mobile */
  @media (max-width: 768px) {
    .wrap, .container { padding: 16px; }
    .row { flex-direction: column; }
    button { width: 100%; }
    h1 { font-size: 1.6rem; }
.reading-passage { font-size: 1.2rem; padding: 18px; }

  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    * { transition-duration: 0.01ms !important; animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; }
    button:hover { transform: none !important; }
  }

  /* Print keeps contrast and outlines light */
  @media print {
    body { background: #fff !important; color: #000 !important; }
    .card { background: #fff !important; border: 1px solid #000 !important; box-shadow: none !important; }
    button, .recording-indicator, .admin-panel, .connection-status { display: none !important; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div id="sr-live" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
<button id="toggle-large-print" class="secondary lp-toggle" type="button" aria-pressed="false" title="Large Print Mode (Alt+L)">
  Large Print: Off
</button>

  <!-- Welcome Screen -->
  <div id="screen-welcome" class="card">
    <h1>WIAT-2 Reading Comprehension Study</h1>
    <p class="muted">Please enter your information to begin.</p>
    <div class="warning-box" role="alert">
      <span class="warning-icon" aria-hidden="true">⚠️</span>
      <div class="warning-text">
        <strong>Note:</strong> This version uses inline text for better performance. Click buttons once and wait.
      </div>
    </div>

    <div class="row">
      <div>
        <label for="pid">Participant Code</label>
        <input id="pid" type="text" placeholder="Enter initials" required
               maxlength="20"
               pattern="[A-Za-z0-9_-]{1,20}"
               title="Use letters, numbers, underscores, and hyphens only (max 20)"
               inputmode="text"
               autocomplete="off"
               autocapitalize="off"
               spellcheck="false" />
      </div>
      <div>
        <label for="edu">Education Level</label>
        <select id="edu" required>
          <option value="">Select...</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
          <option value="13+">College or higher</option>
        </select>
      </div>
    </div>

    <div class="group-info">
      <fieldset>
        <legend>Participant Group</legend>
        <div class="radio-group">
          <label>
            <input type="radio" name="participant-group" value="deaf-fluent" />
            <span>Deaf - Fluent ASL signer</span>
          </label>
          <label>
            <input type="radio" name="participant-group" value="hearing-fluent" />
            <span>Hearing - Fluent ASL signer</span>
          </label>
          <label>
            <input type="radio" name="participant-group" value="deaf-nonfluent" />
            <span>Deaf - Non-fluent ASL signer</span>
          </label>
          <label>
            <input type="radio" name="participant-group" value="hearing-nonfluent" />
            <span>Hearing - Non-fluent ASL signer</span>
          </label>
          <label>
            <input type="radio" name="participant-group" value="hearing-nonsigner" />
            <span>Hearing - Non-signer</span>
          </label>
        </div>
      </fieldset>
    </div>

    <div id="modality-selection" class="modality-selection hidden">
      <fieldset aria-describedby="modality-desc">
        <legend>Communication Preference for "Read Aloud" Items</legend>
        <p id="modality-desc" class="muted" style="margin: 0 0 10px;">How would you prefer to "read aloud"?</p>
        <div id="deaf-note" class="accessibility-note hidden">
          <strong>Note for deaf participants:</strong> You may choose to sign in ASL (video recording) or use spoken language (audio recording) based on your preference and comfort level.
        </div>
        <div class="radio-group">
          <label>
            <input type="radio" name="read-modality" value="sign" />
            <span>Sign (ASL) - Video recording</span>
          </label>
          <label>
            <input type="radio" name="read-modality" value="speak" />
            <span>Speak - Audio recording</span>
          </label>
        </div>
      </fieldset>
    </div>

    <div id="config-warning" class="status-box error hidden" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="status-message">
        <strong>Setup Required:</strong> Google Drive integration not configured. 
        Please update GOOGLE_SCRIPT_URL in the code.
      </div>
    </div>

    <div style="margin-top: 20px;">
      <label style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <input type="checkbox" id="consent" />
        <span>I consent to audio/video recording and secure storage for this study.</span>
      </label>
      <p class="muted" style="margin:6px 0 12px;">Recordings and responses are stored securely and used for research purposes only.</p>

      <button id="begin" class="primary" disabled>Continue to Setup</button>
    </div>
  </div>

  <!-- Setup Screen -->
  <div id="screen-setup" class="card hidden">
    <h2>Recording Setup</h2>

    <div id="recording-method-info" class="recording-info">
      <div class="status-message" id="recording-method-text" role="status" aria-live="polite" aria-atomic="true">
        Setting up recording...
      </div>
    </div>
    
    <div class="comfort-options">
      <label style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="pref-hide-timer" />
        <span>Hide the reading timer during passages</span>
      </label>
      <label id="pref-hide-selfview" class="hidden" style="display:flex;align-items:center;gap:8px;margin-top:8px;">
        <input type="checkbox" id="toggle-selfview" />
        <span>Hide my camera preview during recording</span>
      </label>
      <p class="muted" style="margin:8px 0 0;">You can change these anytime.</p>
    </div>

    <div id="video-setup" class="hidden">
      <p class="muted">For ASL "read aloud" items, we need to set up video recording.</p>
      <div class="video-preview-wrapper">
        <video id="preview" class="video-preview" autoplay muted playsinline></video>
      </div>
      <p id="video-status" class="muted center" role="status" aria-live="polite" aria-atomic="true">Requesting camera access...</p>
    </div>

    <div id="audio-setup" class="hidden">
      <p class="muted">For spoken "read aloud" items, we need to set up audio recording.</p>
      <div class="recording-controls">
        <button id="test-audio-record" class="danger">Test Audio Recording</button>
        <button id="stop-test-audio" class="hidden" type="button">Stop Test</button>
        <span class="recording-timer hidden" id="test-audio-timer">00:00</span>
            <!-- NEW -->
  <button id="skip-recording" class="secondary hidden" type="button">Skip Recording</button>

      </div>
      <audio id="test-audio-playback" controls class="hidden" style="width: 100%; max-width: 400px; margin: 10px auto; display: block;"></audio>
      <p id="audio-status" class="muted center" role="status" aria-live="polite" aria-atomic="true">Click "Test Audio Recording" to verify your microphone is working.</p>
    </div>

    <div id="setup-status" class="status-box" style="margin-top: 20px;">
      <div class="status-message" id="setup-status-text" role="status" aria-live="polite" aria-atomic="true">Initializing...</div>
    </div>

    <div style="margin-top: 20px; text-align: center;">
      <button id="start-study" class="primary" disabled>Start Assessment</button>
    </div>
  </div>

  <!-- Item Screen -->
  <div id="screen-item" class="card hidden">
    <div class="recording-indicator hidden" id="rec-indicator">
      <span class="recording-dot"></span>
      <span id="rec-type">Recording</span>
    </div>

    <div class="item-header">
      <div class="item-info">
        Item <span id="actual-item-number"></span>
      </div>
      <div id="timer-container" class="hidden">
        <span class="timer-display" id="timer">00:00</span>
      </div>
    </div>

    <!-- Reading Passage Container -->
    <div id="passage-container" class="reading-passage">
      <!-- Content will be dynamically inserted here -->
    </div>

    <div id="instructions" class="muted center" style="margin: 16px 0;">
      <span id="instruction-text"></span>
    </div>

    <!-- Read Aloud Instructions Box -->
    <div id="read-aloud-instructions" class="read-aloud-box hidden">
      <h4 id="read-aloud-title">Read Aloud Instructions</h4>
      <p id="read-aloud-text" class="muted" style="margin: 0;"></p>
    </div>

    <!-- Recording controls for read-aloud items -->
    <div id="recording-controls" class="recording-controls hidden">
      <button id="start-recording" class="danger" aria-describedby="recording-help">Start Recording</button>
        <button id="stop-recording" class="hidden" type="button">Stop Recording</button>
<button id="skip-recording-now" class="secondary hidden" type="button">Skip Recording</button>

      <span class="recording-timer hidden" id="recording-timer">00:00</span>
  

  <div id="recording-help" class="sr-only">Click to begin recording your response</div>
</div>

<!-- NEW: shown only when mic/cam isn’t available -->
<div id="recording-unavailable" class="status-box error hidden"
     role="alert" aria-live="assertive" aria-atomic="true" style="margin-top:10px;">
  <div>Recording isn’t available. You can allow access and retry, or choose
    <strong>Skip Recording</strong> to continue.</div>
</div>
      
    <!-- Standard reading controls -->
    <div id="reading-controls" class="center hidden" style="margin: 16px 0;">
      <button id="start-reading" class="primary">Start Reading</button>
      <button id="done-reading" class="hidden">Done Reading</button>
    </div>

    <form id="qa-form" class="hidden">
      <div id="qa-fields"></div>
      <div style="margin-top: 16px;">
        <button type="submit" class="primary">Submit</button>
        <button type="button" id="skip" class="secondary">Skip</button>
      </div>
    </form>
  </div>

  <!-- Finish Screen -->
  <div id="screen-finish" class="card hidden">
    <h2>Assessment Complete</h2>
    <p id="finish-msg" class="muted" role="status" aria-live="polite" aria-atomic="true">Thank you for participating.</p>

    <div id="upload-status" class="status-box">
      <div class="status-message" id="upload-progress" role="status" aria-live="polite" aria-atomic="true">Saving your data...</div>
    </div>

    <div id="final-stats" class="hidden" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px;">
      <h3 style="font-size: 14px; margin: 0 0 10px;">Session Summary</h3>
      <div id="stats-content"></div>
    </div>

    <div style="margin-top: 20px; text-align: center;">
      <button id="retry-upload" class="primary hidden">Retry Upload</button>
      <button id="download-backup" class="hidden">Download Backup</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="admin-panel">
    <div>Group: <span id="admin-group">-</span></div>
    <div>Item: <span id="admin-item">-</span></div>
    <div>Score: <span id="admin-score">0</span></div>
    <div>Zeros: <span id="admin-zeros">0</span></div>
    <div>Status: <span id="admin-status">Active</span></div>
  </div>

  <!-- Connection Status -->
  <div class="connection-status" id="connection-status">
    <span id="connection-text" role="status" aria-live="polite" aria-atomic="true">Not connected</span>
  </div>

</div>

<script>
/* ===========================
   TEXT PASSAGES DATA
   =========================== */
const PASSAGES = {
  1: {
    title: "How California Came To Be",
    subtitle: "Among the Native American Gabrielino people of Southern California, this tale has become part of their heritage.",
    content: `Before Kwawar, the Great Spirit, had placed people on earth, there was nothing but water. While the Great Spirit contemplated how to create land, a huge turtle swam by. Kwawar had an idea: "Turtle," he summoned, "bring me your six brothers so I may bestow a great gift upon you."

When they arrived, the Great Spirit decreed, "Form a line from head to tail, extending from north to south." Kwawar spread bulrushes over the backs of the Brothers. Then he deposited earth over their shells and majestic mountains arose. Next, he inserted his fingers into the soil and noble trees sprouted skyward. Water flowed in to fill lakes and rivers.

At first, the Brothers were proud to bear California on their backs, but eventually they became restless. The earth began to tremble. However, because of the weight of the land, the Turtle Brothers could not travel far from each other.

From time to time the Turtle Brothers disagree and the ground quivers. But when the Brothers are in harmony, the land is serene once again.`
  },
  2: {
    content: `Traffic stopped when an avalanche came tumbling down the hillside, covering the road with <span class="underlined">debris</span>.`
  },
  3: {
    content: `You might think that cheese would be the choice of mice, but they <span class="underlined">fancy</span> nuts, grain, and seeds more.`
  },
  4: {
    content: `Because of the <span class="underlined">inclement</span> weather, the long distance events were cancelled; consequently, the track meet ended earlier than expected.`
  },
  5: {
    title: "YUKON GOLD",
    subtitle: "Starring Johnathan Dupre, Elise Young, and Piers Janal",
    content: `<strong>Daily News, Gary Callahan:</strong> Yukon Gold mixed wilderness adventure and family conflict into a sometimes-interesting story. The Jasso family is in Seattle when they hear about the Yukon gold rush. Shortly after they board a ship for Alaska, outlaws attack them. Then they must hike the Chilkoot Pass, a cold and harsh wilderness. Luckily for the Jassos, they meet Leaping Fish, a young Native American. He helps them survive while he guides them to Dawson City. Yukon Gold has some exciting moments, such as when the father is attacked by a grizzly. Unfortunately, the story is hackneyed, and the ending holds no surprises. (2 stars)

<strong>North America Press Service, Diana Fernandez:</strong> Yukon Gold is about one family's experiences during the last gold rush. Buried within this exciting adventure tale is the story of two teenagers fighting to become independent. Ed Jasso dreams of gold and sets off for Yukon during the Gold Rush of 1898. His teenage children, Charlie and Helen, go with him on the uncertain journey. Charlie rebels against going because he does not want to chase his father's dreams. The family encounters one danger after another. They are robbed in Alaska and barely survive the wilderness, only to face a fierce grizzly bear. If you see just one movie all summer, see Yukon Gold. (4 stars)`
  },
  6: {
    title: "Words of Wisdom",
    content: `Proverbs are well-known sayings that sum up apparent truths about life in a few words. "Better late than never." "Practice makes perfect." "A stitch in time saves nine." Human beings almost everywhere in the world have thought up and repeated proverbs, probably ever since they began to talk. The oldest known proverbs are found among the oldest written records, 3500-year-old clay tablets from ancient Sumer.

Benjamin Franklin popularized many proverbs in his Poor Richard's Almanack. For more than two centuries, parents have reminded their children that "Early to bed, early to rise, makes a man healthy, wealthy, and wise" and "Haste makes waste." But not all proverbs are so old. "A picture is worth a thousand words" was made up in the 1920's. "Different strokes for different folks" was first heard in the 1950's. "Garbage in, garbage out" is a product of the computer age.

Old or new, proverbs remain popular in advertising, songs, and everyday conversations. People like proverbs. They are short, easily remembered, and widely accepted as true.`
  },
  7: {
    content: `Mammals differ in sundry ways from the group of animals called saurian. Mammals maintain a fairly consistent body temperature that is independent of their environment, but the temperature of saurian changes relative to the environmental temperature.`
  },
  8: {
    content: `The great Dust Bowl began in 1931 when it quit raining in large parts of Kansas, Colorado, New Mexico, and Texas.`
  },
  9: {
    title: "Jewel on Ice",
    content: `Could you awaken at four o'clock every morning, practice skating for the next five hours, and then begin your school day? After seeing her idol, figure skater Dorothy Hamill, win Olympic gold in 1976, five-year-old Kristi Yamaguchi, chose this grueling <span class="underlined">routine</span>.

Kristi's mother began her lessons the next year, hoping that figure skating would strengthen her daughter's frail legs. By 1982, at age eleven, Kristi was good enough to team up with 13-year-old Rudi Galindo. Together, the duo developed a beautifully choreographed <span class="underlined">routine</span> that often captivated their audience. At the 1986 National Figure Skating Championship, Kristi and Rudi captured the junior pairs title.

Although Kristi had teamed up with Rudi, she never stopped skating solo. Her stamina amazed her coaches. In 1989, she and Rudi won the pairs gold medal, and Kristi took an individual silver medal at the Nationals. She duplicated this accomplishment the following year, but felt she had to concentrate on her singles career to make the 1992 Olympic team. As a warm-up, Kristi garnered gold at the 1991 World Championships as well as at the Nationals in January 1992.

With the approach of the Olympics, a reporter dubbed Kristi a "Jewel on Ice." Nowhere was this jewel more scintillating than in Albertville, France. What Kristi lacked in athletic ability was more than compensated for by her grace and consistency. The crystal-and-gold medal she won illuminated the arduous road that had originated in the dreams of a five-year-old girl.`
  },
  10: {
    title: "Humpback Whales - Survival or Extinction?",
    content: `At one time there were over 100,000 humpbacks in the world. By the 1960's there were only 7,000 of these majestic creatures remaining. Then, in 1966, humpback whales were placed on the endangered species list.

One reason for the decline in the number of humpback whales is that people hunt them for commercial gain. Factories use whale bones to make glues and fertilizers. Then the fat is made into oil that is used in oil lamps. A portion of the fat is also used to make soaps and waxes.

The fishing industries are another threat to the humpback existence. If a humpback whale gets caught in a fisherman's nets, it can drown. Sometimes, the larger whales can pull the entire net off the boat. If they are unable to get the net from around their head, they will starve.

Understanding the reason for the decline in the number of humpback whales is the first step to finding a solution. Just as people have been the primary reason for their demise, people must be the primary reason for their recovery. Because more people are now aware of the situation and are more active in their recovery, there has been a change. Although we do not know the precise number of humpback whales remaining, all studies suggest a promising recovery for the species. It is easy to see the importance of saving even one of these beautiful creatures.`
  },
  11: {
    content: `When peaches first appear in grocery stores, their prices are quite high. At the height of the growing season, their prices actually decrease. As the season nears its conclusion, their prices increase again.`
  },
  12: {
    title: "Should City Zoo Hike Prices?",
    content: `<strong>NO</strong>

Dear Editor,

The City Zoo is considering raising the price of admission for adults and children. The zoo should not consider any increase in admission prices for one obvious reason. No one can deny that the zoo's own statistics demonstrate that the last time admission increased, there was a dramatic decline in attendance. For example, in 1992, over 968,000 people visited the zoo. In March of the next year, a $1.00 per ticket increase was instituted.

The 1993 attendance fell to 902,000. In 1994, only 871,000 patrons paid admission, and in 1995, attendance dropped to 866,000. It seems that attendance never rebounded from the price increase.

Maybe the City Zoo needs to think about how other entertainment facilities, like the local movie houses, boost income. They offer a reasonable admission price and take up the slack with concession and souvenir sales.

Sincerely,
Tom Green

<strong>YES</strong>

Dear Editor,

The City Zoo has no choice. They must raise admission prices or else close their gates! Then everyone loses, because animals would be sold off to other zoos, City children would no longer have the learning experiences offered by the zoo, and families would have to look elsewhere for weekend entertainment. An increase of $1.00 per ticket is a small price to pay, and the increased revenue could support a small employee raise, much needed facility improvements, and new animal acquisitions.

Funding these expenses through increased concession and souvenir sales is unrealistic. In fact, only 25% of zoo revenues, according to their last annual report, are from such sales. Also, zoo patrons may start bringing their own snacks into the park rather than buy the more expensive treats. This could even lower concession income in the long run. In my opinion, the small price increase is justified by zoo needs, and should be supported by the community.

Sincerely,
Tanisha Washington`
  },
  13: {
    content: `The king's reign ended with his demise.`
  },
  14: {
    title: "Under Gobi Sands",
    content: `To naturalist Roy Chapman Andrews, the shifting sands of the Gobi Desert looked forbidding.

Located on the boundaries of mysterious Mongolia, few North Americans had ever seen the great desert. Andrews was sure the dunes contained dinosaur fossils.

Andrews had faced mystery and danger more than once in his lifetime. Working for the American Museum of Natural History, he had hunted whales off the Alaskan coast, was accosted by Manchurian bandits in Northeastern China, and searched the remote regions of Tibet and Burma for museum specimens.

In April 1923, Andrews was in the Gobi Desert. With two automobiles and a caravan of camels, the naturalist and his Central Asiatic Expedition snaked their way across the wasteland. The region was so desolate that he was able to see the tire tracks made the year before. At one point, Andrews was forced to use his vehicle to chase away brigands waiting in ambush on their Mongol ponies.

Arriving at a region known as the Flaming Cliffs, Andrews' band of scientists immediately began sifting through the sands in search of prehistoric bones. By nightfall, all had discovered dinosaur skulls. The next day, however, held the true treasure. Scientist George Olsen noticed fossilized eggs in the dunes. Andrews, Olsen, and other paleontologists carefully began scraping away loose rock and sand. The eggs were elongated and about nine inches long. Two of the eggs were broken and contained the tiny skeletons of unhatched baby dinosaurs. Andrews was certain these were the first dinosaur eggs to be seen by modern man.

Later, in a valley called Iren Dabassu, Andrews' expedition discovered mounds of bones from herbivorous and carnivorous dinosaurs. But it was the discovery at the Flaming Cliffs that astounded the scientific world and proved that dinosaurs laid eggs.`
  },
  15: {
    content: `In 1990, 76.9% of adults could expect to live to the age of 65 years or older; at the turn of the previous century, however, only 40.9% of adults enjoyed such <span class="underlined">longevity</span>.`
  },
  16: {
    title: "Life Stages and Typical Developmental Tasks",
    content: `<table>
      <thead>
        <tr>
          <th>Stage</th>
          <th>Age</th>
          <th>Tasks</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Breaking Loose</strong></td>
          <td>Late teens - early 20's</td>
          <td>leave home, focus on peers, attach to causes, change lifestyle, challenge family morals, test own beliefs, identify anticipated occupation</td>
        </tr>
        <tr>
          <td><strong>Building the Nest</strong></td>
          <td>20's</td>
          <td>search for identity, intimate friendships/relationships, marriage, great dreams, take on responsibilities, get launched in a career, work toward goals, do "shoulds," find a mentor, have children</td>
        </tr>
        <tr>
          <td><strong>Looking Around</strong></td>
          <td>30's</td>
          <td>raise questions, recognize painful limitations, gather possessions, move up career ladder, settle down, ask "What do I want to do with my life?"</td>
        </tr>
        <tr>
          <td><strong>Mid-life Rebirth</strong></td>
          <td>40's</td>
          <td>aware of mortality, diminished physical energy, emotional turmoil, finding new friends, deep questions regarding spiritual issues, change careers, sense of aloneness, remodel life structure, establish new stability</td>
        </tr>
        <tr>
          <td><strong>Investing in Life</strong></td>
          <td>50's</td>
          <td>life ordered, settle down, act on new values, focus on people instead of possessions and power, select a few good friends, last child leaving home, grandparenting, more financial freedom, more leisure time, empty nest, lost dreams</td>
        </tr>
      </tbody>
    </table>`
  },
  17: {
    title: "The Rock",
    content: `Angela and Sherry made their way slowly up the mountain. When they had set out this morning, their energy had been high and they'd radiated confidence. Now they felt like mules whose packs had become too heavy at the end of the day. The last half-hour had been especially taxing. The switchbacks seemed to come every few feet.

Abruptly the trail came to an end. A twenty-foot escarpment towered above the women, rising out of a bed of shale. Angela and Sherry peered into the sun hanging just over the top of the mountain. They then contemplated the craggy ravine below. The possibility of turning back crossed their minds, but these women had not hiked five miles and 6,000 feet only to surrender to a clump of rocks.

As the women dropped their backpacks, the wind whipped at their clothes. It felt like ice dicing them into tiny pieces, as they stood frozen in time. Then Angela shivered, breaking the mountain's spell. She stepped forward to challenge the rock, seeking a handhold that must be there. After much patting, she found one and hoisted herself up to the next crevice in the stone. Angela moved cautiously, inching her way up the sheer surface. Finally, she came to a fissure in the stone and wedged herself in out of the wind. Looking up, she realized that there were only five feet to go. She dared not look down to check on Sherry's progress. Angela began to creep along the crack. Within what seemed like hour-long seconds, she reached the summit. She stretched up, saluting the sun, then bent down to give Sherry a hand. They'd made it!`
  }
};

/* ===========================
   CONFIGURATION
   =========================== */
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX6yfgjIVSzmL2nL73IxIWPCV4RPbxfjPTDOxB-_Ax6siB2vmKJXnCpwLP4-PUA4MCpQ/exec';
const GITHUB_BACKUP_URL = 'https://readingcomp-f3ii59o6j-melodys-projects-8b5cbe18.vercel.app/';
const GOOGLE_TIMEOUT_MS = 3500;
const BACKUP_TIMEOUT_MS = 3500;
const BACKUP_REPO_OWNER = 'melodyfschwenk';
const BACKUP_REPO_NAME = 'readingcomp';
const BACKUP_DIR_HINT = 'data/sessions';
const DISCONTINUE_AFTER_ZEROS = 6;

const SESSION_ID = (() => {
  try { return crypto.randomUUID(); }
  catch { return 'sid_' + Date.now() + '_' + Math.random().toString(36).slice(2); }
})();

/* ===========================
   Debug helper
   =========================== */
function debugLog(message, data = null) {
  if (window.location.hostname === 'localhost' || window.location.search.includes('debug=1')) {
    if (data !== null) console.log(message, data);
    else console.log(message);
  }
}

/* ===========================
   State Management
   =========================== */
function announceToScreenReader(message, priority = 'polite') {
    const liveRegion = document.getElementById('sr-live');
    if (liveRegion) {
        liveRegion.setAttribute('aria-live', priority);
        liveRegion.textContent = message;
        
        setTimeout(() => {
            liveRegion.textContent = '';
        }, 4000);
    }
}

let state = {
  pid: '',
  edu: '',
  participantGroup: '',
  readModality: '',
  sessionStartTime: null,
  
  currentIndex: 0,
  totalPoints: 0,
  consecutiveZeros: 0,
  gateItemsFailed: [],

  results: [],
  sequence: [],
  
  timers: {
    reading: null,
    recording: null,
    test: null,
    heartbeat: null
  },
  readingStartTime: null,
  itemStartTime: null,
  lastStartPromise: null,

  useVideoRecording: false,
  useAudioRecording: false,
  mediaRecorder: null,
  recordedChunks: [],
  stream: null,
  recordMime: '',
  adminMode: false,
  uploadAttempts: 0,
  savedData: null,
  connectionStatus: false,

  reviewQueue: [],
  scoringMetrics: {
    highConfidence: 0,
    mediumConfidence: 0,
    lowConfidence: 0,
    manualReviewNeeded: 0
  }
};

let testTimerSec = 0;

    function saveLocal() {
  try {
    const snapshot = {
      state: {
        ...state,
        stream: null,          // don't try to serialize MediaStream
        mediaRecorder: null,   // don't serialize
        recordedChunks: []     // discard in-memory chunks here
      }
    };
    localStorage.setItem('wiat2_session', JSON.stringify(snapshot));
  } catch {}
}
function loadLocal() {
  try {
    const s = JSON.parse(localStorage.getItem('wiat2_session'));
    if (s?.state) Object.assign(state, s.state);
  } catch {}
}

/* ===========================
   WIAT-2 Scoring Reference (same as original)
   =========================== */
const SCORING_REFERENCE = {
  q75: {
    twoPoint: {
      patterns: [/great\s+spirit/i, /\bgod\b/i, /deity/i, /creator/i, /divine\s+being/i, /supreme\s+being/i]
    },
    onePoint: {
      patterns: [/spirit\b/i, /supernatural/i]
    },
    notes: "Must indicate a divine/supreme being for 2 points."
  },
  q76: {
    twoPoint: { patterns: [/\b7\b/, /\bseven\b/i] },
    notes: "Must be exactly 7."
  },
  q77: {
    twoPoint: { patterns: [/soil.*turtle/i, /turtle.*soil/i, /earth.*turtle/i] },
    onePoint: { patterns: [/earth/i, /brush/i, /bush/i] }
  },
  q78: {
    twoPoint: { patterns: [/earthquake/i] },
    onePoint: { patterns: [/land.*quake/i, /ground.*quiver/i] }
  },
  q79: {
    twoPoint: { patterns: [/california.*back/i, /california.*made/i] },
    onePoint: { patterns: [/part.*land/i] }
  },
  q80: {
    twoPoint: { patterns: [/think\s+about/i, /form.*plan/i, /ponder/i] },
    onePoint: { patterns: [/think\s+hard/i, /\bthink\b/i] }
  },
  q82: {
    twoPoint: { patterns: [/road.*covered.*debris/i, /traffic.*stop/i] },
    onePoint: { patterns: [/snow.*covered.*road/i, /avalanche.*covered/i] }
  },
  q83: {
    twoPoint: { patterns: [/tree.*branch/i, /\bdirt\b/i, /\brock/i, /\bmud\b/i, /junk/i] },
    onePoint: { patterns: [/\bsnow\b/i, /rubbish/i] }
  },
  q85: {
    twoPoint: { patterns: [/like.*better/i, /prefer/i, /\blike\b/i] },
    onePoint: { patterns: [/adore/i, /enjoy/i] }
  },
  q87: {
    twoPoint: { patterns: [/bad.*weather.*cancel/i, /weather.*long.*distance/i] },
    onePoint: { patterns: [/bad.*weather/i, /cancel/i] }
  },
  q88: {
    twoPoint: {
      patterns: [
        /\binclement\b/i,
        /(bad|severe|stormy|harsh|rough|foul|nasty)\s+(weather|storm|conditions)/i,
        /(unpleasant|poor)\s+weather/i
      ]
    },
    notes: "Full = clearly 'bad/severe/stormy weather'. Partial = mentions weather conditions without stating severity."
  },
  q89: {
    onePoint: {
      patterns: [
        /(cold|freez|blizzard|snowstorm)/i,
        /(bear|wolf|wolves|animal attack|wildlife)/i,
        /(starv|hunger|food shortage|lack of food)/i,
        /(rapid|river|ice.*break|thin ice|avalanche|landslide)/i,
        /(sick|illness|injur|exhaustion|fatigue)/i
      ]
    },
    notes: "Give 2 if two clear journey dangers are named; 1 for one credible danger. Often needs review."
  },
  q90: {
    twoPoint: {
      patterns: [
        /(does\s*not|doesn't|didn't)\s+want.*(go|yukon).*(cold|freez|danger|hard|difficult|long trip)/i,
        /(reluctant|unwilling|afraid|fear).*go.*(cold|freez|danger|hard|difficult)/i
      ]
    },
    onePoint: { patterns: [/(does\s*not|doesn't|didn't)\s+want.*go/i, /(afraid|fear|scared)/i, /(cold|freez)/i] },
    notes: "Full credit if his reason is the cold/dangers/hardship noted by Diana."
  },
  q91: {
    onePoint: {
      patterns: [
        /(surviv|persever|endure|overcome)/i,
        /(family|together|teamwork|loyalty)/i,
        /(courage|brave|risk|adventure)/i
      ]
    },
    notes: "Give 2 for two accurate themes tied to the text; 1 for one plausible theme (review recommended)."
  },
  q92: {
    twoPoint: { patterns: [/(predictabl|hackneyed|clich[eé]|unoriginal|stale|trite)/i, /(same old|formula(ic)?)/i] },
    onePoint: { patterns: [/(plot|story).*weak|bad/i, /(boring|dull)/i] },
    notes: "Gary disliked that it was unoriginal/predictable."
  },
  q93: {
    twoPoint: { patterns: [/(overused|trite|clich[eé]|worn[- ]?out|stale|banal|unoriginal)/i] },
    onePoint: { patterns: [/(commonplace|old|familiar)/i] },
    notes: "Meaning of 'hackneyed'."
  },
  q94: {
    twoPoint: { patterns: [/(written|document|recorded|chronicle|account)s?\b/i] },
    onePoint: { patterns: [/(history|facts|notes|information)/i] },
    notes: "'Records' = written accounts/documents."
  },
  q95: {
    twoPoint: {
      patterns: [
        /(collected|compiled|gathered|borrowed|took)\s+(from\s+)?(others|folk|people|sayings|maxims|aphorisms)/i,
        /(traditional|folk)\s+(proverb|saying)s?/i
      ]
    },
    onePoint: { patterns: [/(books|almanacs?|newspapers|sources)/i] },
    notes: "He collected existing proverbs."
  },
  q96: {
    twoPoint: { patterns: [/(rush|haste|hurry).*(mistake|waste|redo|do it again|sloppy|error)/i] },
    onePoint: { patterns: [/(don'?t|do not)\s+rush/i, /(take your time|be careful)/i] }
  },
  q97: {
    twoPoint: {
      patterns: [
        /(short|brief|simple|concise).*(sayings|proverbs)/i,
        /(easy\s+to\s+remember|memorable)/i,
        /(wisdom|truth|advice|lesson)/i
      ]
    },
    onePoint: { patterns: [/(people|most).*(like|enjoy).*(proverb|saying)/i] }
  },
  q98: {
    notes: "Selects the proverb that comments on modern technology. Mark for manual review (no scoring patterns here)."
  },
  q100: {
    twoPoint: { patterns: [/(mammal).*(warm[- ]?blood)/i, /(saurian|reptile).*(cold[- ]?blood)/i] },
    onePoint: { patterns: [/(warm[- ]?blood|cold[- ]?blood)/i, /(mammal|saurian|reptile)/i] }
  },
  q102: {
    twoPoint: { patterns: [/(long|several|many)\s+(years|period).*(no|little)\s+rain/i, /\bdrought\b/i] },
    onePoint: { patterns: [/(dust\s*storm|sand\s*storm)s?/i] }
  },
  q103: {
    twoPoint: { patterns: [/(health|medical|therapy|exercise)/i, /(turned[- ]in\s+(hips|feet)|foot\s+problem|hip\s+problem)/i] },
    onePoint: { patterns: [/(to\s+exercise|for\s+her\s+health)/i] }
  },
  q104: {
    semantic: {
      full: [
        ["daily routine", "everyday routine", "habit", "regular schedule", "usual activities", "day-to-day"],
        ["skating routine", "performance routine", "program", "choreograph", "set sequence", "planned moves"]
      ],
      partial: ["daily", "habit", "schedule", "program", "performance", "choreographed"]
    },
    notes: "First = everyday schedule; next = choreographed program/performance."
  },
  q105: {
    twoPoint: {
      patterns: [
        /(did|skated?)\s+both\s+(pairs|pair)\s+and\s+(singles|single)/i,
        /(pairs|pair)\s+and\s+(singles|single)\s+at\s+the\s+same\s+time/i
      ]
    },
    onePoint: { patterns: [/(too\s+much\s+work|many\s+events|double\s+workload)/i] }
  },
  q106: {
    twoPoint: { patterns: [/(kristi|yamaguchi).*(rudy|galindo)/i] },
    notes: "Kristi Yamaguchi & Rudy Galindo."
  },
  q107: {
    twoPoint: { patterns: [/(choreograph(y|ic)|artistry|presentation|style|grace|expression)/i] },
    onePoint: { patterns: [/(not\s+just\s+jumps|technique|balance|control)/i] },
    notes: "She compensated with choreography/artistry."
  },
  q108: {
    twoPoint: { patterns: [/(death|dying|end|extinction|downfall|ruin)/i] },
    onePoint: { patterns: [/(decline|fall|reduce|less)/i] }
  },
  q109: {
    semantic: {
      full: [
        ["hunt", "hunted", "whale", "whaling", "killed"],
        ["net", "fishing net", "entangle", "caught", "bycatch", "pollution", "ship strike"]
      ],
      partial: ["hunted", "whaling", "nets", "entangled", "pollution", "bycatch", "ships"]
    },
    notes: "Two ways: (1) hunting/whaling; (2) nets/entanglement (pollution/ship strikes may count if text supports)."
  },
  q110: {
    twoPoint: { patterns: [/(we)\s+can\s+(protect|save|help|conserve)/i, /(awareness|understand).*(protect|conserve|laws|action)/i] },
    onePoint: { patterns: [/(important|know|learn)/i] }
  },
  q111: {
    semantic: {
      full: [
        ["drown", "suffocate", "asphyxiate"],
        ["starve", "starvation"]
      ],
      partial: ["drown", "suffocate", "starve"]
    },
    notes: "Two things: drown and starve."
  },
  q112: {
    twoPoint: { patterns: [/(become|go)\s+extinct/i, /(die\s+out)/i] },
    onePoint: { patterns: [/(decline|decrease|fall)\s+in\s+numbers/i, /(endangered|at\s+risk)/i] }
  },
  q114: {
    twoPoint: {
      patterns: [
        /(in\s+season|harvest|summer|supply.*high).*price(s)?\s+(low|lower|drop)/i,
        /(off[- ]season|winter|supply.*low).*price(s)?\s+(rise|higher|increase)/i
      ]
    },
    onePoint: { patterns: [/(supply).*affect(s|ed)?.*price/i, /(season|harvest)/i] },
    notes: "Seasonal supply explains price changes."
  },
  q115: {
    twoPoint: { patterns: [/\$?\s*3(\.00)?\b/i, /\bthree\s*dollars?\b/i] },
    onePoint: { patterns: [/(less|cheaper|lower)/i] }
  },
  q116: {
  twoPoint: {
    patterns: [
      /(attendance|visits|visitation).*(fell|drop(ped)?|declined)/i,
      /(price|admission).*increase.*(led|caused).*decline/i
    ]
  },
  onePoint: {
    patterns: [
      /(fewer|less)\s+people\s+(went|visited)/i,
      /(raising|higher)\s+(price|admission)\s+is\s+bad/i
    ]
  },
  notes: "Tom’s main reason: the last price increase caused a decline in attendance that never rebounded."
},

  q117: {
    twoPoint: {
      patterns: [
        /(take\s+up\s+the\s+slack)\s*=\s*(compensate|cover|make\s+up|fill\s+in|carry\s+the\s+load)/i,
        /(compensate|cover|make\s+up).*(for\s+others|shortfall|lack)/i
      ]
    },
    onePoint: { patterns: [/(help\s+out|do\s+more|pick\s+up\s+the\s+slack)/i] }
  },
  q118: {
    twoPoint: {
      patterns: [
        /(acquisition|acquisitions)\s*=\s*(purchases|things\s+the\s+zoo\s+buys|new\s+animals|items\s+obtained)/i,
        /(purchase|buy|obtain)\s+(animals|exhibits|items)/i
      ]
    },
    onePoint: { patterns: [/(new\s+animals|new\s+exhibits|purchases)/i] }
  },
  q119: {
    onePoint: {
      patterns: [
        /(fewer|no)\s+(acquisitions|new\s+animals|new\s+exhibits)/i,
        /(reduce(d)?|cut)\s+(hours|services|staff|care|maintenance)/i,
        /(close|closure)/i,
        /(lack\s+of\s+funds|budget\s+shortfall)/i
      ]
    },
    notes: "Give 2 if three stated consequences are listed; 1 for one–two. Often needs review."
  },
  q121: {
    twoPoint: { patterns: [/(the\s+)?king\s+(has\s+)?(died|is\s+dead|passed\s+away|was\s+assassinated)/i] },
    onePoint: { patterns: [/(the\s+)?king\s+(is\s+gone|no\s+longer|not\s+alive)/i] }
  },
  q122: {
    twoPoint: { patterns: [/(new\s+king|succession|heir|prince\s+becomes\s+king)/i, /(funeral|mourning|power\s+struggle|war|chaos)/i] },
    onePoint: { patterns: [/(someone\s+else\s+will\s+rule|change\s+of\s+power)/i] }
  },
  q123: {
    twoPoint: { patterns: [/(first|initial)\s+discovery.*(skull|skulls)/i, /(flaming\s+cliffs|bayanzag|gobi)/i] },
    onePoint: { patterns: [/(dinosaur|fossil)/i] }
  },
  q124: {
    onePoint: { patterns: [/(adventure|expedition|voyage|journey|exploration)/i] },
    notes: "Give 2 if three specific pre-Gobi adventures are correctly named; 1 for one–two (manual review)."
  },
  q125: {
    twoPoint: { patterns: [/(gobi\s+desert|mongolia|flaming\s+cliffs)/i, /(nest|nests|eggs)/i] },
    onePoint: { patterns: [/(desert|sand|cliffs)/i] }
  },
  q126: {
    twoPoint: { patterns: [/(proved|showed|demonstrated)\s+that\s+dinosaurs?\s+(laid|lay)\s+eggs/i, /(first|new)\s+dinosaur\s+eggs?\s+discovered/i] },
    onePoint: { patterns: [/(changed|altered)\s+scientific\s+knowledge/i] }
  },
  q127: {
    twoPoint: { patterns: [/(brigands?)\s*=\s*(bandits?|robbers?|thieves?)/i] },
    onePoint: { patterns: [/(outlaws?|criminals?)/i] }
  },
  q129: {
    twoPoint: { patterns: [/(longevity)\s*=\s*(length\s+of\s+life|life\s*span|how\s+long\s+people\s+live)/i] },
    onePoint: { patterns: [/(old|older|age)/i] }
  },
  q130: {
    twoPoint: { patterns: [/(life\s+expectancy|longevity)\s+(has\s+)?(risen|increased|gone\s+up|grown)\b/i, /(trend|graph|chart).*(upward|increase|rise)/i] },
    onePoint: { patterns: [/(people\s+live\s+longer)/i] }
  },
  q131: {
    twoPoint: { patterns: [/(young|early)\s+adult(hood)?/i, /(begin|start)\s+a\s+career/i] },
    onePoint: { patterns: [/\badult\b/i] }
  },
  q132: {
    twoPoint: { patterns: [/(reassess|re[- ]?evaluate|reconsider|question).*(goals|career|life|relationships?)/i, /(change|adjust|redirect).*(life|career|path|relationships?)/i] },
    onePoint: { patterns: [/(mid[- ]?life).*(change|question|reassess)/i] }
  },
  q133: {
    twoPoint: { patterns: [/(mid[- ]?life\s+rebirth)/i] },
    onePoint: { patterns: [/(mid[- ]?life|reassessment)/i] }
  },
  q134: {
    twoPoint: { patterns: [/(lack|missing|fail(ed)?\s+to\s+develop).*(independence|self[- ]?reliance)/i, /(remain|stay)\s+(dependent|immature|tied)/i] },
    onePoint: { patterns: [/(problems|issues)\s+with\s+(independence|identity)/i] }
  },
  q135: {
    twoPoint: { patterns: [/(mentor|guide|teach|advise|give\s+back)/i, /(reflect|wisdom|insight|legacy|purpose|meaning)/i] },
    onePoint: { patterns: [/(help\s+others|share\s+experience|reflection)/i] }
  },
  q136: {
    twoPoint: { patterns: [/(fissure)\s*=\s*(narrow|thin)\s+(crack|split|opening)\s+in\s+rock/i] },
    onePoint: { patterns: [/(crack|split|opening)/i] }
  },
  q137: {
    twoPoint: { patterns: [/(sheer|vertical)\s+(wall|face|escarpment)/i, /(sudden(ly)?)\s+(steep|drop|cliff)/i] },
    onePoint: { patterns: [/(harder|difficult|steeper)/i] }
  },
  q138: {
    twoPoint: { patterns: [/(fatigue|exhaustion|very\s+tired)/i] },
    onePoint: { patterns: [/(fear|scared|mental|mindset|discouraged)/i] }
  },
  q139: {
    twoPoint: { patterns: [/(determination|willpower|resolve|too\s+far\s+to\s+quit|couldn'?t\s+turn\s+back)/i] },
    onePoint: { patterns: [/(close\s+to\s+the\s+top|almost\s+there|came\s+so\s+far)/i] }
  },
  q140: {
    twoPoint: { patterns: [/(focus(ed)?\s+on\s+herself|needed\s+to\s+concentrate|had\s+to\s+get\s+herself\s+to\s+top)/i] },
    onePoint: { patterns: [/(afraid|fear|if\s+she\s+looked\s+down|discouraged|didn'?t\s+want\s+to\s+look\s+back)/i] }
  }
};

/* ===========================
   TRIALS Configuration
   =========================== */
const TRIALS = [
  // Turtle Brothers passage
  {
    item: 75,
    passageId: 1,
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q75",
      text: "Who is Kwawar?",
      scoringKey: "q75"
    }]
  },
  {
    item: 76,
    passageId: 1,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q76",
      text: "In all, how many Turtle Brothers were needed to fulfill Kwawar's request?",
      scoringKey: "q76"
    }]
  },
  {
    item: 77,
    passageId: 1,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q77",
      text: "What caused the mountains to arise?",
      scoringKey: "q77"
    }]
  },
  {
    item: 78,
    passageId: 1,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q78",
      text: "What natural event does the Turtle Brothers' quarreling explain?",
      scoringKey: "q78"
    }]
  },
  {
    item: 79,
    passageId: 1,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q79",
      text: "What great gift did Kwawar give the Turtle Brothers?",
      scoringKey: "q79"
    }]
  },
  {
    item: 80,
    passageId: 1,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q80",
      text: "What is the meaning of contemplated in the story?",
      scoringKey: "q80"
    }]
  },
  
  // Avalanche passage (read aloud)
  {
    item: 81,
    passageId: 2,
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 82,
    passageId: 2,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q82",
      text: "Tell me in your own words, what has happened as a result of the avalanche?",
      scoringKey: "q82"
    }]
  },
  {
    item: 83,
    passageId: 2,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q83",
      text: "What does the word debris mean in this sentence?",
      scoringKey: "q83"
    }]
  },
  
  // Fancy passage (read aloud)
  {
    item: 84,
    passageId: 3,
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 85,
    passageId: 3,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q85",
      text: "What does the word fancy mean in this sentence?",
      scoringKey: "q85"
    }]
  },
  
  // Track meet passage (read aloud)
  {
    item: 86,
    passageId: 4,
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 87,
    passageId: 4,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q87",
      text: "Why did the track meet end earlier than expected?",
      scoringKey: "q87"
    }]
  },
  {
    item: 88,
    passageId: 4,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q88",
      text: "What does the word inclement mean in this sentence?",
      scoringKey: "q88"
    }]
  },
  
  // Yukon Gold passage
  {
    item: 89,
    passageId: 5,
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q89",
      text: "What were two dangers encountered by the family on their journey?",
      scoringKey: "q89"
    }]
  },
  {
    item: 90,
    passageId: 5,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q90",
      text: "According to Diana, why doesn't Charlie want to go to Yukon?",
      scoringKey: "q90"
    }]
  },
  {
    item: 91,
    passageId: 5,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q91",
      text: "According to the reviewers, what are two main themes or ideas in Yukon Gold?",
      scoringKey: "q91"
    }]
  },
  {
    item: 92,
    passageId: 5,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q92",
      text: "Diana gave Yukon Gold four stars although Gary gave it two. What did Gary dislike about the movie?",
      scoringKey: "q92"
    }]
  },
  {
    item: 93,
    passageId: 5,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q93",
      text: "What is the meaning of the word hackneyed in Gary's review?",
      scoringKey: "q93"
    }]
  },
  
  // Words of Wisdom (Grades 9-12 Start)
  {
    item: 94,
    passageId: 6,
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q94",
      text: "What is the meaning of the word records in the first paragraph?",
      scoringKey: "q94"
    }]
  },
  {
    item: 95,
    passageId: 6,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q95",
      text: "Where do you think Ben Franklin found the proverbs he included in the Poor Richard's Almanack?",
      scoringKey: "q95"
    }]
  },
  {
    item: 96,
    passageId: 6,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q96",
      text: "What do you think 'Haste makes waste' might mean?",
      scoringKey: "q96"
    }]
  },
  {
    item: 97,
    passageId: 6,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q97",
      text: "Why do you think most people like proverbs?",
      scoringKey: "q97"
    }]
  },
  {
    item: 98,
    passageId: 6,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q98",
      text: "Which of the proverbs mentioned in the passage is a comment on modern technology?",
      scoringKey: "q98"
    }]
  },
  
  // Mammals vs Saurian (read aloud)
  {
    item: 99,
    passageId: 7,
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 100,
    passageId: 7,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q100",
      text: "How are mammals and saurian different?",
      scoringKey: "q100"
    }]
  },
  
  // Dust Bowl (read aloud)
  {
    item: 101,
    passageId: 8,
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 102,
    passageId: 8,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q102",
      text: "What does the sentence tell you that the great Dust Bowl was?",
      scoringKey: "q102"
    }]
  },
  
  // Kristi Yamaguchi passage
  {
    item: 103,
    passageId: 9,
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q103",
      text: "For what primary reason did Kristi's mother want her daughter to skate?",
      scoringKey: "q103"
    }]
  },
  {
    item: 104,
    passageId: 9,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q104",
      text: "How does the definition of routine in the first paragraph differ from that in the next paragraph?",
      scoringKey: "q104"
    }]
  },
  {
    item: 105,
    passageId: 9,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q105",
      text: "Why was Kristi's workload double that of other skaters?",
      scoringKey: "q105"
    }]
  },
  {
    item: 106,
    passageId: 9,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q106",
      text: "Who won the pairs gold medal at the 1990 Nationals?",
      scoringKey: "q106"
    }]
  },
  {
    item: 107,
    passageId: 9,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q107",
      text: "How was Kristi able to compensate for her athletic limitations?",
      scoringKey: "q107"
    }]
  },
  
  // Humpback whales passage
  {
    item: 108,
    passageId: 10,
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q108",
      text: "What is the meaning of the word demise in this story?",
      scoringKey: "q108"
    }]
  },
  {
    item: 109,
    passageId: 10,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q109",
      text: "In what two ways have people been the primary reason for the whales' demise?",
      scoringKey: "q109"
    }]
  },
  {
    item: 110,
    passageId: 10,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q110",
      text: "Why is it important for us to know about the struggles of the humpback whales?",
      scoringKey: "q110"
    }]
  },
  {
    item: 111,
    passageId: 10,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q111",
      text: "What two things might happen if a whale is caught in a fishing net?",
      scoringKey: "q111"
    }]
  },
  {
    item: 112,
    passageId: 10,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q112",
      text: "According to current studies, what is likely to happen to the humpback whale in the future?",
      scoringKey: "q112"
    }]
  },
  
  // Peach prices (read aloud)
  {
    item: 113,
    passageId: 11,
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 114,
    passageId: 11,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q114",
      text: "What is the most likely reason for the changes in the peach prices during the year?",
      scoringKey: "q114"
    }]
  },
  
  // Zoo admission passage
  {
    item: 115,
    passageId: 12,
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q115",
      text: "If today's zoo admission is $4.00, what was zoo admission in January 1993?",
      scoringKey: "q115"
    }]
  },
  {
    item: 116,
    passageId: 12,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q116",
      text: "What is the main reason Tom gives to support his position?",
      scoringKey: "q116"
    }]
  },
  {
    item: 117,
    passageId: 12,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q117",
      text: "When he says 'take up the slack' in his sentence, what does Tom mean?",
      scoringKey: "q117"
    }]
  },
  {
    item: 118,
    passageId: 12,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q118",
      text: "Tanisha uses the word 'acquisitions' in her letter. What does it mean?",
      scoringKey: "q118"
    }]
  },
  {
    item: 119,
    passageId: 12,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q119",
      text: "According to Tanisha, what three things might happen if zoo prices are not raised?",
      scoringKey: "q119"
    }]
  },
  
  // King passage (read aloud)
  {
    item: 120,
    passageId: 13,
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 121,
    passageId: 13,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q121",
      text: "What has happened to the king?",
      scoringKey: "q121"
    }]
  },
  {
    item: 122,
    passageId: 13,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q122",
      text: "What would you predict might happen as a result of the event described?",
      scoringKey: "q122"
    }]
  },
  
  // Central Asiatic Expedition passage
  {
    item: 123,
    passageId: 14,
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q123",
      text: "What was the first discovery of the Central Asiatic Expedition?",
      scoringKey: "q123"
    }]
  },
  {
    item: 124,
    passageId: 14,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q124",
      text: "Tell three adventures Andrews had experienced before going to the Gobi desert.",
      scoringKey: "q124"
    }]
  },
  {
    item: 125,
    passageId: 14,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q125",
      text: "Where did the scientists discover the dinosaur eggs?",
      scoringKey: "q125"
    }]
  },
  {
    item: 126,
    passageId: 14,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q126",
      text: "How did Andrew's expedition alter scientific knowledge?",
      scoringKey: "q126"
    }]
  },
  {
    item: 127,
    passageId: 14,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q127",
      text: "What is the meaning of the word brigands as used in the passage?",
      scoringKey: "q127"
    }]
  },
  
  // Longevity (read aloud)
  {
    item: 128,
    passageId: 15,
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 129,
    passageId: 15,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q129",
      text: "What is the meaning of the word longevity in this sentence?",
      scoringKey: "q129"
    }]
  },
  {
    item: 130,
    passageId: 15,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q130",
      text: "Describe the trend reported in this sentence",
      scoringKey: "q130"
    }]
  },
  
  // Life stages passage
  {
    item: 131,
    passageId: 16,
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q131",
      text: "At what life stage is a person likely to begin a career?",
      scoringKey: "q131"
    }]
  },
  {
    item: 132,
    passageId: 16,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q132",
      text: "What is the main theme of the 'Mid-life Rebirth' developmental tasks?",
      scoringKey: "q132"
    }]
  },
  {
    item: 133,
    passageId: 16,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q133",
      text: "Although Rachel was recently promoted to manager of her office, she is questioning her choice of careers and regrets that she never pursued her dream of composing music. At the same time, she is reluctant to quit her job because she recently bought a new home. What developmental stage is Rachel probably in?",
      scoringKey: "q133"
    }]
  },
  {
    item: 134,
    passageId: 16,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q134",
      text: "What might happen if a person did not accomplish the developmental tasks of the 'Breaking Loose' stage?",
      scoringKey: "q134"
    }]
  },
  {
    item: 135,
    passageId: 16,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q135",
      text: "If the last life stage called 'Deepening Wisdom' were added to the chart, what would you predict two of the developmental tasks would be?",
      scoringKey: "q135"
    }]
  },
  
  // The Rock passage
  {
    item: 136,
    passageId: 17,
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q136",
      text: "What is the fissure as described in the passage?",
      scoringKey: "q136"
    }]
  },
  {
    item: 137,
    passageId: 17,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q137",
      text: "What suddenly made this rock climb so difficult?",
      scoringKey: "q137"
    }]
  },
  {
    item: 138,
    passageId: 17,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q138",
      text: "What was the most important thing the women had to overcome in order to scale the rock?",
      scoringKey: "q138"
    }]
  },
  {
    item: 139,
    passageId: 17,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q139",
      text: "What kept the women from turning back when they saw the sheer surface of the rock?",
      scoringKey: "q139"
    }]
  },
  {
    item: 140,
    passageId: 17,
    type: "question",
    skipReading: true,
    questions: [{
      id: "q140",
      text: "Why did Angela refuse to look at Sherry as she approached the summit?",
      scoringKey: "q140"
    }]
  }
];

/* ===========================
   REST OF THE JAVASCRIPT CODE - Same as original but with passage display changes
   =========================== */

function getReadAloudInstructions() {
  if (state.useVideoRecording) {
    return {
      title: 'ASL read aloud',
      text: 'When you are ready, sign the passage clearly on camera. You can pause briefly to think.',
      buttonText: 'Start video recording'
    };
  } else {
    return {
      title: 'Spoken read aloud',
      text: 'When you are ready, read the passage out loud into the microphone. You can speak at a natural pace.',
      buttonText: 'Start audio recording'
    };
  }
}

function determineRecordingNeeds() {
  const group = state.participantGroup;
  const modality = state.readModality;
  
  if (modality === 'sign') {
    state.useVideoRecording = true;
    state.useAudioRecording = false;
    return 'video';
  } else {
    state.useVideoRecording = false;
    state.useAudioRecording = true;
    return 'audio';
  }
}

function checkWelcomeReady() {
  const hasPid = document.getElementById('pid').value.trim().length > 0;
  const hasEdu = document.getElementById('edu').value.trim().length > 0;
  const group = document.querySelector('input[name="participant-group"]:checked');
  const consent = document.getElementById('consent').checked;

  state.pid = document.getElementById('pid').value.trim();
  state.edu = document.getElementById('edu').value.trim();
  state.participantGroup = group ? group.value : '';

  // Show modality selection only after group is chosen
  const modalityBlock = document.getElementById('modality-selection');
  const deafNote = document.getElementById('deaf-note');
  if (group) {
    modalityBlock.classList.remove('hidden');
    // If group indicates deaf, show note
    if (state.participantGroup.startsWith('deaf')) deafNote.classList.remove('hidden');
    else deafNote.classList.add('hidden');
  }

  // Enable continue only if everything required is present
  const ready = hasPid && hasEdu && !!group && consent;
  document.getElementById('begin').disabled = !ready;
}

function showScreen(id) {
  for (const el of document.querySelectorAll('#screen-welcome, #screen-setup, #screen-item, #screen-finish')) {
    el.classList.add('hidden');
  }
  const target = document.getElementById(id);
  target.classList.remove('hidden');

  const h = target.querySelector('h1, h2, [role="heading"]');
  if (h) { h.setAttribute('tabindex','-1'); h.focus(); }
  announceToScreenReader(h?.textContent || 'Screen changed', 'polite');
}


function formatMMSS(sec) {
  const m = String(Math.floor(sec / 60)).padStart(2, '0');
  const s = String(Math.floor(sec % 60)).padStart(2, '0');
  return `${m}:${s}`;
}

/* ===========================
   Timers
   =========================== */
const Timers = {
  start(name, tickCb) {
    this.stop(name);
    let t = 0;
    state.timers[name] = setInterval(() => {
      t += 1;
      if (typeof tickCb === 'function') tickCb(t);
    }, 1000);
    return () => this.stop(name);
  },
  stop(name) {
    if (state.timers[name]) {
      clearInterval(state.timers[name]);
      state.timers[name] = null;
    }
  },
  stopAll() {
    Object.keys(state.timers).forEach(k => this.stop(k));
  }
};

/* ===========================
   Media setup and recording
   =========================== */
    function stopMedia() {
  try {
    if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
      state.mediaRecorder.stop();
    }
  } catch {}
  if (state.stream) {
    try { state.stream.getTracks().forEach(tr => tr.stop()); } catch {}
    state.stream = null;
  }
}

    function pickMime() {
  const candidates = state.useVideoRecording
    ? ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm']
    : ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/ogg'];
  return (MediaRecorder.isTypeSupported
    ? candidates.find(m => MediaRecorder.isTypeSupported(m))
    : null) || '';
}

async function blobToBase64(blob){
  const arr = new Uint8Array(await blob.arrayBuffer());
  let s = '';
  for (let i=0; i<arr.length; i++) s += String.fromCharCode(arr[i]);
  return btoa(s);
}

async function uploadBlob(kind, blob, meta = {}) {
  try {
    const data = await blobToBase64(blob);
    return postWithTimeout(GOOGLE_SCRIPT_URL, {
      action: 'upload_blob',
      sessionId: SESSION_ID,
      pid: state.pid,
      itemNumber: currentTrial()?.item,
      kind, mime: blob.type, data,
      ...meta
    }, GOOGLE_TIMEOUT_MS);
  } catch (e) {
    // If this fails silently (CORS), you'll still have the session JSON backup.
  }
}

async function setupVideo() {
  const status = document.getElementById('video-status');
  try {
    state.stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: state.useAudioRecording });
    const v = document.getElementById('preview');
    v.srcObject = state.stream;
    status.textContent = 'Camera is ready. You can proceed.';
    document.getElementById('pref-hide-selfview').classList.remove('hidden');
    document.getElementById('start-study').disabled = false;
    return true;
  } catch (e) {
    const msg = /NotAllowed|Permission/i.test(e.name + e.message)
      ? 'Permission denied. Click the lock icon in your browser’s address bar to allow camera/microphone, then retry.'
      : 'Could not access camera. Ensure no other app is using it and retry.';
    status.textContent = msg;
    document.getElementById('start-study').disabled = true;
    return false;
  }
}


async function setupAudio() {
  const status = document.getElementById('audio-status');
  try {
    state.stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    status.textContent = 'Microphone is ready. You can proceed.';
    document.getElementById('start-study').disabled = false;
    return true;
  } catch (e) {
    const msg = /NotAllowed|Permission/i.test(e.name + e.message)
      ? 'Permission denied. Click the lock icon in your browser’s address bar to allow the microphone, then retry.'
      : 'Could not access microphone. Ensure no other app is using it and retry.';
    status.textContent = msg;
    document.getElementById('start-study').disabled = true;
    return false;
  }
}


function startMediaRecorder(onStop) {
  if (!state.stream) return null;
  try {
    state.recordedChunks = [];
    const mime = pickMime();
    state.recordMime = mime;
    const mr = mime ? new MediaRecorder(state.stream, { mimeType: mime }) : new MediaRecorder(state.stream);
    state.mediaRecorder = mr;

    mr.ondataavailable = e => { if (e.data && e.data.size > 0) state.recordedChunks.push(e.data); };
    mr.onstop = async () => {
      const blob = new Blob(state.recordedChunks, { type: state.recordMime || (state.useVideoRecording ? 'video/webm' : 'audio/webm') });
      try { if (typeof onStop === 'function') onStop(blob); } catch {}
      // Upload the blob “best effort”
      uploadBlob(state.useVideoRecording ? 'video' : 'audio', blob).catch(()=>{});
    };
    mr.start(10000);
    return mr;
  } catch (e) {
    return null;
  }
}


/* ===========================
   Rendering helpers
   =========================== */
    
function renderPassage(passageId) {
  const slot = document.getElementById('passage-container');
  const p = PASSAGES[passageId];
  if (!p) { slot.innerHTML = ''; return; }
  let html = '';
  if (p.title) html += `<h3>${p.title}</h3>`;
  if (p.subtitle) html += `<em>${p.subtitle}</em>`;
  if (p.content) html += `<div class="q-block">${p.content}</div>`;
  slot.innerHTML = html;
}
// Optional: tiny helper for auto-underlining pattern “What does the word X mean…”
function autoFormatQuestionHTML(qText) {
  if (!qText) return "";
  const m = qText.match(/what does the word\s+([A-Za-z’'\-]+)\s+mean/i);
  if (m) {
    const token = m[1];
    const formatted = qText.replace(
      new RegExp(`(what does the word\\s+)(${token})(\\s+mean)`, 'i'),
      (_, a, w, b) => `${a}<span class="underlined">${w}</span>${b}`
    );
    return `<p>${formatted}</p>`; // no extra '?'
  }
  return `<p>${qText}</p>`;
}


// Exact per-question HTML so formatting matches the source’s intent
const QUESTION_HTML_OVERRIDES = {
  // Turtle Brothers (vocab in the question)
  q80:  `<p>What is the meaning of <span class="underlined">contemplated</span> in the story?</p>`,

  // Avalanche / debris
  q82:  `<p><strong>Tell me</strong> in your own words, what has happened as a result of the avalanche?</p>`,
  q83:  `<p>What does the word <span class="underlined">debris</span> mean in this sentence?</p>`,

  // Fancy
  q85:  `<p>What does the word <span class="underlined">fancy</span> mean in this sentence?</p>`,

  // Inclement
  q87:  `<p>Why did the track meet end earlier than expected?</p>`,
  q88:  `<p>What does the word <span class="underlined">inclement</span> mean in this sentence?</p>`,

  // Yukon Gold (keep movie title as the doc emphasizes the title; we’ll use bold smallcaps)
  q89:  `<p>What were two dangers encountered by the family on their journey in <strong>YUKON GOLD</strong>?</p>`,
  q90:  `<p>According to <strong>Diana</strong>, why doesn't Charlie want to go to Yukon?</p>`,
  q91:  `<p>According to the reviewers, what are two main themes or ideas in <strong>YUKON GOLD</strong>?</p>`,
  q92:  `<p>Diana gave <strong>YUKON GOLD</strong> four stars although Gary gave it two. What did Gary dislike about the movie?</p>`,
  q93:  `<p>What is the meaning of the word <span class="underlined">hackneyed</span> in Gary’s review?</p>`,

  // Words of Wisdom
  q94:  `<p>What is the meaning of the word <span class="underlined">records</span> in the first paragraph?</p>`,
  q95:  `<p>Where do you think Ben Franklin found the proverbs he included in the <em>Poor Richard’s Almanack</em>?</p>`,
  q96:  `<p>What do you think <q>Haste makes waste</q> might mean?</p>`,
  q97:  `<p>Why do you think most people like proverbs?</p>`,
  q98:  `<p>Which of the proverbs mentioned in the passage is a comment on modern technology?</p>`,

  // Mammals vs saurian
  q100: `<p>How are mammals and saurian different?</p>`,

  // Dust Bowl
  q102: `<p>What does the sentence tell you that the great Dust Bowl was?</p>`,

  // Kristi Yamaguchi (underline “routine” like the passage does)
  q103: `<p>For what primary reason did Kristi’s mother want her daughter to skate?</p>`,
  q104: `<p>How does the definition of <span class="underlined">routine</span> in the first paragraph differ from that in the next paragraph?</p>`,
  q105: `<p>Why was Kristi’s workload double that of other skaters?</p>`,
  q106: `<p>Who won the pairs gold medal at the 1990 Nationals?</p>`,
  q107: `<p>How was Kristi able to compensate for her athletic limitations?</p>`,

  // Humpback whales (underline “demise”)
  q108: `<p>What is the meaning of the word <span class="underlined">demise</span> in this story?</p>`,
  q109: `<p>In what two ways have people been the primary reason for the whales’ demise?</p>`,
  q110: `<p>Why is it important for us to know about the struggles of the humpback whales?</p>`,
  q111: `<p>What two things might happen if a whale is caught in a fishing net?</p>`,
  q112: `<p>According to current studies, what is likely to happen to the humpback whale in the future?</p>`,

  // Peaches prices
  q114: `<p>What is the most likely reason for the changes in the peach prices during the year?</p>`,

  // City Zoo letters (quote the exact phrases)
  q115: `<p>If today’s zoo admission is $4.00, what was zoo admission in January 1993?</p>`,
  q116: `<p>What is the main reason Tom gives to support his position?</p>`,
  q117: `<p>When he says <q>take up the slack</q> in his sentence, what does Tom mean?</p>`,
  q118: `<p>Tanisha uses the word <q>acquisitions</q> in her letter. What does it mean?</p>`,
  q119: `<p>According to Tanisha, what three things might happen if zoo prices are not raised?</p>`,

  // King
  q121: `<p>What has happened to the king?</p>`,
  q122: `<p>What would you predict might happen as a result of the event described?</p>`,

  // Gobi (quote key terms where helpful)
  q123: `<p>What was the first discovery of the Central Asiatic Expedition?</p>`,
  q124: `<p>Tell three adventures Andrews had experienced before going to the Gobi Desert.</p>`,
  q125: `<p>Where did the scientists discover the dinosaur eggs?</p>`,
  q126: `<p>How did Andrews’ expedition alter scientific knowledge?</p>`,
  q127: `<p>What is the meaning of the word <span class="underlined">brigands</span> as used in the passage?</p>`,

  // Longevity
  q129: `<p>What is the meaning of the word <span class="underlined">longevity</span> in this sentence?</p>`,
  q130: `<p>Describe the trend reported in this sentence.</p>`,

  // Life stages
  q131: `<p>At what life stage is a person likely to begin a career?</p>`,
  q132: `<p>What is the main theme of the <q>Mid-life Rebirth</q> developmental tasks?</p>`,
  q133: `<p>Although Rachel was recently promoted to manager of her office, she is questioning her choice of careers and regrets that she never pursued her dream of composing music. At the same time, she is reluctant to quit her job because she recently bought a new home. What developmental stage is Rachel probably in?</p>`,
  q134: `<p>What might happen if a person did not accomplish the developmental tasks of the <q>Breaking Loose</q> stage?</p>`,
  q135: `<p>If the last life stage called <q>Deepening Wisdom</q> were added to the chart, what would you predict two of the developmental tasks would be?</p>`,

  // The Rock
  q136: `<p>What is the <span class="underlined">fissure</span> as described in the passage?</p>`,
  q137: `<p>What suddenly made this rock climb so difficult?</p>`,
  q138: `<p>What was the most important thing the women had to overcome in order to scale the rock?</p>`,
  q139: `<p>What kept the women from turning back when they saw the sheer surface of the rock?</p>`,
  q140: `<p>Why did Angela refuse to look at Sherry as she approached the summit?</p>`
};


function renderQAFields(trial) {
  const holder = document.getElementById('qa-fields');
  holder.innerHTML = '';
  if (!trial.questions || !trial.questions.length) return;

  trial.questions.forEach((q, idx) => {
    const inputId = `ans_${trial.item}_${idx}`;
    const hintId  = `hint_${trial.item}_${idx}`;

    // Build rich HTML for the prompt
    const override = QUESTION_HTML_OVERRIDES[q.id];
    const htmlPrompt = override || autoFormatQuestionHTML(q.text || '');

    const block = document.createElement('div');
    block.className = 'q-block';
    block.innerHTML = `
      <div class="q-text" id="qtext_${trial.item}_${idx}">
        ${htmlPrompt || `<p>${q.text}</p>`}
      </div>

      <label for="${inputId}" class="sr-only">${q.text}</label>
      <textarea id="${inputId}"
        data-scoring-key="${q.scoringKey || ''}"
        placeholder="Type your answer here…"
        aria-describedby="${hintId}"
        autocomplete="off" autocapitalize="sentences" spellcheck="true"></textarea>

      <div id="${hintId}" class="muted">Answer in your own words.</div>
    `;
    holder.appendChild(block);
  });
}

/* ===========================
   Scoring
   =========================== */
    function scoreTwoDistinct(text, groups){
  let hits = 0;
  for (const g of groups) if (g.some(rx => rx.test(text))) hits += 1;
  return hits >= 2 ? 2 : hits === 1 ? 1 : 0;
}
const MANUAL_REVIEW = new Set(['q98']); // technology proverb (manual)

function scoreAnswer(scoringKey, text) {
  const val = (text || '').trim();
  if (!scoringKey || !SCORING_REFERENCE[scoringKey]) return { points: 0, note: 'no-key' };
  const ref = SCORING_REFERENCE[scoringKey];
  const t = val.toLowerCase();
// Multi-category items: score based on distinct hazards/themes mentioned
if (scoringKey === 'q89') {
  // 2 dangers on the journey
  const points = scoreTwoDistinct(val, [
    [/(cold|freez|blizzard|storm|inclement)/i],
    [/(bear|wolf|wildlife|animal\s+attack)/i],
    [/(starv|hunger|lack of food)/i],
    [/(river|rapid|ice|avalanche|landslide)/i],
    [/(sick(ness)?|illness|injur|exhaust|fatigue)/i]
  ]);
  return { points, note: 'multi-cat' };
}
if (scoringKey === 'q119') {
  // 3 consequences if prices not raised
  let hits = 0;
  if (/(fewer|no)\s+(acquisitions|new\s+animals|new\s+exhibits)/i.test(val)) hits++;
  if (/(reduce(d)?|cut)\s+(hours|services|staff|care|maintenance)/i.test(val)) hits++;
  if (/(close|closure)/i.test(val)) hits++;
  if (/(lack\s+of\s+funds|budget\s+shortfall)/i.test(val)) hits++;
  return { points: hits >= 3 ? 2 : hits >= 1 ? 1 : 0, note: 'multi-count' };
}

  // semantic blocks
  if (ref.semantic) {
    // full means all words from at least one list are present
    for (const set of (ref.semantic.full || [])) {
      const hit = set.every(word => t.includes(word.toLowerCase()));
      if (hit) return { points: 2, note: 'semantic-full' };
    }
    for (const word of (ref.semantic.partial || [])) {
      if (t.includes(word.toLowerCase())) return { points: 1, note: 'semantic-partial' };
    }
    return { points: 0, note: 'semantic-none' };
  }

  // regex patterns
  if (ref.twoPoint && ref.twoPoint.patterns && ref.twoPoint.patterns.some(rx => rx.test(val))) {
    return { points: 2, note: 'pattern-2' };
  }
  if (ref.onePoint && ref.onePoint.patterns && ref.onePoint.patterns.some(rx => rx.test(val))) {
    return { points: 1, note: 'pattern-1' };
  }
  return { points: 0, note: 'no-match' };
}

/* ===========================
   Trial flow
   =========================== */
function currentTrial() { return TRIALS[state.currentIndex]; }

function resetReadingUI() {
  document.getElementById('timer-container').classList.add('hidden');
  document.getElementById('timer').textContent = '00:00';
  document.getElementById('read-aloud-instructions').classList.add('hidden');
  document.getElementById('recording-controls').classList.add('hidden');
  document.getElementById('reading-controls').classList.add('hidden');
  document.getElementById('qa-form').classList.add('hidden');
}

function renderTrial(trial) {
  resetReadingUI();
  document.getElementById('actual-item-number').textContent = trial.item;
  renderPassage(trial.passageId);

  // Instruction text
  document.getElementById('instruction-text').textContent = trial.instruction || '';
// 🔹 TRIAL-BY-TRIAL: item_started
gsPost('item_started', {
  pid: state.pid,
  itemNumber: trial.item,
  imageFile: '', // text-only now
  questionText: (trial.questions && trial.questions[0]) ? trial.questions[0].text : '',
  itemType: trial.type || (trial.readAloud ? 'read-aloud' : 'question'),
  timestamp: new Date().toISOString()
});

  // Read aloud item
  if (trial.type === 'read-aloud' || trial.readAloud) {
    const info = getReadAloudInstructions();
    document.getElementById('read-aloud-title').textContent = info.title;
    document.getElementById('read-aloud-text').textContent = info.text;
   document.getElementById('read-aloud-instructions').classList.remove('hidden');
document.getElementById('recording-controls').classList.remove('hidden');
document.getElementById('start-recording').textContent = info.buttonText;

// reset controls for this trial
const startBtn = document.getElementById('start-recording');
const stopBtn = document.getElementById('stop-recording');
const timerEl = document.getElementById('recording-timer');
startBtn.classList.remove('hidden');
stopBtn.classList.add('hidden');
timerEl.classList.add('hidden');
document.getElementById('rec-indicator').classList.add('hidden');
      // NEW: make Skip visible and reset alert panel
const skipBtn =
  document.getElementById('skip-recording-now') || // item screen (if you add one later)
  document.getElementById('skip-recording');       // setup screen fallback
if (skipBtn) skipBtn.classList.remove('hidden');
if (unavailableBox) unavailableBox.classList.add('hidden');


return;
  }

  // Passage that requires timed reading first
  if (trial.type === 'passage' && !trial.skipReading) {
    document.getElementById('reading-controls').classList.remove('hidden');
    if (!document.getElementById('pref-hide-timer').checked) {
      document.getElementById('timer-container').classList.remove('hidden');
    }
    return;
  }

  // Plain question (no reading step)
  if (trial.type === 'question') {
    renderQAFields(trial);
    document.getElementById('qa-form').classList.remove('hidden');
  }
}

function goNextOrFinish() {
  state.currentIndex += 1;
  if (state.currentIndex >= state.sequence.length) {
    finishAssessment();
    return;
  }
  renderTrial(currentTrial());
}

function handleReadingStart() {
  document.getElementById('start-reading').classList.add('hidden');
  document.getElementById('done-reading').classList.remove('hidden');
  if (!document.getElementById('pref-hide-timer').checked) {
    document.getElementById('timer-container').classList.remove('hidden');
  }
  let sec = 0;
  Timers.start('reading', t => {
    sec = t;
    document.getElementById('timer').textContent = formatMMSS(t);
  });
  state.readingStartTime = Date.now();
}

function handleReadingDone() {
  Timers.stop('reading');
  document.getElementById('reading-controls').classList.add('hidden');

  const trial = currentTrial();
  const dur = Math.round((Date.now() - (state.readingStartTime || Date.now())) / 1000);
  const text = document.querySelector('#passage-container .q-block')?.innerText?.trim() || '';
  const wc = text ? text.split(/\s+/).filter(Boolean).length : 0;

  gsPost('reading_time', {
    pid: state.pid,
    itemNumber: trial.item,
    imageFile: '',
    readingType: 'silent',
    startTime: new Date(state.readingStartTime || Date.now()).toISOString(),
    endTime: new Date().toISOString(),
    duration: dur,
    wordCount: wc
  });

  if (trial.questions && trial.questions.length) {
    renderQAFields(trial);
    document.getElementById('qa-form').classList.remove('hidden');
  } else {
    goNextOrFinish();
  }
}


async function handleStartRecording() {
  // If we don't have a stream yet, try to get one (don’t block progress forever)
  if (!state.stream) {
    const ok = state.useVideoRecording ? await setupVideo() : await setupAudio();
    if (!ok) {
      // Show inline alert + focus Skip instead of silently failing
      announceToScreenReader('Recording not available. You can allow access or skip recording.', 'assertive');
      const unavailableBox = document.getElementById('recording-unavailable');
      const skipBtn =
  document.getElementById('skip-recording-now') ||
  document.getElementById('skip-recording');
if (skipBtn) skipBtn.classList.remove('hidden');

      return;
    }
  }

  // Toggle UI
  const startBtn = document.getElementById('start-recording');
  const stopBtn  = document.getElementById('stop-recording');
  const timerEl  = document.getElementById('recording-timer');

  startBtn.classList.add('hidden');
  stopBtn.classList.remove('hidden');
  timerEl.classList.remove('hidden');
  timerEl.textContent = '00:00';

  document.getElementById('rec-indicator').classList.remove('hidden');
  document.getElementById('rec-type').textContent = state.useVideoRecording ? 'Recording video' : 'Recording audio';

  let sec = 0;
  Timers.start('recording', t => {
    sec = t;
    timerEl.textContent = formatMMSS(t);
  });

  startMediaRecorder(() => {
    const trial = currentTrial();
    state.results.push({
      item: trial.item,
      type: 'read-aloud',
      passageId: trial.passageId,
      durationSec: sec,
      mediaPresent: true
    });
    saveLocal();
  });
}



function handleStopRecording() {
  document.getElementById('stop-recording').classList.add('hidden');
  document.getElementById('recording-timer').classList.add('hidden');
  Timers.stop('recording');
    document.getElementById('rec-indicator').classList.add('hidden');

  if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
    state.mediaRecorder.stop();
  }

  // 🔹 TRIAL-BY-TRIAL: item_completed (read-aloud)
  const trial = currentTrial();
  const durText = (document.getElementById('recording-timer').textContent || '00:00').trim();
  const durSec = durText.split(':').reduce((m, s) => m * 60 + (+s || 0), 0);

    gsPost('item_completed', {
  pid: state.pid,
  itemNumber: trial.item,
  endTime: new Date().toISOString(),
  duration: durSec,
  response: '[read-aloud]',
  explanation: '',
  autoScore: '',
  scoreConfidence: '',
  needsReview: false,
  scoringNotes: 'read-aloud',
  finalScore: '',
  itemType: 'read-aloud'
});


  // Discontinue rule
  if (DISCONTINUE_AFTER_ZEROS > 0 && state.consecutiveZeros >= DISCONTINUE_AFTER_ZEROS) {
    announceToScreenReader('Assessment will end early due to repeated zero scores.', 'assertive');
    finishAssessment('Stopped early due to scoring rule.');
    return;
  }

  goNextOrFinish();
}
function handleSkipRecording() {
  // Ensure any recording is stopped
  try { if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') state.mediaRecorder.stop(); } catch {}
  Timers.stop('recording');
  document.getElementById('rec-indicator').classList.add('hidden');

  const trial = currentTrial();
  state.results.push({
    item: trial.item,
    type: 'read-aloud',
    passageId: trial.passageId,
    durationSec: 0,
    mediaPresent: false,
    skipped: true
  });

  gsPost('item_completed', {
    pid: state.pid,
    itemNumber: trial.item,
    endTime: new Date().toISOString(),
    duration: 0,
    response: '[read-aloud: skipped/no media]',
    explanation: '',
    autoScore: '',
    scoreConfidence: '',
    needsReview: false,
    scoringNotes: 'read-aloud skipped by user',
    finalScore: '',
    itemType: 'read-aloud'
  });

  goNextOrFinish();
}

    
        function handleQASkip() {
  const trial = currentTrial();

  state.consecutiveZeros += 1;
  state.results.push({
    item: trial.item,
    type: 'qa',
    passageId: trial.passageId,
    answers: [],
    points: 0,
    skipped: true
  });

  gsPost('item_skipped', {
    pid: state.pid,
    itemNumber: trial.item,
    timestamp: new Date().toISOString(),
    itemType: 'question',
    reason: 'User choice',
    consecutiveZeros: state.consecutiveZeros
  });

  if (DISCONTINUE_AFTER_ZEROS > 0 && state.consecutiveZeros >= DISCONTINUE_AFTER_ZEROS) {
    finishAssessment('Stopped early due to scoring rule.');
    return;
  }
  goNextOrFinish();
}

/* ===========================
   Upload and backup
   =========================== */
// Replace your existing postWithTimeout function
function postWithTimeout(url, data, timeoutMs) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs || 3500);
  return fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(data),
    signal: ctrl.signal,
    mode: 'no-cors' // Key addition
  }).then(() => {
    setConnectionStatus(true); // Mark as connected
    return { ok: true }; // Fake response since we can't read it
  }).catch(error => {
    if (error.name !== 'AbortError') {
      setConnectionStatus(false);
    }
    throw error;
  }).finally(() => clearTimeout(t));
}

function gsPost(action, payload) {
  return postWithTimeout(GOOGLE_SCRIPT_URL, { action, ...payload }, GOOGLE_TIMEOUT_MS)
    .then(() => {
      setConnectionStatus(true);
      return true;
    })
    .catch(() => {
      // Don't update to false to avoid flickering
      return false;
    });
}


async function testConnection() {
  try {
    await postWithTimeout(GOOGLE_SCRIPT_URL, {
      action: 'test_connection',
      timestamp: new Date().toISOString()
    }, 2000);
    setConnectionStatus(true);
    return true;
  } catch (error) {
    setConnectionStatus(false);
    return false;
  }
}


async function uploadAll() {
  const payload = {
    action: 'study_completed',
    sessionId: SESSION_ID,
    pid: state.pid,
    edu: state.edu,
    group: state.participantGroup,
    modality: state.readModality,
    startedAt: state.sessionStartTime,
    finishedAt: Date.now(),
    totals: {
      points: state.totalPoints,
      items: state.results.length
    },
    results: state.results
  };

  let googleOk = false;
try {
  await postWithTimeout(GOOGLE_SCRIPT_URL, payload, GOOGLE_TIMEOUT_MS);
  // With no-cors, no error = success
  googleOk = true;
} catch {
  googleOk = false;
}

  // Always try backup as a second leg if Google didn't clearly OK
  let backupOk = false;
  if (!googleOk) {
    try {
      const b = await postWithTimeout(GITHUB_BACKUP_URL, {
        owner: BACKUP_REPO_OWNER,
        repo: BACKUP_REPO_NAME,
        dirHint: BACKUP_DIR_HINT,
        fileHint: `session_${SESSION_ID}.json`,
        payload
      }, BACKUP_TIMEOUT_MS);
      backupOk = !!(b && b.ok);
    } catch {}
  }

  if (googleOk || backupOk) {
    setConnectionStatus(true);
    document.getElementById('upload-progress').textContent =
      googleOk && backupOk ? 'Saved to Google and backup.' :
      googleOk ? 'Saved to Google successfully.' :
      'Saved to backup endpoint successfully.';
    return true;
  }

  setConnectionStatus(false);
  const looksConfigured = /^https:\/\/script\.google\.com\/macros\/s\//.test(GOOGLE_SCRIPT_URL);
  if (!looksConfigured) document.getElementById('config-warning').classList.remove('hidden');

  document.getElementById('upload-progress').textContent =
    'Upload failed. You can retry or download a local backup file.';
  document.getElementById('retry-upload').classList.remove('hidden');
  document.getElementById('download-backup').classList.remove('hidden');
  return false;
}


function downloadLocalBackup() {
  const data = {
    sessionId: SESSION_ID,
    pid: state.pid,
    edu: state.edu,
    group: state.participantGroup,
    modality: state.readModality,
    startedAt: state.sessionStartTime,
    finishedAt: Date.now(),
    totals: { points: state.totalPoints, items: state.results.length },
    results: state.results
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `readingcomp_${SESSION_ID}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function setConnectionStatus(connected) {
  state.connectionStatus = connected;
  const box = document.getElementById('connection-status');
  const text = document.getElementById('connection-text');
  box.classList.remove('connected', 'error');
  if (connected) {
    box.classList.add('connected');
    text.textContent = 'Connected';
  } else {
    box.classList.add('error');
    text.textContent = 'Offline';
  }
}

/* ===========================
   Finish
   =========================== */
async function finishAssessment(reason = '') {
    stopMedia();
Timers.stopAll();

  showScreen('screen-finish');
  const msg = document.getElementById('finish-msg');
  msg.textContent = reason ? `Thank you. ${reason}` : 'Thank you for participating.';

  // Minimal session stats
  const stats = document.getElementById('final-stats');
  const content = document.getElementById('stats-content');
  content.innerHTML = `
    <div>Total items: <strong>${state.results.length}</strong></div>
    <div>Total points: <strong>${state.totalPoints}</strong></div>
    <div>Session: <strong>${SESSION_ID}</strong></div>
  `;
  stats.classList.remove('hidden');

  // Attempt upload
  document.getElementById('upload-progress').textContent = 'Saving your data...';
  await uploadAll();
    // 🔹 TRIAL-BY-TRIAL: session_complete
gsPost('session_complete', {
  pid: state.pid,
  timestamp: new Date().toISOString(),
  duration: Math.round((Date.now() - (state.sessionStartTime || Date.now())) / 60000),
  itemsCompleted: state.results.length,
  totalScore: state.totalPoints,
  consecutiveZeros: state.consecutiveZeros,
  discontinued: !!reason && /stopp?ed/i.test(reason),
  gateItemsFailed: (state.gateItemsFailed || []).join(', ')
});
    }

/* ===========================
   Setup screen logic
   =========================== */
function determineReadModalityFromUI() {
  const chosen = document.querySelector('input[name="read-modality"]:checked');
  state.readModality = chosen ? chosen.value : 'speak';
  return state.readModality;
}

async function enterSetup() {
  showScreen('screen-setup');
  document.getElementById('setup-status-text').textContent = 'Initializing...';

  determineReadModalityFromUI();
  const mode = determineRecordingNeeds();

  // Show which method we're setting up
  const methodEl = document.getElementById('recording-method-text');
  if (methodEl) {
    methodEl.textContent = mode === 'video'
      ? 'Setting up camera (video recording)…'
      : 'Setting up microphone (audio recording)…';
  }

  // Try to get media, but do NOT block progress if it fails
  const vs = document.getElementById('video-setup');
  const as = document.getElementById('audio-setup');
  let ok = false;

  if (mode === 'video') {
    vs.classList.remove('hidden');
    as.classList.add('hidden');
    ok = await setupVideo();
  } else {
    vs.classList.add('hidden');
    as.classList.remove('hidden');
    ok = await setupAudio();
  }

  document.getElementById('setup-status-text').textContent =
    ok
      ? 'Ready. You can start the assessment.'
      : 'Recording setup failed. You can still continue; read-aloud recordings will be unavailable until you allow access.';

  // ALWAYS allow proceeding, even if setup failed
  document.getElementById('start-study').disabled = false;
}


function handleQASubmit(e) {
  e.preventDefault();
  const trial = currentTrial();

  let answers = [];
  let trialPoints = 0;

  // Collect answers and score
  document.querySelectorAll('#qa-fields textarea').forEach(tx => {
    const key = tx.dataset.scoringKey || '';
    const val = tx.value || '';
    const scored = scoreAnswer(key, val);
    answers.push({ key, answer: val, points: scored.points, note: scored.note });
    trialPoints += Number(scored.points || 0);
  });

  // NOW that answers exist, decide if all are manual-review items
  const allManual = answers.length > 0 && answers.every(a => MANUAL_REVIEW.has(a.key));

  // update zero streak and totals (manual-review items shouldn't penalize)
  if (!allManual) {
    if (trialPoints === 0) state.consecutiveZeros += 1;
    else state.consecutiveZeros = 0;
  }
  state.totalPoints += trialPoints;

  // save result
  state.results.push({
    item: trial.item,
    type: 'qa',
    passageId: trial.passageId,
    answers,
    points: trialPoints
  });

  // telemetry
  const qText = (trial.questions || []).map(q => q.text).join(' | ');
  const responseJoined = answers.map(a => a.answer).join(' | ');
  const notesJoined = answers.map(a => a.note || '').join(', ');
  const conf = trialPoints >= 2 ? 'High' : (trialPoints > 0 ? 'Medium' : 'Low');

  gsPost('item_completed', {
    pid: state.pid,
    itemNumber: trial.item,
    endTime: new Date().toISOString(),
    duration: '',
    response: responseJoined,
    explanation: '',
    autoScore: trialPoints,
    scoreConfidence: conf,
    needsReview: allManual || /review/i.test(notesJoined),
    scoringNotes: notesJoined,
    finalScore: trialPoints,
    consecutiveZeros: state.consecutiveZeros,
    questionText: qText,
    itemType: 'question'
  });

  // discontinue rule
  if (DISCONTINUE_AFTER_ZEROS > 0 && state.consecutiveZeros >= DISCONTINUE_AFTER_ZEROS) {
    announceToScreenReader('Assessment will end early due to repeated zero scores.', 'assertive');
    finishAssessment('Stopped early due to scoring rule.');
    return;
  }

  goNextOrFinish();
}


/* ===========================
   Wire up DOM events
   =========================== */
document.addEventListener('DOMContentLoaded', () => {
      testConnection();
  
  // Periodically check connection (optional)
  setInterval(testConnection, 30000); // Every 30 seconds
  // ——— Welcome form events ———
    document.getElementById('skip-recording-now')?.addEventListener('click', handleSkipRecording);

  document.getElementById('pid').addEventListener('input', checkWelcomeReady);
  document.getElementById('edu').addEventListener('change', checkWelcomeReady);
  document.getElementById('consent').addEventListener('change', checkWelcomeReady);
  document.querySelectorAll('input[name="participant-group"]').forEach(el => {
    el.addEventListener('change', checkWelcomeReady);
  });
  document.querySelectorAll('input[name="read-modality"]').forEach(el => {
    el.addEventListener('change', () => {
      determineReadModalityFromUI();
      checkWelcomeReady();
    });
  });

  // ——— Begin -> Setup ———
  document.getElementById('begin').addEventListener('click', () => {
    state.sessionStartTime = Date.now();
    enterSetup();
  });

  // ——— Test audio on setup ———
  const testBtn = document.getElementById('test-audio-record');
  const stopTestBtn = document.getElementById('stop-test-audio');
  const testTimer = document.getElementById('test-audio-timer');
  const testPlayback = document.getElementById('test-audio-playback');

  if (testBtn) {
    testBtn.addEventListener('click', async () => {
      // Ensure audio stream
      if (!state.stream) await setupAudio();

      testBtn.classList.add('hidden');
      stopTestBtn.classList.remove('hidden');
      testTimer.classList.remove('hidden');
      testTimer.textContent = '00:00';

      let sec = 0;
      Timers.start('test', t => { sec = t; testTimer.textContent = formatMMSS(t); });

      startMediaRecorder(blob => {
        Timers.stop('test');
        stopTestBtn.classList.add('hidden');
        testBtn.classList.remove('hidden');
        testPlayback.src = URL.createObjectURL(blob);
        testPlayback.classList.remove('hidden');
        document.getElementById('audio-status').textContent = 'Test recording complete. Play it back to confirm.';
      });
    });
  }

  if (stopTestBtn) {
    stopTestBtn.addEventListener('click', () => {
      stopTestBtn.classList.add('hidden');
      testBtn.classList.remove('hidden');
      Timers.stop('test');
      if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') state.mediaRecorder.stop();
    });
  }

  // ——— Start study ———
  document.getElementById('start-study').addEventListener('click', () => {
    state.sequence = TRIALS.slice();
    state.currentIndex = 0;
    state.totalPoints = 0;
    state.consecutiveZeros = 0;

    gsPost('session_start', {
      pid: state.pid,
      education: state.edu,
      timestamp: new Date().toISOString(),
      adminMode: !!state.adminMode,
      hasRecording: !!(state.useVideoRecording || state.useAudioRecording),
      userAgent: navigator.userAgent
    });

    showScreen('screen-item');
    renderTrial(currentTrial());
  });

  // ——— Reading controls ———
  document.getElementById('start-reading').addEventListener('click', handleReadingStart);
  document.getElementById('done-reading').addEventListener('click', handleReadingDone);

  // ——— Recording controls (item screen) ———
  document.getElementById('start-recording').addEventListener('click', handleStartRecording);
  document.getElementById('stop-recording').addEventListener('click', handleStopRecording);
  document.getElementById('skip-recording').addEventListener('click', handleSkipRecording);

  // ——— QA form ———
  document.getElementById('qa-form').addEventListener('submit', handleQASubmit);
  document.getElementById('skip').addEventListener('click', handleQASkip);

  // ——— Finish actions ———
  document.getElementById('retry-upload').addEventListener('click', uploadAll);
  document.getElementById('download-backup').addEventListener('click', downloadLocalBackup);

  // ——— Preferences ———
  const selfview = document.getElementById('toggle-selfview');
  if (selfview) {
    selfview.addEventListener('change', (e) => {
      const v = document.getElementById('preview');
      if (v) v.style.visibility = e.target.checked ? 'hidden' : 'visible';
    });
  }

  // ——— Initial ———
  // Restore any prior snapshot first
loadLocal();

// Core listeners
document.getElementById('start-recording')?.addEventListener('click', handleStartRecording);
document.getElementById('stop-recording')?.addEventListener('click', handleStopRecording);
document.getElementById('skip-recording')?.addEventListener('click', handleSkipRecording);

document.getElementById('start-reading')?.addEventListener('click', () => { handleReadingStart(); saveLocal(); });
document.getElementById('done-reading')?.addEventListener('click', () => { handleReadingDone(); saveLocal(); });

document.getElementById('qa-form')?.addEventListener('submit', (e) => { handleQASubmit(e); saveLocal(); });
document.getElementById('skip')?.addEventListener('click', () => { handleQASkip(); saveLocal(); });

// Defensive snapshot on navigation
window.addEventListener('beforeunload', saveLocal);

    /* ===========================
   Large Print Mode toggle
   =========================== */
(function () {
  const STORAGE_KEY = 'largePrintOn';

  function setLargePrint(on) {
    document.body.classList.toggle('large-print', !!on);
    const btn = document.getElementById('toggle-large-print');
    if (btn) {
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      btn.textContent = on ? 'Large Print: On' : 'Large Print: Off';
    }
    try { localStorage.setItem(STORAGE_KEY, on ? '1' : '0'); } catch {}
  }

  function getInitial() {
    try { return localStorage.getItem(STORAGE_KEY) === '1'; }
    catch { return false; }
  }

  // Initialize once DOM is ready enough for the button to exist
  function initLP() {
    setLargePrint(getInitial());
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'toggle-large-print') {
        setLargePrint(!document.body.classList.contains('large-print'));
      }
    });
    // Keyboard shortcut: Alt+L (or Option+L on macOS)
    document.addEventListener('keydown', (e) => {
      const key = (e.key || '').toLowerCase();
      if ((e.altKey || e.metaKey) && key === 'l') {
        e.preventDefault();
        setLargePrint(!document.body.classList.contains('large-print'));
      }
    });
  }

  // Run asap
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLP);
  } else {
    initLP();
  }
})();

</script>
</body>
</html>
