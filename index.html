<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reading Comprehension Study</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#f8f9fa; color:#212529; }
  .wrap { max-width: 900px; margin: 0 auto; padding: 20px; }
  .card { background:#fff; border:1px solid #dee2e6; border-radius:4px; padding:20px; margin:12px 0; }
  h1 { font-size:1.5rem; margin:0 0 12px; font-weight:400; }
  h2 { font-size:1.25rem; margin:0 0 12px; font-weight:400; }
  .row { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
  .row > * { flex:1 1 auto; min-width:200px; }
  label { display:block; margin:8px 0 4px; font-size:14px; }
  input[type="text"], textarea, select { width:100%; border:1px solid #ced4da; border-radius:3px; padding:6px 8px; font-size:14px; }
  textarea { min-height:70px; resize:vertical; font-family:inherit; }
  button { padding:8px 16px; border-radius:3px; border:1px solid #6c757d; background:#6c757d; color:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#5a6268; }
  button.primary { background:#0d6efd; border-color:#0d6efd; }
  button.primary:hover { background:#0b5ed7; }
  button:disabled { opacity:0.6; cursor:not-allowed; }
  .hidden { display:none !important; }
  .muted { color:#6c757d; font-size:13px; margin:8px 0; }
  .center { text-align:center; }
  img.stim { max-width:100%; height:auto; border:1px solid #dee2e6; display:block; margin: 12px auto; }
  .q-block { margin: 12px 0; padding:8px; background:#f8f9fa; border-left:3px solid #dee2e6; }
  .explain-field { margin-top:8px; padding:8px; background:#fff3cd; border-left:3px solid #ffc107; }
  
  /* Recording indicator */
  .recording-indicator { 
    position:fixed; top:20px; right:20px; padding:8px 12px; 
    background:#dc3545; color:#fff; border-radius:4px; 
    display:flex; align-items:center; gap:8px; font-size:13px;
    box-shadow:0 2px 4px rgba(0,0,0,0.2);
  }
  .recording-dot { 
    width:8px; height:8px; background:#fff; border-radius:50%; 
    animation: pulse 1.5s infinite; 
  }
  @keyframes pulse {
    0%, 100% { opacity:1; }
    50% { opacity:0.3; }
  }
  
  /* Timer display */
  .timer-display {
    font-family: monospace;
    font-size: 18px;
    color: #495057;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 3px;
    display: inline-block;
  }
  
  /* Progress bar */
  .progress-bar {
    height: 3px;
    background: #e9ecef;
    margin: 20px 0;
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: #0d6efd;
    transition: width 0.3s ease;
  }
  
  /* Item display */
  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
  }
  .item-info { font-size: 13px; color: #6c757d; }
</style>
</head>
<body>
<div class="wrap">

  <div id="screen-welcome" class="card">
    <h1>Reading Comprehension Study</h1>
    <p class="muted">Please enter your information to begin.</p>
    <div class="row">
      <div>
        <label for="pid">Participant Code</label>
        <input id="pid" type="text" placeholder="Enter code" />
      </div>
      <div>
        <label for="edu">Education Level</label>
        <select id="edu">
          <option value="">Select...</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
          <option value="13+">College or higher</option>
        </select>
      </div>
    </div>
    <div style="margin-top:20px;">
      <button id="begin" class="primary">Begin</button>
    </div>
  </div>

  <div id="screen-setup" class="card hidden">
    <h2>Setup Recording</h2>
    <p class="muted">This study will record video and audio for research purposes. Please ensure your camera and microphone are working.</p>
    <div id="preview-container" style="margin:20px 0;">
      <video id="preview" style="width:320px; height:240px; background:#000; border:1px solid #dee2e6;" autoplay muted></video>
    </div>
    <p id="setup-status" class="muted">Requesting camera and microphone access...</p>
    <div style="margin-top:20px;">
      <button id="start-study" class="primary" disabled>Start Study</button>
      <button id="test-audio">Test Audio</button>
    </div>
  </div>

  <div id="screen-item" class="card hidden">
    <div class="recording-indicator hidden" id="rec-indicator">
      <span class="recording-dot"></span>
      <span>Recording</span>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width:0%"></div>
    </div>
    
    <div class="item-header">
      <div class="item-info">
        <span id="item-number"></span>
      </div>
      <div id="timer-container" class="hidden">
        <span class="timer-display" id="timer">00:00</span>
      </div>
    </div>
    
    <div id="stim-container" class="center">
      <img id="stim" class="stim" alt="Reading material" />
    </div>
    
    <div id="instructions" class="muted center" style="margin:16px 0;">
      <span id="instruction-text"></span>
    </div>
    
    <div id="reading-controls" class="center" style="margin:16px 0;">
      <button id="start-reading" class="primary hidden">Start Reading</button>
      <button id="done-reading" class="hidden">Done Reading</button>
    </div>
    
    <form id="qa-form" class="hidden">
      <div id="qa-fields"></div>
      <div style="margin-top:16px;">
        <button type="submit" class="primary">Submit</button>
        <button type="button" id="skip">Skip</button>
      </div>
    </form>
  </div>

  <div id="screen-finish" class="card hidden">
    <h2>Study Complete</h2>
    <p id="finish-msg" class="muted">Thank you for participating.</p>
    <div style="margin-top:20px;">
      <button id="download" class="primary">Download Data</button>
      <button id="stop-recording">Stop Recording</button>
    </div>
  </div>

</div>

<script>
/* ===========================
   Trial Configuration
   =========================== */
const TRIALS = [
  // 1.jpeg - Items 75-80
  {
    item: 75,
    image: "1.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q75",
        text: "Who is Kwawar?",
        scoring: {
          twoPoint: ["the great spirit", "a great spirit of the native americans", "a god", "great spirit"],
          onePoint: []
        }
      }
    ]
  },
  {
    item: 76,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q76",
        text: "In all, how many Turtle Brothers were needed to fulfill Kwawar's request?",
        scoring: {
          twoPoint: ["7", "seven"],
          onePoint: []
        }
      }
    ]
  },
  {
    item: 77,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q77",
        text: "What caused the mountains to arise?",
        scoring: {
          twoPoint: ["soil on the turtle", "soil on turtle backs", "soil on the turtles"],
          onePoint: ["the earth", "the brushes", "the bushes"],
          queries: ["the earth"]
        }
      }
    ]
  },
  {
    item: 78,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q78",
        text: "What natural event does the Turtle Brothers' quarreling explain?",
        scoring: {
          twoPoint: ["earthquake", "an earthquake"],
          onePoint: ["land quakes", "ground quivers"]
        }
      }
    ]
  },
  {
    item: 79,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q79",
        text: "What great gift did Kwawr give the Turtle Brothers?",
        scoring: {
          twoPoint: ["gift of having california on their backs", "california was made from them", "california on their backs"],
          onePoint: ["made them part of land"],
          queries: ["made them part of land"]
        }
      }
    ]
  },
  {
    item: 80,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q80",
        text: "What is the meaning of contemplated in the story?",
        scoring: {
          twoPoint: ["to think about", "form a new plan", "pondering the idea", "pondering", "ponder"],
          onePoint: ["had to think hard", "to think"]
        }
      }
    ]
  },
  // 2.jpeg - Items 82-83
  {
    item: 82,
    image: "2.jpeg",
    type: "passage",
    instruction: "Read this aloud.",
    readAloud: true,
    questions: [
      {
        id: "q82",
        text: "Tell me in your own words, what has happened as a result of the avalanche?",
        scoring: {
          twoPoint: ["road was covered with debris so traffic stopped", "traffic stopped", "road blocked with debris"],
          onePoint: ["result is the snow covered the road", "avalanche covered the road", "snow covered road"]
        }
      }
    ]
  },
  {
    item: 83,
    image: "2.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q83",
        text: "What does the word debris mean in this sentence?",
        scoring: {
          twoPoint: ["tree branches", "dirt", "rocks", "mud", "dirt and junk", "branches"],
          onePoint: ["snow", "rubbish"]
        }
      }
    ]
  },
  // 3.jpeg - Items 84-85
  {
    item: 84,
    image: "3.jpeg",
    type: "read-aloud-only",
    instruction: "Read this aloud.",
    readAloud: true,
    skipScoring: true
  },
  {
    item: 85,
    image: "3.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q85",
        text: "What does the word fancy mean in this sentence?",
        scoring: {
          twoPoint: ["they like the food better", "prefer", "like"],
          onePoint: ["adore", "enjoy"]
        }
      }
    ]
  },
  // 4.jpeg - Items 86-88
  {
    item: 86,
    image: "4.jpeg",
    type: "read-aloud-only",
    instruction: "Read this aloud.",
    readAloud: true,
    skipScoring: true
  },
  {
    item: 87,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q87",
        text: "Why did the track meet end earlier than expected?",
        scoring: {
          twoPoint: ["bad weather", "cancellation of long distance events"],
          onePoint: ["bad weather", "cancellation of long distance events"],
          requireBoth: true
        }
      }
    ]
  },
  {
    item: 88,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q88",
        text: "What does the word inclement mean in this sentence?",
        scoring: {
          twoPoint: ["big, bad storm", "bad weather", "unpleasant weather", "big storm", "severe weather"],
          onePoint: []
        }
      }
    ]
  },
  // 5.jpeg - Yukon Gold Items 89-93
  {
    item: 89,
    image: "5.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q89",
        text: "What were two dangers encountered by the family on their journey?",
        scoring: {
          countRequired: true,
          twoPoint: 2,
          onePoint: 1,
          validItems: ["cold", "freezing", "wild animals", "river", "rapids", "lack of food", "starvation", "storms", "snow", "animals", "food shortage"]
        }
      }
    ]
  },
  {
    item: 90,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q90",
        text: "According to Diana, why doesn't Charlie want to go to Yukon?",
        scoring: {
          twoPoint: ["doesn't want to chase his father's dreams", "his goals and desires differ", "goals differ from his father", "not chasing father's dreams"],
          onePoint: ["because it wasn't his idea", "wasn't his idea"]
        }
      }
    ]
  },
  {
    item: 91,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q91",
        text: "According to the reviewers, what are two main themes or ideas in Yukon Gold?",
        scoring: {
          twoPoint: ["wilderness adventure", "family conflict"],
          onePoint: ["wilderness adventure", "family conflict"],
          requireBoth: true
        }
      }
    ]
  },
  {
    item: 92,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q92",
        text: "Diana gave Yukon Gold four stars although Gary gave it two. What did Gary dislike about the movie?",
        scoring: {
          twoPoint: ["didn't like that it was so predictable", "hackneyed", "story was too predictable", "boring ending", "predictable"],
          onePoint: ["the ending", "ending"]
        }
      }
    ]
  },
  {
    item: 93,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q93",
        text: "What is the meaning of the word hackneyed in Gary's review?",
        scoring: {
          twoPoint: ["banal", "trite", "overused", "same story ending as in other movies", "cliche"],
          onePoint: ["too predictable", "predictable"]
        }
      }
    ]
  },
  // Continue with remaining items following same pattern...
  // Items 94-140 would continue here with same structure
];

/* ===========================
   State Management
   =========================== */
let state = {
  pid: '',
  edu: '',
  currentIndex: 0,
  totalPoints: 0,
  consecutiveZeros: 0,
  results: [],
  sequence: [],
  timerInterval: null,
  readingStartTime: null,
  itemStartTime: null,
  mediaRecorder: null,
  recordedChunks: [],
  stream: null
};

/* ===========================
   Recording Functions
   =========================== */
async function setupRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }, 
      audio: true 
    });
    
    state.stream = stream;
    const preview = document.getElementById('preview');
    preview.srcObject = stream;
    
    // Setup MediaRecorder
    const options = {
      mimeType: 'video/webm;codecs=vp8,opus'
    };
    
    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
      options.mimeType = 'video/webm';
    }
    
    state.mediaRecorder = new MediaRecorder(stream, options);
    state.recordedChunks = [];
    
    state.mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        state.recordedChunks.push(event.data);
      }
    };
    
    state.mediaRecorder.onstop = () => {
      const blob = new Blob(state.recordedChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${state.pid}_recording_${Date.now()}.webm`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };
    
    document.getElementById('setup-status').textContent = 'Camera and microphone ready.';
    document.getElementById('start-study').disabled = false;
    
  } catch (err) {
    console.error('Error accessing media devices:', err);
    document.getElementById('setup-status').textContent = 'Error: Could not access camera/microphone. Please check permissions.';
  }
}

function startRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state === 'inactive') {
    state.mediaRecorder.start();
    document.getElementById('rec-indicator').classList.remove('hidden');
  }
}

function stopRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
    state.mediaRecorder.stop();
    document.getElementById('rec-indicator').classList.add('hidden');
  }
  if (state.stream) {
    state.stream.getTracks().forEach(track => track.stop());
  }
}

/* ===========================
   Timer Functions
   =========================== */
function startTimer() {
  state.readingStartTime = Date.now();
  let seconds = 0;
  
  document.getElementById('timer-container').classList.remove('hidden');
  
  state.timerInterval = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    document.getElementById('timer').textContent = 
      `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }, 1000);
}

function stopTimer() {
  if (state.timerInterval) {
    clearInterval(state.timerInterval);
    state.timerInterval = null;
  }
  document.getElementById('timer-container').classList.add('hidden');
  return Date.now() - state.readingStartTime;
}

/* ===========================
   DOM Elements
   =========================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

/* ===========================
   Event Listeners
   =========================== */
document.getElementById('begin').addEventListener('click', async () => {
  state.pid = document.getElementById('pid').value.trim();
  state.edu = document.getElementById('edu').value;
  
  if (!state.pid || !state.edu) {
    alert('Please complete all fields.');
    return;
  }
  
  showScreen('setup');
  await setupRecording();
});

document.getElementById('test-audio').addEventListener('click', () => {
  const audio = new Audio();
  audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE';
  audio.play();
});

document.getElementById('start-study').addEventListener('click', () => {
  startRecording();
  buildSequence();
  state.currentIndex = 0;
  showItem();
});

document.getElementById('start-reading').addEventListener('click', () => {
  startTimer();
  document.getElementById('start-reading').classList.add('hidden');
  document.getElementById('done-reading').classList.remove('hidden');
});

document.getElementById('done-reading').addEventListener('click', () => {
  const readingTime = stopTimer();
  showQuestions(readingTime);
});

document.getElementById('qa-form').addEventListener('submit', submitAnswers);
document.getElementById('skip').addEventListener('click', skipItem);
document.getElementById('download').addEventListener('click', downloadResults);
document.getElementById('stop-recording').addEventListener('click', stopRecording);

/* ===========================
   Core Functions
   =========================== */
function buildSequence() {
  const gradeNum = state.edu === "13+" ? 13 : parseInt(state.edu);
  
  if (gradeNum >= 9) {
    const startIdx = TRIALS.findIndex(t => t.item === 94);
    state.sequence = TRIALS.slice(startIdx);
  } else {
    state.sequence = TRIALS.slice();
  }
}

function showItem() {
  if (state.currentIndex >= state.sequence.length) {
    finishAssessment();
    return;
  }
  
  if (state.consecutiveZeros >= 5) {
    finishAssessment();
    return;
  }
  
  const trial = state.sequence[state.currentIndex];
  
  showScreen('item');
  updateProgress();
  
  // Update item display
  document.getElementById('item-number').textContent = `Item ${state.currentIndex + 1} of ${state.sequence.length}`;
  document.getElementById('stim').src = `stimuli/${trial.image}`;
  
  // Clear previous state
  document.getElementById('qa-form').classList.add('hidden');
  document.getElementById('qa-fields').innerHTML = '';
  document.getElementById('timer').textContent = '00:00';
  
  // Set instruction
  const instruction = trial.instruction || '';
  document.getElementById('instruction-text').textContent = instruction;
  
  // Handle different trial types
  if (trial.skipScoring) {
    // Read-aloud only items
    document.getElementById('start-reading').classList.add('hidden');
    document.getElementById('done-reading').classList.remove('hidden');
    document.getElementById('done-reading').textContent = 'Continue';
  } else if (trial.skipReading) {
    // Question-only items (no reading phase)
    document.getElementById('start-reading').classList.add('hidden');
    document.getElementById('done-reading').classList.add('hidden');
    showQuestions(0);
  } else {
    // Normal reading items
    document.getElementById('start-reading').classList.remove('hidden');
    document.getElementById('done-reading').classList.add('hidden');
    document.getElementById('done-reading').textContent = 'Done Reading';
  }
  
  state.itemStartTime = Date.now();
}

function showQuestions(readingTime) {
  const trial = state.sequence[state.currentIndex];
  
  // Handle read-aloud only items
  if (trial.skipScoring) {
    state.results.push({
      pid: state.pid,
      edu: state.edu,
      item: trial.item,
      image: trial.image,
      type: 'read-aloud',
      response: 'N/A',
      score: 'N/A',
      readingTime: readingTime || 0,
      timestamp: new Date().toISOString()
    });
    state.currentIndex++;
    showItem();
    return;
  }
  
  document.getElementById('qa-form').classList.remove('hidden');
  document.getElementById('start-reading').classList.add('hidden');
  document.getElementById('done-reading').classList.add('hidden');
  
  // Create question fields
  trial.questions.forEach(q => {
    const qDiv = document.createElement('div');
    qDiv.className = 'q-block';
    
    const label = document.createElement('label');
    label.textContent = q.text;
    label.setAttribute('for', q.id);
    
    const textarea = document.createElement('textarea');
    textarea.id = q.id;
    textarea.name = q.id;
    textarea.required = true;
    
    // Add query detection if needed
    if (q.scoring.queries) {
      textarea.addEventListener('input', function() {
        checkForQuery(this.value, q);
      });
    }
    
    qDiv.appendChild(label);
    qDiv.appendChild(textarea);
    document.getElementById('qa-fields').appendChild(qDiv);
  });
}

function checkForQuery(response, question) {
  if (!question.scoring.queries) return;
  
  const lower = response.toLowerCase();
  const needsExplain = question.scoring.queries.some(q => 
    lower.includes(q.toLowerCase())
  );
  
  const explainId = `${question.id}_explain`;
  let explainDiv = document.getElementById(`${explainId}_div`);
  
  if (needsExplain && !explainDiv) {
    const div = document.createElement('div');
    div.id = `${explainId}_div`;
    div.className = 'explain-field';
    
    const label = document.createElement('label');
    label.textContent = 'Please explain:';
    label.setAttribute('for', explainId);
    
    const textarea = document.createElement('textarea');
    textarea.id = explainId;
    textarea.name = explainId;
    
    div.appendChild(label);
    div.appendChild(textarea);
    
    const questionDiv = document.getElementById(question.id).parentElement;
    questionDiv.appendChild(div);
  } else if (!needsExplain && explainDiv) {
    explainDiv.remove();
  }
}

function submitAnswers(e) {
  e.preventDefault();
  
  const trial = state.sequence[state.currentIndex];
  let totalScore = 0;
  const responses = {};
  
  trial.questions.forEach(q => {
    const response = document.getElementById(q.id).value.trim();
    const explain = document.getElementById(`${q.id}_explain`) ? 
      document.getElementById(`${q.id}_explain`).value.trim() : "";
    
    const score = scoreResponse(response, q.scoring);
    totalScore += score;
    
    responses[q.id] = {
      question: q.text,
      response: response,
      explanation: explain,
      score: score
    };
  });
  
  const finalScore = Math.round(totalScore / trial.questions.length);
  
  state.totalPoints += finalScore;
  if (finalScore === 0) {
    state.consecutiveZeros++;
  } else {
    state.consecutiveZeros = 0;
  }
  
  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    responses: responses,
    totalScore: finalScore,
    readingTime: state.readingStartTime ? Date.now() - state.readingStartTime : 0,
    totalTime: Date.now() - state.itemStartTime,
    timestamp: new Date().toISOString()
  });
  
  // Handle gate items
  if (trial.isGateItem && finalScore === 0) {
    handleGateFailure(trial.item);
  } else {
    state.currentIndex++;
    showItem();
  }
}

function scoreResponse(response, scoring) {
  const lower = response.toLowerCase();
  
  if (scoring.countRequired) {
    const validItems = scoring.validItems || [];
    const foundCount = validItems.filter(item => 
      lower.includes(item.toLowerCase())
    ).length;
    
    if (typeof scoring.twoPoint === 'number') {
      if (foundCount >= scoring.twoPoint) return 2;
      if (foundCount >= scoring.onePoint) return 1;
    }
    return 0;
  }
  
  if (scoring.requireBoth) {
    const hasAll = scoring.twoPoint.every(term => 
      lower.includes(term.toLowerCase())
    );
    if (hasAll) return 2;
    
    const hasAny = scoring.onePoint.some(term => 
      lower.includes(term.toLowerCase())
    );
    if (hasAny) return 1;
    return 0;
  }
  
  if (scoring.twoPoint && scoring.twoPoint.some(term => 
    lower.includes(term.toLowerCase())
  )) {
    return 2;
  }
  
  if (scoring.onePoint && scoring.onePoint.some(term => 
    lower.includes(term.toLowerCase())
  )) {
    return 1;
  }
  
  return 0;
}

function handleGateFailure(gateItem) {
  if (gateItem === 94) {
    const remedialItems = TRIALS.filter(t => t.item >= 75 && t.item <= 93);
    const afterRemedial = TRIALS.filter(t => t.item >= 99);
    state.sequence = remedialItems.concat(afterRemedial);
    state.currentIndex = 0;
  } else if (gateItem === 108) {
    const currentPos = state.currentIndex;
    const remedialItems = TRIALS.filter(t => t.item >= 94 && t.item <= 107);
    const afterRemedial = TRIALS.filter(t => t.item >= 113);
    const before = state.sequence.slice(0, currentPos + 1);
    state.sequence = before.concat(remedialItems, afterRemedial);
    state.currentIndex++;
  } else {
    state.currentIndex++;
  }
  showItem();
}

function skipItem() {
  const trial = state.sequence[state.currentIndex];
  
  if (!trial.skipScoring) {
    state.consecutiveZeros++;
  }
  
  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    response: 'SKIPPED',
    score: 0,
    readingTime: 0,
    totalTime: Date.now() - state.itemStartTime,
    timestamp: new Date().toISOString()
  });
  
  state.currentIndex++;
  showItem();
}

function updateProgress() {
  const percent = (state.currentIndex / state.sequence.length) * 100;
  document.getElementById('progress').style.width = `${percent}%`;
}

function finishAssessment() {
  showScreen('finish');
  const msg = state.consecutiveZeros >= 5 ? 
    'Study discontinued due to response pattern.' : 
    'Thank you for participating.';
  document.getElementById('finish-msg').textContent = msg;
}

function downloadResults() {
  const csv = convertToCSV();
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${state.pid}_data_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function convertToCSV() {
  const rows = [
    ['PID', 'Education', 'Item', 'Image', 'Response', 'Explanation', 'Score', 'Reading Time (ms)', 'Total Time (ms)', 'Timestamp']
  ];
  
  state.results.forEach(r => {
    if (r.responses) {
      Object.keys(r.responses).forEach(qId => {
        const q = r.responses[qId];
        rows.push([
          r.pid,
          r.edu,
          r.item,
          r.image,
          q.response.replace(/,/g, ';'),
          (q.explanation || '').replace(/,/g, ';'),
          q.score,
          r.readingTime || '',
          r.totalTime || '',
          r.timestamp
        ]);
      });
    } else {
      rows.push([
        r.pid,
        r.edu,
        r.item,
        r.image,
        r.response || 'N/A',
        '',
        r.score === 'N/A' ? 'N/A' : r.score,
        r.readingTime || '',
        r.totalTime || '',
        r.timestamp
      ]);
    }
  });
  
  return rows.map(row => row.join(',')).join('\n');
}

function showScreen(name) {
  document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
  document.getElementById(`screen-${name}`).classList.remove('hidden');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  showScreen('welcome');
});
</script>
</body>
</html>
