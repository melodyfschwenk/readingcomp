<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIAT-2 Reading Comprehension Study</title>
    <style>
      /* Light mode (default) color scheme */
      :root {
        /* Primary colors */
        --primary-600: #5b21b6;
        --primary-500: #7c3aed;
        --primary-400: #a78bfa;
        --primary-100: #ede9fe;
        
        /* Success colors */
        --success-600: #059669;
        --success-500: #10b981;
        --success-100: #d1fae5;
        
        /* Warning colors */
        --warning-600: #d97706;
        --warning-100: #fef3c7;
        
        /* Danger colors */
        --danger-500: #dc3545;
        --danger-400: #e74c3c;
        
        /* Accent colors */
        --accent-500: #f97316;
        --accent-400: #fb923c;
        
        /* Text colors */
        --text-primary: #1f2937;
        --text-secondary: #4b5563;
        --text-muted: #6b7280;
        --text-on-dark: #ffffff;
        
        /* Background colors */
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-tertiary: #374151;
        --bg-card: #ffffff;
        --bg-gradient-start: #e0e7ff;
        --bg-gradient-mid: #fae8ff;
        --bg-gradient-end: #fef3c7;
        
        /* Border colors */
        --border-primary: #e5e7eb;
        --border-secondary: #d1d5db;
        --border-focus: var(--primary-500);
        
        /* Shadow colors */
        --shadow-sm: rgba(0, 0, 0, 0.05);
        --shadow-md: rgba(0, 0, 0, 0.1);
        --shadow-lg: rgba(0, 0, 0, 0.2);
        --shadow-xl: rgba(0, 0, 0, 0.3);
      }
      
      /* Dark mode color scheme */
      @media (prefers-color-scheme: dark) {
        :root {
          /* Primary colors - adjusted for dark backgrounds */
          --primary-600: #8b5cf6;
          --primary-500: #a78bfa;
          --primary-400: #c4b5fd;
          --primary-100: #2e1065;
          
          /* Success colors - adjusted for dark */
          --success-600: #34d399;
          --success-500: #10b981;
          --success-100: #064e3b;
          
          /* Warning colors - adjusted for dark */
          --warning-600: #fbbf24;
          --warning-100: #451a03;
          
          /* Danger colors - adjusted for dark */
          --danger-500: #f87171;
          --danger-400: #fca5a5;
          
          /* Accent colors - adjusted for dark */
          --accent-500: #fb923c;
          --accent-400: #fdba74;
          
          /* Text colors - inverted for dark mode */
          --text-primary: #f9fafb;
          --text-secondary: #e5e7eb;
          --text-muted: #9ca3af;
          --text-on-dark: #1f2937;
          
          /* Background colors - dark variants */
          --bg-primary: #111827;
          --bg-secondary: #1f2937;
          --bg-tertiary: #374151;
          --bg-card: #1f2937;
          --bg-gradient-start: #1e1b4b;
          --bg-gradient-mid: #312e81;
          --bg-gradient-end: #1e293b;
          
          /* Border colors - adjusted for dark */
          --border-primary: #374151;
          --border-secondary: #4b5563;
          --border-focus: var(--primary-400);
          
          /* Shadow colors - lighter shadows for dark mode */
          --shadow-sm: rgba(0, 0, 0, 0.2);
          --shadow-md: rgba(0, 0, 0, 0.4);
          --shadow-lg: rgba(0, 0, 0, 0.6);
          --shadow-xl: rgba(0, 0, 0, 0.8);
        }
      }
      
      /* Base styles using CSS variables */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%);
        min-height: 100vh;
        font-size: 18px;
        line-height: 1.6;
        color: var(--text-primary);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      
      /* Focus styles */
      *:focus {
        outline: none;
        box-shadow: 0 0 0 3px var(--border-focus);
        transition: box-shadow 0.2s ease;
      }
      
      button:focus-visible {
        outline: 3px solid var(--accent-500);
        outline-offset: 2px;
      }
      
      a:focus, 
      input:focus, 
      textarea:focus, 
      select:focus {
        position: relative;
        z-index: 1;
      }
      
      /* Container styles */
      .container, .wrap {
        background: var(--bg-card);
        border-radius: 20px;
        box-shadow: 0 20px 60px var(--shadow-xl);
        padding: 40px;
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
      }
      
      .header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border-primary);
      }
      
      h1 {
        color: var(--text-primary);
        font-size: 2.5em;
        margin-bottom: 10px;
      }
      
      h2 {
        color: var(--text-primary);
        font-size: 1.8em;
        margin-bottom: 15px;
      }
      
      .subtitle, .muted {
        color: var(--text-muted);
        font-size: 1.1em;
      }
      
      .card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
        border: 1px solid var(--border-primary);
      }
      
      .instructions {
        background: var(--bg-tertiary);
        border-left: 4px solid var(--primary-500);
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 8px;
      }
      
      .instructions h2 {
        color: var(--text-primary);
        margin-bottom: 15px;
        font-size: 1.3em;
      }
      
      .instructions ul {
        list-style: none;
        padding-left: 0;
      }
      
      .instructions li {
        margin-bottom: 12px;
        padding-left: 25px;
        position: relative;
        color: var(--text-secondary);
        line-height: 1.6;
      }
      
      .instructions li:before {
        content: "✓";
        position: absolute;
        left: 0;
        color: var(--primary-500);
        font-weight: bold;
      }
      
      .warning-box {
        background: var(--warning-100);
        border: 2px solid var(--warning-600);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      
      .warning-icon {
        font-size: 24px;
        color: var(--warning-600);
      }
      
      .warning-text {
        flex: 1;
        color: var(--text-primary);
        line-height: 1.5;
      }
      
      .warning-text strong {
        color: var(--danger-500);
      }
      
      /* Button styles */
      button {
        border: none;
        padding: 15px 40px;
        font-size: 1.1em;
        border-radius: 50px;
        cursor: pointer;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        min-height: 48px;
        min-width: 120px;
        color: var(--text-on-dark);
      }
      
      button.primary, 
      button:not([class]) {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-500) 100%);
        box-shadow: 0 4px 15px var(--shadow-md);
      }
      
      button.primary:hover:not(:disabled),
      button:not([class]):hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px var(--shadow-lg);
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-400) 100%);
      }
      
      button.primary:active:not(:disabled) {
        transform: translateY(0);
      }
      
      button.danger {
        background: linear-gradient(135deg, var(--danger-500) 0%, var(--danger-400) 100%);
        box-shadow: 0 4px 15px var(--shadow-md);
      }
      
      button.danger:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px var(--shadow-lg);
      }
      
      button.secondary {
        background: var(--bg-primary);
        color: var(--primary-600);
        border: 2px solid var(--primary-600);
        box-shadow: 0 2px 10px var(--shadow-sm);
      }
      
      button.secondary:hover:not(:disabled) {
        background: var(--bg-secondary);
        transform: translateY(-1px);
        box-shadow: 0 4px 15px var(--shadow-md);
      }
      
      button.success-button {
        background: linear-gradient(135deg, var(--success-600) 0%, var(--success-500) 100%);
        box-shadow: 0 4px 15px var(--shadow-md);
      }
      
      button.success-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px var(--shadow-lg);
      }
      
      button:disabled {
        background: var(--border-primary) !important;
        color: var(--text-muted) !important;
        cursor: not-allowed;
        box-shadow: none !important;
        opacity: 0.6;
        transform: none !important;
      }
      
      /* Form elements */
      input[type="text"], select, textarea {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid var(--border-primary);
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.2s ease;
        background: var(--bg-primary);
        color: var(--text-primary);
      }
      
      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: var(--primary-500);
        cursor: pointer;
      }
      
      input[type="checkbox"]:focus {
        outline: 3px solid var(--primary-400);
        outline-offset: 2px;
      }
      
      input[type="text"]:focus, 
      select:focus, 
      textarea:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 4px var(--shadow-sm);
        background: var(--bg-primary);
      }
      
      input[type="text"]:hover:not(:focus), 
      select:hover:not(:focus), 
      textarea:hover:not(:focus) {
        border-color: var(--primary-400);
      }
      
      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-primary);
        font-weight: 600;
      }
      
      .row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      
      .row > div {
        flex: 1;
      }
      
      /* Radio group styles */
      .radio-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 12px;
      }
      
      .radio-group label {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        background: var(--bg-primary);
        border: 2px solid var(--border-primary);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
      }
      
      .radio-group label:hover {
        border-color: var(--primary-400);
        background: var(--bg-secondary);
        transform: translateX(4px);
      }
      
      .radio-group input[type="radio"] {
        margin-right: 12px;
        width: 20px;
        height: 20px;
        accent-color: var(--primary-500);
      }
      
      .radio-group input[type="radio"]:checked + span {
        color: var(--primary-600);
        font-weight: 600;
      }
      
      .radio-group label:has(input:checked) {
        background: var(--primary-100);
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--shadow-sm);
      }
      
      /* Status boxes */
      .status-box {
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      
      .status-box.success {
        background: var(--success-100);
        border: 1px solid var(--success-600);
        color: var(--text-primary);
      }
      
      .status-box.error {
        background: var(--danger-400);
        background-opacity: 0.1;
        border: 1px solid var(--danger-500);
        color: var(--text-primary);
      }
      
      /* Item screen specific */
      .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: var(--bg-tertiary);
        border-radius: 8px;
      }
      
      .item-info {
        color: var(--text-secondary);
        font-size: 1.1em;
      }
      
      .timer-display {
        font-family: monospace;
        font-size: 1.3em;
        color: var(--primary-500);
        font-weight: bold;
      }
      
      /* Recording indicator */
      .recording-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--danger-500);
        color: white;
        padding: 10px 20px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: pulse 2s infinite;
      }
      
      .recording-dot {
        width: 12px;
        height: 12px;
        background: white;
        border-radius: 50%;
        animation: blink 1s infinite;
      }
      
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      
      @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
      }
      
      /* Question blocks */
      .q-block {
        margin-bottom: 25px;
        padding: 20px;
        background: var(--bg-primary);
        border-radius: 8px;
        border: 2px solid var(--border-primary);
      }
      
      .q-block label {
        color: var(--text-primary);
        font-size: 1.1em;
        margin-bottom: 12px;
      }
      
      .q-block textarea {
        min-height: 100px;
        resize: vertical;
      }

      /* Ensure stimulus images scale on small screens */
      #stim {
        max-width: 100%;
        height: auto;
      }
      
      /* Admin panel */
      .admin-panel {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        padding: 10px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 12px;
        display: none;
        border: 1px solid var(--border-primary);
      }
      
      body.admin-mode .admin-panel {
        display: block;
      }
      
      /* Connection status */
      .connection-status {
        position: fixed;
        bottom: 10px;
        left: 10px;
        padding: 8px 15px;
        background: var(--bg-primary);
        border: 2px solid var(--border-primary);
        border-radius: 50px;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s;
        color: var(--text-primary);
      }
      
      .connection-status.connected {
        border-color: var(--success-600);
        color: var(--success-600);
      }
      
      .connection-status.error {
        border-color: var(--danger-500);
        color: var(--danger-500);
      }
      
      /* Video preview */
      .video-preview-wrapper {
        text-align: center;
        margin: 20px 0;
      }
      
      .video-preview {
        width: 100%;
        max-width: 480px;
        height: auto;
        background: #000;
        border: 3px solid var(--primary-500);
        border-radius: 12px;
        box-shadow: 0 8px 24px var(--shadow-md);
      }
      
      /* Read aloud box */
      .read-aloud-box {
        background: var(--warning-100);
        border: 2px solid var(--warning-600);
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      
      .read-aloud-box h4 {
        margin: 0 0 10px;
        font-size: 1.2em;
        color: var(--text-primary);
      }
      
      /* Tip box */
      .tip-box {
        background: var(--bg-tertiary);
        border: 2px solid var(--primary-500);
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        color: var(--text-primary);
      }
      
      .tip-box ul {
        margin: 10px 0 0 20px;
        color: var(--text-secondary);
      }
      
      /* Utility classes */
      .hidden {
        display: none !important;
      }
      
      .center {
        text-align: center;
      }
      
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      
      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .container, .wrap {
          padding: 20px;
        }
        
        h1 {
          font-size: 1.8em;
        }
        
        .row {
          flex-direction: column;
        }
        
        button {
          width: 100%;
          padding: 12px 20px;
        }
        
        .recording-indicator {
          top: 10px;
          right: 10px;
          padding: 8px 15px;
          font-size: 0.9em;
        }
      }

      @media (max-width: 480px) {
        .card {
          padding: 20px;
        }

        h1 {
          font-size: 1.5em;
        }
      }
      
      /* Accessibility enhancements */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
        
        button:hover {
          transform: none !important;
        }
      }
      
      /* High contrast mode */
      @media (prefers-contrast: high) {
        :root {
          --primary-600: #4c1d95;
          --primary-500: #6d28d9;
          --text-primary: #000000;
        }
        
        @media (prefers-color-scheme: dark) {
          :root {
            --primary-600: #c4b5fd;
            --primary-500: #ddd6fe;
            --text-primary: #ffffff;
          }
        }
        
        .card {
          border: 3px solid currentColor !important;
        }
        
        button {
          border: 2px solid currentColor !important;
        }
      }
      
      /* Skip link for screen readers */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: var(--primary-600);
        color: white;
        padding: 8px 16px;
        text-decoration: none;
        border-radius: 0 0 8px 0;
        z-index: 10000;
        transition: top 0.3s ease;
      }
      
      .skip-link:focus {
        top: 0;
      }
      
      /* Print styles */
      @media print {
        body {
          background: white !important;
        }
        
        .card {
          box-shadow: none !important;
          border: 1px solid black !important;
        }
        
        button {
          display: none !important;
        }
      }
    </style>
</head>
<body>
<div class="wrap">
  <div id="sr-live" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

  <!-- Welcome Screen -->
  <div id="screen-welcome" class="card">
    <h1>WIAT-2 Reading Comprehension Study</h1>
    <p class="muted">Please enter your information to begin.</p>
    <div class="warning-box" role="alert">
      <span class="warning-icon" aria-hidden="true">⚠️</span>
      <div class="warning-text">
        <strong>Note:</strong> Pages may load slowly. Please click buttons once and wait—avoid double clicking.
      </div>
    </div>

    <div class="row">
      <div>
        <label for="pid">Participant Code</label>
        <!-- Enforce format and length in HTML -->
        <input id="pid" type="text" placeholder="Enter initials" required
               maxlength="20"
               pattern="[A-Za-z0-9_-]{1,20}"
               title="Use letters, numbers, underscores, and hyphens only (max 20)"
               inputmode="latin"
               autocomplete="off"
               autocapitalize="off"
               spellcheck="false" />
      </div>
      <div>
        <label for="edu">Education Level</label>
        <select id="edu" required>
          <option value="">Select...</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
          <option value="13+">College or higher</option>
        </select>
      </div>
    </div>

    <div class="group-info">
      <fieldset>
        <legend>Participant Group</legend>
        <div class="radio-group">
          <label>
            <input type="radio" name="participant-group" value="deaf-fluent" />
            <span>Deaf - Fluent ASL signer</span>
          </label>
          <label>
            <input type="radio" name="participant-group" value="hearing-fluent" />
            <span>Hearing - Fluent ASL signer</span>
          </label>
          <label>
            <input type="radio" name="participant-group" value="deaf-nonfluent" />
            <span>Deaf - Non-fluent ASL signer</span>
          </label>
          <label>
            <input type="radio" name="participant-group" value="hearing-nonfluent" />
            <span>Hearing - Non-fluent ASL signer</span>
          </label>
          <label>
            <input type="radio" name="participant-group" value="hearing-nonsigner" />
            <span>Hearing - Non-signer</span>
          </label>
        </div>
      </fieldset>
    </div>

    <div id="modality-selection" class="modality-selection hidden">
      <fieldset aria-describedby="modality-desc">
        <legend>Communication Preference for "Read Aloud" Items</legend>
        <p id="modality-desc" class="muted" style="margin: 0 0 10px;">How would you prefer to "read aloud"?</p>
        <div id="deaf-note" class="accessibility-note hidden">
          <strong>Note for deaf participants:</strong> You may choose to sign in ASL (video recording) or use spoken language (audio recording) based on your preference and comfort level.
        </div>
        <div class="radio-group">
          <label>
            <input type="radio" name="read-modality" value="sign" />
            <span>Sign (ASL) - Video recording</span>
          </label>
          <label>
            <input type="radio" name="read-modality" value="speak" />
            <span>Speak - Audio recording</span>
          </label>
        </div>
      </fieldset>
    </div>

    <div id="config-warning" class="status-box error hidden" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="status-message">
        <strong>Setup Required:</strong> Google Drive integration not configured. 
        Please update GOOGLE_SCRIPT_URL in the code.
      </div>
    </div>

    <div style="margin-top: 20px;">
      <!-- Consent + privacy -->
      <label style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <input type="checkbox" id="consent" />
        <span>I consent to audio/video recording and secure storage for this study.</span>
      </label>
      <p class="muted" style="margin:6px 0 12px;">Recordings and responses are stored securely and used for research purposes only.</p>

      <button id="begin" class="primary" disabled>Continue to Setup</button>
    </div>
  </div>

  <!-- Setup Screen -->
  <div id="screen-setup" class="card hidden">
    <h2>Recording Setup</h2>

    <div id="recording-method-info" class="recording-info">
      <div class="status-message" id="recording-method-text" role="status" aria-live="polite" aria-atomic="true">
        Setting up recording...
      </div>
    </div>
    
    <div class="comfort-options">
      <label style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="pref-hide-timer" />
        <span>Hide the reading timer during passages</span>
      </label>
      <label id="pref-hide-selfview" class="hidden" style="display:flex;align-items:center;gap:8px;margin-top:8px;">
        <input type="checkbox" id="toggle-selfview" />
        <span>Hide my camera preview during recording</span>
      </label>
      <p class="muted" style="margin:8px 0 0;">You can change these anytime.</p>
    </div>

    <div id="video-setup" class="hidden">
      <p class="muted">For ASL "read aloud" items, we need to set up video recording.</p>
      <div class="video-preview-wrapper">
        <video id="preview" class="video-preview" autoplay muted playsinline></video>
      </div>
      <p id="video-status" class="muted center" role="status" aria-live="polite" aria-atomic="true">Requesting camera access...</p>
    </div>

    <div id="audio-setup" class="hidden">
      <p class="muted">For spoken "read aloud" items, we need to set up audio recording.</p>
      <div class="recording-controls">
        <button id="test-audio-record" class="danger">Test Audio Recording</button>
        <button id="stop-test-audio" class="hidden">Stop Test</button>
        <span class="recording-timer hidden" id="test-audio-timer">00:00</span>
      </div>
      <audio id="test-audio-playback" controls class="hidden" style="width: 100%; max-width: 400px; margin: 10px auto; display: block;"></audio>
      <p id="audio-status" class="muted center" role="status" aria-live="polite" aria-atomic="true">Click "Test Audio Recording" to verify your microphone is working.</p>
    </div>

    <div id="setup-status" class="status-box" style="margin-top: 20px;">
      <div class="status-message" id="setup-status-text" role="status" aria-live="polite" aria-atomic="true">Initializing...</div>
    </div>

    <div style="margin-top: 20px; text-align: center;">
      <button id="start-study" class="primary" disabled>Start Assessment</button>
    </div>
  </div>

  <!-- Item Screen -->
  <div id="screen-item" class="card hidden">
    <div class="recording-indicator hidden" id="rec-indicator">
      <span class="recording-dot"></span>
      <span id="rec-type">Recording</span>
    </div>

    <div class="item-header">
      <div class="item-info">
        <!-- CHANGED: Only show item number without position info -->
        Item <span id="actual-item-number"></span>
      </div>
      <div id="timer-container" class="hidden">
        <span class="timer-display" id="timer">00:00</span>
      </div>
    </div>

    <div id="stim-container" class="center">
      <img id="stim" class="stim" alt="Reading material" />
    </div>

    <div id="instructions" class="muted center" style="margin: 16px 0;">
      <span id="instruction-text"></span>
    </div>

    <!-- Read Aloud Instructions Box -->
    <div id="read-aloud-instructions" class="read-aloud-box hidden">
      <h4 id="read-aloud-title">Read Aloud Instructions</h4>
      <p id="read-aloud-text" class="muted" style="margin: 0;"></p>
    </div>

    <!-- Recording controls for read-aloud items -->
    <div id="recording-controls" class="recording-controls hidden">
      <button id="start-recording" class="danger" aria-describedby="recording-help">Start Recording</button>
      <button id="stop-recording" class="hidden">Stop Recording</button>
      <span class="recording-timer hidden" id="recording-timer">00:00</span>
      <div id="recording-help" class="sr-only">Click to begin recording your response</div>
    </div>

    <!-- Standard reading controls -->
    <div id="reading-controls" class="center hidden" style="margin: 16px 0;">
      <button id="start-reading" class="primary">Start Reading</button>
      <button id="done-reading" class="hidden">Done Reading</button>
    </div>

    <form id="qa-form" class="hidden">
      <div id="qa-fields"></div>
      <div style="margin-top: 16px;">
        <button type="submit" class="primary">Submit</button>
        <button type="button" id="skip" class="secondary">Skip</button>
      </div>
    </form>
  </div>

  <!-- Finish Screen -->
  <div id="screen-finish" class="card hidden">
    <h2>Assessment Complete</h2>
<p id="finish-msg" class="muted" role="status" aria-live="polite" aria-atomic="true">Thank you for participating.</p>

<div id="upload-status" class="status-box">
<div class="status-message" id="upload-progress" role="status" aria-live="polite" aria-atomic="true">Saving your data...</div>
    </div>

<div id="final-stats" class="hidden" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px;">
  <h3 style="font-size: 14px; margin: 0 0 10px;">Session Summary</h3>
  <div id="stats-content"></div>
</div>

<div style="margin-top: 20px; text-align: center;">
  <button id="retry-upload" class="primary hidden">Retry Upload</button>
  <button id="download-backup" class="hidden">Download Backup</button>
</div>
  </div>

  <!-- Admin Panel -->
  <div class="admin-panel">
    <div>Group: <span id="admin-group">-</span></div>
    <div>Item: <span id="admin-item">-</span></div>
    <div>Score: <span id="admin-score">0</span></div>
    <div>Zeros: <span id="admin-zeros">0</span></div>
    <div>Status: <span id="admin-status">Active</span></div>
  </div>

  <!-- Connection Status -->
  <div class="connection-status" id="connection-status">
<span id="connection-text" role="status" aria-live="polite" aria-atomic="true">Not connected</span>
  </div>

</div>

<script>
/* ===========================
   CONFIGURATION
   =========================== */
// IMPORTANT: Replace this with your actual Google Apps Script Web App URL
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX6yfgjIVSzmL2nL73IxIWPCV4RPbxfjPTDOxB-_Ax6siB2vmKJXnCpwLP4-PUA4MCpQ/exec';

// Add: Secondary backup endpoint (serverless function you control)
// Example: https://your-worker.example.com/wiat-backup
const GITHUB_BACKUP_URL = 'https://readingcomp-f3ii59o6j-melodys-projects-8b5cbe18.vercel.app/'; // Vercel backup endpoint
const GOOGLE_TIMEOUT_MS = 3500; // consider as "slow"
const BACKUP_TIMEOUT_MS = 3500;

// Add: GitHub repo/path hints for your backup endpoint (non-sensitive, safe in client)
const BACKUP_REPO_OWNER = 'melodyfschwenk';
const BACKUP_REPO_NAME = 'readingcomp';
const BACKUP_DIR_HINT = 'data/sessions';

// Tunable discontinue threshold
const DISCONTINUE_AFTER_ZEROS = 6;

// Add: stable session id to help dedupe on the server side
const SESSION_ID = (() => {
  try { return crypto.randomUUID(); }
  catch { return 'sid_' + Date.now() + '_' + Math.random().toString(36).slice(2); }
})();

/* ===========================
   Debug helper (conditional console logging)
   =========================== */
function debugLog(message, data = null) {
  if (window.location.hostname === 'localhost' || window.location.search.includes('debug=1')) {
    if (data !== null) console.log(message, data);
    else console.log(message);
  }
}

/* ===========================
   State Management
   =========================== */
// ADD THIS: Better screen reader announcements
function announceToScreenReader(message, priority = 'polite') {
    const liveRegion = document.getElementById('sr-live');
    if (liveRegion) {
        liveRegion.setAttribute('aria-live', priority);
        liveRegion.textContent = message;
        
        // Clear after announcement
        setTimeout(() => {
            liveRegion.textContent = '';
        }, 1000);
    }
}

// MOVED: State declaration after the announceToScreenReader function
let state = {
  // Session info
  pid: '',
  edu: '',
  participantGroup: '', // deaf-fluent, hearing-fluent, deaf-nonfluent, hearing-nonfluent, hearing-nonsigner
  readModality: '', // sign or speak (for all participants who can choose)
  sessionStartTime: null,
  
  // Progress tracking
  currentIndex: 0,
  totalPoints: 0,
  consecutiveZeros: 0,
  gateItemsFailed: [],

  // Results storage
  results: [],
  sequence: [],
  
  // Timers
  timers: {
    reading: null,
    recording: null,
    test: null,
    // New: fast connectivity heartbeat timer
    heartbeat: null
  },
  readingStartTime: null,
  itemStartTime: null,
  
  // Recording
  useVideoRecording: false,
  useAudioRecording: false,
  mediaRecorder: null,
  recordedChunks: [],
  stream: null,
  recordMime: '',
  adminMode: false,
  uploadAttempts: 0,
  savedData: null,
  connectionStatus: false,

  reviewQueue: [],
  scoringMetrics: {
    highConfidence: 0,
    mediumConfidence: 0,
    lowConfidence: 0,
    manualReviewNeeded: 0
  }
};

// Test recording timer variables (global scope to prevent memory leaks)
let testTimerSec = 0;

/* ===========================
   WIAT-2 Scoring Reference
   =========================== */

const SCORING_REFERENCE = {
  /* =======================
     Turtle Brothers (75–80)
     ======================= */
  q75: {
    twoPoint: {
      patterns: [/great\s+spirit/i, /\bgod\b/i, /deity/i, /creator/i, /divine\s+being/i, /supreme\s+being/i]
    },
    onePoint: {
      patterns: [/spirit\b/i, /supernatural/i]
    },
    notes: "Must indicate a divine/supreme being for 2 points."
  },
  q76: {
    twoPoint: { patterns: [/\b7\b/, /\bseven\b/i] },
    notes: "Must be exactly 7."
  },
  q77: {
    twoPoint: { patterns: [/soil.*turtle/i, /turtle.*soil/i, /earth.*turtle/i] },
    onePoint: { patterns: [/earth/i, /brush/i, /bush/i] }
  },
  q78: {
    twoPoint: { patterns: [/earthquake/i] },
    onePoint: { patterns: [/land.*quake/i, /ground.*quiver/i] }
  },
  q79: {
    twoPoint: { patterns: [/california.*back/i, /california.*made/i] },
    onePoint: { patterns: [/part.*land/i] }
  },
  q80: {
    twoPoint: { patterns: [/think\s+about/i, /form.*plan/i, /ponder/i] },
    onePoint: { patterns: [/think\s+hard/i, /\bthink\b/i] }
  },

  /* =======================
     Avalanche (82–83)
     ======================= */
  q82: {
    twoPoint: { patterns: [/road.*covered.*debris/i, /traffic.*stop/i] },
    onePoint: { patterns: [/snow.*covered.*road/i, /avalanche.*covered/i] }
  },
  q83: {
    twoPoint: { patterns: [/tree.*branch/i, /\bdirt\b/i, /\brock/i, /\bmud\b/i, /junk/i] },
    onePoint: { patterns: [/\bsnow\b/i, /rubbish/i] }
  },

  /* =======================
     Fancy (85)
     ======================= */
  q85: {
    twoPoint: { patterns: [/like.*better/i, /prefer/i, /\blike\b/i] },
    onePoint: { patterns: [/adore/i, /enjoy/i] }
  },

  /* =======================
     Track Meet (87–88)
     ======================= */
  q87: {
    twoPoint: { patterns: [/bad.*weather.*cancel/i, /weather.*long.*distance/i] },
    onePoint: { patterns: [/bad.*weather/i, /cancel/i] }
  },
  q88: {
    twoPoint: {
      patterns: [
        /\binclement\b/i,                           // echoes the key word
        /(bad|severe|stormy|harsh|rough|foul|nasty)\s+(weather|storm|conditions)/i,
        /(unpleasant|poor)\s+weather/i
      ]
    },
    notes: "Full = clearly 'bad/severe/stormy weather'. Partial = mentions weather conditions without stating severity."
  },

  /* =======================
     Yukon Gold (89–93)
     ======================= */
  q89: {
    onePoint: {
      patterns: [
        /(cold|freez|blizzard|snowstorm)/i,
        /(bear|wolf|wolves|animal attack|wildlife)/i,
        /(starv|hunger|food shortage|lack of food)/i,
        /(rapid|river|ice.*break|thin ice|avalanche|landslide)/i,
        /(sick|illness|injur|exhaustion|fatigue)/i
      ]
    },
    notes: "Give 2 if two clear journey dangers are named; 1 for one credible danger. Often needs review."
  },
  q90: {
    twoPoint: {
      patterns: [
        /(does\s*not|doesn't|didn't)\s+want.*(go|yukon).*(cold|freez|danger|hard|difficult|long trip)/i,
        /(reluctant|unwilling|afraid|fear).*go.*(cold|freez|danger|hard|difficult)/i
      ]
    },
    onePoint: { patterns: [/(does\s*not|doesn't|didn't)\s+want.*go/i, /(afraid|fear|scared)/i, /(cold|freez)/i] },
    notes: "Full credit if his reason is the cold/dangers/hardship noted by Diana."
  },
  q91: {
    onePoint: {
      patterns: [
        /(surviv|persever|endure|overcome)/i,
        /(family|together|teamwork|loyalty)/i,
        /(courage|brave|risk|adventure)/i
      ]
    },
    notes: "Give 2 for two accurate themes tied to the text; 1 for one plausible theme (review recommended)."
  },
  q92: {
    twoPoint: { patterns: [/(predictabl|hackneyed|clich[eé]|unoriginal|stale|trite)/i, /(same old|formula(ic)?)/i] },
    onePoint: { patterns: [/(plot|story).*weak|bad/i, /(boring|dull)/i] },
    notes: "Gary disliked that it was unoriginal/predictable."
  },
  q93: {
    twoPoint: { patterns: [/(overused|trite|clich[eé]|worn[- ]?out|stale|banal|unoriginal)/i] },
    onePoint: { patterns: [/(commonplace|old|familiar)/i] },
    notes: "Meaning of 'hackneyed'."
  },

  /* =======================
     Words of Wisdom (94–98)
     ======================= */
  q94: {
    twoPoint: { patterns: [/(written|document|recorded|chronicle|account)s?\b/i] },
    onePoint: { patterns: [/(history|facts|notes|information)/i] },
    notes: "'Records' = written accounts/documents."
  },
  q95: {
    twoPoint: {
      patterns: [
        /(collected|compiled|gathered|borrowed|took)\s+(from\s+)?(others|folk|people|sayings|maxims|aphorisms)/i,
        /(traditional|folk)\s+(proverb|saying)s?/i
      ]
    },
    onePoint: { patterns: [/(books|almanacs?|newspapers|sources)/i] },
    notes: "He collected existing proverbs."
  },
  q96: {
    twoPoint: { patterns: [/(rush|haste|hurry).*(mistake|waste|redo|do it again|sloppy|error)/i] },
    onePoint: { patterns: [/(don'?t|do not)\s+rush/i, /(take your time|be careful)/i] }
  },
  q97: {
    twoPoint: {
      patterns: [
        /(short|brief|simple|concise).*(sayings|proverbs)/i,
        /(easy\s+to\s+remember|memorable)/i,
        /(wisdom|truth|advice|lesson)/i
      ]
    },
    onePoint: { patterns: [/(people|most).*(like|enjoy).*(proverb|saying)/i] }
  },
  q98: {
    notes: "Selects the proverb that comments on modern technology. Mark for manual review (no scoring patterns here)."
  },

  /* =======================
     Mammals vs Saurian (100) & Dust Bowl (102)
     ======================= */
  q100: {
    twoPoint: { patterns: [/(mammal).*(warm[- ]?blood)/i, /(saurian|reptile).*(cold[- ]?blood)/i] },
    onePoint: { patterns: [/(warm[- ]?blood|cold[- ]?blood)/i, /(mammal|saurian|reptile)/i] }
  },
  q102: {
    twoPoint: { patterns: [/(long|several|many)\s+(years|period).*(no|little)\s+rain/i, /\bdrought\b/i] },
    onePoint: { patterns: [/(dust\s*storm|sand\s*storm)s?/i] }
  },

  /* =======================
     Kristi Yamaguchi (103–107)
     ======================= */
  q103: {
    twoPoint: { patterns: [/(health|medical|therapy|exercise)/i, /(turned[- ]in\s+(hips|feet)|foot\s+problem|hip\s+problem)/i] },
    onePoint: { patterns: [/(to\s+exercise|for\s+her\s+health)/i] }
  },
  q104: {
    semantic: {
      full: [
        ["daily routine", "everyday routine", "habit", "regular schedule", "usual activities", "day-to-day"],
        ["skating routine", "performance routine", "program", "choreograph", "set sequence", "planned moves"]
      ],
      partial: ["daily", "habit", "schedule", "program", "performance", "choreographed"]
    },
    notes: "First = everyday schedule; next = choreographed program/performance."
  },
  q105: {
    twoPoint: {
      patterns: [
        /(did|skated?)\s+both\s+(pairs|pair)\s+and\s+(singles|single)/i,
        /(pairs|pair)\s+and\s+(singles|single)\s+at\s+the\s+same\s+time/i
      ]
    },
    onePoint: { patterns: [/(too\s+much\s+work|many\s+events|double\s+workload)/i] }
  },
  q106: {
    twoPoint: { patterns: [/(kristi|yamaguchi).*(rudy|galindo)/i] },
    notes: "Kristi Yamaguchi & Rudy Galindo."
  },
  q107: {
    twoPoint: { patterns: [/(choreograph(y|ic)|artistry|presentation|style|grace|expression)/i] },
    onePoint: { patterns: [/(not\s+just\s+jumps|technique|balance|control)/i] },
    notes: "She compensated with choreography/artistry."
  },

  /* =======================
     Humpback Whales (108–112)
     ======================= */
  q108: {
    twoPoint: { patterns: [/(death|dying|end|extinction|downfall|ruin)/i] },
    onePoint: { patterns: [/(decline|fall|reduce|less)/i] }
  },
  q109: {
    semantic: {
      full: [
        ["hunt", "hunted", "whale", "whaling", "killed"],
        ["net", "fishing net", "entangle", "caught", "bycatch", "pollution", "ship strike"]
      ],
      partial: ["hunted", "whaling", "nets", "entangled", "pollution", "bycatch", "ships"]
    },
    notes: "Two ways: (1) hunting/whaling; (2) nets/entanglement (pollution/ship strikes may count if text supports)."
  },
  q110: {
    twoPoint: { patterns: [/(we)\s+can\s+(protect|save|help|conserve)/i, /(awareness|understand).*(protect|conserve|laws|action)/i] },
    onePoint: { patterns: [/(important|know|learn)/i] }
  },
  q111: {
    semantic: {
      full: [
        ["drown", "suffocate", "asphyxiate"],
        ["starve", "starvation"]
      ],
      partial: ["drown", "suffocate", "starve"]
    },
    notes: "Two things: drown and starve."
  },
  q112: {
    twoPoint: { patterns: [/(become|go)\s+extinct/i, /(die\s+out)/i] },
    onePoint: { patterns: [/(decline|decrease|fall)\s+in\s+numbers/i, /(endangered|at\s+risk)/i] }
  },

  /* =======================
     Peach Prices (114)
     ======================= */
  q114: {
    twoPoint: {
      patterns: [
        /(in\s+season|harvest|summer|supply.*high).*price(s)?\s+(low|lower|drop)/i,
        /(off[- ]season|winter|supply.*low).*price(s)?\s+(rise|higher|increase)/i
      ]
    },
    onePoint: { patterns: [/(supply).*affect(s|ed)?.*price/i, /(season|harvest)/i] },
    notes: "Seasonal supply explains price changes."
  },

  /* =======================
     Zoo Admission (115–119)
     ======================= */
  q115: {
    twoPoint: { patterns: [/\$?\s*3(\.00)?\b/i, /\bthree\s*dollars?\b/i] },
    onePoint: { patterns: [/(less|cheaper|lower)/i] }
  },
  q116: {
    twoPoint: {
      patterns: [
        /(main|primary)\s+reason.*(support|position)/i,
        /(because|since|as)\s+(costs|expenses|budget|funds|money).*(need|require)/i
      ]
    },
    onePoint: { patterns: [/(money|costs|budget)/i] },
    notes: "Tom's main reason: costs/finances; raising price covers expenses."
  },
  q117: {
    twoPoint: {
      patterns: [
        /(take\s+up\s+the\s+slack)\s*=\s*(compensate|cover|make\s+up|fill\s+in|carry\s+the\s+load)/i,
        /(compensate|cover|make\s+up).*(for\s+others|shortfall|lack)/i
      ]
    },
    onePoint: { patterns: [/(help\s+out|do\s+more|pick\s+up\s+the\s+slack)/i] }
  },
  q118: {
    twoPoint: {
      patterns: [
        /(acquisition|acquisitions)\s*=\s*(purchases|things\s+the\s+zoo\s+buys|new\s+animals|items\s+obtained)/i,
        /(purchase|buy|obtain)\s+(animals|exhibits|items)/i
      ]
    },
    onePoint: { patterns: [/(new\s+animals|new\s+exhibits|purchases)/i] }
  },
  q119: {
    onePoint: {
      patterns: [
        /(fewer|no)\s+(acquisitions|new\s+animals|new\s+exhibits)/i,
        /(reduce(d)?|cut)\s+(hours|services|staff|care|maintenance)/i,
        /(close|closure)/i,
        /(lack\s+of\s+funds|budget\s+shortfall)/i
      ]
    },
    notes: "Give 2 if three stated consequences are listed; 1 for one–two. Often needs review."
  },

  /* =======================
     The King (121–122)
     ======================= */
  q121: {
    twoPoint: { patterns: [/(the\s+)?king\s+(has\s+)?(died|is\s+dead|passed\s+away|was\s+assassinated)/i] },
    onePoint: { patterns: [/(the\s+)?king\s+(is\s+gone|no\s+longer|not\s+alive)/i] }
  },
  q122: {
    twoPoint: { patterns: [/(new\s+king|succession|heir|prince\s+becomes\s+king)/i, /(funeral|mourning|power\s+struggle|war|chaos)/i] },
    onePoint: { patterns: [/(someone\s+else\s+will\s+rule|change\s+of\s+power)/i] }
  },

  /* =======================
     Central Asiatic Expedition (123–127)
     ======================= */
  q123: {
    twoPoint: { patterns: [/(first|initial)\s+discovery.*(skull|skulls)/i, /(flaming\s+cliffs|bayanzag|gobi)/i] },
    onePoint: { patterns: [/(dinosaur|fossil)/i] }
  },
  q124: {
    onePoint: { patterns: [/(adventure|expedition|voyage|journey|exploration)/i] },
    notes: "Give 2 if three specific pre-Gobi adventures are correctly named; 1 for one–two (manual review)."
  },
  q125: {
    twoPoint: { patterns: [/(gobi\s+desert|mongolia|flaming\s+cliffs)/i, /(nest|nests|eggs)/i] },
    onePoint: { patterns: [/(desert|sand|cliffs)/i] }
  },
  q126: {
    twoPoint: { patterns: [/(proved|showed|demonstrated)\s+that\s+dinosaurs?\s+(laid|lay)\s+eggs/i, /(first|new)\s+dinosaur\s+eggs?\s+discovered/i] },
    onePoint: { patterns: [/(changed|altered)\s+scientific\s+knowledge/i] }
  },
  q127: {
    twoPoint: { patterns: [/(brigands?)\s*=\s*(bandits?|robbers?|thieves?)/i] },
    onePoint: { patterns: [/(outlaws?|criminals?)/i] }
  },

  /* =======================
     Longevity (129–130)
     ======================= */
  q129: {
    twoPoint: { patterns: [/(longevity)\s*=\s*(length\s+of\s+life|life\s*span|how\s+long\s+people\s+live)/i] },
    onePoint: { patterns: [/(old|older|age)/i] }
  },
  q130: {
    twoPoint: { patterns: [/(life\s+expectancy|longevity)\s+(has\s+)?(risen|increased|gone\s+up|grown)\b/i, /(trend|graph|chart).*(upward|increase|rise)/i] },
    onePoint: { patterns: [/(people\s+live\s+longer)/i] }
  },

  /* =======================
     Life Stages (131–135)
     ======================= */
  q131: {
    twoPoint: { patterns: [/(young|early)\s+adult(hood)?/i, /(begin|start)\s+a\s+career/i] },
    onePoint: { patterns: [/\badult\b/i] }
  },
  q132: {
    twoPoint: { patterns: [/(reassess|re[- ]?evaluate|reconsider|question).*(goals|career|life|relationships?)/i, /(change|adjust|redirect).*(life|career|path|relationships?)/i] },
    onePoint: { patterns: [/(mid[- ]?life).*(change|question|reassess)/i] }
  },
  q133: {
    twoPoint: { patterns: [/(mid[- ]?life\s+rebirth)/i] },
    onePoint: { patterns: [/(mid[- ]?life|reassessment)/i] }
  },
  q134: {
    twoPoint: { patterns: [/(lack|missing|fail(ed)?\s+to\s+develop).*(independence|self[- ]?reliance)/i, /(remain|stay)\s+(dependent|immature|tied)/i] },
    onePoint: { patterns: [/(problems|issues)\s+with\s+(independence|identity)/i] }
  },
  q135: {
    twoPoint: { patterns: [/(mentor|guide|teach|advise|give\s+back)/i, /(reflect|wisdom|insight|legacy|purpose|meaning)/i] },
    onePoint: { patterns: [/(help\s+others|share\s+experience|reflection)/i] }
  },

  /* =======================
     The Rock (136–140)
     ======================= */
  q136: {
    twoPoint: { patterns: [/(fissure)\s*=\s*(narrow|thin)\s+(crack|split|opening)\s+in\s+rock/i] },
    onePoint: { patterns: [/(crack|split|opening)/i] }
  },
  q137: {
    twoPoint: { patterns: [/(sheer|vertical)\s+(wall|face|escarpment)/i, /(sudden(ly)?)\s+(steep|drop|cliff)/i] },
    onePoint: { patterns: [/(harder|difficult|steeper)/i] }
  },
  q138: {
    twoPoint: { patterns: [/(fatigue|exhaustion|very\s+tired)/i] },
    onePoint: { patterns: [/(fear|scared|mental|mindset|discouraged)/i] }
  },
  q139: {
    twoPoint: { patterns: [/(determination|willpower|resolve|too\s+far\s+to\s+quit|couldn'?t\s+turn\s+back)/i] },
    onePoint: { patterns: [/(close\s+to\s+the\s+top|almost\s+there|came\s+so\s+far)/i] }
  },
  q140: {
    twoPoint: { patterns: [/(focus(ed)?\s+on\s+herself|needed\s+to\s+concentrate|had\s+to\s+get\s+herself\s+to\s+top)/i] },
    onePoint: { patterns: [/(afraid|fear|if\s+she\s+looked\s+down|discouraged|didn'?t\s+want\s+to\s+look\s+back)/i] }
  }
};

/* ===========================
   TRIALS Configuration - COMPLETE
   =========================== */
const TRIALS = [
  // Turtle Brothers passage
  {
    item: 75,
    image: "1.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q75",
      text: "Who is Kwawar?",
      scoringKey: "q75"
    }]
  },
  {
    item: 76,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q76",
      text: "In all, how many Turtle Brothers were needed to fulfill Kwawar's request?",
      scoringKey: "q76"
    }]
  },
  {
    item: 77,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q77",
      text: "What caused the mountains to arise?",
      scoringKey: "q77"
    }]
  },
  {
    item: 78,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q78",
      text: "What natural event does the Turtle Brothers' quarreling explain?",
      scoringKey: "q78"
    }]
  },
  {
    item: 79,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q79",
      text: "What great gift did Kwawar give the Turtle Brothers?",
      scoringKey: "q79"
    }]
  },
  {
    item: 80,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q80",
      text: "What is the meaning of contemplated in the story?",
      scoringKey: "q80"
    }]
  },
  
  // Avalanche passage (read aloud)
  {
    item: 81,
    image: "2.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 82,
    image: "2.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q82",
      text: "Tell me in your own words, what has happened as a result of the avalanche?",
      scoringKey: "q82"
    }]
  },
  {
    item: 83,
    image: "2.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q83",
      text: "What does the word debris mean in this sentence?",
      scoringKey: "q83"
    }]
  },
  
  // Fancy passage (read aloud)
  {
    item: 84,
    image: "3.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 85,
    image: "3.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q85",
      text: "What does the word fancy mean in this sentence?",
      scoringKey: "q85"
    }]
  },
  
  // Track meet passage (read aloud)
  {
    item: 86,
    image: "4.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 87,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q87",
      text: "Why did the track meet end earlier than expected?",
      scoringKey: "q87"
    }]
  },
  {
    item: 88,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q88",
      text: "What does the word inclement mean in this sentence?",
      scoringKey: "q88"
    }]
  },
  
  // Yukon Gold passage
  {
    item: 89,
    image: "5.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q89",
      text: "What were two dangers encountered by the family on their journey?",
      scoringKey: "q89"
    }]
  },
  {
    item: 90,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q90",
      text: "According to Diana, why doesn't Charlie want to go to Yukon?",
      scoringKey: "q90"
    }]
  },
  {
    item: 91,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q91",
      text: "According to the reviewers, what are two main themes or ideas in Yukon Gold?",
      scoringKey: "q91"
    }]
  },
  {
    item: 92,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q92",
      text: "Diana gave Yukon Gold four stars although Gary gave it two. What did Gary dislike about the movie?",
      scoringKey: "q92"
    }]
  },
  {
    item: 93,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q93",
      text: "What is the meaning of the word hackneyed in Gary's review?",
      scoringKey: "q93"
    }]
  },
  
  // Words of Wisdom (Grades 9-12 Start)
  {
    item: 94,
    image: "6.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q94",
      text: "What is the meaning of the word records in the first paragraph?",
      scoringKey: "q94"
    }]
  },
  {
    item: 95,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q95",
      text: "Where do you think Ben Franklin found the proverbs he included in the Poor Richard's Almanack?",
      scoringKey: "q95"
    }]
  },
  {
    item: 96,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q96",
      text: "What do you think 'Haste makes waste' might mean?",
      scoringKey: "q96"
    }]
  },
  {
    item: 97,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q97",
      text: "Why do you think most people like proverbs?",
      scoringKey: "q97"
    }]
  },
  {
    item: 98,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q98",
      text: "Which of the proverbs mentioned in the passage is a comment on modern technology?",
      scoringKey: "q98"
    }]
  },
  
  // Mammals vs Saurian (read aloud)
  {
    item: 99,
    image: "7.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 100,
    image: "7.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q100",
      text: "How are mammals and saurian different?",
      scoringKey: "q100"
    }]
  },
  
  // Dust Bowl (read aloud)
  {
    item: 101,
    image: "8.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 102,
    image: "8.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q102",
      text: "What does the sentence tell you that the great Dust Bowl was?",
      scoringKey: "q102"
    }]
  },
  
  // Kristi Yamaguchi passage
  {
    item: 103,
    image: "9.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q103",
      text: "For what primary reason did Kristi's mother want her daughter to skate?",
      scoringKey: "q103"
    }]
  },
  {
    item: 104,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q104",
      text: "How does the definition of routine in the first paragraph differ from that in the next paragraph?",
      scoringKey: "q104"
    }]
  },
  {
    item: 105,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q105",
      text: "Why was Kristi's workload double that of other skaters?",
      scoringKey: "q105"
    }]
  },
  {
    item: 106,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q106",
      text: "Who won the pairs gold medal at the 1990 Nationals?",
      scoringKey: "q106"
    }]
  },
  {
    item: 107,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q107",
      text: "How was Kristi able to compensate for her athletic limitations?",
      scoringKey: "q107"
    }]
  },
  
  // Humpback whales passage
  {
    item: 108,
    image: "10.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q108",
      text: "What is the meaning of the word demise in this story?",
      scoringKey: "q108"
    }]
  },
  {
    item: 109,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q109",
      text: "In what two ways have people been the primary reason for the whales' demise?",
      scoringKey: "q109"
    }]
  },
  {
    item: 110,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q110",
      text: "Why is it important for us to know about the struggles of the humpback whales?",
      scoringKey: "q110"
    }]
  },
  {
    item: 111,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q111",
      text: "What two things might happen if a whale is caught in a fishing net?",
      scoringKey: "q111"
    }]
  },
  {
    item: 112,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q112",
      text: "According to current studies, what is likely to happen to the humpback whale in the future?",
      scoringKey: "q112"
    }]
  },
  
  // Peach prices (read aloud)
  {
    item: 113,
    image: "11.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 114,
    image: "11.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q114",
      text: "What is the most likely reason for the changes in the peach prices during the year?",
      scoringKey: "q114"
    }]
  },
  
  // Zoo admission passage
  {
    item: 115,
    image: "12.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q115",
      text: "If today's zoo admission is $4.00, what was zoo admission in January 1993?",
      scoringKey: "q115"
    }]
  },
  {
    item: 116,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q116",
      text: "What is the main reason Tom gives to support his position?",
      scoringKey: "q116"
    }]
  },
  {
    item: 117,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q117",
      text: "When he says 'take up the slack' in his sentence, what does Tom mean?",
      scoringKey: "q117"
    }]
  },
  {
    item: 118,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q118",
      text: "Tanisha uses the word 'acquisitions' in her letter. What does it mean?",
      scoringKey: "q118"
    }]
  },
  {
    item: 119,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q119",
      text: "According to Tanisha, what three things might happen if zoo prices are not raised?",
      scoringKey: "q119"
    }]
  },
  
  // King passage (read aloud)
  {
    item: 120,
    image: "13.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 121,
    image: "13.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q121",
      text: "What has happened to the king?",
      scoringKey: "q121"
    }]
  },
  {
       item: 122,
    image: "13.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q122",
      text: "What would you predict might happen as a result of the event described?",
      scoringKey: "q122"
    }]
  },
  
  // Central Asiatic Expedition passage
  {
    item: 123,
    image: "14.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q123",
      text: "What was the first discovery of the Central Asiatic Expedition?",
      scoringKey: "q123"
    }]
  },
  {
    item: 124,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q124",
      text: "Tell three adventures Andrew's had experienced before going to the Gobi desert.",
      scoringKey: "q124"
    }]
  },
  {
    item: 125,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q125",
      text: "Where did the scientists discover the dinosaur eggs?",
      scoringKey: "q125"
    }]
  },
  {
    item: 126,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q126",
      text: "How did Andrew's expedition alter scientific knowledge?",
      scoringKey: "q126"
    }]
  },
  {
    item: 127,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q127",
      text: "What is the meaning of the word brigands as used in the passage?",
      scoringKey: "q127"
    }]
  },
  
  // Longevity (read aloud)
  {
    item: 128,
    image: "15.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 129,
    image: "15.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q129",
      text: "What is the meaning of the word longevity in this sentence?",
      scoringKey: "q129"
    }]
  },
  {
    item: 130,
    image: "15.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q130",
      text: "Describe the trend reported in this sentence",
      scoringKey: "q130"
    }]
  },
  
  // Life stages passage
  {
    item: 131,
    image: "16.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q131",
      text: "At what life stage is a person likely to begin a career?",
      scoringKey: "q131"
    }]
  },
  {
    item: 132,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q132",
      text: "What is the main theme of the 'Mid-life Rebirth' developmental tasks?",
      scoringKey: "q132"
    }]
  },
  {
    item: 133,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q133",
      text: "Although Rachel was recently promoted to manager of her office, she is questioning her choice of careers and regrets that she never pursued her dream of composing music. At the same time, she is reluctant to quit her job because she recently bought a new home. What developmental stage is Rachel probably in?",
      scoringKey: "q133"
    }]
  },
  {
    item: 134,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q134",
      text: "What might happen if a person did not accomplish the developmental tasks of the 'Breaking Loose' stage?",
      scoringKey: "q134"
    }]
  },
  {
    item: 135,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q135",
      text: "If the last life stage called 'Deepening Wisdom' were added to the chart, what would you predict two of the developmental tasks would be?",
      scoringKey: "q135"
    }]
  },
  
  // The Rock passage
  {
    item: 136,
    image: "17.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q136",
      text: "What is the fissure as described in the passage?",
      scoringKey: "q136"
    }]
  },
  {
    item: 137,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q137",
      text: "What suddenly made this rock climb so difficult?",
      scoringKey: "q137"
    }]
  },
  {
    item: 138,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q138",
      text: "What was the most important thing the women had to overcome in order to scale the rock?",
      scoringKey: "q138"
    }]
  },
  {
    item: 139,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q139",
      text: "What kept the women from turning back when they saw the sheer surface of the rock?",
      scoringKey: "q139"
    }]
  },
  {
    item: 140,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q140",
      text: "Why did Angela refuse to look at Sherry as she approached the summit?",
      scoringKey: "q140"
    }]
  }
];

function getReadAloudInstructions() {
  if (state.useVideoRecording) {
    return {
      title: 'ASL read aloud',
      text: 'When you are ready, sign the passage clearly on camera. You can pause briefly to think.',
      buttonText: 'Start video recording'
    };
  } else {
    return {
      title: 'Spoken read aloud',
      text: 'When you are ready, read the passage out loud into the microphone. You can speak at a natural pace.',
      buttonText: 'Start audio recording'
    };
  }
}

/* ===========================
   Participant Group Configuration
   =========================== */
function determineRecordingNeeds() {
  const group = state.participantGroup;
  const modality = state.readModality;
  
  // All participants can choose their modality
  if (modality === 'sign') {
    state.useVideoRecording = true;
    state.useAudioRecording = false;
    return 'video';
  } else {
    state.useVideoRecording = false;
    state.useAudioRecording = true;
    return 'audio';
  }
}

// Check whether all welcome fields are completed
function checkWelcomeReady() {
  const hasPid = document.getElementById('pid').value.trim().length > 0;
  const hasEdu = !!document.getElementById('edu').value;
  const hasGroup = !!state.participantGroup;
  const hasModality = !!state.readModality;
  const hasConsent = document.getElementById('consent').checked;
  
  const isReady = hasPid && hasEdu && hasGroup && hasModality && hasConsent;
  document.getElementById('begin').disabled = !isReady;
}

// Bind welcome screen inputs so the Continue button can enable
document.getElementById('pid').addEventListener('input', (e) => {
  // Sanitize input - remove special characters, limit length
  let value = e.target.value.replace(/[^a-zA-Z0-9_-]/g, '').substring(0, 20);
  e.target.value = value;
  state.pid = value.trim();
  checkWelcomeReady();
});

document.getElementById('edu').addEventListener('change', (e) => {
  state.edu = e.target.value;
  checkWelcomeReady();
});

document.querySelectorAll('input[name="participant-group"]').forEach((radio) => {
  radio.addEventListener('change', (e) => {
    state.participantGroup = e.target.value;
    // Reveal modality options and deaf note if applicable
    document.getElementById('modality-selection').classList.remove('hidden');
    const deafNote = document.getElementById('deaf-note');
    if (e.target.value.startsWith('deaf')) deafNote.classList.remove('hidden');
    else deafNote.classList.add('hidden');
    checkWelcomeReady();
  });
});

document.querySelectorAll('input[name="read-modality"]').forEach((radio) => {
  radio.addEventListener('change', (e) => {
    state.readModality = e.target.value;
    checkWelcomeReady();
  });
});

// Listen for consent changes to enable/disable Continue
document.getElementById('consent').addEventListener('change', checkWelcomeReady);

// Move from welcome to setup once all fields are ready
document.getElementById('begin').addEventListener('click', async () => {
  const beginBtn = document.getElementById('begin');
  if (beginBtn.disabled) return;
  
  // Prevent double-clicks
  beginBtn.disabled = true;
  
  try {
    // Hide welcome, show setup
    document.getElementById('screen-welcome').classList.add('hidden');
    document.getElementById('screen-setup').classList.remove('hidden');
    
    // Setup recording based on choices
    const recordingType = determineRecordingNeeds();
    
    document.getElementById('recording-method-text').textContent = 
      recordingType === 'video' 
        ? 'Setting up video recording for ASL...' 
        : 'Setting up audio recording for spoken responses...';
    
    let setupSuccess = false;
    
    if (recordingType === 'video') {
      document.getElementById('video-setup').classList.remove('hidden');
      document.getElementById('pref-hide-selfview').classList.remove('hidden');
      setupSuccess = await setupVideoRecording();
    } else {
      document.getElementById('audio-setup').classList.remove('hidden');
      setupSuccess = await setupAudioRecording();
    }
    
    if (setupSuccess) {
      document.getElementById('setup-status').className = 'status-box success';
      document.getElementById('setup-status-text').textContent = 'Setup complete! Ready to begin.';
      document.getElementById('start-study').disabled = false;
    } else {
      document.getElementById('setup-status').className = 'status-box error';
      document.getElementById('setup-status-text').textContent = 'Setup failed. Please check permissions and refresh.';
    }
  } catch (error) {
    console.error('Setup error:', error);
    document.getElementById('setup-status').className = 'status-box error';
    document.getElementById('setup-status-text').textContent = 'Setup failed. Please check permissions and refresh.';
  } finally {
    // Don't re-enable begin button after navigation
    // Only re-enable if there was an error and user is still on welcome screen
    if (!document.getElementById('screen-welcome').classList.contains('hidden')) {
      beginBtn.disabled = false;
    }
  }
});

// ADD THIS FUNCTION - It's being called but not defined!
function ensureMediaRecorder() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    throw new Error('mediaDevices unsupported');
  }
  if (!('MediaRecorder' in window)) {
    throw new Error('MediaRecorder unsupported');
  }
}

async function setupVideoRecording() {
  // Disable buttons during setup to prevent race conditions
  const startButton = document.getElementById('start-study');
  const beginButton = document.getElementById('begin');
  const originalStartState = startButton.disabled;
  
  startButton.disabled = true;
  beginButton.disabled = true;
  
  try {
    ensureMediaRecorder(); // capability check first

    // Clean up any existing stream
    if (state.stream) {
      state.stream.getTracks().forEach(track => track.stop());
    }
    
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' },
      audio: false
    });
    state.stream = stream;
    const preview = document.getElementById('preview');
    preview.srcObject = stream;

    const mime = pickMime('video');
    state.recordMime = mime || 'video/webm';
    state.mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : {});
    state.recordedChunks = [];
    state.mediaRecorder.ondataavailable = (e) => { 
      if (e.data.size > 0) state.recordedChunks.push(e.data); 
    };

    document.getElementById('video-status').textContent = 'Camera ready. You can see yourself above.';
    return true;
  } catch (err) {
    console.error('Video setup error:', err);
    const statusEl = document.getElementById('video-status');
    if (err && err.message === 'mediaDevices unsupported') {
      statusEl.textContent = 'This browser does not support camera access. Please use the latest Chrome, Edge, or Firefox.';
    } else if (err && err.message === 'MediaRecorder unsupported') {
      statusEl.textContent = 'Recording is not supported in this browser. Please use the latest Chrome, Edge, or Firefox.';
    } else if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
      statusEl.textContent = 'Camera permission is blocked. Please allow camera access in your browser settings and retry.';
    } else if (err && (err.name === 'NotFoundError' || err.name === 'OverconstrainedError')) {
      statusEl.textContent = 'No camera was found or it is in use by another app. Please check your device and try again.';
    } else {
      statusEl.textContent = 'Error: Could not access camera. Please check permissions.';
    }
    return false;
  } finally {
    // Re-enable buttons after setup completes
    startButton.disabled = originalStartState;
    beginButton.disabled = false;
  }
}

async function setupAudioRecording() {
  // Disable buttons during setup to prevent race conditions
  const startButton = document.getElementById('start-study');
  const beginButton = document.getElementById('begin');
  const testRecordButton = document.getElementById('test-audio-record');
  const originalStartState = startButton.disabled;
  
  startButton.disabled = true;
  beginButton.disabled = true;
  testRecordButton.disabled = true;
  
  try {
    ensureMediaRecorder(); // capability check first

    // Clean up any existing stream
    if (state.stream) {
      state.stream.getTracks().forEach(track => track.stop());
    }
    
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: true, noiseSuppression: true }
    });
    state.stream = stream;

    const mime = pickMime('audio');
    state.recordMime = mime || 'audio/webm';
    state.mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : {});
    state.recordedChunks = [];
    state.mediaRecorder.ondataavailable = (e) => { 
      if (e.data.size > 0) state.recordedChunks.push(e.data); 
    };

    document.getElementById('audio-status').textContent = 'Microphone ready. Test your audio above.';
    return true;
  } catch (err) {
    console.error('Audio setup error:', err);
    const statusEl = document.getElementById('audio-status');
    if (err && err.message === 'mediaDevices unsupported') {
      statusEl.textContent = 'This browser does not support microphone access. Please use the latest Chrome, Edge, or Firefox.';
    } else if (err && err.message === 'MediaRecorder unsupported') {
      statusEl.textContent = 'Recording is not supported in this browser. Please use the latest Chrome, Edge, or Firefox.';
    } else if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
      statusEl.textContent = 'Microphone permission is blocked. Please allow microphone access in your browser settings and retry.';
    } else if (err && (err.name === 'NotFoundError' || err.name === 'OverconstrainedError')) {
      statusEl.textContent = 'No microphone was found or it is in use by another app. Please check your device and try again.';
    } else {
      statusEl.textContent = 'Error: Could not access microphone. Please check permissions.';
    }
    return false;
  } finally {
    // Re-enable buttons after setup completes
    startButton.disabled = originalStartState;
    beginButton.disabled = false;
    testRecordButton.disabled = false;
  }
}

/* ===========================
   Core Functions
   =========================== */
function buildSequence() {
  const gradeNum = state.edu === "13+" ? 13 : parseInt(state.edu);
  
  const sortedTrials = TRIALS.slice().sort((a, b) => a.item - b.item);
  
  if (gradeNum >= 9) {
    const startIdx = sortedTrials.findIndex(t => t.item === 94);
    if (startIdx >= 0) {
      state.sequence = sortedTrials.slice(startIdx);
    } else {
      state.sequence = sortedTrials;
    }
  } else {
    state.sequence = sortedTrials;
  }
  
  debugLog(`Built sequence with ${state.sequence.length} items for grade ${state.edu}`);
}

async function showItem() {
  if (state.currentIndex >= state.sequence.length) {
    finishAssessment();
    return;
  }
  
  // WIAT-2 discontinue rule
  if (state.consecutiveZeros >= DISCONTINUE_AFTER_ZEROS) {
    finishAssessment();
    return;
  }
  
  const trial = state.sequence[state.currentIndex];

  // Fire-and-forget to prevent blocking UI on slow networks
  sendEventSafely('item_started', {
    sessionId: SESSION_ID,
    pid: state.pid,
    edu: state.edu,
    participantGroup: state.participantGroup,
    readModality: state.readModality,
    itemNumber: trial.item,
    imageFile: trial.image,
    questionText: trial.questions ? trial.questions[0].text : '',
    itemType: trial.type
  }).catch(() => {});

  // Immediately render the item
  showScreen('item');
  updateAdminPanel();
  
  // CHANGED: Only show item number without position
  document.getElementById('actual-item-number').textContent = trial.item;
  document.getElementById('stim').src = `stimuli/${trial.image}`;
  
  // Reset form and controls
  document.getElementById('qa-form').classList.add('hidden');
  document.getElementById('qa-fields').innerHTML = '';
  document.getElementById('timer').textContent = '00:00';
  document.getElementById('timer-container').classList.add('hidden');
  
  // Hide all controls initially
  document.getElementById('recording-controls').classList.add('hidden');
  document.getElementById('reading-controls').classList.add('hidden');
  document.getElementById('read-aloud-instructions').classList.add('hidden');
  
  // Reset button states
  document.getElementById('start-reading').classList.remove('hidden');
  document.getElementById('done-reading').classList.add('hidden');
  document.getElementById('start-recording').classList.remove('hidden');
  document.getElementById('stop-recording').classList.add('hidden');
  
  const instruction = trial.instruction || '';
  document.getElementById('instruction-text').textContent = instruction;
  
  // Clear any existing timers
  clearAllTimers();
  
  // Handle different item types
  if (trial.readAloud) {
    // This is a read-aloud item
    const instructions = getReadAloudInstructions();
    document.getElementById('read-aloud-title').textContent = instructions.title;
    document.getElementById('read-aloud-text').textContent = instructions.text;
    document.getElementById('read-aloud-instructions').classList.remove('hidden');
    document.getElementById('recording-controls').classList.remove('hidden');
    document.getElementById('start-recording').textContent = instructions.buttonText;
  } else if (trial.skipReading) {
    // Question only, no reading needed
    showQuestions(0);
  } else {
    // Standard silent reading passage
    document.getElementById('reading-controls').classList.remove('hidden');
    document.getElementById('start-reading').classList.remove('hidden');
    document.getElementById('done-reading').classList.add('hidden');
  }
  
  state.itemStartTime = Date.now();
}
// Helper to pick a recorder mime type the browser actually supports
function pickMime(kind){
  const c = kind === 'video'
    ? [
        'video/webm;codecs=vp8',
        'video/webm',
        // Safari resilience
        'video/mp4;codecs=h264'
      ]
    : [
        'audio/webm;codecs=opus',
        'audio/webm',
        'audio/ogg',
        // Safari resilience
        'audio/mp4'
      ];
  return c.find(t => window.MediaRecorder && MediaRecorder.isTypeSupported(t)) || '';
}


function showQuestions(readingTime) {
  const trial = state.sequence[state.currentIndex];
  if (trial.skipScoring) {
    state.currentIndex++;
    showItem();
    return;
  }

  const form = document.getElementById('qa-form');
  const fields = document.getElementById('qa-fields');
  form.classList.remove('hidden');
  document.getElementById('reading-controls').classList.add('hidden');
  document.getElementById('recording-controls').classList.add('hidden');
  document.getElementById('read-aloud-instructions').classList.add('hidden');

  // Clear existing
  fields.innerHTML = '';

  // Add a participant-friendly tip only once per item
  const tip = document.createElement('div');
  tip.className = 'tip-box';
  tip.id = 'answer-tips';
  tip.innerHTML = `
    <div><strong>Answer tips</strong></div>
    <ul>
      <li>Type in your own words. <em>Spelling and grammar don't matter.</em></li>
      <li>Short answers are okay (a sentence or two).</li>
      <li>If you're unsure, write your best guess.</li>
      <li>You can use ASL gloss if that's easier.</li>
      <li>You can skip any question.</li>
      <li><span class="kbd">Ctrl/⌘ + Enter</span> = Submit, <span class="kbd">Alt + S</span> = Skip</li>
    </ul>
  `;
  fields.appendChild(tip);

  // Build question fields
  trial.questions.forEach(q => {
    const qDiv = document.createElement('div');
    qDiv.className = 'q-block';

    const label = document.createElement('label');
    label.textContent = q.text;
    label.setAttribute('for', q.id);

    const textarea = document.createElement('textarea');
    textarea.id = q.id;
    textarea.name = q.id;
    // Align with Skip: do not require text entry
    textarea.required = false;
    // Participant-friendly typing settings
    textarea.placeholder = 'Type your answer here (short is fine)';
    textarea.setAttribute('spellcheck', 'false');
    textarea.setAttribute('autocapitalize', 'off');
    textarea.setAttribute('autocorrect', 'off');
    textarea.setAttribute('aria-describedby', 'answer-tips');

    // Optional tiny word count (non-judgmental)
    const wc = document.createElement('div');
    wc.className = 'muted';
    wc.style.marginTop = '6px';
    wc.textContent = 'Word count: 0 (no minimum)';
    textarea.addEventListener('input', () => {
      const n = textarea.value.trim() ? textarea.value.trim().split(/\s+/).length : 0;
      wc.textContent = `Word count: ${n} (no minimum)`;
    });

    qDiv.appendChild(label);
    qDiv.appendChild(textarea);
    qDiv.appendChild(wc);
    fields.appendChild(qDiv);
  });

  // Friendlier skip label each time this view shows
  const skipBtn = document.getElementById('skip');
  if (skipBtn) skipBtn.textContent = 'Skip question';

  // Keyboard shortcuts
  form.onkeydown = (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      form.requestSubmit();
    } else if (e.altKey && e.key.toLowerCase() === 's') {
      e.preventDefault();
      document.getElementById('skip').click();
    }
  };
}


  /* ===========================
   Semantic scoring helpers - universal
   =========================== */
const STOPWORDS = new Set(['a','an','the','of','to','in','on','for','with','and','or','but','is','are','was','were','be','been','being','as','by','from','that','this','those','these','it','its','at','which','who','whom','what','why','how','do','does','did','so','very','really','just','about','into','over','under','up','down','out','off','than','then','there','their','them','they','you','your']);

const NUMBER_WORDS = new Map([
  ['zero','0'], ['one','1'], ['two','2'], ['three','3'], ['four','4'],
  ['five','5'], ['six','6'], ['seven','7'], ['eight','8'], ['nine','9'],
  ['ten','10'], ['eleven','11'], ['twelve','12']
]);

// REPLACE normalizeText with this merged version
function normalizeText(t) {
  t = String(t || '').toLowerCase();
  // unify quotes
  t = t.replace(/[\u2018\u2019]/g, "'").replace(/[\u201C\u201D]/g, '"');

  // expand only true contractions (avoid turning possessives into "is")
  t = t
    .replace(/\bwon't\b/g, 'will not')
    .replace(/\bcan't\b/g, 'cannot')
    .replace(/n't\b/g, ' not')
    .replace(/\bI'm\b/gi, 'I am')
    .replace(/\byou're\b/gi, 'you are')
    .replace(/\bwe're\b/gi, 'we are')
    .replace(/\bthey're\b/gi, 'they are')
    .replace(/\bI've\b/gi, 'I have')
    .replace(/\bwe've\b/gi, 'we have')
    .replace(/\bthey've\b/gi, 'they have')
    .replace(/\bI'll\b/gi, 'I will')
    .replace(/\byou'll\b/gi, 'you will')
    .replace(/\bwe'll\b/gi, 'we will')
    .replace(/\bthey'll\b/gi, 'they will');

  // strip punctuation (keep digits/letters/spaces)
  t = t.replace(/[.,!?;:"`']/g, ' ').replace(/\s+/g, ' ').trim();
  return t;
}

function simpleStem(w) {
  if (!w) return w;
  // light stem rules; do NOT eat short words like "is"
  if (w.length > 3) {
    if (w.endsWith('ies')) return w.slice(0, -3) + 'y';
    if (/(ing|ed|ly|ers|er|est)$/.test(w)) return w.replace(/(ing|ed|ly|ers|er|est)$/,'');

    // Also handle plural "s" correctly
    if (w.endsWith('s') && !w.endsWith('ss') && !w.endsWith('us')) return w.slice(0, -1);
  }
  return w;
}

function tokenize(t) {
  const norm = normalizeText(t);
  const raw = norm.split(' ').map(w => NUMBER_WORDS.get(w) || w);
  const filtered = raw.filter(w => w && !STOPWORDS.has(w));
  const stemmed = filtered.map(simpleStem);
  return { tokens: stemmed, joined: ' ' + stemmed.join(' ') + ' ' };
}

function patternToTokenSet(pat) {
  const src = pat instanceof RegExp ? pat.source : String(pat || '');
  // strip common regex meta so alternations like (foo|bar) become tokens
  const deRegex = src.replace(/[\\^$.*+?()[\]{}|]/g, ' ');
  const parts = normalizeText(deRegex).split(' ');
  const toks = parts.map(simpleStem).filter(Boolean);
  return new Set(toks);
}

function tokenSetSatisfied(respTokens, tokenSet) {
  if (!tokenSet || tokenSet.size === 0) return { hits: 0, need: 0 };
  let hits = 0;
  for (const tok of tokenSet) if (respTokens.includes(tok)) hits++;
  return { hits, need: tokenSet.size };
}


  // --- Simple response quality + review helpers (used in submitAnswers) ---
function checkKeywords(response, scoringKey) {
  // Heuristic: does the response hit some tokens from any pattern in SCORING_REFERENCE?
  const scoring = SCORING_REFERENCE[scoringKey];
  if (!scoring) return false;
  const { tokens } = tokenize(response);

  const sets = [];
  const addSets = (bucket) => {
    if (bucket && Array.isArray(bucket.patterns)) {
      bucket.patterns.forEach(p => sets.push(patternToTokenSet(p)));
    }
  };
  addSets(scoring.twoPoint);
  addSets(scoring.onePoint);

  return sets.some(set => {
    let hits = 0;
    set.forEach(tok => { if (tokens.includes(tok)) hits++; });
    return hits >= Math.max(1, Math.ceil(set.size * 0.4)); // ~40% overlap counts as "has relevant keywords"
  });
}

function detectASLGloss(response) {
  const raw = String(response || '');
  const words = raw.trim().split(/\s+/);
  const upperFrac = words.length ? words.filter(w => /^[A-Z0-9-]{2,}$/.test(w)).length / words.length : 0;
  return upperFrac > 0.3; // Return true if >30% of words look like ASL gloss
}

/* ===========================
   Form Submission & Scoring
   =========================== */
async function submitAnswers(e) {
  e.preventDefault();
  
  const trial = state.sequence[state.currentIndex];
  const itemResult = {
    item: trial.item,
    image: trial.image,
    type: trial.type,
    readingTime: state.readingStartTime ? Date.now() - state.readingStartTime : 0,
    responses: {},
    scores: {},
    totalScore: 0,
    timestamp: new Date().toISOString()
  };
  
  // Collect responses and score them
  let itemScore = 0;
  for (const q of trial.questions) {
    const response = document.getElementById(q.id).value.trim();
    itemResult.responses[q.id] = response;
    
    // Auto-score if scoring key exists
    if (q.scoringKey && SCORING_REFERENCE[q.scoringKey]) {
      const score = scoreResponse(response, q.scoringKey);
      itemResult.scores[q.id] = score;
      itemScore = Math.max(itemScore, score); // Take highest score for item
    }
  }
  
  itemResult.totalScore = itemScore;
  state.results.push(itemResult);
  
  // Always update local state first
  state.totalPoints += itemScore;
  if (itemScore === 0) {
    state.consecutiveZeros++;
  } else {
    state.consecutiveZeros = 0;
  }
  
  // Prepare data for Google Apps Script
  const gasData = {
    itemNumber: trial.item,
    imageFile: trial.image,
    questionText: trial.questions ? trial.questions[0].text : '',
    itemType: trial.type,
    response: Object.values(itemResult.responses).join(' | '),
    explanation: '',
    autoScore: itemScore,
    scoreConfidence: itemScore > 0 ? 'High' : 'Low',
    // Flag for manual review if no points were awarded but at least one response
    // contains more than 10 characters. This helps catch potentially valid
    // answers that our heuristic auto-scorer missed.
    needsReview: itemScore === 0 &&
                 Object.values(itemResult.responses).some(r => r.length > 10),
    scoringNotes: `Auto-scored: ${itemScore}`,
    finalScore: itemScore,
    duration: Math.round((Date.now() - state.itemStartTime) / 1000),
    endTime: new Date().toISOString(),
    consecutiveZeros: state.consecutiveZeros
  };
  
  // Try to send to Google
  try {
    await sendEventSafely('item_completed', gasData);
    updateConnectionStatus(true);
  } catch (error) {
    console.warn('Failed to send item to Google, continuing locally:', error);
    updateConnectionStatus(false);
    const live = document.getElementById('sr-live');
    if (live) live.textContent = 'Network issue: response saved locally. You can continue.';
  }
  
  // Always move to next item
  state.currentIndex++;
  showItem();
}

function scoreResponse(response, scoringKey) {
  if (!response || !response.trim()) return 0;
  
  const scoring = SCORING_REFERENCE[scoringKey];
  if (!scoring) return 0;
  
  const norm = normalizeText(response);
  
  // Check 2-point patterns
  if (scoring.twoPoint && scoring.twoPoint.patterns) {
    for (const pattern of scoring.twoPoint.patterns) {
      if (pattern.test(norm)) return 2;
    }
  }
  
  // Check 1-point patterns
  if (scoring.onePoint && scoring.onePoint.patterns) {
    for (const pattern of scoring.onePoint.patterns) {
      if (pattern.test(norm)) return 1;
    }
  }
  
  // Check semantic scoring if available
  if (scoring.semantic) {
    const { tokens } = tokenize(response);
    
    // Check full credit
    if (scoring.semantic.full) {
      let matches = 0;
      for (const conceptGroup of scoring.semantic.full) {
        const concepts = Array.isArray(conceptGroup) ? conceptGroup : [conceptGroup];
        if (concepts.some(concept => {
          const conceptTokens = tokenize(concept).tokens;
          return conceptTokens.every(t => tokens.includes(t));
        })) {
          matches++;
        }
      }
      if (matches >= (scoring.semantic.full.length === 2 ? 2 : 1)) return 2;
      if (matches >= 1) return 1;
    }
    
    // Check partial credit
    if (scoring.semantic.partial) {
      if (scoring.semantic.partial.some(term => tokens.includes(simpleStem(term)))) {
        return 1;
      }
    }
  }
  
  return 0;
}

/* ===========================
   UI Functions
   =========================== */
function showScreen(screen) {
  document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
  document.getElementById(`screen-${screen}`).classList.remove('hidden');
}

function updateAdminPanel() {
  if (!state.adminMode) return;
  document.getElementById('admin-group').textContent = state.participantGroup || '-';
  document.getElementById('admin-item').textContent = (state.sequence[state.currentIndex] && state.sequence[state.currentIndex].item) || '-';
  document.getElementById('admin-score').textContent = state.totalPoints;
  document.getElementById('admin-zeros').textContent = state.consecutiveZeros;
  document.getElementById('admin-status').textContent =
    state.consecutiveZeros >= DISCONTINUE_AFTER_ZEROS ? 'Discontinue' : 'Active';
}

/* ===========================
   Timer Functions
   =========================== */
function clearAllTimers() {
  Object.keys(state.timers).forEach((key) => {
    if (state.timers[key]) {
      clearInterval(state.timers[key]);
      state.timers[key] = null;
    }
  });
}

function startTimer() {
  state.readingStartTime = Date.now();
  let seconds = 0;
  const timerEl = document.getElementById('timer');
  const container = document.getElementById('timer-container');

  if (!document.getElementById('pref-hide-timer').checked) {
    container.classList.remove('hidden');
  }

  // Use centralized reading timer
  state.timers.reading = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }, 1000);
}

function stopTimer() {
  if (state.timers.reading) {
    clearInterval(state.timers.reading);
    state.timers.reading = null;
  }
}

/* ===========================
   Assessment Flow
   =========================== */
async function startAssessment() {
  state.sessionStartTime = Date.now();
  buildSequence();

  // Send session start with correct field names for GAS
  await sendEventSafely('session_started', {
    education: state.edu, // GAS expects 'education'
    participantGroup: state.participantGroup,
    readModality: state.readModality,
    totalItems: state.sequence.length,
    adminMode: state.adminMode,
    hasRecording: state.useVideoRecording || state.useAudioRecording,
    userAgent: navigator.userAgent,
    ipAddress: '' // Will be filled by GAS if needed
  });

  state.currentIndex = 0;
  showItem();
}

async function finishAssessment() {
  // Clean up resources first
  cleanupResources();
  
  showScreen('finish');
  
  const sessionData = {
    pid: state.pid,
    education: state.edu, // Will be mapped to 'education' in sendEventSafely
    participantGroup: state.participantGroup,
    readModality: state.readModality,
    sessionStartTime: state.sessionStartTime,
    sessionEndTime: Date.now(),
    duration: Math.round((Date.now() - state.sessionStartTime) / 60000),
    totalPoints: state.totalPoints,
    itemsCompleted: state.results.length,
    consecutiveZeros: state.consecutiveZeros,
    discontinued: state.consecutiveZeros >= DISCONTINUE_AFTER_ZEROS,
    gateItemsFailed: state.gateItemsFailed.join(', '),
    results: state.results
  };
  
  // Save locally first
  state.savedData = sessionData;
  localStorage.setItem(`wiat2_${state.pid}_${Date.now()}`, JSON.stringify(sessionData));
  
  // Try to upload (Google-first, then backup)
  document.getElementById('upload-progress').textContent = 'Uploading your results...';
  const ok = await sendEventSafely('session_completed', sessionData);

  if (ok) {
    document.getElementById('upload-status').className = 'status-box success';
    document.getElementById('upload-progress').textContent = 'Results uploaded successfully!';
    
    // Show stats
    document.getElementById('final-stats').classList.remove('hidden');
    document.getElementById('stats-content').innerHTML = `
      <p>Items completed: ${state.results.length}</p>
      <p>Total score: ${state.totalPoints}</p>
      <p>Session duration: ${Math.round((sessionData.sessionEndTime - sessionData.sessionStartTime) / 60000)} minutes</p>
    `;
  } else {
    document.getElementById('upload-status').className = 'status-box error';
    document.getElementById('upload-progress').textContent = 'Upload failed. Your data is saved locally.';
    document.getElementById('retry-upload').classList.remove('hidden');
    document.getElementById('download-backup').classList.remove('hidden');
  }
}

// Add cleanup function if it doesn't exist
function cleanupResources() {
  // Stop all timers
  clearAllTimers();
  
  // Stop any active media streams
  if (state.stream) {
    state.stream.getTracks().forEach(track => track.stop());
    state.stream = null;
  }
  
  // Stop any active recording
  if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
    state.mediaRecorder.stop();
  }
}

// Before-unload cleanup & “unsaved” prompt
window.addEventListener('beforeunload', (e) => {
  try { cleanupResources(); } catch (_) {}
  if (state.results.length && !state.savedData) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// Add event listeners for buttons that might be missing
document.addEventListener('DOMContentLoaded', () => {
  // ADD THIS: Show keyboard shortcuts on focus
  const keyboardHelp = document.createElement('div');
  keyboardHelp.innerHTML = `
      <div style="position: fixed; bottom: 20px; right: 20px; 
                  background: white; padding: 10px; border-radius: 8px; 
                  box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 12px;
                  display: none; z-index: 1000;" id="keyboard-help">
          <strong>Keyboard shortcuts:</strong><br>
          Tab = Navigate<br>
          Enter = Select<br>
          Ctrl+Enter = Submit<br>
          Alt+S = Skip<br>
          Alt+A = Admin panel
      </div>
  `;
  document.body.appendChild(keyboardHelp);
  
  // Show help when user presses ?
  document.addEventListener('keydown', (e) => {
      if (e.key === '?') {
          const help = document.getElementById('keyboard-help');
          help.style.display = help.style.display === 'none' ? 'block' : 'none';
      }
  });
  
  // Start Study button
  const startStudyBtn = document.getElementById('start-study');
  if (startStudyBtn) {
    startStudyBtn.addEventListener('click', startAssessment);
  }
  
  // Start/Done Reading buttons
  const startReadingBtn = document.getElementById('start-reading');
  if (startReadingBtn) {
    startReadingBtn.addEventListener('click', () => {
      startTimer();
      startReadingBtn.classList.add('hidden');
      document.getElementById('done-reading').classList.remove('hidden');
    });
  }
  
  const doneReadingBtn = document.getElementById('done-reading');
  if (doneReadingBtn) {
    doneReadingBtn.addEventListener('click', () => {
      stopTimer();
      const readingTime = Date.now() - state.readingStartTime;
      showQuestions(readingTime);
    });
  }
  
  // Recording buttons
  const startRecordingBtn = document.getElementById('start-recording');
  if (startRecordingBtn) {
    startRecordingBtn.addEventListener('click', startRecording);
  }
  
  const stopRecordingBtn = document.getElementById('stop-recording');
  if (stopRecordingBtn) {
    stopRecordingBtn.addEventListener('click', stopRecording);
  }
  
  // Form submission
  const qaForm = document.getElementById('qa-form');
  if (qaForm) {
    qaForm.addEventListener('submit', submitAnswers);
  }
  
  // Skip button
  const skipBtn = document.getElementById('skip');
  if (skipBtn) {
    skipBtn.addEventListener('click', () => {
      // Send skip event to Google Apps Script
      sendEventSafely('item_skipped', {
        itemNumber: state.sequence[state.currentIndex].item,
        imageFile: state.sequence[state.currentIndex].image,
        questionText: (state.sequence[state.currentIndex].questions && state.sequence[state.currentIndex].questions[0] && state.sequence[state.currentIndex].questions[0].text) || '',
        itemType: state.sequence[state.currentIndex].type,
        reason: 'User choice',
        consecutiveZeros: state.consecutiveZeros + 1
      });
      
      state.consecutiveZeros++;
      state.currentIndex++;
      showItem();
    });
  }
  
  // Retry upload button
  const retryBtn = document.getElementById('retry-upload');
  if (retryBtn) {
    retryBtn.addEventListener('click', async () => {
      retryBtn.disabled = true;
      document.getElementById('upload-progress').textContent = 'Retrying upload...';
      
      const ok = await sendEventSafely('session_completed', state.savedData);
      
      if (ok) {
        document.getElementById('upload-status').className = 'status-box success';
        document.getElementById('upload-progress').textContent = 'Results uploaded successfully!';
        retryBtn.classList.add('hidden');
      } else {
        document.getElementById('upload-progress').textContent = 'Upload failed again. Please download backup.';
        retryBtn.disabled = false;
      }
    });
  }
  
  // Download backup button
  const downloadBtn = document.getElementById('download-backup');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(state.savedData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `wiat2_${state.pid}_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }
  
  // Audio test setup
  const testAudioBtn = document.getElementById('test-audio-record');
  const stopTestBtn = document.getElementById('stop-test-audio');
  if (testAudioBtn && stopTestBtn) {
    setupAudioTest(testAudioBtn, stopTestBtn);
  }
});

// ---------- Utilities ----------
function timeout(ms) {
  return new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), ms));
}

async function postWithTimeout(url, body, timeoutMs, asForm=false) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  
  try {
    console.log(`POST request to: ${url}`);
    
    // Add no-cors mode for Google Apps Script if needed
    const fetchOptions = {
      method: 'POST',
      mode: url.includes('script.google.com') ? 'no-cors' : 'cors',
      headers: asForm ? {} : { 'Content-Type': 'application/json' },
      body: asForm ? body : JSON.stringify(body),
      signal: ctrl.signal
    };
    
    const res = await fetch(url, fetchOptions);
    clearTimeout(t);
    
    // Handle no-cors mode (Google Apps Script returns opaque response)
    if (fetchOptions.mode === 'no-cors') {
      console.log('Google Apps Script request sent (no-cors mode, response opaque)');
      return {}; // Can't read response in no-cors mode, assume success
    }
    
    if (!res.ok) throw new Error('bad status ' + res.status);
    return await res.json().catch(() => ({}));
  } catch (error) {
    clearTimeout(t);
    if (error.name === 'AbortError') {
      throw new Error(`Request timeout after ${timeoutMs}ms`);
    }
    throw error;
  }
}

// Update the bottom-left connection chip
function updateConnectionStatus(connected) {
  const el = document.getElementById('connection-status');
  const txt = document.getElementById('connection-text');
  if (!el || !txt) return;
  if (connected) {
    el.classList.remove('error');
    el.classList.add('connected');
    txt.textContent = 'Connected';
  } else {
    el.classList.remove('connected');
    el.classList.add('error');
    txt.textContent = 'Offline (saved locally)';
  }
}

// Try Google first, then backup, then give up (return false)
async function sendEventSafely(kind, payload) {
  // Map frontend events to Google Apps Script actions
  const actionMap = {
    'session_started': 'session_start',
    'item_started': 'item_started',
    'item_completed': 'item_completed',
    'session_completed': 'session_complete',
    'media_upload': 'video_upload'
  };
  
  // Prepare payload for Google Apps Script
  const gasPayload = {
    action: actionMap[kind] || kind,
    sessionId: SESSION_ID,
    pid: state.pid,
    education: state.edu, // Note: GAS expects 'education' not 'edu'
    timestamp: new Date().toISOString(),
    ...payload
  };
  
  // Remove duplicate fields
  delete gasPayload.kind;
  delete gasPayload.edu;
  
  // Special handling for media uploads
  if (kind === 'media_upload' && payload instanceof FormData) {
    // Convert FormData to base64 for Google Apps Script
    try {
      const mediaBlob = payload.get('media');
      if (mediaBlob) {
        const arrayBuffer = await mediaBlob.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
        
        gasPayload.videoData = base64;
        gasPayload.itemNumber = payload.get('itemNumber');
        gasPayload.sessionDate = new Date().toISOString().split('T')[0];
      }
    } catch (err) {
      console.error('Failed to convert media to base64:', err);
      return false;
    }
  }

  console.log(`Attempting to send ${kind} to server...`);
  
  try {
    // Google Apps Script expects POST with JSON body
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors', // GAS doesn't support CORS
      headers: {
        'Content-Type': 'text/plain' // GAS prefers text/plain for CORS workaround
      },
      body: JSON.stringify(gasPayload)
    });
    
    console.log(`Successfully sent ${kind} to Google Apps Script`);
    updateConnectionStatus(true);
    return true;
  } catch (error) {
    console.error(`Failed to send to Google Apps Script:`, error);
    
    // Try backup endpoint if available
    if (GITHUB_BACKUP_URL && GITHUB_BACKUP_URL !== 'https://readingcomp-f3ii59o6j-melodys-projects-8b5cbe18.vercel.app/') {
      console.log(`Attempting backup endpoint...`);
      try {
        const backupResponse = await fetch(GITHUB_BACKUP_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (backupResponse.ok) {
          console.log(`Successfully sent ${kind} to backup endpoint`);
          updateConnectionStatus(true);
          return true;
        }
      } catch (e2) {
        console.error(`Failed to send to backup endpoint:`, e2);
      }
    }
    
    updateConnectionStatus(false);
    return false;
  }
}



// Add connection test on page load
window.addEventListener('DOMContentLoaded', async () => {
  // Test connection to Google Apps Script
  console.log('Testing connection to Google Apps Script...');
  try {
    const testPayload = { test: true, timestamp: Date.now() };
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors', // Google Apps Script doesn't support CORS
      body: JSON.stringify(testPayload)
    });
    console.log('Google Apps Script connection test completed');
    updateConnectionStatus(true);
  } catch (error) {
    console.error('Google Apps Script connection test failed:', error);
    updateConnectionStatus(false);
    
    // Show warning if Google Script is not accessible
    const warn = document.getElementById('config-warning');
    if (warn) {
      warn.classList.remove('hidden');
      warn.querySelector('.status-message').innerHTML = `
        <strong>Connection Issue:</strong> Cannot reach Google Apps Script. 
        Data will be saved locally and to backup endpoint if available.
        <br><small>URL: ${GOOGLE_SCRIPT_URL}</small>
      `;
    }
  }
  
  // Test backup endpoint
  if (GITHUB_BACKUP_URL && GITHUB_BACKUP_URL !== 'https://readingcomp-f3ii59o6j-melodys-projects-8b5cbe18.vercel.app/') {
    console.log('Testing backup endpoint...');
    try {
      const response = await fetch(GITHUB_BACKUP_URL, {
        method: 'GET', // Test with GET first
        mode: 'cors'
      });
      console.log('Backup endpoint accessible');
    } catch (error) {
      console.error('Backup endpoint test failed:', error);
    }
  }
});

// ---------- Recording (read-aloud) ----------
let recTimerSec = 0;
function startRecording() {
  if (!state.mediaRecorder) {
    alert('Recorder not ready. Please go back to Setup.');
    return;
  }
  state.recordedChunks = [];
  try {
    state.mediaRecorder.start(200); // gather chunks
  } catch (e) {
    alert('Could not start recording in this browser.');
    return;
  }
  // UI
  document.getElementById('rec-indicator').classList.remove('hidden');
  document.getElementById('recording-timer').classList.remove('hidden');
  document.getElementById('start-recording').classList.add('hidden');
  document.getElementById('stop-recording').classList.remove('hidden');

  // Timer
  recTimerSec = 0;
  const tEl = document.getElementById('recording-timer');
  tEl.textContent = '00:00';
  state.timers.recording = setInterval(() => {
    recTimerSec++;
    const m = String(Math.floor(recTimerSec/60)).padStart(2,'0');
    const s = String(recTimerSec%60).padStart(2,'0');
    tEl.textContent = `${m}:${s}`;
  }, 1000);
}

async function stopRecording() {
  try { if (state.mediaRecorder && state.mediaRecorder.state === 'recording') state.mediaRecorder.stop(); } catch (_) {}
  if (state.timers.recording) { clearInterval(state.timers.recording); state.timers.recording = null; }

  // UI
  document.getElementById('rec-indicator').classList.add('hidden');
  document.getElementById('recording-timer').classList.add('hidden');
  document.getElementById('stop-recording').classList.add('hidden');

  // Wait one tick for last dataavailable
  await new Promise(r => setTimeout(r, 100));

  const mime = state.recordMime || (state.useVideoRecording ? 'video/webm' : 'audio/webm');
  const ext  = mime.includes('mp4') ? 'mp4' : (mime.startsWith('audio/') ? 'webm' : 'webm');
  const trial = state.sequence[state.currentIndex];

  const blob = new Blob(state.recordedChunks, { type: mime });
  state.recordedChunks = [];

  // Try to upload
  const fd = new FormData();
  fd.append('pid', state.pid);
  fd.append('edu', state.edu);
  fd.append('participantGroup', state.participantGroup);
  fd.append('readModality', state.readModality);
  fd.append('itemNumber', String(trial.item));
  fd.append('mime', mime);
  const fname = `${state.pid || 'anon'}_item${trial.item}_${Date.now()}.${ext}`;
  fd.append('fileName', fname);
  fd.append('media', blob, fname);

  const ok = await sendEventSafely('media_upload', fd);
  if (!ok) {
    // Fallback: client-side download so nothing is lost
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    const live = document.getElementById('sr-live');
    if (live) live.textContent = 'Network issue: recording saved to your device.';
  }

  // Read-aloud items are non-scored → advance
  state.currentIndex++;
  showItem();
}

// ---------- Audio Test ----------
function setupAudioTest(btnStart, btnStop) {
  const timerEl = document.getElementById('test-audio-timer');
  const pb = document.getElementById('test-audio-playback');
  let testChunks = [];
  let testRecorder = null;

  btnStart.addEventListener('click', () => {
    if (!state.stream) { alert('Microphone not initialized.'); return; }
    testChunks = [];
    try {
      const mime = pickMime('audio') || 'audio/webm';
      testRecorder = new MediaRecorder(state.stream, mime ? { mimeType: mime } : {});
    } catch (e) { alert('Audio recording not supported here.'); return; }

    testRecorder.ondataavailable = (e) => { if (e.data.size) testChunks.push(e.data); };
    testRecorder.start(200);

    // UI
    btnStart.classList.add('hidden');
    btnStop.classList.remove('hidden');
    timerEl.classList.remove('hidden');
    testTimerSec = 0;
    timerEl.textContent = '00:00';
    state.timers.test = setInterval(() => {
      testTimerSec++;
      const m = String(Math.floor(testTimerSec/60)).padStart(2,'0');
      const s = String(testTimerSec%60).padStart(2,'0');
      timerEl.textContent = `${m}:${s}`;
    }, 1000);
  });

  btnStop.addEventListener('click', () => {
    try { if (testRecorder && testRecorder.state === 'recording') testRecorder.stop(); } catch (_) {}
    if (state.timers.test) { clearInterval(state.timers.test); state.timers.test = null; }
    btnStop.classList.add('hidden');
    btnStart.classList.remove('hidden');
    timerEl.classList.add('hidden');

    setTimeout(() => {
      const blob = new Blob(testChunks, { type: state.recordMime || 'audio/webm' });
      pb.src = URL.createObjectURL(blob);
      pb.classList.remove('hidden');
      document.getElementById('audio-status').textContent = 'Test recorded. Play it back to confirm.';
    }, 50);
  });
}

// ---------- Optional: keyboard to toggle admin panel ----------
window.addEventListener('keydown', (e) => {
  if (e.altKey && e.key.toLowerCase() === 'a') {
    state.adminMode = !state.adminMode;
    document.body.classList.toggle('admin-mode', state.adminMode);
    updateAdminPanel();
  }
});
</script>
