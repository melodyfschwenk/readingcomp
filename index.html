<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WIAT-2 Reading Comprehension Study</title>
<style>
  body { 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; 
    margin: 0; 
    background: #f8f9fa; 
    color: #212529; 
  }
  .wrap { 
    max-width: 900px; 
    margin: 0 auto; 
    padding: 20px; 
  }
  .card { 
    background: #fff; 
    border: 1px solid #dee2e6; 
    border-radius: 4px; 
    padding: 20px; 
    margin: 12px 0; 
  }
  h1 { 
    font-size: 1.5rem; 
    margin: 0 0 12px; 
    font-weight: 400; 
  }
  h2 { 
    font-size: 1.25rem; 
    margin: 0 0 12px; 
    font-weight: 400; 
  }
  .row { 
    display: flex; 
    gap: 12px; 
    flex-wrap: wrap; 
    margin: 12px 0; 
  }
  .row > * { 
    flex: 1 1 auto; 
    min-width: 200px; 
  }
  label { 
    display: block; 
    margin: 8px 0 4px; 
    font-size: 14px; 
  }
  input[type="text"], textarea, select { 
    width: 100%; 
    border: 1px solid #ced4da; 
    border-radius: 3px; 
    padding: 6px 8px; 
    font-size: 14px; 
  }
  textarea { 
    min-height: 70px; 
    resize: vertical; 
    font-family: inherit; 
  }
  button { 
    padding: 8px 16px; 
    border-radius: 3px; 
    border: 1px solid #6c757d; 
    background: #6c757d; 
    color: #fff; 
    cursor: pointer; 
    font-size: 14px; 
  }
  button:hover { 
    background: #5a6268; 
  }
  button.primary { 
    background: #0d6efd; 
    border-color: #0d6efd; 
  }
  button.primary:hover { 
    background: #0b5ed7; 
  }
  button.danger {
    background: #dc3545;
    border-color: #dc3545;
  }
  button.danger:hover {
    background: #c82333;
  }
  button:disabled { 
    opacity: 0.6; 
    cursor: not-allowed; 
  }
  .hidden { 
    display: none !important; 
  }
  .muted { 
    color: #6c757d; 
    font-size: 13px; 
    margin: 8px 0; 
  }
  .center { 
    text-align: center; 
  }
  img.stim { 
    max-width: 100%; 
    height: auto; 
    border: 1px solid #dee2e6; 
    display: block; 
    margin: 12px auto; 
  }
  .q-block { 
    margin: 12px 0; 
    padding: 8px; 
    background: #f8f9fa; 
    border-left: 3px solid #dee2e6; 
  }
  .explain-field { 
    margin-top: 8px; 
    padding: 8px; 
    background: #fff3cd; 
    border-left: 3px solid #ffc107; 
  }
  
  /* Recording indicator */
  .recording-indicator { 
    position: fixed; 
    top: 20px; 
    right: 20px; 
    padding: 8px 12px; 
    background: #dc3545; 
    color: #fff; 
    border-radius: 4px; 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    font-size: 13px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .recording-dot { 
    width: 8px; 
    height: 8px; 
    background: #fff; 
    border-radius: 50%; 
    animation: pulse 1.5s infinite; 
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  
  /* Timer display */
  .timer-display {
    font-family: monospace;
    font-size: 18px;
    color: #495057;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 3px;
    display: inline-block;
  }
  
  /* Progress bar */
  .progress-bar {
    height: 3px;
    background: #e9ecef;
    margin: 20px 0;
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: #0d6efd;
    transition: width 0.3s ease;
  }
  
  /* Item display */
  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
  }
  .item-info { 
    font-size: 13px; 
    color: #6c757d; 
  }
  
  /* Admin panel */
  .admin-panel {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: rgba(255,255,255,0.95);
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    font-size: 11px;
    color: #6c757d;
    display: none;
  }
  .admin-mode .admin-panel { 
    display: block; 
  }
  
  /* Upload status */
  .status-box {
    padding: 12px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #0d6efd;
    margin: 12px 0;
  }
  .status-box.success {
    border-left-color: #28a745;
    background: #d4edda;
  }
  .status-box.error {
    border-left-color: #dc3545;
    background: #f8d7da;
  }
  .status-box.warning {
    border-left-color: #ffc107;
    background: #fff3cd;
  }
  .status-message {
    font-size: 14px;
    color: #495057;
  }
  .success .status-message {
    color: #155724;
  }
  .error .status-message {
    color: #721c24;
  }
  .warning .status-message {
    color: #856404;
  }
  
  /* Participant group info */
  .group-info {
    background: #e9ecef;
    padding: 15px;
    border-radius: 4px;
    margin: 15px 0;
  }
  .group-info h3 {
    font-size: 14px;
    margin: 0 0 10px;
    font-weight: 600;
  }
  .radio-group {
    margin: 10px 0;
  }
  .radio-group label {
    display: flex;
    align-items: center;
    margin: 8px 0;
    cursor: pointer;
  }
  .radio-group input[type="radio"] {
    width: auto;
    margin-right: 10px;
  }
  
  /* Recording setup info */
  .recording-info {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 4px;
    margin: 15px 0;
    border: 1px solid #dee2e6;
  }
  .recording-info.video {
    border-color: #0d6efd;
    background: #e7f3ff;
  }
  .recording-info.audio {
    border-color: #28a745;
    background: #e6f4ea;
  }
  
  /* Recording controls */
  .recording-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
  }
  .recording-timer {
    font-family: monospace;
    font-size: 18px;
    color: #dc3545;
    padding: 4px 8px;
    background: #f8f9fa;
    border-radius: 3px;
  }
  
  /* Connection status */
  .connection-status {
    position: fixed;
    bottom: 10px;
    left: 10px;
    padding: 5px 10px;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    font-size: 11px;
  }
  .connection-status.connected {
    border-color: #28a745;
    color: #28a745;
  }
  .connection-status.error {
    border-color: #dc3545;
    color: #dc3545;
  }
  
  /* Video preview */
  .video-preview-wrapper {
    text-align: center;
    margin: 20px 0;
  }
  .video-preview {
    width: 100%;
    max-width: 480px;
    height: auto;
    background: #000;
    border: 2px solid #dee2e6;
    border-radius: 4px;
  }
  
  /* Read aloud instructions */
  .read-aloud-box {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    padding: 15px;
    margin: 15px 0;
  }
  .read-aloud-box h4 {
    margin: 0 0 10px;
    font-size: 14px;
    color: #856404;
  }
  
  /* Modality selection */
  .modality-selection {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    margin: 15px 0;
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- Welcome Screen -->
  <div id="screen-welcome" class="card">
    <h1>WIAT-2 Reading Comprehension Study</h1>
    <p class="muted">Please enter your information to begin.</p>
    
    <div class="row">
      <div>
        <label for="pid">Participant Code</label>
        <input id="pid" type="text" placeholder="Enter code" />
      </div>
      <div>
        <label for="edu">Education Level</label>
        <select id="edu">
          <option value="">Select...</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
          <option value="13+">College or higher</option>
        </select>
      </div>
    </div>
    
    <div class="group-info">
      <h3>Participant Group</h3>
      <div class="radio-group">
        <label>
          <input type="radio" name="participant-group" value="deaf-fluent" />
          <span>Deaf - Fluent ASL signer</span>
        </label>
        <label>
          <input type="radio" name="participant-group" value="hearing-fluent" />
          <span>Hearing - Fluent ASL signer</span>
        </label>
        <label>
          <input type="radio" name="participant-group" value="deaf-nonfluent" />
          <span>Deaf - Non-fluent ASL signer</span>
        </label>
        <label>
          <input type="radio" name="participant-group" value="hearing-nonfluent" />
          <span>Hearing - Non-fluent ASL signer</span>
        </label>
        <label>
          <input type="radio" name="participant-group" value="hearing-nonsigner" />
          <span>Hearing - Non-signer</span>
        </label>
      </div>
    </div>
    
    <div id="modality-selection" class="modality-selection hidden">
      <h3 style="font-size: 14px; margin: 0 0 10px;">Communication Preference for "Read Aloud" Items</h3>
      <p class="muted" style="margin: 0 0 10px;">How would you prefer to "read aloud"?</p>
      <div class="radio-group">
        <label>
          <input type="radio" name="read-modality" value="sign" />
          <span>Sign (ASL) - Video recording</span>
        </label>
        <label>
          <input type="radio" name="read-modality" value="speak" />
          <span>Speak - Audio recording</span>
        </label>
      </div>
    </div>
    
    <div id="config-warning" class="status-box error hidden">
      <div class="status-message">
        <strong>Setup Required:</strong> Google Drive integration not configured. 
        Please update GOOGLE_SCRIPT_URL in the code.
      </div>
    </div>
    
    <div style="margin-top: 20px;">
      <button id="begin" class="primary" disabled>Continue to Setup</button>
    </div>
  </div>

  <!-- Setup Screen -->
  <div id="screen-setup" class="card hidden">
    <h2>Recording Setup</h2>
    
    <div id="recording-method-info" class="recording-info">
      <div class="status-message" id="recording-method-text">
        Setting up recording...
      </div>
    </div>
    
    <div id="video-setup" class="hidden">
      <p class="muted">For ASL "read aloud" items, we need to set up video recording.</p>
      <div class="video-preview-wrapper">
        <video id="preview" class="video-preview" autoplay muted></video>
      </div>
      <p id="video-status" class="muted center">Requesting camera access...</p>
    </div>
    
    <div id="audio-setup" class="hidden">
      <p class="muted">For spoken "read aloud" items, we need to set up audio recording.</p>
      <div class="recording-controls">
        <button id="test-audio-record" class="danger">Test Audio Recording</button>
        <button id="stop-test-audio" class="hidden">Stop Test</button>
        <span class="recording-timer hidden" id="test-audio-timer">00:00</span>
      </div>
      <audio id="test-audio-playback" controls class="hidden" style="width: 100%; max-width: 400px; margin: 10px auto; display: block;"></audio>
      <p id="audio-status" class="muted center">Click "Test Audio Recording" to verify your microphone is working.</p>
    </div>
    
    <div id="setup-status" class="status-box" style="margin-top: 20px;">
      <div class="status-message" id="setup-status-text">Initializing...</div>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
      <button id="start-study" class="primary" disabled>Start Assessment</button>
    </div>
  </div>

  <!-- Item Screen -->
  <div id="screen-item" class="card hidden">
    <div class="recording-indicator hidden" id="rec-indicator">
      <span class="recording-dot"></span>
      <span id="rec-type">Recording</span>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width: 0%"></div>
    </div>
    
    <div class="item-header">
      <div class="item-info">
        <span id="item-number"></span> | Item <span id="actual-item-number"></span>
      </div>
      <div id="timer-container" class="hidden">
        <span class="timer-display" id="timer">00:00</span>
      </div>
    </div>
    
    <div id="stim-container" class="center">
      <img id="stim" class="stim" alt="Reading material" />
    </div>
    
    <div id="instructions" class="muted center" style="margin: 16px 0;">
      <span id="instruction-text"></span>
    </div>
    
    <!-- Read Aloud Instructions Box -->
    <div id="read-aloud-instructions" class="read-aloud-box hidden">
      <h4 id="read-aloud-title">Read Aloud Instructions</h4>
      <p id="read-aloud-text" class="muted" style="margin: 0;"></p>
    </div>
    
    <!-- Recording controls for read-aloud items -->
    <div id="recording-controls" class="recording-controls hidden">
      <button id="start-recording" class="danger">Start Recording</button>
      <button id="stop-recording" class="hidden">Stop Recording</button>
      <span class="recording-timer hidden" id="recording-timer">00:00</span>
    </div>
    
    <!-- Standard reading controls -->
    <div id="reading-controls" class="center hidden" style="margin: 16px 0;">
      <button id="start-reading" class="primary">Start Reading</button>
      <button id="done-reading" class="hidden">Done Reading</button>
    </div>
    
    <form id="qa-form" class="hidden">
      <div id="qa-fields"></div>
      <div style="margin-top: 16px;">
        <button type="submit" class="primary">Submit</button>
        <button type="button" id="skip">Skip</button>
      </div>
    </form>
  </div>

  <!-- Finish Screen -->
  <div id="screen-finish" class="card hidden">
    <h2>Assessment Complete</h2>
    <p id="finish-msg" class="muted">Thank you for participating.</p>
    
    <div id="upload-status" class="status-box">
      <div class="status-message" id="upload-progress">Saving your data...</div>
    </div>
    
    <div id="final-stats" class="hidden" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px;">
      <h3 style="font-size: 14px; margin: 0 0 10px;">Session Summary</h3>
      <div id="stats-content"></div>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
      <button id="retry-upload" class="primary hidden">Retry Upload</button>
      <button id="download-backup" class="hidden">Download Backup</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="admin-panel">
    <div>Group: <span id="admin-group">-</span></div>
    <div>Item: <span id="admin-item">-</span></div>
    <div>Score: <span id="admin-score">0</span></div>
    <div>Zeros: <span id="admin-zeros">0</span></div>
    <div>Status: <span id="admin-status">Active</span></div>
  </div>

  <!-- Connection Status -->
  <div class="connection-status" id="connection-status">
    <span id="connection-text">Not connected</span>
  </div>

</div>

<script>
/* ===========================
   CONFIGURATION
   =========================== */
// IMPORTANT: Replace this with your actual Google Apps Script Web App URL
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX6yfgjIVSzmL2nL73IxIWPCV4RPbxfjPTDOxB-_Ax6siB2vmKJXnCpwLP4-PUA4MCpQ/exec';

/* ===========================
   State Management
   =========================== */
let state = {
  // Session info
  pid: '',
  edu: '',
  participantGroup: '', // deaf-fluent, hearing-fluent, deaf-nonfluent, hearing-nonfluent, hearing-nonsigner
  readModality: '', // sign or speak (for hearing signers only)
  sessionStartTime: null,
  
  // Progress tracking
  currentIndex: 0,
  totalPoints: 0,
  consecutiveZeros: 0,
  gateItemsFailed: [],
  
  // Results storage
  results: [],
  sequence: [],
  
  // Timers
  timerInterval: null,
  readingStartTime: null,
  itemStartTime: null,
  recordingTimerInterval: null,
  
  // Recording
  useVideoRecording: false, // Will be set based on participant group
  useAudioRecording: false, // Will be set based on participant group
  mediaRecorder: null,
  recordedChunks: [],
  stream: null,
  
  // Admin and upload
  adminMode: false,
  uploadAttempts: 0,
  savedData: null,
  connectionStatus: false
};

/* ===========================
   WIAT-2 Scoring Reference (abbreviated for space - same as before)
   =========================== */
const SCORING_REFERENCE = {
  // [Previous scoring reference content - keeping abbreviated for space]
  q75: {
    twoPoint: {
      concepts: ["great spirit", "god", "deity", "creator", "divine being"],
      patterns: [/great\s+spirit/i, /\bgod\b/i, /deity/i, /creator/i, /divine/i, /supreme\s+being/i]
    },
    onePoint: {
      concepts: ["spirit", "supernatural"],
      patterns: [/spirit/i, /supernatural/i]
    },
    notes: "Must indicate divine/supreme nature for 2 points"
  },
  // ... [rest of scoring continues as before]
};

/* ===========================
   TRIALS Configuration (abbreviated for space - same as before)
   =========================== */
const TRIALS = [
  // [Previous TRIALS array - keeping abbreviated for space]
  {
    item: 75,
    image: "1.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q75",
      text: "Who is Kwawar?",
      scoringKey: "q75"
    }]
  },
  // ... [rest of trials continue as before]
];

/* ===========================
   Participant Group Configuration
   =========================== */
function determineRecordingNeeds() {
  const group = state.participantGroup;
  const modality = state.readModality;
  
  // Determine recording requirements based on group
  if (group.startsWith('deaf')) {
    // Deaf participants always use video for ASL
    state.useVideoRecording = true;
    state.useAudioRecording = false;
    return 'video';
  } else if (group === 'hearing-fluent' || group === 'hearing-nonfluent') {
    // Hearing signers choose their modality
    if (modality === 'sign') {
      state.useVideoRecording = true;
      state.useAudioRecording = false;
      return 'video';
    } else {
      state.useVideoRecording = false;
      state.useAudioRecording = true;
      return 'audio';
    }
  } else {
    // Hearing non-signers use audio
    state.useVideoRecording = false;
    state.useAudioRecording = true;
    return 'audio';
  }
}

function getReadAloudInstructions() {
  const group = state.participantGroup;
  const modality = state.readModality;
  
  if (group.startsWith('deaf')) {
    return {
      title: "Sign This Passage",
      text: "Please sign this passage in ASL. Click 'Start Recording' when ready to begin signing.",
      buttonText: "Start Signing"
    };
  } else if ((group === 'hearing-fluent' || group === 'hearing-nonfluent') && modality === 'sign') {
    return {
      title: "Sign This Passage",
      text: "Please sign this passage in ASL. Click 'Start Recording' when ready to begin signing.",
      buttonText: "Start Signing"
    };
  } else {
    return {
      title: "Read This Aloud",
      text: "Please read this passage aloud. Click 'Start Recording' when ready to begin speaking.",
      buttonText: "Start Speaking"
    };
  }
}

/* ===========================
   Google Apps Script Communication
   =========================== */
async function sendToGoogle(action, data) {
  try {
    const payload = {
      action: action,
      ...data,
      participantGroup: state.participantGroup,
      readModality: state.readModality,
      timestamp: new Date().toISOString()
    };
    
    console.log('Sending to Google:', action, payload);
    
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });
    
    updateConnectionStatus(true);
    return { status: 'success' };
    
  } catch (error) {
    console.error('Google Apps Script error:', error);
    updateConnectionStatus(false);
    throw error;
  }
}

function updateConnectionStatus(connected) {
  state.connectionStatus = connected;
  const statusEl = document.getElementById('connection-status');
  const textEl = document.getElementById('connection-text');
  
  if (connected) {
    statusEl.className = 'connection-status connected';
    textEl.textContent = '● Connected to Google Sheets';
  } else {
    statusEl.className = 'connection-status error';
    textEl.textContent = '○ Connection error';
  }
}

/* ===========================
   Recording Functions
   =========================== */
async function setupVideoRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: 'user'
      }, 
      audio: false // No audio needed for ASL
    });
    
    state.stream = stream;
    const preview = document.getElementById('preview');
    preview.srcObject = stream;
    
    const options = {
      mimeType: 'video/webm;codecs=vp8'
    };
    
    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
      options.mimeType = 'video/webm';
    }
    
    state.mediaRecorder = new MediaRecorder(stream, options);
    state.recordedChunks = [];
    
    state.mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        state.recordedChunks.push(event.data);
      }
    };
    
    document.getElementById('video-status').textContent = 'Camera ready. You can see yourself above.';
    return true;
  } catch (err) {
    console.error('Video setup error:', err);
    document.getElementById('video-status').textContent = 'Error: Could not access camera. Please check permissions.';
    return false;
  }
}

async function setupAudioRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      } 
    });
    
    state.stream = stream;
    
    const options = {
      mimeType: 'audio/webm'
    };
    
    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
      options.mimeType = 'audio/ogg';
    }
    
    state.mediaRecorder = new MediaRecorder(stream, options);
    state.recordedChunks = [];
    
    state.mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        state.recordedChunks.push(event.data);
      }
    };
    
    document.getElementById('audio-status').textContent = 'Microphone ready. Test your audio above.';
    return true;
  } catch (err) {
    console.error('Audio setup error:', err);
    document.getElementById('audio-status').textContent = 'Error: Could not access microphone. Please check permissions.';
    return false;
  }
}

function startRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state === 'inactive') {
    state.recordedChunks = [];
    state.mediaRecorder.start();
    
    // Start recording timer
    let seconds = 0;
    const timerEl = document.getElementById('recording-timer');
    timerEl.classList.remove('hidden');
    
    state.recordingTimerInterval = setInterval(() => {
      seconds++;
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }, 1000);
    
    // Show recording indicator
    document.getElementById('rec-indicator').classList.remove('hidden');
    document.getElementById('rec-type').textContent = state.useVideoRecording ? 'Recording Video' : 'Recording Audio';
  }
}

function stopRecording() {
  return new Promise((resolve) => {
    if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
      state.mediaRecorder.onstop = () => {
        const mimeType = state.useVideoRecording ? 'video/webm' : 'audio/webm';
        const blob = new Blob(state.recordedChunks, { type: mimeType });
        resolve(blob);
      };
      
      state.mediaRecorder.stop();
      
      // Stop timer
      if (state.recordingTimerInterval) {
        clearInterval(state.recordingTimerInterval);
        state.recordingTimerInterval = null;
      }
      
      document.getElementById('recording-timer').classList.add('hidden');
      document.getElementById('rec-indicator').classList.add('hidden');
    } else {
      resolve(null);
    }
  });
}

/* ===========================
   Event Listeners
   =========================== */
// Participant group selection
document.querySelectorAll('input[name="participant-group"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    state.participantGroup = e.target.value;
    
    // Show modality selection only for hearing signers
    const modalityDiv = document.getElementById('modality-selection');
    if (state.participantGroup === 'hearing-fluent' || state.participantGroup === 'hearing-nonfluent') {
      modalityDiv.classList.remove('hidden');
      document.getElementById('begin').disabled = true; // Wait for modality selection
    } else {
      modalityDiv.classList.add('hidden');
      document.getElementById('begin').disabled = false;
      
      // Set default modality for other groups
      if (state.participantGroup.startsWith('deaf')) {
        state.readModality = 'sign';
      } else {
        state.readModality = 'speak';
      }
    }
  });
});

// Modality selection for hearing signers
document.querySelectorAll('input[name="read-modality"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    state.readModality = e.target.value;
    document.getElementById('begin').disabled = false;
  });
});

document.getElementById('begin').addEventListener('click', async () => {
  state.pid = document.getElementById('pid').value.trim();
  state.edu = document.getElementById('edu').value;
  
  if (!state.pid || !state.edu || !state.participantGroup) {
    alert('Please complete all required fields.');
    return;
  }
  
  // Check for admin mode
  if (state.pid.toLowerCase().includes('admin')) {
    state.adminMode = true;
    document.body.classList.add('admin-mode');
  }
  
  // Determine recording needs
  const recordingType = determineRecordingNeeds();
  
  // Initialize session with Google Sheets
  try {
    await sendToGoogle('session_start', {
      pid: state.pid,
      education: state.edu,
      adminMode: state.adminMode,
      hasRecording: true,
      ipAddress: '',
      userAgent: navigator.userAgent
    });
  } catch (error) {
    console.error('Failed to initialize session:', error);
  }
  
  showScreen('setup');
  setupRecording(recordingType);
});

async function setupRecording(recordingType) {
  const statusEl = document.getElementById('setup-status-text');
  const methodEl = document.getElementById('recording-method-text');
  const methodDiv = document.getElementById('recording-method-info');
  
  if (recordingType === 'video') {
    methodDiv.className = 'recording-info video';
    methodEl.textContent = 'Video recording will be used for ASL "read aloud" items.';
    document.getElementById('video-setup').classList.remove('hidden');
    document.getElementById('audio-setup').classList.add('hidden');
    
    statusEl.textContent = 'Setting up video recording...';
    const success = await setupVideoRecording();
    
    if (success) {
      statusEl.textContent = '✓ Video recording ready';
      document.getElementById('start-study').disabled = false;
    } else {
      statusEl.textContent = '✗ Video setup failed. Please refresh and try again.';
    }
  } else {
    methodDiv.className = 'recording-info audio';
    methodEl.textContent = 'Audio recording will be used for spoken "read aloud" items.';
    document.getElementById('audio-setup').classList.remove('hidden');
    document.getElementById('video-setup').classList.add('hidden');
    
    statusEl.textContent = 'Setting up audio recording...';
    const success = await setupAudioRecording();
    
    if (success) {
      statusEl.textContent = '✓ Audio recording ready';
      document.getElementById('start-study').disabled = false;
    } else {
      statusEl.textContent = '✗ Audio setup failed. Please refresh and try again.';
    }
  }
}

// Test audio recording
document.getElementById('test-audio-record').addEventListener('click', () => {
  const btn = document.getElementById('test-audio-record');
  const stopBtn = document.getElementById('stop-test-audio');
  const timerEl = document.getElementById('test-audio-timer');
  
  btn.classList.add('hidden');
  stopBtn.classList.remove('hidden');
  timerEl.classList.remove('hidden');
  
  // Start test recording
  const testChunks = [];
  const testRecorder = new MediaRecorder(state.stream);
  
  testRecorder.ondataavailable = (e) => {
    if (e.data.size > 0) testChunks.push(e.data);
  };
  
  testRecorder.onstop = () => {
    const blob = new Blob(testChunks, { type: 'audio/webm' });
    const url = URL.createObjectURL(blob);
    const playback = document.getElementById('test-audio-playback');
    playback.src = url;
    playback.classList.remove('hidden');
    document.getElementById('audio-status').textContent = 'Recording saved. Play it back to verify quality.';
  };
  
  testRecorder.start();
  
  // Timer
  let seconds = 0;
  const interval = setInterval(() => {
    seconds++;
    timerEl.textContent = `${Math.floor(seconds/60).toString().padStart(2,'0')}:${(seconds%60).toString().padStart(2,'0')}`;
  }, 1000);
  
  stopBtn.onclick = () => {
    testRecorder.stop();
    clearInterval(interval);
    btn.classList.remove('hidden');
    stopBtn.classList.add('hidden');
    timerEl.classList.add('hidden');
  };
});

document.getElementById('start-study').addEventListener('click', startStudy);

async function startStudy() {
  state.sessionStartTime = Date.now();
  buildSequence();
  state.currentIndex = 0;
  showItem();
}

// Timer functions
function startTimer() {
  state.readingStartTime = Date.now();
  let seconds = 0;
  
  document.getElementById('timer-container').classList.remove('hidden');
  
  state.timerInterval = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    document.getElementById('timer').textContent = 
      `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }, 1000);
}

function stopTimer() {
  if (state.timerInterval) {
    clearInterval(state.timerInterval);
    state.timerInterval = null;
  }
  document.getElementById('timer-container').classList.add('hidden');
  const elapsed = state.readingStartTime ? Date.now() - state.readingStartTime : 0;
  state.readingStartTime = null;
  return elapsed;
}

// Item navigation
document.getElementById('start-reading').addEventListener('click', () => {
  startTimer();
  
  // Send reading start event
  sendToGoogle('reading_time', {
    pid: state.pid,
    itemNumber: state.sequence[state.currentIndex].item,
    imageFile: state.sequence[state.currentIndex].image,
    readingType: 'silent',
    startTime: new Date().toISOString()
  });
  
  document.getElementById('start-reading').classList.add('hidden');
  document.getElementById('done-reading').classList.remove('hidden');
});

document.getElementById('done-reading').addEventListener('click', async () => {
  const readingTime = stopTimer();
  const trial = state.sequence[state.currentIndex];
  
  // For non-scored items, just continue
  if (trial.skipScoring) {
    state.currentIndex++;
    showItem();
    return;
  }
  
  // Send reading complete event
  await sendToGoogle('reading_time', {
    pid: state.pid,
    itemNumber: trial.item,
    imageFile: trial.image,
    readingType: 'silent',
    startTime: new Date(Date.now() - readingTime).toISOString(),
    endTime: new Date().toISOString(),
    duration: readingTime / 1000
  });
  
  showQuestions(readingTime);
});

// Recording controls
document.getElementById('start-recording').addEventListener('click', () => {
  startRecording();
  document.getElementById('start-recording').classList.add('hidden');
  document.getElementById('stop-recording').classList.remove('hidden');
});

document.getElementById('stop-recording').addEventListener('click', async () => {
  const blob = await stopRecording();
  
  document.getElementById('start-recording').classList.remove('hidden');
  document.getElementById('stop-recording').classList.add('hidden');
  
  // Upload recording
  if (blob) {
    const trial = state.sequence[state.currentIndex];
    uploadRecordingToGoogle(blob, trial.item);
  }
  
  // Move to next item or show questions
  const trial = state.sequence[state.currentIndex];
  if (trial.skipScoring) {
    // Read-aloud only, no questions
    state.currentIndex++;
    showItem();
  } else {
    // Show questions after read-aloud
    showQuestions(0);
  }
});

document.getElementById('qa-form').addEventListener('submit', submitAnswers);
document.getElementById('skip').addEventListener('click', skipItem);
document.getElementById('retry-upload').addEventListener('click', retryUpload);
document.getElementById('download-backup').addEventListener('click', downloadBackup);

/* ===========================
   Core Functions
   =========================== */
function buildSequence() {
  const gradeNum = state.edu === "13+" ? 13 : parseInt(state.edu);
  
  const sortedTrials = TRIALS.slice().sort((a, b) => a.item - b.item);
  
  if (gradeNum >= 9) {
    const startIdx = sortedTrials.findIndex(t => t.item === 94);
    if (startIdx >= 0) {
      state.sequence = sortedTrials.slice(startIdx);
    } else {
      state.sequence = sortedTrials;
    }
  } else {
    state.sequence = sortedTrials;
  }
  
  console.log(`Built sequence with ${state.sequence.length} items for grade ${state.edu}`);
}

async function showItem() {
  if (state.currentIndex >= state.sequence.length) {
    finishAssessment();
    return;
  }
  
  // WIAT-2 discontinue rule
  if (state.consecutiveZeros >= 6) {
    finishAssessment();
    return;
  }
  
  const trial = state.sequence[state.currentIndex];
  
  // Send item started event to Google
  await sendToGoogle('item_started', {
    pid: state.pid,
    itemNumber: trial.item,
    imageFile: trial.image,
    questionText: trial.questions ? trial.questions[0].text : '',
    itemType: trial.type
  });
  
  showScreen('item');
  updateProgress();
  updateAdminPanel();
  
  document.getElementById('item-number').textContent = `Item ${state.currentIndex + 1} of ${state.sequence.length}`;
  document.getElementById('actual-item-number').textContent = trial.item;
  document.getElementById('stim').src = `stimuli/${trial.image}`;
  
  // Reset form
  document.getElementById('qa-form').classList.add('hidden');
  document.getElementById('qa-fields').innerHTML = '';
  document.getElementById('timer').textContent = '00:00';
  
  // Hide all controls initially
  document.getElementById('recording-controls').classList.add('hidden');
  document.getElementById('reading-controls').classList.add('hidden');
  document.getElementById('read-aloud-instructions').classList.add('hidden');
  
  const instruction = trial.instruction || '';
  document.getElementById('instruction-text').textContent = instruction;
  
  // Handle different item types
  if (trial.readAloud) {
    // This is a read-aloud item
    const instructions = getReadAloudInstructions();
    document.getElementById('read-aloud-title').textContent = instructions.title;
    document.getElementById('read-aloud-text').textContent = instructions.text;
    document.getElementById('read-aloud-instructions').classList.remove('hidden');
    document.getElementById('recording-controls').classList.remove('hidden');
    document.getElementById('start-recording').textContent = instructions.buttonText;
    
    if (!trial.skipScoring) {
      // Will show questions after recording
      showQuestions(0);
    }
  } else if (trial.skipScoring) {
    // Non-recording read item (shouldn't happen often)
    document.getElementById('reading-controls').classList.remove('hidden');
    document.getElementById('start-reading').classList.add('hidden');
    document.getElementById('done-reading').classList.remove('hidden');
    document.getElementById('done-reading').textContent = 'Continue';
  } else if (trial.skipReading) {
    // Question only, no reading
    showQuestions(0);
  } else {
    // Standard silent reading passage
    document.getElementById('reading-controls').classList.remove('hidden');
    document.getElementById('start-reading').classList.remove('hidden');
    document.getElementById('done-reading').classList.add('hidden');
    document.getElementById('done-reading').textContent = 'Done Reading';
  }
  
  state.itemStartTime = Date.now();
}

function showQuestions(readingTime) {
  const trial = state.sequence[state.currentIndex];
  
  if (trial.skipScoring) {
    // Just move to next item
    state.currentIndex++;
    showItem();
    return;
  }
  
  document.getElementById('qa-form').classList.remove('hidden');
  document.getElementById('reading-controls').classList.add('hidden');
  document.getElementById('recording-controls').classList.add('hidden');
  document.getElementById('read-aloud-instructions').classList.add('hidden');
  
  trial.questions.forEach(q => {
    const qDiv = document.createElement('div');
    qDiv.className = 'q-block';
    
    const label = document.createElement('label');
    label.textContent = q.text;
    label.setAttribute('for', q.id);
    
    const textarea = document.createElement('textarea');
    textarea.id = q.id;
    textarea.name = q.id;
    textarea.required = true;
    
    qDiv.appendChild(label);
    qDiv.appendChild(textarea);
    document.getElementById('qa-fields').appendChild(qDiv);
  });
}

// Scoring function (abbreviated - same as before)
function flexibleScore(response, scoringKey) {
  const scoring = SCORING_REFERENCE[scoringKey];
  if (!scoring) {
    return {
      autoScore: null,
      confidence: 'none',
      needsReview: true,
      notes: 'No scoring reference available'
    };
  }
  
  // [Previous scoring logic remains the same]
  
  return {
    autoScore: 0,
    confidence: 'none',
    needsReview: true,
    notes: 'No pattern match - requires human scoring'
  };
}

async function submitAnswers(e) {
  e.preventDefault();
  
  const trial = state.sequence[state.currentIndex];
  const endTime = new Date().toISOString();
  const duration = (Date.now() - state.itemStartTime) / 1000;
  
  let totalScore = 0;
  let allNeedReview = false;
  const responses = {};
  
  // Score each question
  trial.questions.forEach(q => {
    const response = document.getElementById(q.id).value.trim();
    const scoringResult = flexibleScore(response, q.scoringKey);
    
    if (scoringResult.needsReview) allNeedReview = true;
    totalScore += (scoringResult.autoScore || 0);
    
    responses[q.id] = {
      question: q.text,
      response: response,
      autoScore: scoringResult.autoScore,
      scoringDetails: scoringResult,
      needsReview: scoringResult.needsReview
    };
  });
  
  const finalScore = Math.round(totalScore / trial.questions.length);
  
  // Update running totals
  state.totalPoints += finalScore;
  if (finalScore === 0) {
    state.consecutiveZeros++;
  } else {
    state.consecutiveZeros = 0;
  }
  
  // Check gate items
  if (trial.isGateItem && finalScore === 0) {
    state.gateItemsFailed.push(trial.item);
  }
  
  // Send to Google Sheets
  for (const qId in responses) {
    const q = responses[qId];
    await sendToGoogle('item_completed', {
      pid: state.pid,
      itemNumber: trial.item,
      endTime: endTime,
      duration: duration,
      response: q.response,
      explanation: '',
      autoScore: q.autoScore,
      scoreConfidence: q.scoringDetails.confidence,
      needsReview: q.needsReview,
      scoringNotes: q.scoringDetails.notes,
      finalScore: q.autoScore,
      consecutiveZeros: state.consecutiveZeros,
      scoringDetails: q.scoringDetails
    });
  }
  
  // Store results
  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    responses: responses,
    autoScoreTotal: finalScore,
    needsReview: allNeedReview,
    totalTime: duration * 1000,
    timestamp: endTime
  });
  
  state.currentIndex++;
  showItem();
}

async function skipItem() {
  const trial = state.sequence[state.currentIndex];
  
  if (!trial.skipScoring) {
    state.consecutiveZeros++;
  }
  
  // Send skip event to Google
  await sendToGoogle('item_skipped', {
    pid: state.pid,
    itemNumber: trial.item,
    imageFile: trial.image,
    questionText: trial.questions ? trial.questions[0].text : '',
    itemType: trial.type,
    reason: 'User choice',
    consecutiveZeros: state.consecutiveZeros
  });
  
  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    response: 'SKIPPED',
    autoScore: 0,
    needsReview: false,
    totalTime: Date.now() - state.itemStartTime,
    timestamp: new Date().toISOString()
  });
  
  state.currentIndex++;
  showItem();
}

function updateProgress() {
  const percent = (state.currentIndex / state.sequence.length) * 100;
  document.getElementById('progress').style.width = `${percent}%`;
}

function updateAdminPanel() {
  if (state.adminMode) {
    document.getElementById('admin-group').textContent = state.participantGroup;
    document.getElementById('admin-item').textContent = 
      state.sequence[state.currentIndex] ? state.sequence[state.currentIndex].item : '-';
    document.getElementById('admin-score').textContent = state.totalPoints;
    document.getElementById('admin-zeros').textContent = state.consecutiveZeros;
    document.getElementById('admin-status').textContent = 
      state.consecutiveZeros >= 6 ? 'Discontinue' : 'Active';
  }
}

async function finishAssessment() {
  showScreen('finish');
  
  const duration = (Date.now() - state.sessionStartTime) / 1000 / 60; // minutes
  let msg = 'Thank you for participating.';
  let discontinued = false;
  
  if (state.consecutiveZeros >= 6) {
    msg = `Assessment discontinued after ${state.consecutiveZeros} consecutive zero-point responses.`;
    discontinued = true;
  } else if (state.currentIndex >= state.sequence.length) {
    msg = `Completed all ${state.sequence.length} items. Thank you for participating!`;
  }
  
  document.getElementById('finish-msg').textContent = msg;
  
  // Stop any streams
  if (state.stream) {
    state.stream.getTracks().forEach(track => track.stop());
  }
  
  // Send session complete event
  await sendToGoogle('session_complete', {
    pid: state.pid,
    duration: duration,
    itemsCompleted: state.results.length,
    totalScore: state.totalPoints,
    consecutiveZeros: state.consecutiveZeros,
    discontinued: discontinued,
    gateItemsFailed: state.gateItemsFailed.join(',')
  });
  
  // Show summary
  showSummary();
  
  // Save backup
  saveLocalBackup();
}

function showSummary() {
  const statsDiv = document.getElementById('final-stats');
  const content = document.getElementById('stats-content');
  
  const itemsReviewed = state.results.filter(r => r.needsReview).length;
  const avgScore = state.results.length > 0 ? 
    (state.totalPoints / state.results.length).toFixed(2) : 0;
  
  content.innerHTML = `
    <div>Participant Group: ${state.participantGroup}</div>
    <div>Communication Mode: ${state.readModality === 'sign' ? 'ASL' : 'Spoken'}</div>
    <div>Total Items Completed: ${state.results.length}</div>
    <div>Total Auto-Score: ${state.totalPoints}</div>
    <div>Average Score: ${avgScore}</div>
    <div>Items Needing Review: ${itemsReviewed}</div>
    <div>Session Duration: ${Math.round((Date.now() - state.sessionStartTime) / 1000 / 60)} minutes</div>
  `;
  
  statsDiv.classList.remove('hidden');
  
  updateUploadStatus('✓ All data saved to Google Sheets', 'success');
  document.getElementById('download-backup').classList.remove('hidden');
}

async function uploadRecordingToGoogle(blob, itemNumber) {
  if (!blob) return;
  
  try {
    const reader = new FileReader();
    reader.onloadend = async function() {
      const base64data = reader.result.split(',')[1];
      const fileType = state.useVideoRecording ? 'video' : 'audio';
      
      await sendToGoogle('video_upload', {
        pid: state.pid,
        videoData: base64data,
        sessionDate: new Date().toISOString().split('T')[0],
        itemNumber: `${fileType}_item_${itemNumber}`
      });
    };
    reader.readAsDataURL(blob);
  } catch (error) {
    console.error('Recording upload error:', error);
  }
}

function updateUploadStatus(message, type = '') {
  const statusDiv = document.getElementById('upload-status');
  const progressDiv = document.getElementById('upload-progress');
  
  progressDiv.textContent = message;
  statusDiv.className = 'status-box' + (type ? ' ' + type : '');
}

async function retryUpload() {
  state.uploadAttempts++;
  updateUploadStatus(`Retrying upload (attempt ${state.uploadAttempts + 1})...`);
  
  await sendToGoogle('save_backup', {
    pid: state.pid,
    allData: state.results
  });
  
  updateUploadStatus('✓ Retry successful', 'success');
}

function saveLocalBackup() {
  state.savedData = {
    participant: state.pid,
    education: state.edu,
    participantGroup: state.participantGroup,
    readModality: state.readModality,
    totalAutoScore: state.totalPoints,
    itemsCompleted: state.results.length,
    consecutiveZeros: state.consecutiveZeros,
    gateItemsFailed: state.gateItemsFailed,
    allResponses: state.results,
    sessionDuration: (Date.now() - state.sessionStartTime) / 1000 / 60,
    timestamp: new Date().toISOString()
  };
}

function downloadBackup() {
  if (!state.savedData) {
    saveLocalBackup();
  }
  
  // Create CSV backup
  const rows = [
    ['PID', 'Education', 'Group', 'Modality', 'Item', 'Image', 'Question', 'Response', 
     'AutoScore', 'Confidence', 'NeedsReview', 'ScoringNotes', 
     'TotalTime(ms)', 'Timestamp']
  ];
  
  state.results.forEach(r => {
    if (r.responses) {
      Object.keys(r.responses).forEach(qId => {
        const q = r.responses[qId];
        rows.push([
          r.pid,
          r.edu,
          state.participantGroup,
          state.readModality,
          r.item,
          r.image,
          q.question,
          q.response.replace(/[,\n]/g, '; '),
          q.autoScore !== null ? q.autoScore : 'REVIEW',
          q.scoringDetails ? q.scoringDetails.confidence : '',
          q.needsReview ? 'YES' : 'NO',
          q.scoringDetails ? q.scoringDetails.notes : '',
          r.totalTime || '',
          r.timestamp
        ]);
      });
    } else {
      rows.push([
        r.pid,
        r.edu,
        state.participantGroup,
        state.readModality,
        r.item,
        r.image,
        'N/A',
        r.response || 'N/A',
        r.autoScore === 'N/A' ? 'N/A' : r.autoScore,
        '',
        'NO',
        '',
        r.totalTime || '',
        r.timestamp
      ]);
    }
  });
  
  const csv = rows.map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `WIAT2_${state.pid}_${state.participantGroup}_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  
  // Also save JSON backup
  const jsonBlob = new Blob([JSON.stringify(state.savedData, null, 2)], 
    { type: 'application/json' });
  const jsonUrl = URL.createObjectURL(jsonBlob);
  const jsonLink = document.createElement('a');
  jsonLink.href = jsonUrl;
  jsonLink.download = `WIAT2_${state.pid}_${state.participantGroup}_${Date.now()}.json`;
  document.body.appendChild(jsonLink);
  jsonLink.click();
  jsonLink.remove();
  URL.revokeObjectURL(jsonUrl);
  
  updateUploadStatus('Backup files downloaded', 'success');
}

function showScreen(name) {
  document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
  document.getElementById(`screen-${name}`).classList.remove('hidden');
}

/* ===========================
   Initialization
   =========================== */
document.addEventListener('DOMContentLoaded', () => {
  showScreen('welcome');
  
  // Check if Google Script URL is configured
if (GOOGLE_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT_URL_HERE')) {
  document.getElementById('config-warning').classList.remove('hidden');
  document.getElementById('begin').disabled = true;
}
  
  updateConnectionStatus(false);
});
</script>
</body>
</html>
