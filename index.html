<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reading Comprehension Study</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#f8f9fa; color:#212529; }
  .wrap { max-width: 900px; margin: 0 auto; padding: 20px; }
  .card { background:#fff; border:1px solid #dee2e6; border-radius:4px; padding:20px; margin:12px 0; }
  h1 { font-size:1.5rem; margin:0 0 12px; font-weight:400; }
  h2 { font-size:1.25rem; margin:0 0 12px; font-weight:400; }
  .row { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
  .row > * { flex:1 1 auto; min-width:200px; }
  label { display:block; margin:8px 0 4px; font-size:14px; }
  input[type="text"], textarea, select { width:100%; border:1px solid #ced4da; border-radius:3px; padding:6px 8px; font-size:14px; }
  textarea { min-height:70px; resize:vertical; font-family:inherit; }
  button { padding:8px 16px; border-radius:3px; border:1px solid #6c757d; background:#6c757d; color:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#5a6268; }
  button.primary { background:#0d6efd; border-color:#0d6efd; }
  button.primary:hover { background:#0b5ed7; }
  button:disabled { opacity:0.6; cursor:not-allowed; }
  .hidden { display:none !important; }
  .muted { color:#6c757d; font-size:13px; margin:8px 0; }
  .center { text-align:center; }
  img.stim { max-width:100%; height:auto; border:1px solid #dee2e6; display:block; margin: 12px auto; }
  .q-block { margin: 12px 0; padding:8px; background:#f8f9fa; border-left:3px solid #dee2e6; }
  .explain-field { margin-top:8px; padding:8px; background:#fff3cd; border-left:3px solid #ffc107; }
  
  /* Recording indicator */
  .recording-indicator { 
    position:fixed; top:20px; right:20px; padding:8px 12px; 
    background:#dc3545; color:#fff; border-radius:4px; 
    display:flex; align-items:center; gap:8px; font-size:13px;
    box-shadow:0 2px 4px rgba(0,0,0,0.2);
  }
  .recording-dot { 
    width:8px; height:8px; background:#fff; border-radius:50%; 
    animation: pulse 1.5s infinite; 
  }
  @keyframes pulse {
    0%, 100% { opacity:1; }
    50% { opacity:0.3; }
  }
  
  /* Timer display */
  .timer-display {
    font-family: monospace;
    font-size: 18px;
    color: #495057;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 3px;
    display: inline-block;
  }
  
  /* Progress bar */
  .progress-bar {
    height: 3px;
    background: #e9ecef;
    margin: 20px 0;
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: #0d6efd;
    transition: width 0.3s ease;
  }
  
  /* Item display */
  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
  }
  .item-info { font-size: 13px; color: #6c757d; }
  
  /* Admin panel */
  .admin-panel {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: rgba(255,255,255,0.95);
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    font-size: 11px;
    color: #6c757d;
    display: none;
  }
  .admin-mode .admin-panel { display: block; }
  
  /* Upload status */
  #upload-status {
    padding: 12px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #0d6efd;
  }
  #upload-progress {
    font-size: 14px;
    color: #495057;
  }
  .success {
    border-left-color: #28a745 !important;
    background: #d4edda !important;
  }
  .success #upload-progress {
    color: #155724;
  }
  .error {
    border-left-color: #dc3545 !important;
    background: #f8d7da !important;
  }
  .error #upload-progress {
    color: #721c24;
  }
</style>
</head>
<body>
<div class="wrap">

  <div id="screen-welcome" class="card">
    <h1>Reading Comprehension Study</h1>
    <p class="muted">Please enter your information to begin.</p>
    <div class="row">
      <div>
        <label for="pid">Participant Code</label>
        <input id="pid" type="text" placeholder="Enter code" />
      </div>
      <div>
        <label for="edu">Education Level</label>
        <select id="edu">
          <option value="">Select...</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
          <option value="13+">College or higher</option>
        </select>
      </div>
    </div>
    <div id="config-warning" class="error hidden" style="margin:12px 0; padding:8px; border-radius:4px;">
      <strong>Setup Required:</strong> Google Drive integration not configured. See setup instructions.
    </div>
    <div style="margin-top:20px;">
      <button id="begin" class="primary">Begin</button>
    </div>
  </div>

  <div id="screen-setup" class="card hidden">
    <h2>Setup Recording</h2>
    <p class="muted">This study will record video and audio for research purposes. Please ensure your camera and microphone are working.</p>
    <div id="preview-container" style="margin:20px 0;">
      <video id="preview" style="width:320px; height:240px; background:#000; border:1px solid #dee2e6;" autoplay muted></video>
    </div>
    <p id="setup-status" class="muted">Requesting camera and microphone access...</p>
    <div style="margin-top:20px;">
      <button id="start-study" class="primary" disabled>Start Study</button>
      <button id="test-audio">Test Audio</button>
    </div>
  </div>

  <div id="screen-item" class="card hidden">
    <div class="recording-indicator hidden" id="rec-indicator">
      <span class="recording-dot"></span>
      <span>Recording</span>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width:0%"></div>
    </div>
    
    <div class="item-header">
      <div class="item-info">
        <span id="item-number"></span>
      </div>
      <div id="timer-container" class="hidden">
        <span class="timer-display" id="timer">00:00</span>
      </div>
    </div>
    
    <div id="stim-container" class="center">
      <img id="stim" class="stim" alt="Reading material" />
    </div>
    
    <div id="instructions" class="muted center" style="margin:16px 0;">
      <span id="instruction-text"></span>
    </div>
    
    <div id="reading-controls" class="center" style="margin:16px 0;">
      <button id="start-reading" class="primary hidden">Start Reading</button>
      <button id="done-reading" class="hidden">Done Reading</button>
    </div>
    
    <form id="qa-form" class="hidden">
      <div id="qa-fields"></div>
      <div style="margin-top:16px;">
        <button type="submit" class="primary">Submit</button>
        <button type="button" id="skip">Skip</button>
      </div>
    </form>
  </div>

  <div id="screen-finish" class="card hidden">
    <h2>Study Complete</h2>
    <p id="finish-msg" class="muted">Thank you for participating.</p>
    <div id="upload-status" style="margin:12px 0;">
      <div id="upload-progress">Saving your data...</div>
    </div>
    <div style="margin-top:20px;">
      <button id="retry-upload" class="primary hidden">Retry Upload</button>
      <button id="download-backup" class="hidden">Download Backup</button>
    </div>
  </div>

  <div class="admin-panel">
    <div>Score: <span id="admin-score">0</span></div>
    <div>Zeros: <span id="admin-zeros">0</span></div>
  </div>

</div>

<script>
/* ===========================
   WIAT-2 Scoring Reference
   
   IMPORTANT: These are REFERENCE responses from the manual.
   Actual scoring should be done by trained administrators who
   can judge semantic equivalence, not exact matches.
   
   This system records ALL responses for human review.
   Auto-scoring is provided as a rough guide only.
   =========================== */

const SCORING_REFERENCE = {
  // Item 75: Who is Kwawar?
  q75: {
    twoPoint: {
      concepts: ["great spirit", "god", "deity", "creator", "divine being"],
      patterns: [
        /great\s+spirit/i,
        /\bgod\b/i,
        /deity/i,
        /creator/i,
        /divine/i,
        /supreme\s+being/i
      ]
    },
    onePoint: {
      concepts: ["spirit", "supernatural"],
      patterns: [/spirit/i, /supernatural/i]
    },
    notes: "Must indicate divine/supreme nature for 2 points"
  },
  
  // Item 76: How many Turtle Brothers?
  q76: {
    twoPoint: {
      concepts: ["7", "seven"],
      patterns: [/\b7\b/, /\bseven\b/i]
    },
    onePoint: { concepts: [], patterns: [] },
    notes: "Must be exactly 7"
  },
  
  // Item 77: What caused mountains to arise?
  q77: {
    twoPoint: {
      concepts: ["soil on turtle backs", "earth on turtles"],
      patterns: [
        /soil.*turtle/i,
        /turtle.*soil/i,
        /earth.*turtle/i,
        /dirt.*turtle/i
      ]
    },
    onePoint: {
      concepts: ["earth", "brushes", "bushes"],
      patterns: [/\bearth\b/i, /brush/i, /bush/i],
      requiresExplain: ["earth"] // Triggers follow-up
    },
    notes: "2pt must connect soil/earth to turtles"
  },
  
  // Item 78: Natural event explained by quarreling
  q78: {
    twoPoint: {
      concepts: ["earthquake"],
      patterns: [/earthquake/i, /earth\s*quake/i]
    },
    onePoint: {
      concepts: ["land quakes", "ground quivers"],
      patterns: [/land.*quake/i, /ground.*quiver/i, /shaking/i]
    },
    notes: "Earthquake or ground movement"
  },
  
  // Item 79: Great gift from Kwawar
  q79: {
    twoPoint: {
      concepts: ["california on their backs", "california was made from them"],
      patterns: [/california.*back/i, /california.*made/i, /bear.*california/i]
    },
    onePoint: {
      concepts: ["made them part of land"],
      patterns: [/part.*land/i, /land/i],
      requiresExplain: ["made them part of land"]
    },
    notes: "Connection to California"
  },
  
  // Item 80: Meaning of contemplated
  q80: {
    twoPoint: {
      concepts: ["to think about", "form a new plan", "pondering"],
      patterns: [/think.*about/i, /ponder/i, /consider/i, /reflect/i, /deliberate/i]
    },
    onePoint: {
      concepts: ["to think", "thought"],
      patterns: [/think/i, /thought/i]
    },
    notes: "Deep thinking or consideration"
  },
  
  // Item 87: Why did track meet end early?
  q87: {
    twoPoint: {
      concepts: ["bad weather AND cancellation of long distance"],
      requiresBoth: ["weather", "cancel"],
      patterns: [
        /weather.*cancel/i,
        /cancel.*weather/i,
        /storm.*cancel/i,
        /rain.*cancel/i
      ]
    },
    onePoint: {
      concepts: ["bad weather OR cancellation"],
      patterns: [/weather/i, /cancel/i, /storm/i, /rain/i]
    },
    notes: "2pt requires BOTH weather AND cancellation"
  },
  
  // Item 89: Two dangers encountered
  q89: {
    countBased: true,
    validConcepts: [
      "cold", "freezing", "freeze", "frozen", "ice",
      "animals", "bears", "wolves", "wildlife",
      "river", "rapids", "water", "drowning",
      "starvation", "hunger", "no food", "starving",
      "storm", "blizzard", "snow", "weather"
    ],
    twoPoint: { minCount: 2 },
    onePoint: { minCount: 1 },
    notes: "Count distinct dangers mentioned"
  },
  
  // Item 93: Meaning of hackneyed
  q93: {
    twoPoint: {
      concepts: ["overused", "cliche", "trite", "banal", "unoriginal"],
      patterns: [
        /overused/i,
        /cliche/i,
        /trite/i,
        /banal/i,
        /unoriginal/i,
        /overdone/i,
        /worn.?out/i,
        /stale/i
      ]
    },
    onePoint: {
      concepts: ["predictable"],
      patterns: [/predictable/i, /boring/i, /common/i]
    },
    notes: "2pt indicates overuse, 1pt indicates predictability"
  },
  
  // Additional scoring references for items 82-112
  q82: {
    twoPoint: {
      concepts: ["road covered with debris and traffic stopped"],
      patterns: [/road.*debris.*traffic/i, /traffic.*stop/i, /road.*block/i]
    },
    onePoint: {
      concepts: ["snow covered road", "avalanche covered road"],
      patterns: [/snow.*road/i, /avalanche.*road/i]
    }
  },
  
  q83: {
    twoPoint: {
      concepts: ["tree branches", "dirt", "rocks", "mud"],
      patterns: [/branch/i, /dirt/i, /rock/i, /mud/i, /rubble/i]
    },
    onePoint: {
      concepts: ["snow", "rubbish"],
      patterns: [/snow/i, /rubbish/i, /trash/i]
    }
  },
  
  q85: {
    twoPoint: {
      concepts: ["like better", "prefer"],
      patterns: [/like.*better/i, /prefer/i]
    },
    onePoint: {
      concepts: ["adore", "enjoy", "love"],
      patterns: [/adore/i, /enjoy/i, /love/i]
    }
  },
  
  q88: {
    twoPoint: {
      concepts: ["bad weather", "storm"],
      patterns: [/bad.*weather/i, /storm/i, /severe.*weather/i, /harsh.*weather/i]
    },
    onePoint: {
      concepts: [],
      patterns: []
    }
  },
  
  q90: {
    twoPoint: {
      concepts: ["not his father's dreams", "his goals differ"],
      patterns: [/father.*dream/i, /goals.*differ/i, /own.*dream/i]
    },
    onePoint: {
      concepts: ["wasn't his idea"],
      patterns: [/not.*his.*idea/i, /wasn.*his.*idea/i]
    }
  },
  
  q91: {
    twoPoint: {
      requiresBoth: ["wilderness", "family"],
      patterns: [/wilderness.*family/i, /family.*wilderness/i, /adventure.*conflict/i]
    },
    onePoint: {
      concepts: ["wilderness", "family conflict"],
      patterns: [/wilderness/i, /family/i, /adventure/i, /conflict/i]
    }
  },
  
  q92: {
    twoPoint: {
      concepts: ["predictable", "hackneyed", "boring ending"],
      patterns: [/predictable/i, /hackneyed/i, /boring.*ending/i]
    },
    onePoint: {
      concepts: ["ending"],
      patterns: [/ending/i]
    }
  },
  
  q94: {
    twoPoint: {
      concepts: ["preserved information", "information from past"],
      patterns: [/preserv.*information/i, /information.*past/i, /historical.*record/i]
    },
    onePoint: {
      concepts: ["information"],
      patterns: [/information/i],
      requiresExplain: ["information"]
    }
  },
  
  q95: {
    twoPoint: {
      concepts: ["old records", "older people", "people before him"],
      patterns: [/old.*record/i, /older.*people/i, /people.*before/i, /ancestor/i]
    },
    onePoint: {
      concepts: ["everyday life", "life experiences"],
      patterns: [/everyday.*life/i, /life.*experience/i]
    }
  },
  
  q96: {
    twoPoint: {
      requiresBoth: ["haste", "waste"],
      patterns: [/haste.*waste/i, /hurry.*mess/i, /rush.*mistake/i]
    },
    onePoint: {
      concepts: ["hurrying causes mistakes"],
      patterns: [/hurry.*mistake/i, /rush.*error/i]
    }
  },
  
  q97: {
    twoPoint: {
      concepts: ["short, easy to remember, contain wisdom"],
      patterns: [/short.*easy.*wisdom/i, /wisdom/i, /life.*lesson/i]
    },
    onePoint: {
      concepts: ["short and easy"],
      patterns: [/short.*easy/i, /easy.*remember/i]
    }
  },
  
  q98: {
    twoPoint: {
      concepts: ["garbage in, garbage out"],
      patterns: [/garbage.*in.*garbage.*out/i, /gigo/i]
    },
    onePoint: {
      concepts: [],
      patterns: []
    }
  },
  
  q100: {
    twoPoint: {
      concepts: ["constant temperature vs changing temperature"],
      patterns: [/constant.*temperature.*chang/i, /warm.*blood.*cold.*blood/i]
    },
    onePoint: {
      concepts: ["temperature"],
      patterns: [/temperature/i, /warm.*blood/i, /cold.*blood/i]
    }
  },
  
  q102: {
    twoPoint: {
      concepts: ["drought", "time without rain"],
      patterns: [/drought/i, /no.*rain/i, /without.*rain/i]
    },
    onePoint: {
      concepts: ["dust storms"],
      patterns: [/dust.*storm/i, /sand.*storm/i]
    }
  },
  
  q103: {
    twoPoint: {
      concepts: ["strengthen frail legs"],
      patterns: [/strengthen.*frail.*leg/i, /strengthen.*leg/i, /weak.*leg/i]
    },
    onePoint: {
      concepts: ["make stronger"],
      patterns: [/make.*strong/i, /strength/i]
    }
  },
  
  q104: {
    twoPoint: {
      requiresBoth: ["daily planning", "skating order"],
      patterns: [/daily.*skat/i, /routine.*differ/i]
    },
    onePoint: {
      concepts: ["routine", "order"],
      patterns: [/routine/i, /order/i, /sequence/i]
    }
  },
  
  q105: {
    twoPoint: {
      concepts: ["solo and duo", "singles and pairs"],
      patterns: [/solo.*duo/i, /single.*pair/i, /both.*program/i]
    },
    onePoint: {
      concepts: [],
      patterns: []
    }
  },
  
  q106: {
    twoPoint: {
      concepts: ["kristi and rudy"],
      patterns: [/kristi.*rudy/i, /rudy.*galindo/i]
    },
    onePoint: {
      concepts: ["kristi"],
      patterns: [/kristi/i]
    }
  },
  
  q107: {
    twoPoint: {
      concepts: ["grace and consistency"],
      patterns: [/grace.*consistency/i, /consistency.*grace/i]
    },
    onePoint: {
      concepts: ["grace", "consistency"],
      patterns: [/grace/i, /consistency/i, /artistic/i]
    }
  },
  
  q108: {
    twoPoint: {
      concepts: ["disappearance", "die out", "extinction"],
      patterns: [/disappear/i, /die.*out/i, /extinct/i, /death/i]
    },
    onePoint: {
      concepts: ["downfall", "decline"],
      patterns: [/downfall/i, /decline/i, /end/i],
      requiresExplain: ["downfall"]
    }
  },
  
  q109: {
    countBased: true,
    validConcepts: [
      "hunting", "whaling", "commercial gain", "killed",
      "nets", "fishing nets", "entanglement", "caught", "starving"
    ],
    twoPoint: { minCount: 2 },
    onePoint: { minCount: 1 }
  },
  
  q110: {
    twoPoint: {
      concepts: ["know problem to find solution"],
      patterns: [/know.*problem.*solution/i, /awareness.*help/i, /understand.*solve/i]
    },
    onePoint: {
      concepts: ["one species affects others"],
      patterns: [/species.*affect/i, /ecosystem/i, /chain/i],
      requiresExplain: ["species"]
    }
  },
  
  q111: {
    twoPoint: {
      requiresBoth: ["drown", "starve"],
      patterns: [/drown.*starv/i, /starv.*drown/i]
    },
    onePoint: {
      concepts: ["drown", "starve", "die"],
      patterns: [/drown/i, /starv/i, /die/i]
    }
  },
  
  q112: {
    twoPoint: {
      concepts: ["numbers will grow", "population increase"],
      patterns: [/number.*grow/i, /population.*increase/i, /recover/i]
    },
    onePoint: {
      concepts: ["protected better"],
      patterns: [/protect/i, /conservation/i]
    }
  },
  
  // Items 114-140
  q114: {
    twoPoint: {
      requiresBoth: ["supply", "demand"],
      patterns: [/supply.*demand/i, /demand.*supply/i]
    },
    onePoint: {
      concepts: ["supply", "demand"],
      patterns: [/supply/i, /demand/i]
    }
  },
  
  q115: {
    twoPoint: {
      concepts: ["$3", "three dollars", "dollar less"],
      patterns: [/\$3/i, /three.*dollar/i, /dollar.*less/i]
    },
    onePoint: {
      concepts: [],
      patterns: []
    }
  },
  
  q116: {
    twoPoint: {
      concepts: ["price increase caused attendance decline"],
      patterns: [/price.*increase.*attendance/i, /attendance.*drop.*price/i]
    },
    onePoint: {
      concepts: ["attendance dropped"],
      patterns: [/attendance.*drop/i, /fewer.*visitor/i]
    }
  },
  
  q117: {
    twoPoint: {
      concepts: ["make up for money lost"],
      patterns: [/make.*up.*money/i, /compensate.*loss/i]
    },
    onePoint: {
      concepts: ["make up difference"],
      patterns: [/make.*up.*difference/i]
    }
  },
  
  q118: {
    twoPoint: {
      concepts: ["buy new animals", "get new animals"],
      patterns: [/buy.*animal/i, /get.*animal/i, /new.*animal/i]
    },
    onePoint: {
      concepts: ["new additions"],
      patterns: [/addition/i, /things.*bought/i],
      requiresExplain: ["additions", "things bought"]
    }
  },
  
  q119: {
    countBased: true,
    validConcepts: [
      "fewer acquisitions", "budget shortfall", "reduced staffing",
      "cut programs", "animals suffer", "maintenance issues",
      "layoffs", "program cuts", "less animals"
    ],
    twoPoint: { minCount: 3 },
    onePoint: { minCount: 1 }
  },
  
  q121: {
    twoPoint: {
      concepts: ["died", "dead", "passed away"],
      patterns: [/died/i, /dead/i, /passed.*away/i, /death/i]
    },
    onePoint: {
      concepts: ["gone", "no longer king"],
      patterns: [/gone/i, /no.*longer.*king/i],
      requiresExplain: ["gone"]
    }
  },
  
  q122: {
    twoPoint: {
      concepts: ["new king crowned", "son becomes king", "succession"],
      patterns: [/new.*king/i, /son.*king/i, /crown/i, /succession/i, /heir/i]
    },
    onePoint: {
      concepts: ["change in government"],
      patterns: [/change.*government/i, /political.*change/i]
    }
  },
  
  q123: {
    twoPoint: {
      concepts: ["dinosaur skulls", "flaming cliffs skulls"],
      patterns: [/dinosaur.*skull/i, /flaming.*cliff/i]
    },
    onePoint: {
      concepts: ["fossils", "bones"],
      patterns: [/fossil/i, /bone/i, /skeleton/i]
    }
  },
  
  q124: {
    countBased: true,
    validConcepts: [
      "whale hunts", "whaling", "desert trek", "ship voyage",
      "mountain climb", "jungle expedition", "exploration",
      "arctic", "sea voyage", "expedition"
    ],
    twoPoint: { minCount: 3 },
    onePoint: { minCount: 2 }
  },
  
  q125: {
    twoPoint: {
      concepts: ["flaming cliffs"],
      patterns: [/flaming.*cliff/i]
    },
    onePoint: {
      concepts: ["gobi desert", "mongolia", "dunes"],
      patterns: [/gobi/i, /mongolia/i, /dune/i, /desert/i]
    }
  },
  
  q126: {
    twoPoint: {
      concepts: ["proved dinosaurs laid eggs"],
      patterns: [/prov.*dinosaur.*egg/i, /dinosaur.*laid.*egg/i]
    },
    onePoint: {
      concepts: ["dinosaur reproduction", "first eggs"],
      patterns: [/reproduction/i, /first.*egg/i]
    }
  },
  
  q127: {
    twoPoint: {
      concepts: ["outlaws", "bandits", "thieves", "pirates"],
      patterns: [/outlaw/i, /bandit/i, /thieve/i, /pirate/i, /highwaymen/i]
    },
    onePoint: {
      concepts: ["bad guys", "criminals"],
      patterns: [/bad.*guy/i, /criminal/i, /warrior/i]
    }
  },
  
  q129: {
    twoPoint: {
      concepts: ["long life", "length of life", "living long"],
      patterns: [/long.*life/i, /length.*life/i, /living.*long/i]
    },
    onePoint: {
      concepts: ["ages past 65"],
      patterns: [/age.*past.*65/i],
      requiresExplain: ["ages past 65"]
    }
  },
  
  q130: {
    twoPoint: {
      concepts: ["people living longer", "more people reaching 65"],
      patterns: [/people.*living.*longer/i, /more.*people.*65/i, /life.*expectancy.*increas/i]
    },
    onePoint: {
      concepts: ["living longer"],
      patterns: [/living.*longer/i]
    }
  },
  
  q131: {
    twoPoint: {
      concepts: ["building the nest", "20s building nest"],
      patterns: [/building.*nest/i, /20.*building/i, /twenties.*building/i]
    },
    onePoint: {
      concepts: ["20s", "twenties"],
      patterns: [/20s/i, /twenties/i]
    }
  },
  
  q132: {
    twoPoint: {
      requiresBoth: ["change", "action"],
      patterns: [/change.*action/i, /reevaluat.*action/i]
    },
    onePoint: {
      concepts: ["change", "action", "reevaluation"],
      patterns: [/change/i, /action/i, /reevaluat/i]
    }
  },
  
  q133: {
    twoPoint: {
      concepts: ["looking around", "30s looking around"],
      patterns: [/looking.*around/i, /30.*looking/i, /thirties.*looking/i]
    },
    onePoint: {
      concepts: ["30s", "thirties"],
      patterns: [/30s/i, /thirties/i]
    }
  },
  
  q134: {
    twoPoint: {
      concepts: ["never become independent", "no stable career", "no own morals"],
      patterns: [/never.*independent/i, /no.*stable.*career/i, /no.*own.*moral/i]
    },
    onePoint: {
      concepts: ["no direction", "live at home"],
      patterns: [/no.*direction/i, /live.*home/i, /dependent/i]
    }
  },
  
  q135: {
    countBased: true,
    validConcepts: [
      "enjoyment of life", "seeking knowledge", "mentoring",
      "reflection", "community service", "legacy",
      "wisdom sharing", "spiritual growth", "teaching",
      "volunteering", "memories", "family time"
    ],
    twoPoint: { minCount: 2 },
    onePoint: { minCount: 1 }
  },
  
  q136: {
    twoPoint: {
      concepts: ["cleft in rock", "crevice", "crack"],
      patterns: [/cleft.*rock/i, /crevice/i, /crack.*stone/i]
    },
    onePoint: {
      concepts: ["opening", "indentation"],
      patterns: [/opening/i, /indentation/i],
      requiresExplain: ["opening"]
    }
  },
  
  q137: {
    twoPoint: {
      concepts: ["high and steep", "20 ft escarpment", "terrain change"],
      patterns: [/high.*steep/i, /20.*ft/i, /escarpment/i, /terrain/i]
    },
    onePoint: {
      concepts: ["tired", "fatigue", "wind"],
      patterns: [/tired/i, /fatigue/i, /wind/i]
    }
  },
  
  q138: {
    twoPoint: {
      concepts: ["fatigue", "last cliff face"],
      patterns: [/fatigue/i, /cliff.*face/i]
    },
    onePoint: {
      concepts: ["hand holds", "mental defeat", "frustration"],
      patterns: [/hand.*hold/i, /mental.*defeat/i, /frustration/i]
    }
  },
  
  q139: {
    twoPoint: {
      concepts: ["determined and gone far", "come so far"],
      patterns: [/determin.*far/i, /come.*so.*far/i, /already.*gone.*distance/i]
    },
    onePoint: {
      concepts: ["close to top", "hiked 5 miles"],
      patterns: [/close.*top/i, /5.*mile/i, /6000.*feet/i]
    }
  },
  
  q140: {
    twoPoint: {
      concepts: ["focused on herself", "needed to get to top"],
      patterns: [/focus.*herself/i, /need.*herself.*top/i]
    },
    onePoint: {
      concepts: ["looking down", "discouraged", "fear"],
      patterns: [/look.*down/i, /discourag/i, /fear/i, /afraid/i],
      requiresExplain: ["discouraged"]
    }
  }
};

/* ===========================
   Trial Configuration - Items 75-140 in order
   =========================== */
const TRIALS = [
  // 1.jpeg - Items 75-80
  {
    item: 75,
    image: "1.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q75",
        text: "Who is Kwawar?",
        scoringKey: "q75"
      }
    ]
  },
  {
    item: 76,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q76",
        text: "In all, how many Turtle Brothers were needed to fulfill Kwawar's request?",
        scoringKey: "q76"
      }
    ]
  },
  {
    item: 77,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q77",
        text: "What caused the mountains to arise?",
        scoringKey: "q77"
      }
    ]
  },
  {
    item: 78,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q78",
        text: "What natural event does the Turtle Brothers' quarreling explain?",
        scoringKey: "q78"
      }
    ]
  },
  {
    item: 79,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q79",
        text: "What great gift did Kwawr give the Turtle Brothers?",
        scoringKey: "q79"
      }
    ]
  },
  {
    item: 80,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q80",
        text: "What is the meaning of contemplated in the story?",
        scoringKey: "q80"
      }
    ]
  },
  // 2.jpeg - Items 82-83
  {
    item: 82,
    image: "2.jpeg",
    type: "passage",
    instruction: "Read this aloud.",
    readAloud: true,
    questions: [
      {
        id: "q82",
        text: "Tell me in your own words, what has happened as a result of the avalanche?",
        scoringKey: "q82"
      }
    ]
  },
  {
    item: 83,
    image: "2.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q83",
        text: "What does the word debris mean in this sentence?",
        scoringKey: "q83"
      }
    ]
  },
  // 3.jpeg - Items 84-85
  {
    item: 84,
    image: "3.jpeg",
    type: "read-aloud-only",
    instruction: "Read this aloud.",
    readAloud: true,
    skipScoring: true
  },
  {
    item: 85,
    image: "3.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q85",
        text: "What does the word fancy mean in this sentence?",
        scoringKey: "q85"
      }
    ]
  },
  // 4.jpeg - Items 86-88
  {
    item: 86,
    image: "4.jpeg",
    type: "read-aloud-only",
    instruction: "Read this aloud.",
    readAloud: true,
    skipScoring: true
  },
  {
    item: 88,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q88",
        text: "What does the word inclement mean in this sentence?",
        scoringKey: "q88"
      }
    ]
  },
  // 5.jpeg - More Yukon Gold items
  {
    item: 90,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q90",
        text: "According to Diana, why doesn't Charlie want to go to Yukon?",
        scoringKey: "q90"
      }
    ]
  },
  {
    item: 91,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q91",
        text: "According to the reviewers, what are two main themes or ideas in Yukon Gold?",
        scoringKey: "q91"
      }
    ]
  },
  {
    item: 92,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q92",
        text: "Diana gave Yukon Gold four stars although Gary gave it two. What did Gary dislike about the movie?",
        scoringKey: "q92"
      }
    ]
  },
  // 6.jpeg - Words of Wisdom (Grade 9-12 start)
  {
    item: 94,
    image: "6.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    isGateItem: true,
    questions: [
      {
        id: "q94",
        text: "What is the meaning of the word records in the first paragraph?",
        scoringKey: "q94"
      }
    ]
  },
  {
    item: 95,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q95",
        text: "Where do you think Ben Franklin found the proverbs he included in the Poor Richard's Almanack?",
        scoringKey: "q95"
      }
    ]
  },
  {
    item: 96,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q96",
        text: "What do you think Haste makes waste might mean?",
        scoringKey: "q96"
      }
    ]
  },
  {
    item: 97,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q97",
        text: "Why do you think most people like proverbs?",
        scoringKey: "q97"
      }
    ]
  },
  {
    item: 98,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q98",
        text: "Which of the proverbs mentioned in the passage is a comment on modern technology?",
        scoringKey: "q98"
      }
    ]
  },
  // 7.jpeg - Items 99-100
  {
    item: 99,
    image: "7.jpeg",
    type: "read-aloud-only",
    instruction: "Read this aloud.",
    readAloud: true,
    skipScoring: true
  },
  {
    item: 100,
    image: "7.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q100",
        text: "How are mammals and saurian different?",
        scoringKey: "q100"
      }
    ]
  },
  // 8.jpeg - Items 101-102
  {
    item: 101,
    image: "8.jpeg",
    type: "read-aloud-only",
    instruction: "Read this aloud.",
    readAloud: true,
    skipScoring: true
  },
  {
    item: 102,
    image: "8.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q102",
        text: "What does the sentence tell you that the great Dust Bowl was?",
        scoringKey: "q102"
      }
    ]
  },
  // 9.jpeg - Items 103-107
  {
    item: 103,
    image: "9.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q103",
        text: "For what primary reason did Kristi's mother want her daughter to skate?",
        scoringKey: "q103"
      }
    ]
  },
  {
    item: 104,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q104",
        text: "How does the definition of routine in the first paragraph differ from that in the next paragraph?",
        scoringKey: "q104"
      }
    ]
  },
  {
    item: 105,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q105",
        text: "Why was Kristi's workload double that of other skaters?",
        scoringKey: "q105"
      }
    ]
  },
  {
    item: 106,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q106",
        text: "Who won the pairs gold medal at the 1990 Nationals?",
        scoringKey: "q106"
      }
    ]
  },
  {
    item: 107,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q107",
        text: "How was Kristi able to compensate for her athletic limitations?",
        scoringKey: "q107"
      }
    ]
  },
  // 10.jpeg - Items 108-112
  {
    item: 108,
    image: "10.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    isGateItem: true,
    questions: [
      {
        id: "q108",
        text: "What is the meaning of the word demise in this story?",
        scoringKey: "q108"
      }
    ]
  },
  {
    item: 109,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q109",
        text: "In what two ways have people been the primary reason for the whales' demise?",
        scoringKey: "q109"
      }
    ]
  },
  {
    item: 110,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q110",
        text: "Why is it important for us to know about the struggles of the humpback whales?",
        scoringKey: "q110"
      }
    ]
  },
  {
    item: 111,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q111",
        text: "What two things might happen if a whale is caught in a fishing net?",
        scoringKey: "q111"
      }
    ]
  },
  {
    item: 112,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q112",
        text: "According to current studies, what is likely to happen to the humpback whale in the future?",
        scoringKey: "q112"
      }
    ]
  },
  // 11.jpeg - Items 113-114
  {
    item: 113,
    image: "11.jpeg",
    type: "read-aloud-only",
    instruction: "Read this aloud.",
    readAloud: true,
    skipScoring: true
  },
  {
    item: 114,
    image: "11.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q114",
        text: "What is the most likely reason for the changes in the peach prices during the year?",
        scoringKey: "q114"
      }
    ]
  },
  // 12.jpeg - Items 115-119
  {
    item: 115,
    image: "12.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q115",
        text: "If today's zoo admission is $4.00, what was zoo admission in January 1993?",
        scoringKey: "q115"
      }
    ]
  },
  {
    item: 116,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q116",
        text: "What is the main reason Tom gives to support his position?",
        scoringKey: "q116"
      }
    ]
  },
  {
    item: 117,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q117",
        text: "When he says take up the slack in his sentence, what does Tom mean?",
        scoringKey: "q117"
      }
    ]
  },
  {
    item: 118,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q118",
        text: "Tanisha uses the word acquisitions in her letter. What does it mean?",
        scoringKey: "q118"
      }
    ]
  },
  {
    item: 119,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q119",
        text: "According to Tanisha, what three things might happen if zoo prices are not raised?",
        scoringKey: "q119"
      }
    ]
  },
  // 13.jpeg - Items 120-122
  {
    item: 120,
    image: "13.jpeg",
    type: "read-aloud-only",
    instruction: "Read this aloud.",
    readAloud: true,
    skipScoring: true
  },
  {
    item: 121,
    image: "13.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q121",
        text: "What has happened to the king?",
        scoringKey: "q121"
      }
    ]
  },
  {
    item: 122,
    image: "13.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q122",
        text: "What would you predict might happen as a result of the event described?",
        scoringKey: "q122"
      }
    ]
  },
  // 14.jpeg - Items 123-127
  {
    item: 123,
    image: "14.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q123",
        text: "What was the first discovery of the Central Asiatic Expedition?",
        scoringKey: "q123"
      }
    ]
  },
  {
    item: 124,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q124",
        text: "Tell three adventures Andrews had experienced before going to the Gobi desert.",
        scoringKey: "q124"
      }
    ]
  },
  {
    item: 125,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q125",
        text: "Where did the scientists discover the dinosaur eggs?",
        scoringKey: "q125"
      }
    ]
  },
  {
    item: 126,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q126",
        text: "How did Andrew's expedition alter scientific knowledge?",
        scoringKey: "q126"
      }
    ]
  },
  {
    item: 127,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q127",
        text: "What is the meaning of the word brigands as used in the passage?",
        scoringKey: "q127"
      }
    ]
  },
  // 15.jpeg - Items 128-130
  {
    item: 128,
    image: "15.jpeg",
    type: "read-aloud-only",
    instruction: "Read this aloud.",
    readAloud: true,
    skipScoring: true
  },
  {
    item: 129,
    image: "15.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q129",
        text: "What is the meaning of the word longevity in this sentence?",
        scoringKey: "q129"
      }
    ]
  },
  {
    item: 130,
    image: "15.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q130",
        text: "Describe the trend reported in this sentence.",
        scoringKey: "q130"
      }
    ]
  },
  // 16.jpeg - Items 131-135
  {
    item: 131,
    image: "16.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q131",
        text: "At what life stage is a person likely to begin a career?",
        scoringKey: "q131"
      }
    ]
  },
  {
    item: 132,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q132",
        text: "What is the main theme of the 'Mid-life Rebirth' developmental tasks?",
        scoringKey: "q132"
      }
    ]
  },
  {
    item: 133,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q133",
        text: "Although Rachel was recently promoted to manager of her office, she is questioning her choice of careers and regrets that she never pursued her dream of composing music. At the same time, she is reluctant to quit her job because she recently bought a new home. What developmental stage is Rachel probably in?",
        scoringKey: "q133"
      }
    ]
  },
  {
    item: 134,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q134",
        text: "What might happen if a person did not accomplish the developmental tasks of the 'Breaking Loose' stage?",
        scoringKey: "q134"
      }
    ]
  },
  {
    item: 135,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q135",
        text: "If the last life stage called 'Deepening Wisdom' were added to the chart, what would you predict two of the developmental tasks would be?",
        scoringKey: "q135"
      }
    ]
  },
  // 17.jpeg - Items 136-140
  {
    item: 136,
    image: "17.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q136",
        text: "What is the fissure as described in the passage?",
        scoringKey: "q136"
      }
    ]
  },
  {
    item: 137,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q137",
        text: "What suddenly made this rock climb so difficult?",
        scoringKey: "q137"
      }
    ]
  },
  {
    item: 138,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q138",
        text: "What was the most important thing the women had to overcome in order to scale the rock?",
        scoringKey: "q138"
      }
    ]
  },
  {
    item: 139,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q139",
        text: "What kept the women from turning back when they saw the sheer surface of the rock?",
        scoringKey: "q139"
      }
    ]
  },
  {
    item: 140,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q140",
        text: "Why did Angela refuse to look at Sherry as she approached the summit?",
        scoringKey: "q140"
      }
    ]
  }
];

/* ===========================
   CONFIGURATION
   =========================== */
// IMPORTANT: Replace this with your Google Apps Script Web App URL
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX6yfgjIVSzmL2nL73IxIWPCV4RPbxfjPTDOxB-_Ax6siB2vmKJXnCpwLP4-PUA4MCpQ/exec';

/* ===========================
   State Management
   =========================== */
let state = {
  pid: '',
  edu: '',
  currentIndex: 0,
  totalPoints: 0,
  consecutiveZeros: 0,
  results: [],
  sequence: [],
  timerInterval: null,
  readingStartTime: null,
  itemStartTime: null,
  mediaRecorder: null,
  recordedChunks: [],
  stream: null,
  adminMode: false, // Set true to see scoring during testing
  uploadAttempts: 0,
  savedData: null // Store data for retry
};

/* ===========================
   Flexible Scoring System
   =========================== */
function flexibleScore(response, scoringKey) {
  const scoring = SCORING_REFERENCE[scoringKey];
  if (!scoring) {
    return {
      autoScore: null,
      confidence: 'none',
      needsReview: true,
      notes: 'No scoring reference available'
    };
  }
  
  const cleaned = response.toLowerCase().trim();
  
  // Handle count-based scoring
  if (scoring.countBased) {
    let foundConcepts = [];
    scoring.validConcepts.forEach(concept => {
      if (cleaned.includes(concept.toLowerCase())) {
        foundConcepts.push(concept);
      }
    });
    
    const uniqueCount = [...new Set(foundConcepts)].length;
    
    if (uniqueCount >= scoring.twoPoint.minCount) {
      return {
        autoScore: 2,
        confidence: 'medium',
        foundConcepts: foundConcepts,
        needsReview: true,
        notes: `Found ${uniqueCount} concepts`
      };
    } else if (uniqueCount >= scoring.onePoint.minCount) {
      return {
        autoScore: 1,
        confidence: 'medium',
        foundConcepts: foundConcepts,
        needsReview: true,
        notes: `Found ${uniqueCount} concepts`
      };
    } else {
      return {
        autoScore: 0,
        confidence: 'low',
        foundConcepts: foundConcepts,
        needsReview: true,
        notes: 'May have missed concepts'
      };
    }
  }
  
  // Handle "requires both" scoring
  if (scoring.twoPoint.requiresBoth) {
    const hasAll = scoring.twoPoint.requiresBoth.every(req => 
      cleaned.includes(req.toLowerCase())
    );
    
    if (hasAll) {
      return {
        autoScore: 2,
        confidence: 'high',
        needsReview: false,
        notes: 'Contains all required elements'
      };
    }
    
    const hasAny = scoring.twoPoint.requiresBoth.some(req => 
      cleaned.includes(req.toLowerCase())
    );
    
    if (hasAny) {
      return {
        autoScore: 1,
        confidence: 'medium',
        needsReview: true,
        notes: 'Contains partial elements'
      };
    }
  }
  
  // Check patterns for 2-point responses
  if (scoring.twoPoint.patterns) {
    for (let pattern of scoring.twoPoint.patterns) {
      if (pattern.test(cleaned)) {
        return {
          autoScore: 2,
          confidence: 'high',
          needsReview: false,
          matchedPattern: pattern.toString(),
          notes: 'Clear pattern match'
        };
      }
    }
  }
  
  // Check semantic concepts for 2-point responses
  if (scoring.twoPoint.concepts) {
    for (let concept of scoring.twoPoint.concepts) {
      if (cleaned.includes(concept.toLowerCase())) {
        return {
          autoScore: 2,
          confidence: 'medium',
          needsReview: true,
          matchedConcept: concept,
          notes: 'Concept match - verify context'
        };
      }
    }
  }
  
  // Check 1-point patterns
  if (scoring.onePoint.patterns) {
    for (let pattern of scoring.onePoint.patterns) {
      if (pattern.test(cleaned)) {
        return {
          autoScore: 1,
          confidence: 'medium',
          needsReview: true,
          matchedPattern: pattern.toString(),
          notes: 'Partial credit pattern'
        };
      }
    }
  }
  
  // Check 1-point concepts
  if (scoring.onePoint.concepts) {
    for (let concept of scoring.onePoint.concepts) {
      if (cleaned.includes(concept.toLowerCase())) {
        return {
          autoScore: 1,
          confidence: 'low',
          needsReview: true,
          matchedConcept: concept,
          notes: 'Partial concept - needs review'
        };
      }
    }
  }
  
  // No clear match
  return {
    autoScore: 0,
    confidence: 'none',
    needsReview: true,
    notes: 'No pattern match - requires human scoring'
  };
}

/* ===========================
   Recording Functions
   =========================== */
async function setupRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }, 
      audio: true 
    });
    
    state.stream = stream;
    const preview = document.getElementById('preview');
    preview.srcObject = stream;
    
    const options = {
      mimeType: 'video/webm;codecs=vp8,opus'
    };
    
    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
      options.mimeType = 'video/webm';
    }
    
    state.mediaRecorder = new MediaRecorder(stream, options);
    state.recordedChunks = [];
    
    state.mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        state.recordedChunks.push(event.data);
      }
    };
    
    state.mediaRecorder.onstop = async () => {
      const blob = new Blob(state.recordedChunks, { type: 'video/webm' });
      
      // Upload to Google Drive
      uploadVideoToGoogle(blob);
    };
    
    document.getElementById('setup-status').textContent = 'Camera and microphone ready.';
    document.getElementById('start-study').disabled = false;
    
  } catch (err) {
    console.error('Error accessing media devices:', err);
    document.getElementById('setup-status').textContent = 'Error: Could not access camera/microphone. Please check permissions.';
  }
}

function startRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state === 'inactive') {
    state.mediaRecorder.start();
    document.getElementById('rec-indicator').classList.remove('hidden');
  }
}

function stopRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
    state.mediaRecorder.stop(); // This triggers the onstop handler which uploads
    document.getElementById('rec-indicator').classList.add('hidden');
  }
  if (state.stream) {
    // Don't stop tracks immediately - wait for upload to complete
    setTimeout(() => {
      state.stream.getTracks().forEach(track => track.stop());
    }, 2000);
  }
}

/* ===========================
   Timer Functions
   =========================== */
function startTimer() {
  state.readingStartTime = Date.now();
  let seconds = 0;
  
  document.getElementById('timer-container').classList.remove('hidden');
  
  state.timerInterval = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    document.getElementById('timer').textContent = 
      `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }, 1000);
}

function stopTimer() {
  if (state.timerInterval) {
    clearInterval(state.timerInterval);
    state.timerInterval = null;
  }
  document.getElementById('timer-container').classList.add('hidden');
  const elapsed = state.readingStartTime ? Date.now() - state.readingStartTime : 0;
  state.readingStartTime = null; // Reset for next use
  return elapsed;
}

/* ===========================
   DOM Elements
   =========================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

/* ===========================
   Event Listeners
   =========================== */
document.getElementById('begin').addEventListener('click', async () => {
  state.pid = document.getElementById('pid').value.trim();
  state.edu = document.getElementById('edu').value;
  
  if (!state.pid || !state.edu) {
    alert('Please complete all fields.');
    return;
  }
  
  // Check for admin mode (if participant code contains "admin")
  if (state.pid.toLowerCase().includes('admin')) {
    state.adminMode = true;
    document.body.classList.add('admin-mode');
  }
  
  // Test Google Apps Script connection
  if (GOOGLE_SCRIPT_URL.includes('YOUR_SCRIPT_ID_HERE')) {
    alert('Please configure the Google Apps Script URL in the code first!');
    return;
  }
  
  showScreen('setup');
  await setupRecording();
});

document.getElementById('test-audio').addEventListener('click', () => {
  const audio = new Audio();
  audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE';
  audio.play();
});

document.getElementById('start-study').addEventListener('click', () => {
  startRecording();
  buildSequence();
  state.currentIndex = 0;
  showItem();
});

document.getElementById('start-reading').addEventListener('click', () => {
  startTimer();
  document.getElementById('start-reading').classList.add('hidden');
  document.getElementById('done-reading').classList.remove('hidden');
});

document.getElementById('done-reading').addEventListener('click', () => {
  const readingTime = stopTimer();
  showQuestions(readingTime);
});

document.getElementById('qa-form').addEventListener('submit', (e) => {
  try {
    submitAnswers(e);
  } catch (error) {
    console.error('Error submitting answers:', error);
    alert('An error occurred. Check console for details.');
  }
});
document.getElementById('skip').addEventListener('click', skipItem);
document.getElementById('retry-upload').addEventListener('click', retryUpload);
document.getElementById('download-backup').addEventListener('click', downloadBackup);

/* ===========================
   Core Functions
   =========================== */
function buildSequence() {
  const gradeNum = state.edu === "13+" ? 13 : parseInt(state.edu);
  
  // Sort trials by item number
  const sortedTrials = TRIALS.slice().sort((a, b) => a.item - b.item);
  
  if (gradeNum >= 9) {
    // Grades 9+ start at item 94
    const startIdx = sortedTrials.findIndex(t => t.item === 94);
    if (startIdx >= 0) {
      state.sequence = sortedTrials.slice(startIdx);
    } else {
      state.sequence = sortedTrials;
    }
  } else {
    // Lower grades start at item 75
    state.sequence = sortedTrials;
  }
  
  console.log(`Built sequence with ${state.sequence.length} items for grade ${state.edu}`);
}

function showItem() {
  if (state.currentIndex >= state.sequence.length) {
    finishAssessment();
    return;
  }
  
  // WIAT-2 discontinue rule: 6 consecutive zeros for older students
  if (state.consecutiveZeros >= 6) {
    finishAssessment();
    return;
  }
  
  const trial = state.sequence[state.currentIndex];
  console.log('Showing item:', trial.item, 'Index:', state.currentIndex); // Debug log
  
  showScreen('item');
  updateProgress();
  updateAdminPanel();
  
  document.getElementById('item-number').textContent = `Item ${state.currentIndex + 1} of ${state.sequence.length}`;
  document.getElementById('stim').src = `stimuli/${trial.image}`;
  
  document.getElementById('qa-form').classList.add('hidden');
  document.getElementById('qa-fields').innerHTML = '';
  document.getElementById('timer').textContent = '00:00';
  
  const instruction = trial.instruction || '';
  document.getElementById('instruction-text').textContent = instruction;
  
  if (trial.skipScoring) {
    document.getElementById('start-reading').classList.add('hidden');
    document.getElementById('done-reading').classList.remove('hidden');
    document.getElementById('done-reading').textContent = 'Continue';
  } else if (trial.skipReading) {
    document.getElementById('start-reading').classList.add('hidden');
    document.getElementById('done-reading').classList.add('hidden');
    showQuestions(0);
  } else {
    document.getElementById('start-reading').classList.remove('hidden');
    document.getElementById('done-reading').classList.add('hidden');
    document.getElementById('done-reading').textContent = 'Done Reading';
  }
  
  state.itemStartTime = Date.now();
}

function showQuestions(readingTime) {
  const trial = state.sequence[state.currentIndex];
  
  if (trial.skipScoring) {
    state.results.push({
      pid: state.pid,
      edu: state.edu,
      item: trial.item,
      image: trial.image,
      type: 'read-aloud',
      response: 'N/A',
      autoScore: 'N/A',
      readingTime: readingTime || 0,
      timestamp: new Date().toISOString()
    });
    state.currentIndex++;
    showItem();
    return;
  }
  
  document.getElementById('qa-form').classList.remove('hidden');
  document.getElementById('start-reading').classList.add('hidden');
  document.getElementById('done-reading').classList.add('hidden');
  
  trial.questions.forEach(q => {
    const qDiv = document.createElement('div');
    qDiv.className = 'q-block';
    
    const label = document.createElement('label');
    label.textContent = q.text;
    label.setAttribute('for', q.id);
    
    const textarea = document.createElement('textarea');
    textarea.id = q.id;
    textarea.name = q.id;
    textarea.required = true;
    
    // Check if this question might need follow-up
    try {
      const scoring = SCORING_REFERENCE[q.scoringKey];
      if (scoring && scoring.onePoint && scoring.onePoint.requiresExplain) {
        textarea.addEventListener('input', function() {
          checkForExplain(this.value, q, scoring.onePoint.requiresExplain);
        });
      }
    } catch (err) {
      console.log('No special scoring requirements for', q.scoringKey);
    }
    
    qDiv.appendChild(label);
    qDiv.appendChild(textarea);
    document.getElementById('qa-fields').appendChild(qDiv);
  });
}

function checkForExplain(response, question, triggers) {
  const lower = response.toLowerCase();
  const needsExplain = triggers.some(t => lower.includes(t.toLowerCase()));
  
  const explainId = `${question.id}_explain`;
  let explainDiv = document.getElementById(`${explainId}_div`);
  
  if (needsExplain && !explainDiv) {
    const div = document.createElement('div');
    div.id = `${explainId}_div`;
    div.className = 'explain-field';
    
    const label = document.createElement('label');
    label.textContent = 'Please explain:';
    label.setAttribute('for', explainId);
    
    const textarea = document.createElement('textarea');
    textarea.id = explainId;
    textarea.name = explainId;
    
    div.appendChild(label);
    div.appendChild(textarea);
    
    const questionDiv = document.getElementById(question.id).parentElement;
    questionDiv.appendChild(div);
  } else if (!needsExplain && explainDiv) {
    explainDiv.remove();
  }
}

function submitAnswers(e) {
  e.preventDefault();
  
  const trial = state.sequence[state.currentIndex];
  console.log('Submitting answers for item:', trial.item); // Debug log
  
  let totalScore = 0;
  let allNeedReview = false;
  const responses = {};
  
  trial.questions.forEach(q => {
    const response = document.getElementById(q.id).value.trim();
    const explain = document.getElementById(`${q.id}_explain`) ? 
      document.getElementById(`${q.id}_explain`).value.trim() : "";
    
    const scoringResult = flexibleScore(response, q.scoringKey);
    
    if (scoringResult.needsReview) allNeedReview = true;
    totalScore += (scoringResult.autoScore || 0);
    
    responses[q.id] = {
      question: q.text,
      response: response,
      explanation: explain,
      autoScore: scoringResult.autoScore,
      scoringDetails: scoringResult,
      needsReview: scoringResult.needsReview
    };
  });
  
  const finalScore = Math.round(totalScore / trial.questions.length);
  
  state.totalPoints += finalScore;
  if (finalScore === 0) {
    state.consecutiveZeros++;
  } else {
    state.consecutiveZeros = 0;
  }
  
  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    responses: responses,
    autoScoreTotal: finalScore,
    needsReview: allNeedReview,
    readingTime: state.readingStartTime ? Date.now() - state.readingStartTime : 0,
    totalTime: Date.now() - state.itemStartTime,
    timestamp: new Date().toISOString()
  });
  
  console.log('Moving to next item from index', state.currentIndex, 'to', state.currentIndex + 1); // Debug log
  state.currentIndex++;
  showItem();
}

function skipItem() {
  const trial = state.sequence[state.currentIndex];
  
  // Only count toward discontinue if it's a scored item
  if (!trial.skipScoring) {
    state.consecutiveZeros++;
  }
  
  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    response: 'SKIPPED',
    autoScore: 0,
    needsReview: false,
    readingTime: 0,
    totalTime: Date.now() - state.itemStartTime,
    timestamp: new Date().toISOString()
  });
  
  console.log(`Item ${trial.item} skipped. Consecutive zeros: ${state.consecutiveZeros}`);
  
  state.currentIndex++;
  showItem();
}

function updateProgress() {
  const percent = (state.currentIndex / state.sequence.length) * 100;
  document.getElementById('progress').style.width = `${percent}%`;
}

function updateAdminPanel() {
  if (state.adminMode) {
    document.getElementById('admin-score').textContent = state.totalPoints;
    document.getElementById('admin-zeros').textContent = state.consecutiveZeros;
  }
}

function finishAssessment() {
  showScreen('finish');
  let msg = 'Thank you for participating.';
  
  if (state.consecutiveZeros >= 6) {
    msg = `Study discontinued after ${state.consecutiveZeros} consecutive zero-point responses.`;
  } else if (state.currentIndex >= state.sequence.length) {
    msg = `Completed all ${state.sequence.length} items. Thank you for participating.`;
  }
  
  console.log('Assessment finished:', {
    reason: msg,
    totalItems: state.sequence.length,
    completedItems: state.results.length,
    consecutiveZeros: state.consecutiveZeros,
    totalScore: state.totalPoints
  });
  
  document.getElementById('finish-msg').textContent = msg;
  
  // Stop recording and upload data
  stopRecording();
  uploadDataToGoogle();
}

async function uploadDataToGoogle() {
  // Prepare data for upload
  const summaryData = {
    participant: state.pid,
    education: state.edu,
    totalAutoScore: state.totalPoints,
    itemsNeedingReview: state.results.filter(r => r.needsReview).length,
    allResponses: state.results
  };
  
  state.savedData = summaryData; // Save for retry
  
  updateUploadStatus('Uploading assessment data...');
  
  try {
    // Send data to Google Apps Script
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors', // Required for Google Apps Script
      body: new URLSearchParams({
        type: 'data',
        data: JSON.stringify(summaryData)
      })
    });
    
    // Note: With no-cors, we can't read the response
    // Assume success if no error thrown
    updateUploadStatus(' Assessment data saved successfully');
    
    // Show backup download option just in case
    document.getElementById('download-backup').classList.remove('hidden');
    
  } catch (error) {
    console.error('Upload error:', error);
    updateUploadStatus(' Upload failed. Please use retry or download backup.');
    document.getElementById('retry-upload').classList.remove('hidden');
    document.getElementById('download-backup').classList.remove('hidden');
  }
}

async function uploadVideoToGoogle(blob) {
  updateUploadStatus('Uploading video recording...');
  
  try {
    // Convert blob to base64
    const reader = new FileReader();
    reader.onloadend = async function() {
      const base64data = reader.result.split(',')[1];
      
      // Send to Google Apps Script
      const response = await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: new URLSearchParams({
          type: 'video',
          pid: state.pid,
          timestamp: Date.now(),
          video: base64data
        })
      });
      
      updateUploadStatus(' Video uploaded successfully');
    };
    reader.readAsDataURL(blob);
    
  } catch (error) {
    console.error('Video upload error:', error);
    updateUploadStatus(' Video upload failed. Contact administrator.');
  }
}

function updateUploadStatus(message) {
  const statusDiv = document.getElementById('upload-status');
  const progressDiv = document.getElementById('upload-progress');
  
  progressDiv.textContent = message;
  
  // Add appropriate styling based on message
  if (message.includes('')) {
    statusDiv.className = 'success';
  } else if (message.includes('')) {
    statusDiv.className = 'error';
  } else {
    statusDiv.className = '';
  }
}

function retryUpload() {
  state.uploadAttempts++;
  updateUploadStatus(`Retrying upload (attempt ${state.uploadAttempts + 1})...`);
  uploadDataToGoogle();
}

function downloadBackup() {
  // Create local backup as fallback
  if (!state.savedData) {
    state.savedData = {
      participant: state.pid,
      education: state.edu,
      totalAutoScore: state.totalPoints,
      itemsNeedingReview: state.results.filter(r => r.needsReview).length,
      allResponses: state.results
    };
  }
  
  // CSV backup
  const rows = [
    ['PID', 'Education', 'Item', 'Image', 'Question', 'Response', 'Explanation', 
     'AutoScore', 'Confidence', 'NeedsReview', 'ScoringNotes', 
     'ReadingTime(ms)', 'TotalTime(ms)', 'Timestamp']
  ];
  
  state.results.forEach(r => {
    if (r.responses) {
      Object.keys(r.responses).forEach(qId => {
        const q = r.responses[qId];
        rows.push([
          r.pid,
          r.edu,
          r.item,
          r.image,
          q.question,
          q.response.replace(/[,\n]/g, '; '),
          (q.explanation || '').replace(/[,\n]/g, '; '),
          q.autoScore !== null ? q.autoScore : 'REVIEW',
          q.scoringDetails ? q.scoringDetails.confidence : '',
          q.needsReview ? 'YES' : 'NO',
          q.scoringDetails ? q.scoringDetails.notes : '',
          r.readingTime || '',
          r.totalTime || '',
          r.timestamp
        ]);
      });
    } else {
      rows.push([
        r.pid,
        r.edu,
        r.item,
        r.image,
        'N/A',
        r.response || 'N/A',
        '',
        r.autoScore === 'N/A' ? 'N/A' : r.autoScore,
        '',
        'NO',
        '',
        r.readingTime || '',
        r.totalTime || '',
        r.timestamp
      ]);
    }
  });
  
  const csv = rows.map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${state.pid}_backup_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  
  // Also download JSON
  const jsonBlob = new Blob([JSON.stringify(state.savedData, null, 2)], { type: 'application/json' });
  const jsonUrl = URL.createObjectURL(jsonBlob);
  const jsonLink = document.createElement('a');
  jsonLink.href = jsonUrl;
  jsonLink.download = `${state.pid}_backup_${Date.now()}.json`;
  document.body.appendChild(jsonLink);
  jsonLink.click();
  jsonLink.remove();
  URL.revokeObjectURL(jsonUrl);
  
  updateUploadStatus('Backup files downloaded. Please send to researcher.');
}

function showScreen(name) {
  document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
  document.getElementById(`screen-${name}`).classList.remove('hidden');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  showScreen('welcome');
  
  // Check if Google Script URL is configured
  if (GOOGLE_SCRIPT_URL.includes('YOUR_SCRIPT_ID_HERE')) {
    document.getElementById('config-warning').classList.remove('hidden');
  }
});
</script>
</body>
</html>
