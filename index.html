<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WIAT-2 Reading Comprehension Study</title>
<style>
  body { 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; 
    margin: 0; 
    background: #f8f9fa; 
    color: #212529; 
  }
  .wrap { 
    max-width: 900px; 
    margin: 0 auto; /* FIXED: Center content */
    padding: 20px; 
  }
  .card { 
    background: #fff; 
    border: 1px solid #dee2e6; 
    border-radius: 4px; 
    padding: 20px; 
    margin: 12px 0; 
  }
  h1 { 
    font-size: 1.5rem; 
    margin: 0 0 12px; 
    font-weight: 400; 
  }
  h2 { 
    font-size: 1.25rem; 
    margin: 0 0 12px; 
    font-weight: 400; 
  }
  .row { 
    display: flex; 
    gap: 12px; 
    flex-wrap: wrap; 
    margin: 12px 0; 
  }
  .row > * { 
    flex: 1 1 auto; 
    min-width: 200px; 
  }
  label { 
    display: block; 
    margin: 8px 0 4px; 
    font-size: 14px; 
  }
  input[type="text"], textarea, select { 
    width: 100%; 
    border: 1px solid #ced4da; 
    border-radius: 3px; 
    padding: 6px 8px; 
    font-size: 14px; 
    box-sizing: border-box; /* FIXED: Prevent overflow */
  }
  textarea { 
    min-height: 70px; 
    resize: vertical; 
    font-family: inherit; 
  }
  button { 
    padding: 8px 16px; 
    border-radius: 3px; 
    border: 1px solid #6c757d; 
    background: #6c757d; 
    color: #fff; 
    cursor: pointer; 
    font-size: 14px; 
    /* FIXED: Better touch targets */
    min-height: 44px;
    min-width: 44px;
  }
  button:hover { 
    background: #5a6268; 
  }
  button.primary { 
    background: #0d6efd; 
    border-color: #0d6efd; 
  }
  button.primary:hover { 
    background: #0b5ed7; 
  }
  button.danger {
    background: #dc3545;
    border-color: #dc3545;
  }
  button.danger:hover {
    background: #c82333;
  }
  button:disabled { 
    opacity: 0.6; 
    cursor: not-allowed; 
  }
  .hidden { 
    display: none !important; 
  }
  .muted { 
    color: #6c757d; 
    font-size: 13px; 
    margin: 8px 0; 
  }
  .center { 
    text-align: center; 
  }
  img.stim { 
    max-width: 100%; 
    height: auto; 
    border: 1px solid #dee2e6; 
    display: block; 
    margin: 12px auto; 
  }
  .q-block { 
    margin: 12px 0; 
    padding: 8px; 
    background: #f8f9fa; 
    border-left: 3px solid #dee2e6; 
  }
  .explain-field { 
    margin-top: 8px; 
    padding: 8px; 
    background: #fff3cd; 
    border-left: 3px solid #ffc107; 
  }

/* Recording indicator */
.recording-indicator {
position: fixed;
top: 20px;
right: 20px;
padding: 8px 12px;
background: #dc3545;
color: #fff;
border-radius: 4px;
display: flex;
align-items: center;
gap: 8px;
font-size: 13px;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.recording-dot {
width: 8px;
height: 8px;
background: #fff;
border-radius: 50%;
animation: pulse 1.5s infinite;
}
@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.3; }
}

/* Screen-reader only utility */
.sr-only {
position:absolute; width:1px; height:1px; padding:0; margin:-1px;
overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}

/* Timer display */
.timer-display {
font-family: monospace;
font-size: 18px;
color: #495057;
background: #f8f9fa;
padding: 4px 8px;
border-radius: 3px;
display: inline-block;
}

/* Progress bar */
.progress-bar {
height: 3px;
background: #e9ecef;
margin: 20px 0;
border-radius: 3px;
overflow: hidden;
}
.progress-fill {
height: 100%;
background: #0d6efd;
transition: width 0.3s ease;
}

/* Item display */
.item-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 12px;
padding-bottom: 8px;
border-bottom: 1px solid #e9ecef;
}
.item-info {
font-size: 13px;
color: #6c757d;
}

/* Admin panel */
.admin-panel {
position: fixed;
bottom: 10px;
right: 10px;
background: rgba(255,255,255,0.95);
border: 1px solid #dee2e6;
border-radius: 4px;
padding: 8px;
font-size: 11px;
color: #6c757d;
display: none;
}
.admin-mode .admin-panel {
display: block;
}

/* Upload status */
.status-box {
padding: 12px;
background: #f8f9fa;
border-radius: 4px;
border-left: 3px solid #0d6efd;
margin: 12px 0;
}
.status-box.success {
border-left-color: #28a745;
background: #d4edda;
}
.status-box.error {
border-left-color: #dc3545;
background: #f8d7da;
}
.status-box.warning {
border-left-color: #ffc107;
background: #fff3cd;
}
.status-message {
font-size: 14px;
color: #495057;
}
.success .status-message {
color: #155724;
}
.error .status-message {
color: #721c24;
}
.warning .status-message {
color: #856404;
}

/* Participant group info */
.group-info {
background: #e9ecef;
padding: 15px;
border-radius: 4px;
margin: 15px 0;
}
.group-info h3 {
font-size: 14px;
margin: 0 0 10px;
font-weight: 600;
}
.radio-group {
margin: 10px 0;
}
.radio-group label {
display: flex;
align-items: center;
margin: 8px 0;
cursor: pointer;
/* FIXED: Better touch targets */
min-height: 44px;
padding: 8px;
border-radius: 4px;
background: rgba(255,255,255,0.5);
}
.radio-group label:hover {
background: rgba(255,255,255,0.8);
}
.radio-group input[type=“radio”] {
width: auto;
margin-right: 10px;
/* FIXED: Larger touch target */
transform: scale(1.5);
}

/* Recording setup info */
.recording-info {
background: #f8f9fa;
padding: 12px;
border-radius: 4px;
margin: 15px 0;
border: 1px solid #dee2e6;
}
.recording-info.video {
border-color: #0d6efd;
background: #e7f3ff;
}
.recording-info.audio {
border-color: #28a745;
background: #e6f4ea;
}

/* Recording controls */
.recording-controls {
display: flex;
gap: 10px;
align-items: center;
justify-content: center;
margin: 20px 0;
}
.recording-timer {
font-family: monospace;
font-size: 18px;
color: #dc3545;
padding: 4px 8px;
background: #f8f9fa;
border-radius: 3px;
}

/* Connection status */
.connection-status {
position: fixed;
bottom: 10px;
left: 10px;
padding: 5px 10px;
background: #fff;
border: 1px solid #dee2e6;
border-radius: 3px;
font-size: 11px;
}
.connection-status.connected {
border-color: #28a745;
color: #28a745;
}
.connection-status.error {
border-color: #dc3545;
color: #dc3545;
}

/* Video preview */
.video-preview-wrapper {
text-align: center;
margin: 20px 0;
}
.video-preview {
width: 100%;
max-width: 480px;
height: auto;
background: #000;
border: 2px solid #dee2e6;
border-radius: 4px;
}

/* Read aloud instructions */
.read-aloud-box {
background: #fff3cd;
border: 1px solid #ffc107;
border-radius: 4px;
padding: 15px;
margin: 15px 0;
}
.read-aloud-box h4 {
margin: 0 0 10px;
font-size: 14px;
color: #856404;
}

/* Modality selection */
.modality-selection {
background: #f8f9fa;
padding: 15px;
border-radius: 4px;
margin: 15px 0;
}

/* Accessibility note for deaf participants */
.accessibility-note {
background: #e7f3ff;
border: 1px solid #0d6efd;
border-radius: 4px;
padding: 10px;
margin: 10px 0;
font-size: 13px;
}
.tip-box{
background:#eef7ff;
border:1px solid #cfe2ff;
border-radius:4px;
padding:12px;
margin:12px 0;
font-size:14px;
}
.tip-box ul{ margin:8px 0 0 18px; }
.kbd{
border:1px solid #ced4da; border-bottom-width:2px;
padding:2px 6px; border-radius:3px; font-family:monospace; font-size:12px;
}
.comfort-options{
background:#f8f9fa; border:1px solid #e9ecef; border-radius:4px; padding:12px; margin:12px 0;
}
.video-preview.hidden-selfview{ visibility:hidden; }

/* FIXED: Better mobile support */
@media (max-width: 480px) {
body {
font-size: 16px;
}
.wrap {
padding: 10px; /* Reduce padding on mobile */
}
.row {
flex-direction: column;
gap: 6px;
}
.row > * {
min-width: 0; /* Allow full width on mobile */
}
button {
font-size: 16px;
padding: 12px 16px;
width: 100%; /* Full width buttons on mobile */
margin: 5px 0;
}
.video-preview {
max-width: 100%;
height: auto;
}
.recording-indicator {
bottom: 8px;
right: 8px;
top: auto;
}
.connection-status {
display: none;
}
.radio-group label {
/* Ensure radio labels are easy to tap */
padding: 12px;
margin: 4px 0;
}
.radio-group input[type=“radio”] {
/* Even larger on mobile */
transform: scale(2);
margin-right: 15px;
}
/* Prevent zooming on input focus */
input, select, textarea {
font-size: 16px !important;
}
}

/* FIXED: Prevent horizontal scroll */

- {
  box-sizing: border-box;
  }

html, body {
overflow-x: hidden;
}

</style>
</head>
<body>
<div class="wrap">
  <div id="sr-live" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

  <!-- Welcome Screen -->

  <div id="screen-welcome" class="card">
    <h1>WIAT-2 Reading Comprehension Study</h1>
    <p class="muted">Please enter your information to begin.</p>

```
<div class="row">
  <div>
    <label for="pid">Participant Code</label>
    <input id="pid" type="text" placeholder="Enter initials" required />
  </div>
  <div>
    <label for="edu">Education Level</label>
    <select id="edu" required>
      <option value="">Select...</option>
      <option value="9">Grade 9</option>
      <option value="10">Grade 10</option>
      <option value="11">Grade 11</option>
      <option value="12">Grade 12</option>
      <option value="13+">College or higher</option>
    </select>
  </div>
</div>

<div class="group-info">
  <h3>Participant Group</h3>
  <div class="radio-group">
    <label>
      <input type="radio" name="participant-group" value="deaf-fluent" />
      <span>Deaf - Fluent ASL signer</span>
    </label>
    <label>
      <input type="radio" name="participant-group" value="hearing-fluent" />
      <span>Hearing - Fluent ASL signer</span>
    </label>
    <label>
      <input type="radio" name="participant-group" value="deaf-nonfluent" />
      <span>Deaf - Non-fluent ASL signer</span>
    </label>
    <label>
      <input type="radio" name="participant-group" value="hearing-nonfluent" />
      <span>Hearing - Non-fluent ASL signer</span>
    </label>
    <label>
      <input type="radio" name="participant-group" value="hearing-nonsigner" />
      <span>Hearing - Non-signer</span>
    </label>
  </div>
</div>

<div id="modality-selection" class="modality-selection hidden">
  <h3 style="font-size: 14px; margin: 0 0 10px;">Communication Preference for "Read Aloud" Items</h3>
  <p class="muted" style="margin: 0 0 10px;">How would you prefer to "read aloud"?</p>
  <div id="deaf-note" class="accessibility-note hidden">
    <strong>Note for deaf participants:</strong> You may choose to sign in ASL (video recording) or use spoken language (audio recording) based on your preference and comfort level.
  </div>
  <div class="radio-group">
    <label>
      <input type="radio" name="read-modality" value="sign" />
      <span>Sign (ASL) - Video recording</span>
    </label>
    <label>
      <input type="radio" name="read-modality" value="speak" />
      <span>Speak - Audio recording</span>
    </label>
  </div>
</div>
```

<div id="config-warning" class="status-box error hidden" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="status-message">
    <strong>Setup Required:</strong> Google Drive integration not configured. 
    Please update GOOGLE_SCRIPT_URL in the code.
  </div>
</div>

```
<div style="margin-top: 20px;">
  <button id="begin" class="primary" disabled>Continue to Setup</button>
</div>
```

  </div>

  <!-- Setup Screen -->

  <div id="screen-setup" class="card hidden">
    <h2>Recording Setup</h2>

```
<div id="recording-method-info" class="recording-info">
  <div class="status-message" id="recording-method-text" role="status" aria-live="polite" aria-atomic="true">
```

Setting up recording…

</div>
    </div>
    <div class="comfort-options">
  <label style="display:flex;align-items:center;gap:8px;">
    <input type="checkbox" id="pref-hide-timer" />
    <span>Hide the reading timer during passages</span>
  </label>
  <label id="pref-hide-selfview" class="hidden" style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    <input type="checkbox" id="toggle-selfview" />
    <span>Hide my camera preview during recording</span>
  </label>
  <p class="muted" style="margin:8px 0 0;">You can change these anytime.</p>
</div>

```
<div id="video-setup" class="hidden">
  <p class="muted">For ASL "read aloud" items, we need to set up video recording.</p>
  <div class="video-preview-wrapper">
    <video id="preview" class="video-preview" autoplay muted playsinline></video>
  </div>
  <p id="video-status" class="muted center" role="status" aria-live="polite" aria-atomic="true">Requesting camera access...</p>

</div>

<div id="audio-setup" class="hidden">
  <p class="muted">For spoken "read aloud" items, we need to set up audio recording.</p>
  <div class="recording-controls">
    <button id="test-audio-record" class="danger">Test Audio Recording</button>
    <button id="stop-test-audio" class="hidden">Stop Test</button>
    <span class="recording-timer hidden" id="test-audio-timer">00:00</span>
  </div>
  <audio id="test-audio-playback" controls class="hidden" style="width: 100%; max-width: 400px; margin: 10px auto; display: block;"></audio>
  <p id="audio-status" class="muted center" role="status" aria-live="polite" aria-atomic="true">Click "Test Audio Recording" to verify your microphone is working.</p>
</div>

<div id="setup-status" class="status-box" style="margin-top: 20px;">
```

<div class="status-message" id="setup-status-text" role="status" aria-live="polite" aria-atomic="true">Initializing...</div>
    </div>

```
<div style="margin-top: 20px; text-align: center;">
  <button id="start-study" class="primary" disabled>Start Assessment</button>
</div>
```

  </div>

  <!-- Other screens remain the same... -->

  <div id="screen-item" class="card hidden">
    <p>Assessment screen would go here...</p>
  </div>

  <div id="screen-finish" class="card hidden">
    <p>Finish screen would go here...</p>
  </div>

</div>

<script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX6yfgjIVSzmL2nL73IxIWPCV4RPbxfjPTDOxB-_Ax6siB2vmKJXnCpwLP4-PUA4MCpQ/exec';

let state = {
  pid: '',
  edu: '',
  participantGroup: '',
  readModality: '',
  sessionStartTime: null,
  currentIndex: 0,
  totalPoints: 0,
  consecutiveZeros: 0,
  gateItemsFailed: [],
  results: [],
  sequence: [],
  timerInterval: null,
  readingStartTime: null,
  itemStartTime: null,
  recordingTimerInterval: null,
  useVideoRecording: false,
  useAudioRecording: false,
  mediaRecorder: null,
  recordedChunks: [],
  stream: null,
  adminMode: false,
  uploadAttempts: 0,
  savedData: null,
  connectionStatus: false,
  reviewQueue: [],
  scoringMetrics: {
    highConfidence: 0,
    mediumConfidence: 0,
    lowConfidence: 0,
    manualReviewNeeded: 0
  },
};

function checkWelcomeReady() {
  console.log('Checking welcome ready...'); // DEBUG
  const hasPid = document.getElementById('pid').value.trim().length > 0;
  const hasEdu = !!document.getElementById('edu').value;
  const hasGroup = !!state.participantGroup;
  const hasModality = !!state.readModality;
  
  console.log('Validation:', { hasPid, hasEdu, hasGroup, hasModality }); // DEBUG
  
  const isReady = hasPid && hasEdu && hasGroup && hasModality;
  document.getElementById('begin').disabled = !isReady;
  
  console.log('Button disabled:', !isReady); // DEBUG
}

function showScreen(name) {
  console.log('Showing screen:', name); // DEBUG
  document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
  document.getElementById(`screen-${name}`).classList.remove('hidden');
}

// FIXED: Clean event listener setup - no duplicates
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM loaded, setting up...'); // DEBUG
  showScreen('welcome');
  
  // Basic form inputs
  document.getElementById('pid').addEventListener('input', checkWelcomeReady);
  document.getElementById('edu').addEventListener('change', checkWelcomeReady);

  // Participant group selection - SINGLE listener setup
  document.querySelectorAll('input[name="participant-group"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      console.log('Participant group changed:', e.target.value); // DEBUG
      state.participantGroup = e.target.value;

      const modalityDiv = document.getElementById('modality-selection');
      const deafNote = document.getElementById('deaf-note');
      modalityDiv.classList.remove('hidden');
      
      if (state.participantGroup.startsWith('deaf')) {
        deafNote.classList.remove('hidden');
      } else {
        deafNote.classList.add('hidden');
      }

      if (state.participantGroup === 'hearing-nonsigner') {
        const speakRadio = document.querySelector('input[name="read-modality"][value="speak"]');
        if (speakRadio) {
          speakRadio.checked = true;
          state.readModality = 'speak';
        }
      }
      
      checkWelcomeReady();
      modalityDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });

  // Modality selection - SINGLE listener setup  
  document.querySelectorAll('input[name="read-modality"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      console.log('Read modality changed:', e.target.value); // DEBUG
      state.readModality = e.target.value;
      checkWelcomeReady();
    });
  });

  // Begin button
  document.getElementById('begin').addEventListener('click', async (e) => {
    console.log('Begin button clicked'); // DEBUG
    e.preventDefault(); // Prevent any form submission
    
    state.pid = document.getElementById('pid').value.trim();
    state.edu = document.getElementById('edu').value;
    
    if (!state.pid || !state.edu || !state.participantGroup || !state.readModality) {
      alert('Please complete all required fields.');
      return;
    }
    
    console.log('Validation passed, showing setup screen...'); // DEBUG
    showScreen('setup');
    
    // Setup recording based on modality
    if (state.readModality === 'sign') {
      state.useVideoRecording = true;
      state.useAudioRecording = false;
    } else {
      state.useVideoRecording = false;
      state.useAudioRecording = true;
    }
    
    // Enable start button for demo
    setTimeout(() => {
      document.getElementById('start-study').disabled = false;
      document.getElementById('setup-status-text').textContent = '✓ Setup complete';
    }, 1000);
  });

  // Start study button
  document.getElementById('start-study').addEventListener('click', () => {
    console.log('Starting study...'); // DEBUG
    showScreen('item'); // For demo, just show item screen
  });
  
  // Check for config issues
  if (GOOGLE_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT_URL_HERE')) {
    document.getElementById('config-warning').classList.remove('hidden');
    document.getElementById('begin').disabled = true;
  }
});

</script>

</body>
</html>