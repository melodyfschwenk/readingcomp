<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reading Comprehension Study</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#f8f9fa; color:#212529; }
  .wrap { max-width: 900px; margin: 0 auto; padding: 20px; }
  .card { background:#fff; border:1px solid #dee2e6; border-radius:4px; padding:20px; margin:12px 0; }
  h1 { font-size:1.5rem; margin:0 0 12px; font-weight:400; }
  h2 { font-size:1.25rem; margin:0 0 12px; font-weight:400; }
  .row { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
  .row > * { flex:1 1 auto; min-width:200px; }
  label { display:block; margin:8px 0 4px; font-size:14px; }
  input[type="text"], textarea, select { width:100%; border:1px solid #ced4da; border-radius:3px; padding:6px 8px; font-size:14px; }
  textarea { min-height:70px; resize:vertical; font-family:inherit; }
  button { padding:8px 16px; border-radius:3px; border:1px solid #6c757d; background:#6c757d; color:#fff; cursor:pointer; font-size:14px; }
  button:hover { background:#5a6268; }
  button.primary { background:#0d6efd; border-color:#0d6efd; }
  button.primary:hover { background:#0b5ed7; }
  button:disabled { opacity:0.6; cursor:not-allowed; }
  .hidden { display:none !important; }
  .muted { color:#6c757d; font-size:13px; margin:8px 0; }
  .center { text-align:center; }
  img.stim { max-width:100%; height:auto; border:1px solid #dee2e6; display:block; margin: 12px auto; }
  .q-block { margin: 12px 0; padding:8px; background:#f8f9fa; border-left:3px solid #dee2e6; }
  .explain-field { margin-top:8px; padding:8px; background:#fff3cd; border-left:3px solid #ffc107; }
  
  /* Recording indicator */
  .recording-indicator { 
    position:fixed; top:20px; right:20px; padding:8px 12px; 
    background:#dc3545; color:#fff; border-radius:4px; 
    display:flex; align-items:center; gap:8px; font-size:13px;
    box-shadow:0 2px 4px rgba(0,0,0,0.2);
  }
  .recording-dot { 
    width:8px; height:8px; background:#fff; border-radius:50%; 
    animation: pulse 1.5s infinite; 
  }
  @keyframes pulse {
    0%, 100% { opacity:1; }
    50% { opacity:0.3; }
  }
  
  /* Timer display */
  .timer-display {
    font-family: monospace;
    font-size: 18px;
    color: #495057;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 3px;
    display: inline-block;
  }
  
  /* Progress bar */
  .progress-bar {
    height: 3px;
    background: #e9ecef;
    margin: 20px 0;
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: #0d6efd;
    transition: width 0.3s ease;
  }
  
  /* Item display */
  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
  }
  .item-info { font-size: 13px; color: #6c757d; }
  
  /* Admin panel */
  .admin-panel {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: rgba(255,255,255,0.95);
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    font-size: 11px;
    color: #6c757d;
    display: none;
  }
  .admin-mode .admin-panel { display: block; }
</style>
</head>
<body>
<div class="wrap">

  <div id="screen-welcome" class="card">
    <h1>Reading Comprehension Study</h1>
    <p class="muted">Please enter your information to begin.</p>
    <div class="row">
      <div>
        <label for="pid">Participant Code</label>
        <input id="pid" type="text" placeholder="Enter code" />
      </div>
      <div>
        <label for="edu">Education Level</label>
        <select id="edu">
          <option value="">Select...</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
          <option value="13+">College or higher</option>
        </select>
      </div>
    </div>
    <div style="margin-top:20px;">
      <button id="begin" class="primary">Begin</button>
    </div>
  </div>

  <div id="screen-setup" class="card hidden">
    <h2>Setup Recording</h2>
    <p class="muted">This study will record video and audio for research purposes. Please ensure your camera and microphone are working.</p>
    <div id="preview-container" style="margin:20px 0;">
      <video id="preview" style="width:320px; height:240px; background:#000; border:1px solid #dee2e6;" autoplay muted></video>
    </div>
    <p id="setup-status" class="muted">Requesting camera and microphone access...</p>
    <div style="margin-top:20px;">
      <button id="start-study" class="primary" disabled>Start Study</button>
      <button id="test-audio">Test Audio</button>
    </div>
  </div>

  <div id="screen-item" class="card hidden">
    <div class="recording-indicator hidden" id="rec-indicator">
      <span class="recording-dot"></span>
      <span>Recording</span>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width:0%"></div>
    </div>
    
    <div class="item-header">
      <div class="item-info">
        <span id="item-number"></span>
      </div>
      <div id="timer-container" class="hidden">
        <span class="timer-display" id="timer">00:00</span>
      </div>
    </div>
    
    <div id="stim-container" class="center">
      <img id="stim" class="stim" alt="Reading material" />
    </div>
    
    <div id="instructions" class="muted center" style="margin:16px 0;">
      <span id="instruction-text"></span>
    </div>
    
    <div id="reading-controls" class="center" style="margin:16px 0;">
      <button id="start-reading" class="primary hidden">Start Reading</button>
      <button id="done-reading" class="hidden">Done Reading</button>
    </div>
    
    <form id="qa-form" class="hidden">
      <div id="qa-fields"></div>
      <div style="margin-top:16px;">
        <button type="submit" class="primary">Submit</button>
        <button type="button" id="skip">Skip</button>
      </div>
    </form>
  </div>

  <div id="screen-finish" class="card hidden">
    <h2>Study Complete</h2>
    <p id="finish-msg" class="muted">Thank you for participating.</p>
    <div style="margin-top:20px;">
      <button id="download" class="primary">Download Data</button>
      <button id="stop-recording">Stop Recording</button>
    </div>
  </div>

  <div class="admin-panel">
    <div>Score: <span id="admin-score">0</span></div>
    <div>Zeros: <span id="admin-zeros">0</span></div>
  </div>

</div>

<script>
/* ===========================
   WIAT-2 Scoring Reference
   
   IMPORTANT: These are REFERENCE responses from the manual.
   Actual scoring should be done by trained administrators who
   can judge semantic equivalence, not exact matches.
   
   This system records ALL responses for human review.
   Auto-scoring is provided as a rough guide only.
   =========================== */

const SCORING_REFERENCE = {
  // Item 75: Who is Kwawar?
  q75: {
    twoPoint: {
      concepts: ["great spirit", "god", "deity", "creator", "divine being"],
      patterns: [
        /great\s+spirit/i,
        /\bgod\b/i,
        /deity/i,
        /creator/i,
        /divine/i,
        /supreme\s+being/i
      ]
    },
    onePoint: {
      concepts: ["spirit", "supernatural"],
      patterns: [/spirit/i, /supernatural/i]
    },
    notes: "Must indicate divine/supreme nature for 2 points"
  },
  
  // Item 76: How many Turtle Brothers?
  q76: {
    twoPoint: {
      concepts: ["7", "seven"],
      patterns: [/\b7\b/, /\bseven\b/i]
    },
    onePoint: { concepts: [], patterns: [] },
    notes: "Must be exactly 7"
  },
  
  // Item 77: What caused mountains to arise?
  q77: {
    twoPoint: {
      concepts: ["soil on turtle backs", "earth on turtles"],
      patterns: [
        /soil.*turtle/i,
        /turtle.*soil/i,
        /earth.*turtle/i,
        /dirt.*turtle/i
      ]
    },
    onePoint: {
      concepts: ["earth", "brushes", "bushes"],
      patterns: [/\bearth\b/i, /brush/i, /bush/i],
      requiresExplain: ["earth"] // Triggers follow-up
    },
    notes: "2pt must connect soil/earth to turtles"
  },
  
  // Item 87: Why did track meet end early?
  q87: {
    twoPoint: {
      concepts: ["bad weather AND cancellation of long distance"],
      requiresBoth: ["weather", "cancel"],
      patterns: [
        /weather.*cancel/i,
        /cancel.*weather/i,
        /storm.*cancel/i,
        /rain.*cancel/i
      ]
    },
    onePoint: {
      concepts: ["bad weather OR cancellation"],
      patterns: [/weather/i, /cancel/i, /storm/i, /rain/i]
    },
    notes: "2pt requires BOTH weather AND cancellation"
  },
  
  // Item 89: Two dangers encountered
  q89: {
    countBased: true,
    validConcepts: [
      "cold", "freezing", "freeze", "frozen", "ice",
      "animals", "bears", "wolves", "wildlife",
      "river", "rapids", "water", "drowning",
      "starvation", "hunger", "no food", "starving",
      "storm", "blizzard", "snow", "weather"
    ],
    twoPoint: { minCount: 2 },
    onePoint: { minCount: 1 },
    notes: "Count distinct dangers mentioned"
  },
  
  // Item 93: Meaning of hackneyed
  q93: {
    twoPoint: {
      concepts: ["overused", "cliche", "trite", "banal", "unoriginal"],
      patterns: [
        /overused/i,
        /cliche/i,
        /trite/i,
        /banal/i,
        /unoriginal/i,
        /overdone/i,
        /worn.?out/i,
        /stale/i
      ]
    },
    onePoint: {
      concepts: ["predictable"],
      patterns: [/predictable/i, /boring/i, /common/i]
    },
    notes: "2pt indicates overuse, 1pt indicates predictability"
  }
};

/* ===========================
   Trial Configuration
   =========================== */
const TRIALS = [
  // 1.jpeg - Items 75-80
  {
    item: 75,
    image: "1.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q75",
        text: "Who is Kwawar?",
        scoringKey: "q75"
      }
    ]
  },
  {
    item: 76,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q76",
        text: "In all, how many Turtle Brothers were needed to fulfill Kwawar's request?",
        scoringKey: "q76"
      }
    ]
  },
  {
    item: 77,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q77",
        text: "What caused the mountains to arise?",
        scoringKey: "q77"
      }
    ]
  },
  {
    item: 78,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q78",
        text: "What natural event does the Turtle Brothers' quarreling explain?",
        scoringKey: "q78"
      }
    ]
  },
  {
    item: 79,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q79",
        text: "What great gift did Kwawr give the Turtle Brothers?",
        scoringKey: "q79"
      }
    ]
  },
  {
    item: 80,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q80",
        text: "What is the meaning of contemplated in the story?",
        scoringKey: "q80"
      }
    ]
  },
  // Continue with more items...
  {
    item: 87,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q87",
        text: "Why did the track meet end earlier than expected?",
        scoringKey: "q87"
      }
    ]
  },
  {
    item: 89,
    image: "5.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [
      {
        id: "q89",
        text: "What were two dangers encountered by the family on their journey?",
        scoringKey: "q89"
      }
    ]
  },
  {
    item: 93,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [
      {
        id: "q93",
        text: "What is the meaning of the word hackneyed in Gary's review?",
        scoringKey: "q93"
      }
    ]
  }
  // Add all remaining items here...
];

/* ===========================
   State Management
   =========================== */
let state = {
  pid: '',
  edu: '',
  currentIndex: 0,
  totalPoints: 0,
  consecutiveZeros: 0,
  results: [],
  sequence: [],
  timerInterval: null,
  readingStartTime: null,
  itemStartTime: null,
  mediaRecorder: null,
  recordedChunks: [],
  stream: null,
  adminMode: false // Set true to see scoring during testing
};

/* ===========================
   Flexible Scoring System
   =========================== */
function flexibleScore(response, scoringKey) {
  const scoring = SCORING_REFERENCE[scoringKey];
  if (!scoring) {
    return {
      autoScore: null,
      confidence: 'none',
      needsReview: true,
      notes: 'No scoring reference available'
    };
  }
  
  const cleaned = response.toLowerCase().trim();
  
  // Handle count-based scoring
  if (scoring.countBased) {
    let foundConcepts = [];
    scoring.validConcepts.forEach(concept => {
      if (cleaned.includes(concept.toLowerCase())) {
        foundConcepts.push(concept);
      }
    });
    
    const uniqueCount = [...new Set(foundConcepts)].length;
    
    if (uniqueCount >= scoring.twoPoint.minCount) {
      return {
        autoScore: 2,
        confidence: 'medium',
        foundConcepts: foundConcepts,
        needsReview: true,
        notes: `Found ${uniqueCount} concepts`
      };
    } else if (uniqueCount >= scoring.onePoint.minCount) {
      return {
        autoScore: 1,
        confidence: 'medium',
        foundConcepts: foundConcepts,
        needsReview: true,
        notes: `Found ${uniqueCount} concepts`
      };
    } else {
      return {
        autoScore: 0,
        confidence: 'low',
        foundConcepts: foundConcepts,
        needsReview: true,
        notes: 'May have missed concepts'
      };
    }
  }
  
  // Handle "requires both" scoring
  if (scoring.twoPoint.requiresBoth) {
    const hasAll = scoring.twoPoint.requiresBoth.every(req => 
      cleaned.includes(req.toLowerCase())
    );
    
    if (hasAll) {
      return {
        autoScore: 2,
        confidence: 'high',
        needsReview: false,
        notes: 'Contains all required elements'
      };
    }
    
    const hasAny = scoring.twoPoint.requiresBoth.some(req => 
      cleaned.includes(req.toLowerCase())
    );
    
    if (hasAny) {
      return {
        autoScore: 1,
        confidence: 'medium',
        needsReview: true,
        notes: 'Contains partial elements'
      };
    }
  }
  
  // Check patterns for 2-point responses
  if (scoring.twoPoint.patterns) {
    for (let pattern of scoring.twoPoint.patterns) {
      if (pattern.test(cleaned)) {
        return {
          autoScore: 2,
          confidence: 'high',
          needsReview: false,
          matchedPattern: pattern.toString(),
          notes: 'Clear pattern match'
        };
      }
    }
  }
  
  // Check semantic concepts for 2-point responses
  if (scoring.twoPoint.concepts) {
    for (let concept of scoring.twoPoint.concepts) {
      if (cleaned.includes(concept.toLowerCase())) {
        return {
          autoScore: 2,
          confidence: 'medium',
          needsReview: true,
          matchedConcept: concept,
          notes: 'Concept match - verify context'
        };
      }
    }
  }
  
  // Check 1-point patterns
  if (scoring.onePoint.patterns) {
    for (let pattern of scoring.onePoint.patterns) {
      if (pattern.test(cleaned)) {
        return {
          autoScore: 1,
          confidence: 'medium',
          needsReview: true,
          matchedPattern: pattern.toString(),
          notes: 'Partial credit pattern'
        };
      }
    }
  }
  
  // Check 1-point concepts
  if (scoring.onePoint.concepts) {
    for (let concept of scoring.onePoint.concepts) {
      if (cleaned.includes(concept.toLowerCase())) {
        return {
          autoScore: 1,
          confidence: 'low',
          needsReview: true,
          matchedConcept: concept,
          notes: 'Partial concept - needs review'
        };
      }
    }
  }
  
  // No clear match
  return {
    autoScore: 0,
    confidence: 'none',
    needsReview: true,
    notes: 'No pattern match - requires human scoring'
  };
}

/* ===========================
   Recording Functions
   =========================== */
async function setupRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }, 
      audio: true 
    });
    
    state.stream = stream;
    const preview = document.getElementById('preview');
    preview.srcObject = stream;
    
    const options = {
      mimeType: 'video/webm;codecs=vp8,opus'
    };
    
    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
      options.mimeType = 'video/webm';
    }
    
    state.mediaRecorder = new MediaRecorder(stream, options);
    state.recordedChunks = [];
    
    state.mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        state.recordedChunks.push(event.data);
      }
    };
    
    state.mediaRecorder.onstop = () => {
      const blob = new Blob(state.recordedChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${state.pid}_recording_${Date.now()}.webm`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };
    
    document.getElementById('setup-status').textContent = 'Camera and microphone ready.';
    document.getElementById('start-study').disabled = false;
    
  } catch (err) {
    console.error('Error accessing media devices:', err);
    document.getElementById('setup-status').textContent = 'Error: Could not access camera/microphone. Please check permissions.';
  }
}

function startRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state === 'inactive') {
    state.mediaRecorder.start();
    document.getElementById('rec-indicator').classList.remove('hidden');
  }
}

function stopRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
    state.mediaRecorder.stop();
    document.getElementById('rec-indicator').classList.add('hidden');
  }
  if (state.stream) {
    state.stream.getTracks().forEach(track => track.stop());
  }
}

/* ===========================
   Timer Functions
   =========================== */
function startTimer() {
  state.readingStartTime = Date.now();
  let seconds = 0;
  
  document.getElementById('timer-container').classList.remove('hidden');
  
  state.timerInterval = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    document.getElementById('timer').textContent = 
      `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }, 1000);
}

function stopTimer() {
  if (state.timerInterval) {
    clearInterval(state.timerInterval);
    state.timerInterval = null;
  }
  document.getElementById('timer-container').classList.add('hidden');
  return Date.now() - state.readingStartTime;
}

/* ===========================
   DOM Elements
   =========================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

/* ===========================
   Event Listeners
   =========================== */
document.getElementById('begin').addEventListener('click', async () => {
  state.pid = document.getElementById('pid').value.trim();
  state.edu = document.getElementById('edu').value;
  
  if (!state.pid || !state.edu) {
    alert('Please complete all fields.');
    return;
  }
  
  // Check for admin mode (if participant code contains "admin")
  if (state.pid.toLowerCase().includes('admin')) {
    state.adminMode = true;
    document.body.classList.add('admin-mode');
  }
  
  showScreen('setup');
  await setupRecording();
});

document.getElementById('test-audio').addEventListener('click', () => {
  const audio = new Audio();
  audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE';
  audio.play();
});

document.getElementById('start-study').addEventListener('click', () => {
  startRecording();
  buildSequence();
  state.currentIndex = 0;
  showItem();
});

document.getElementById('start-reading').addEventListener('click', () => {
  startTimer();
  document.getElementById('start-reading').classList.add('hidden');
  document.getElementById('done-reading').classList.remove('hidden');
});

document.getElementById('done-reading').addEventListener('click', () => {
  const readingTime = stopTimer();
  showQuestions(readingTime);
});

document.getElementById('qa-form').addEventListener('submit', submitAnswers);
document.getElementById('skip').addEventListener('click', skipItem);
document.getElementById('download').addEventListener('click', downloadResults);
document.getElementById('stop-recording').addEventListener('click', stopRecording);

/* ===========================
   Core Functions
   =========================== */
function buildSequence() {
  const gradeNum = state.edu === "13+" ? 13 : parseInt(state.edu);
  
  // For demo, just use available trials
  // In production, would filter based on grade
  state.sequence = TRIALS.slice();
}

function showItem() {
  if (state.currentIndex >= state.sequence.length) {
    finishAssessment();
    return;
  }
  
  if (state.consecutiveZeros >= 5) {
    finishAssessment();
    return;
  }
  
  const trial = state.sequence[state.currentIndex];
  
  showScreen('item');
  updateProgress();
  updateAdminPanel();
  
  document.getElementById('item-number').textContent = `Item ${state.currentIndex + 1} of ${state.sequence.length}`;
  document.getElementById('stim').src = `stimuli/${trial.image}`;
  
  document.getElementById('qa-form').classList.add('hidden');
  document.getElementById('qa-fields').innerHTML = '';
  document.getElementById('timer').textContent = '00:00';
  
  const instruction = trial.instruction || '';
  document.getElementById('instruction-text').textContent = instruction;
  
  if (trial.skipScoring) {
    document.getElementById('start-reading').classList.add('hidden');
    document.getElementById('done-reading').classList.remove('hidden');
    document.getElementById('done-reading').textContent = 'Continue';
  } else if (trial.skipReading) {
    document.getElementById('start-reading').classList.add('hidden');
    document.getElementById('done-reading').classList.add('hidden');
    showQuestions(0);
  } else {
    document.getElementById('start-reading').classList.remove('hidden');
    document.getElementById('done-reading').classList.add('hidden');
    document.getElementById('done-reading').textContent = 'Done Reading';
  }
  
  state.itemStartTime = Date.now();
}

function showQuestions(readingTime) {
  const trial = state.sequence[state.currentIndex];
  
  if (trial.skipScoring) {
    state.results.push({
      pid: state.pid,
      edu: state.edu,
      item: trial.item,
      image: trial.image,
      type: 'read-aloud',
      response: 'N/A',
      autoScore: 'N/A',
      readingTime: readingTime || 0,
      timestamp: new Date().toISOString()
    });
    state.currentIndex++;
    showItem();
    return;
  }
  
  document.getElementById('qa-form').classList.remove('hidden');
  document.getElementById('start-reading').classList.add('hidden');
  document.getElementById('done-reading').classList.add('hidden');
  
  trial.questions.forEach(q => {
    const qDiv = document.createElement('div');
    qDiv.className = 'q-block';
    
    const label = document.createElement('label');
    label.textContent = q.text;
    label.setAttribute('for', q.id);
    
    const textarea = document.createElement('textarea');
    textarea.id = q.id;
    textarea.name = q.id;
    textarea.required = true;
    
    // Check if this question might need follow-up
    const scoring = SCORING_REFERENCE[q.scoringKey];
    if (scoring && scoring.onePoint && scoring.onePoint.requiresExplain) {
      textarea.addEventListener('input', function() {
        checkForExplain(this.value, q, scoring.onePoint.requiresExplain);
      });
    }
    
    qDiv.appendChild(label);
    qDiv.appendChild(textarea);
    document.getElementById('qa-fields').appendChild(qDiv);
  });
}

function checkForExplain(response, question, triggers) {
  const lower = response.toLowerCase();
  const needsExplain = triggers.some(t => lower.includes(t.toLowerCase()));
  
  const explainId = `${question.id}_explain`;
  let explainDiv = document.getElementById(`${explainId}_div`);
  
  if (needsExplain && !explainDiv) {
    const div = document.createElement('div');
    div.id = `${explainId}_div`;
    div.className = 'explain-field';
    
    const label = document.createElement('label');
    label.textContent = 'Please explain:';
    label.setAttribute('for', explainId);
    
    const textarea = document.createElement('textarea');
    textarea.id = explainId;
    textarea.name = explainId;
    
    div.appendChild(label);
    div.appendChild(textarea);
    
    const questionDiv = document.getElementById(question.id).parentElement;
    questionDiv.appendChild(div);
  } else if (!needsExplain && explainDiv) {
    explainDiv.remove();
  }
}

function submitAnswers(e) {
  e.preventDefault();
  
  const trial = state.sequence[state.currentIndex];
  let totalScore = 0;
  let allNeedReview = false;
  const responses = {};
  
  trial.questions.forEach(q => {
    const response = document.getElementById(q.id).value.trim();
    const explain = document.getElementById(`${q.id}_explain`) ? 
      document.getElementById(`${q.id}_explain`).value.trim() : "";
    
    const scoringResult = flexibleScore(response, q.scoringKey);
    
    if (scoringResult.needsReview) allNeedReview = true;
    totalScore += (scoringResult.autoScore || 0);
    
    responses[q.id] = {
      question: q.text,
      response: response,
      explanation: explain,
      autoScore: scoringResult.autoScore,
      scoringDetails: scoringResult,
      needsReview: scoringResult.needsReview
    };
  });
  
  const finalScore = Math.round(totalScore / trial.questions.length);
  
  state.totalPoints += finalScore;
  if (finalScore === 0) {
    state.consecutiveZeros++;
  } else {
    state.consecutiveZeros = 0;
  }
  
  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    responses: responses,
    autoScoreTotal: finalScore,
    needsReview: allNeedReview,
    readingTime: state.readingStartTime ? Date.now() - state.readingStartTime : 0,
    totalTime: Date.now() - state.itemStartTime,
    timestamp: new Date().toISOString()
  });
  
  state.currentIndex++;
  showItem();
}

function skipItem() {
  const trial = state.sequence[state.currentIndex];
  
  if (!trial.skipScoring) {
    state.consecutiveZeros++;
  }
  
  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    response: 'SKIPPED',
    autoScore: 0,
    needsReview: false,
    readingTime: 0,
    totalTime: Date.now() - state.itemStartTime,
    timestamp: new Date().toISOString()
  });
  
  state.currentIndex++;
  showItem();
}

function updateProgress() {
  const percent = (state.currentIndex / state.sequence.length) * 100;
  document.getElementById('progress').style.width = `${percent}%`;
}

function updateAdminPanel() {
  if (state.adminMode) {
    document.getElementById('admin-score').textContent = state.totalPoints;
    document.getElementById('admin-zeros').textContent = state.consecutiveZeros;
  }
}

function finishAssessment() {
  showScreen('finish');
  const msg = state.consecutiveZeros >= 5 ? 
    'Study discontinued due to response pattern.' : 
    'Thank you for participating.';
  document.getElementById('finish-msg').textContent = msg;
}

function downloadResults() {
  // Create detailed CSV with all response data
  const rows = [
    ['PID', 'Education', 'Item', 'Image', 'Question', 'Response', 'Explanation', 
     'AutoScore', 'Confidence', 'NeedsReview', 'ScoringNotes', 
     'ReadingTime(ms)', 'TotalTime(ms)', 'Timestamp']
  ];
  
  state.results.forEach(r => {
    if (r.responses) {
      Object.keys(r.responses).forEach(qId => {
        const q = r.responses[qId];
        rows.push([
          r.pid,
          r.edu,
          r.item,
          r.image,
          q.question,
          q.response.replace(/[,\n]/g, '; '),
          (q.explanation || '').replace(/[,\n]/g, '; '),
          q.autoScore !== null ? q.autoScore : 'REVIEW',
          q.scoringDetails.confidence || '',
          q.needsReview ? 'YES' : 'NO',
          q.scoringDetails.notes || '',
          r.readingTime || '',
          r.totalTime || '',
          r.timestamp
        ]);
      });
    } else {
      rows.push([
        r.pid,
        r.edu,
        r.item,
        r.image,
        'N/A',
        r.response || 'N/A',
        '',
        r.autoScore === 'N/A' ? 'N/A' : r.autoScore,
        '',
        'NO',
        '',
        r.readingTime || '',
        r.totalTime || '',
        r.timestamp
      ]);
    }
  });
  
  const csv = rows.map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${state.pid}_responses_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  
  // Also create summary JSON for easier analysis
  const summaryData = {
    participant: state.pid,
    education: state.edu,
    totalAutoScore: state.totalPoints,
    itemsNeedingReview: state.results.filter(r => r.needsReview).length,
    allResponses: state.results
  };
  
  const jsonBlob = new Blob([JSON.stringify(summaryData, null, 2)], { type: 'application/json' });
  const jsonUrl = URL.createObjectURL(jsonBlob);
  const jsonLink = document.createElement('a');
  jsonLink.href = jsonUrl;
  jsonLink.download = `${state.pid}_summary_${Date.now()}.json`;
  document.body.appendChild(jsonLink);
  jsonLink.click();
  jsonLink.remove();
  URL.revokeObjectURL(jsonUrl);
}

function showScreen(name) {
  document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
  document.getElementById(`screen-${name}`).classList.remove('hidden');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  showScreen('welcome');
});
</script>
</body>
</html>
