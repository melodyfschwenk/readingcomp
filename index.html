<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reading Comprehension - Research Version</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#0b0e11; color:#e8eef6; }
  .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
  .card { background:#12161c; border:1px solid #1f2630; border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25); margin:14px 0; }
  h1,h2,h3 { margin:0 0 10px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .row > * { flex:1 1 auto; }
  label { font-weight:600; display:block; margin:6px 0; }
  input[type="text"], textarea, select { width:100%; background:#0d1117; color:#e8eef6; border:1px solid #233046; border-radius:10px; padding:10px 12px; }
  button { padding:10px 14px; border-radius:10px; border:1px solid #27476a; background:#1f3b57; color:#d6e8ff; cursor:pointer; font-weight:700; }
  button.secondary { background:#101722; border-color:#2a3647; color:#e8eef6; }
  .hidden { display:none; }
  .muted { color:#9fb1c7; font-size:0.95rem; }
  .badge { display:inline-block; padding:2px 8px; border:1px solid #27476a; border-radius:999px; font-size:12px; background:#101722; color:#cfe1ff; }
  .center { text-align:center; }
  img.stim { max-width:100%; height:auto; border-radius:8px; display:block; margin: 0 auto; }
  .q-block { margin: 12px 0; }
  .explain { margin-top:8px; }
</style>
</head>
<body>
<div class="wrap">

  <div id="screen-welcome" class="card">
    <h1>Reading Comprehension - Research Version</h1>
    <p class="muted">ASL adapted. Timing is precise in the browser. Scores are research measures and not WIAT norms.</p>
    <div class="row">
      <div>
        <label for="pid">Participant ID</label>
        <input id="pid" type="text" placeholder="P1034" />
      </div>
      <div>
        <label for="edu">Last grade completed</label>
        <select id="edu">
          <option value="">Select</option>
          <option value="9-12">9-12</option>
          <option value="13-16">13-16</option>
        </select>
      </div>
    </div>
    <p class="muted">By continuing you confirm consent and agree to recording or observation if enabled in your protocol.</p>
    <div class="row">
      <button id="begin">Begin</button>
      <button class="secondary" id="preview">Preview items</button>
    </div>
  </div>

  <div id="screen-item" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <div><span id="crumb" class="badge">Item</span></div>
      <div>
        <span id="streak" class="badge">Consec 0s: 0</span>
        <span id="points" class="badge">Total pts: 0</span>
      </div>
    </div>
    <div class="center">
      <img id="stim" class="stim" alt="Stimulus" />
    </div>
    <p id="readnote" class="muted center">Read the passage. When finished, click I am done reading to continue.</p>
    <div class="center" style="margin:10px 0">
      <button id="doneReading">I am done reading</button>
    </div>
    <form id="qaForm" class="hidden">
      <div id="qaFields"></div>
      <div class="row">
        <button type="submit">Submit answers</button>
        <button type="button" id="skip" class="secondary">Skip</button>
      </div>
    </form>
  </div>

  <div id="screen-finish" class="card hidden">
    <h2 id="finishTitle">Finished</h2>
    <p id="finishMsg" class="muted"></p>
    <div class="row">
      <button id="download">Download CSV</button>
      <button id="restart" class="secondary">Restart</button>
    </div>
  </div>

  <div id="screen-preview" class="card hidden">
    <h3>Item list</h3>
    <ul id="previewList"></ul>
    <div class="row">
      <button id="closePreview" class="secondary">Close</button>
    </div>
  </div>

</div>

qP("q91","Two themes",[
  // 2 points require BOTH sets hit. Use a synthetic keyword like "both:" and test both in code,
  // or handle via manual review after export.
  r(2, ["wilderness adventure","family conflict"]),
  r(1, ["wilderness adventure","family conflict"])
])

  /* Helpers already defined earlier:
   function r(points, keywords, query=false){ return { points, keywords, query, requireCount: undefined }; }
   function qP(key, label, rules, type="text"){ return { key, label, type, rules }; }
   function trial(itemNum, img, questions, extra = {}) { ... }
   Note: I added rN(points, keywords, requireCount, query=false) to express "must hit N of these".
*/
function rN(points, keywords, requireCount, query=false){ return { points, keywords, query, requireCount }; }

const TRIALS = [
  /* 1.jpeg - 75..80 */
  trial(75, "stimuli/1.jpeg", [
    qP("q75", "Who is Kwawar?",
      [ r(2, ["great spirit","a great spirit","god"]) ])
  ]),
  trial(76, "stimuli/1.jpeg", [
    qP("q76", "In all, how many Turtle Brothers were needed to fulfill Kwawar’s request?",
      [ r(2, ["7","seven"]) ])
  ]),
  trial(77, "stimuli/1.jpeg", [
    qP("q77", "What caused the mountains to arise?",
      [ r(2, ["soil on the turtle","soil on turtle","soil on the turtles","soil on their backs"]),
        r(1, ["earth","brushes","bushes"], true) ])
  ]),
  trial(78, "stimuli/1.jpeg", [
    qP("q78", "What natural event does the Turtle Brothers’ quarreling explain?",
      [ r(2, ["earthquake"]),
        r(1, ["land quakes","ground quivers"], true) ])
  ]),
  trial(79, "stimuli/1.jpeg", [
    qP("q79", "What great gift did Kwawr give the Turtle Brothers?",
      [ r(2, ["california on their backs","california was made from them"]),
        r(1, ["made them part of land"], true) ])
  ]),
  trial(80, "stimuli/1.jpeg", [
    qP("q80", "What is the meaning of contemplated in the story?",
      [ r(2, ["think about","form a new plan","ponder","pondering"]),
        r(1, ["had to think hard","to think"]) ])
  ]),

  /* 2.jpeg - 82..83 (81 is not listed) */
  // 82 aloud prompt is the question itself, so we just score 82 content
  trial(82, "stimuli/2.jpeg", [
    qP("q82", "What has happened as a result of the avalanche?",
      [ r(2, ["road was covered with debris so traffic stopped","traffic stopped and debris covered the road"]),
        r(1, ["snow covered the road","avalanche covered the road"]) ])
  ]),
  trial(83, "stimuli/2.jpeg", [
    qP("q83", "What does debris mean in this sentence?",
      [ r(2, ["tree branches","branches","dirt","rocks","mud","dirt and junk"]),
        r(1, ["snow","rubbish"]) ])
  ]),

  /* 3.jpeg - 84 aloud, 85 scored */
  trial(84, "stimuli/3.jpeg", [
    qP("q84_readaloud", "Read this aloud (observer note)", [], "text")
  ], { discontinueEligible: false }),
  trial(85, "stimuli/3.jpeg", [
    qP("q85", "What does the word fancy mean in this sentence?",
      [ r(2, ["like the food better","prefer","like"]),
        r(1, ["adore","enjoy"]) ])
  ]),

  /* 4.jpeg - 86 aloud, 87..88 scored */
  trial(86, "stimuli/4.jpeg", [
    qP("q86_readaloud", "Read this aloud (observer note)", [], "text")
  ], { discontinueEligible: false }),
  trial(87, "stimuli/4.jpeg", [
    qP("q87", "Why did the track meet end earlier than expected?",
      [ rN(2, ["bad weather","cancellation of long distance"], 2),
        r(1, ["bad weather","cancellation of long distance"]) ])
  ]),
  trial(88, "stimuli/4.jpeg", [
    qP("q88", "What does the word inclement mean in this sentence?",
      [ r(2, ["bad weather","big storm","unpleasant weather"]) ])
  ]),

  /* 5.jpeg - Yukon Gold 89..93 */
  trial(89, "stimuli/5.jpeg", [
    qP("q89", "Name two dangers the family encountered on their journey.",
      [ rN(2, ["cold","freezing","wild animals","river","rapids","lack of food","starvation","storms","snow"], 2),
        r(1, ["cold","freezing","wild animals","river","rapids","lack of food","starvation","storms","snow"]) ])
  ]),
  trial(90, "stimuli/5.jpeg", [
    qP("q90", "According to Diana, why does Charlie not want to go to Yukon?",
      [ r(2, ["does not want to chase his father's dreams","his goals differ from his father's","not chasing fathers dreams"]),
        r(1, ["it was not his idea"]) ])
  ]),
  trial(91, "stimuli/5.jpeg", [
    qP("q91", "According to the reviewers, what are two main themes in Yukon Gold?",
      [ rN(2, ["wilderness adventure","family conflict"], 2),
        r(1, ["wilderness adventure","family conflict"]) ])
  ]),
  trial(92, "stimuli/5.jpeg", [
    qP("q92", "Why did Gary rate it lower than Diana?",
      [ r(2, ["too predictable","hackneyed","boring ending","predictable story"]),
        r(1, ["the ending"]) ])
  ]),
  trial(93, "stimuli/5.jpeg", [
    qP("q93", "Meaning of hackneyed in Gary’s review?",
      [ r(2, ["banal","trite","overused","same story ending as other movies"]),
        r(1, ["too predictable"]) ])
  ]),

  /* 6.jpeg - grades 9-12 start, 94 gate, 95..98 */
  // If you want a speed field here, add a non-scored trial with discontinueEligible:false
  trial(94, "stimuli/6.jpeg", [
    qP("q94", "Meaning of records in the first paragraph?",
      [ r(2, ["preserved information","information preserved from the past","records from the past"]),
        r(1, ["information"]) ])
  ], { gateQuestionKey: "q94", gateAnswers: ["preserved information","information preserved from the past","records from the past"] }),
  trial(95, "stimuli/6.jpeg", [
    qP("q95", "Where did Franklin find the proverbs he included?",
      [ r(2, ["old records","older people","people before him"]),
        r(1, ["everyday life","life experiences"]) ])
  ]),
  trial(96, "stimuli/6.jpeg", [
    qP("q96", "What might Haste makes waste mean?",
      [ rN(2, ["haste","waste"], 2),
        r(1, ["if you try to hurry you could mess it up","hurry and mess up"]) ])
  ]),
  trial(97, "stimuli/6.jpeg", [
    qP("q97", "Why do most people like proverbs?",
      [ r(2, ["short","easy to remember","contain wisdom","teaches you a lesson","words to live by"]),
        r(1, ["short and easy to remember and true"]) ])
  ]),
  trial(98, "stimuli/6.jpeg", [
    qP("q98", "Which proverb comments on modern technology?",
      [ r(2, ["garbage in, garbage out"]) ])
  ]),

  /* 7.jpeg - 99 aloud, 100 scored */
  trial(99, "stimuli/7.jpeg", [
    qP("q99_readaloud", "Read this aloud (observer note)", [], "text")
  ], { discontinueEligible: false }),
  trial(100, "stimuli/7.jpeg", [
    qP("q100", "How are mammals and saurian different?",
      [ rN(2, ["mammals have constant body temperature","saurian temperature changes with environment","independent of environment"], 2),
        r(1, ["mammals have constant warm body temperature","saurians change with environment"]) ])
  ]),

  /* 8.jpeg - 101 aloud, 102 scored */
  trial(101, "stimuli/8.jpeg", [
    qP("q101_readaloud", "Read this aloud (observer note)", [], "text")
  ], { discontinueEligible: false }),
  trial(102, "stimuli/8.jpeg", [
    qP("q102", "What does the sentence tell you that the great Dust Bowl was?",
      [ r(2, ["drought","a time without rain"]),
        r(1, ["dust storms","sand storms"]) ])
  ]),

  /* 9.jpeg - story and 103..107 */
  trial(103, "stimuli/9.jpeg", [
    qP("q103", "Primary reason Kristi's mother wanted her to skate?",
      [ r(2, ["to strengthen her frail legs"]),
        r(1, ["to make her stronger"]) ])
  ]),
  trial(104, "stimuli/9.jpeg", [
    qP("q104", "How does routine differ between first and next paragraph?",
      [ rN(2, ["planning of her day","order of her stunts"], 2),
        r(1, ["skated over and over","dance moves in order"]) ])
  ]),
  trial(105, "stimuli/9.jpeg", [
    qP("q105", "Why was Kristi's workload double that of other skaters?",
      [ r(2, ["she skated solo and duo"]) ])
  ]),
  trial(106, "stimuli/9.jpeg", [
    qP("q106", "Who won the pairs gold medal at the 1990 Nationals?",
      [ r(2, ["kristi and rudy","kristi and rudy galindo"]),
        r(1, ["kristi and her partner"]) ])
  ]),
  trial(107, "stimuli/9.jpeg", [
    qP("q107", "How did Kristi compensate for her athletic limitations?",
      [ rN(2, ["grace","consistency"], 2),
        r(1, ["grace","consistency"]) ])
  ]),

  /* 10.jpeg - 108 gate, 109..112 */
  trial(108, "stimuli/10.jpeg", [
    qP("q108", "Meaning of demise in this story?",
      [ r(2, ["disappearance","killed off","to die out"]),
        r(1, ["downfall","perish","gone","killing","to die"], true) ])
  ], { gateQuestionKey: "q108", gateAnswers: ["disappearance","killed off","die out","to die out"] }),
  trial(109, "stimuli/10.jpeg", [
    qP("q109", "In what two ways have people been the primary reason for the whales' demise?",
      [ rN(2, ["hunted for commercial gain","caught in nets and starve","whaling","entanglement nets starving"], 2),
        r(1, ["hunted for commercial gain","caught in nets and starve","whaling","entanglement nets starving"]) ])
  ]),
  trial(110, "stimuli/10.jpeg", [
    qP("q110", "Why is it important to know about the struggles of humpback whales?",
      [ r(2, ["once we know about the problem we can work toward a solution"]),
        r(1, ["if one species dies it can alter others","we caused their demise"], true) ])
  ]),
  trial(111, "stimuli/10.jpeg", [
    qP("q111", "What two things might happen if a whale is caught in a fishing net?",
      [ rN(2, ["drowning","starving","starvation"], 2),
        r(1, ["starve","flippers get caught","have to cut net off"]) ])
  ]),
  trial(112, "stimuli/10.jpeg", [
    qP("q112", "According to current studies, what is likely to happen to the humpback whale in the future?",
      [ r(2, ["their numbers will grow"]),
        r(1, ["they will be protected better"]) ])
  ]),

  /* 11.jpeg - 113 aloud, 114 scored */
  trial(113, "stimuli/11.jpeg", [
    qP("q113_readaloud", "Read this aloud (observer note)", [], "text")
  ], { discontinueEligible: false }),
  trial(114, "stimuli/11.jpeg", [
    qP("q114", "Most likely reason for the changes in the peach prices during the year?",
      [ rN(2, ["supply","demand"], 2),
        r(1, ["supply","demand"]) ])
  ]),

  /* 12.jpeg - story and 115..119 */
  trial(115, "stimuli/12.jpeg", [
    qP("q115", "If today's admission is $4.00, what was admission in Jan 1993?",
      [ r(2, ["$3.00","$3","3","a dollar less"]) ])
  ]),
  trial(116, "stimuli/12.jpeg", [
    qP("q116", "Main reason Tom gives to support his position?",
      [ r(2, ["price increase caused decline in attendance","cause and effect between last price increase and attendance drop"]),
        r(1, ["attendance has dropped but no reason"]) ])
  ]),
  trial(117, "stimuli/12.jpeg", [
    qP("q117", "Meaning of take up the slack here?",
      [ rN(2, ["make up for money lost","make up in concessions for money lost"], 1),
        r(1, ["make up the difference"]) ])
  ]),
  trial(118, "stimuli/12.jpeg", [
    qP("q118", "Meaning of acquisitions in Tanisha's letter?",
      [ rN(2, ["to buy new animals","to get new animals"], 1),
        r(1, ["new additions","things bought"], true) ])
  ]),
  trial(119, "stimuli/12.jpeg", [
    qP("q119", "According to Tanisha, what three things might happen if prices are not raised?",
      [ rN(2, ["fewer acquisitions","budget shortfall","reduced staffing","cut programs","animals suffer","maintenance issues"], 3),
        rN(1, ["fewer acquisitions","budget shortfall","reduced staffing","cut programs","animals suffer","maintenance issues"], 1) ])
  ]),

  /* 13.jpeg - 120 aloud, 121 scored, second passage 122 scored */
  trial(120, "stimuli/13.jpeg", [
    qP("q120_readaloud", "Read this aloud (observer note)", [], "text")
  ], { discontinueEligible: false }),
  trial(121, "stimuli/13.jpeg", [
    qP("q121", "What has happened to the king?",
      [ r(2, ["he died","he is dead","the king has died","the king is dead","he's dead","he is gone","he's gone"], true),
        r(2, ["he is no longer the king"]) ])
  ]),
  trial(122, "stimuli/13.jpeg", [
    qP("q122", "What would you predict might happen as a result of the event described?",
      [ r(2, ["a new king would be crowned","his son would become king","his son would succeed","a new king would reign"]),
        r(1, ["there would be some change in government","people were not happy with old ruling"]) ])
  ]),

  /* 14.jpeg - speed field optional, then 123..127 */
  // If you want a speed entry, set discontinueEligible:false so it never counts toward streak
  trial(12301, "stimuli/14.jpeg", [
    qP("speed_14", "Reading speed (seconds)", [], "text")
  ], { discontinueEligible: false }),
  trial(123, "stimuli/14.jpeg", [
    qP("q123", "What was the first discovery of the Central Asiatic Expedition?",
      [ r(2, ["dinosaur skulls","flaming cliffs dinosaur skulls"]),
        r(1, ["dinosaur fossils","prehistoric bones","skulls","bones","skeletons"]) ])
  ]),
  trial(124, "stimuli/14.jpeg", [
    qP("q124", "Tell three adventures Andrews had experienced before going to the Gobi desert.",
      [ rN(2, ["whale hunts","desert trek","ship voyage","mountain climb","jungle expedition","field work"], 3),
        rN(1, ["whale hunts","desert trek","ship voyage","mountain climb","jungle expedition","field work"], 2) ])
  ]),
  trial(125, "stimuli/14.jpeg", [
    qP("q125", "Where did the scientists discover the dinosaur eggs?",
      [ r(2, ["flaming cliffs"]),
        r(1, ["dunes","gobi desert","loose rock and sand of the dunes","mongolia","asia"]) ])
  ]),
  trial(126, "stimuli/14.jpeg", [
    qP("q126", "How did Andrews's expedition alter scientific knowledge?",
      [ r(2, ["proved dinosaurs laid eggs","proved conclusively dinosaurs laid eggs"]),
        r(1, ["now they know more about dinosaur reproduction","first discovery of dinosaur eggs"]) ])
  ]),
  trial(127, "stimuli/14.jpeg", [
    qP("q127", "Meaning of brigands as used in the passage?",
      [ r(2, ["outlaws","bandits","highwaymen","thieves","pirates"]),
        r(1, ["bad guys","scavengers","warriors","intruders"]) ])
  ]),

  /* 15.jpeg - speed optional, 128 aloud, 129..130 */
  trial(1501, "stimuli/15.jpeg", [
    qP("speed_15", "Reading speed (seconds)", [], "text")
  ], { discontinueEligible: false }),
  trial(128, "stimuli/15.jpeg", [
    qP("q128_readaloud", "Read this aloud (observer note)", [], "text")
  ], { discontinueEligible: false }),
  trial(129, "stimuli/15.jpeg", [
    qP("q129", "Meaning of longevity in this sentence?",
      [ r(2, ["to live long","long duration of life","length of life"]),
        r(1, ["people's ages went past 65"], true) ])
  ]),
  trial(130, "stimuli/15.jpeg", [
    qP("q130", "Describe the trend reported in this sentence.",
      [ r(2, ["as time goes by more people are living longer","more people are living to age 65 now than in 1900","people are living longer than previously"]),
        r(1, ["people living longer"]) ])
  ]),

  /* 16.jpeg - speed optional, 131..135 */
  trial(1601, "stimuli/16.jpeg", [
    qP("speed_16", "Reading speed (seconds)", [], "text")
  ], { discontinueEligible: false }),
  trial(131, "stimuli/16.jpeg", [
    qP("q131", "At what life stage is a person likely to begin a career?",
      [ r(2, ["building the nest","20s building the nest","twenties building the nest"]),
        r(1, ["20s","twenties"]) ])
  ]),
  trial(132, "stimuli/16.jpeg", [
    qP("q132", "Main theme of the Mid-life Rebirth tasks?",
      [ rN(2, ["change","reevaluation","action"], 2),
        r(1, ["change","action","reevaluation"]) ])
  ]),
  trial(133, "stimuli/16.jpeg", [
    qP("q133", "Rachel scenario: which developmental stage?",
      [ r(2, ["looking around","30s looking around"]),
        r(1, ["the 30s"]) ])
  ]),
  trial(134, "stimuli/16.jpeg", [
    qP("q134", "What might happen if a person did not accomplish the tasks of Breaking Loose?",
      [ rN(2, ["never become their own person","no stable career","no own set of morals"], 2),
        r(1, ["no direction","mommy's or daddy's child all their life","live at home"]) ])
  ]),
  trial(135, "stimuli/16.jpeg", [
    qP("q135", "If Deepening Wisdom were added, predict two developmental tasks.",
      [ rN(2, ["enjoyment of life","seeking knowledge","mentoring","reflection","community service","legacy"], 2) ])
  ]),

  /* 17.jpeg - speed optional, 136..140 */
  trial(1701, "stimuli/17.jpeg", [
    qP("speed_17", "Reading speed (seconds)", [], "text")
  ], { discontinueEligible: false }),
  trial(136, "stimuli/17.jpeg", [
    qP("q136", "What is the fissure as described in the passage?",
      [ r(2, ["cleft in the rock","crevice","crack in the stone","crack in the rock","part of the stone that stuck out"]),
        r(1, ["opening","indentation in the rock"], true) ])
  ]),
  trial(137, "stimuli/17.jpeg", [
    qP("q137", "What suddenly made this rock climb so difficult?",
      [ r(2, ["how high and steep it was","20 ft escarpment to climb","change in the terrain"]),
        r(1, ["they were tired","fatigue","wind","elements"]) ])
  ]),
  trial(138, "stimuli/17.jpeg", [
    qP("q138", "Most important thing they had to overcome to scale the rock?",
      [ r(2, ["fatigue","last cliff face"]),
        r(1, ["finding hand holds","mental defeat","frustration"]) ])
  ]),
  trial(139, "stimuli/17.jpeg", [
    qP("q139", "What kept them from turning back at the sheer surface?",
      [ r(2, ["determined and had already gone a significant distance","had come so far"]),
        r(1, ["close to the top","already hiked 5 miles","gone up 6000 feet"]) ])
  ]),
  trial(140, "stimuli/17.jpeg", [
    qP("q140", "Why did Angela refuse to look at Sherry near the summit?",
      [ r(2, ["very focused on herself","needed to get herself to the top"]),
        r(1, ["she would be looking down","if she looked back she would get discouraged","fear","afraid"], true) ])
  ])
];

/* ===========================
   Runtime state
   =========================== */
const trialByItem = new Map(TRIALS.map(t => [t.item, t]));
let pid = "";
let edu = "";
let seq = [];       // planned sequence of item numbers
let ptr = 0;        // pointer into seq
let readStart = 0;  // perf time
let zeroStreak = 0; // consecutive zero-point items
let totalPoints = 0;
const results = []; // per item rows

/* ===========================
   DOM
   =========================== */
const $ = sel => document.querySelector(sel);
$("#begin").addEventListener("click", begin);
$("#preview").addEventListener("click", showPreview);
$("#closePreview").addEventListener("click", () => showScreen("welcome"));
$("#doneReading").addEventListener("click", onDoneReading);
$("#qaForm").addEventListener("submit", onSubmit);
$("#skip").addEventListener("click", onSkip);
$("#download").addEventListener("click", downloadCSV);
$("#restart").addEventListener("click", () => location.reload());

function showScreen(name) {
  $("#screen-welcome").classList.add("hidden");
  $("#screen-item").classList.add("hidden");
  $("#screen-finish").classList.add("hidden");
  $("#screen-preview").classList.add("hidden");
  if (name === "welcome") $("#screen-welcome").classList.remove("hidden");
  if (name === "item") $("#screen-item").classList.remove("hidden");
  if (name === "finish") $("#screen-finish").classList.remove("hidden");
  if (name === "preview") $("#screen-preview").classList.remove("hidden");
}

/* ===========================
   Flow
   =========================== */
function begin() {
  pid = $("#pid").value.trim();
  edu = $("#edu").value;
  if (!pid || !edu) { alert("Enter Participant ID and select last grade completed."); return; }
  buildInitialSequence();
  ptr = 0;
  showCurrent();
}

function buildInitialSequence() {
  const rule = START_RULES[edu];
  const itemsSorted = [...TRIALS].sort((a,b) => a.item - b.item).map(t => t.item);
  const startIdx = itemsSorted.findIndex(n => n >= rule.startAt);
  seq = startIdx >= 0 ? itemsSorted.slice(startIdx) : itemsSorted.slice();
}

function showCurrent() {
  if (ptr >= seq.length) { finish("Complete", "You reached the end of available items."); return; }
  const item = seq[ptr];
  const t = trialByItem.get(item);
  if (!t) { ptr++; showCurrent(); return; }
  mountTrial(t);
}

function mountTrial(t) {
  showScreen("item");
  $("#crumb").textContent = `Item ${t.item}`;
  $("#streak").textContent = `Consec 0s: ${zeroStreak}`;
  $("#points").textContent = `Total pts: ${totalPoints}`;
  $("#stim").src = t.img;
  $("#stim").alt = `Stimulus for item ${t.item}`;
  $("#qaFields").innerHTML = "";
  $("#qaForm").classList.add("hidden");
  $("#readnote").classList.remove("hidden");
  $("#doneReading").disabled = false;

  // Build question UI
  t.prompts.forEach(p => {
    const div = document.createElement("div");
    div.className = "q-block";
    const lab = document.createElement("label");
    lab.setAttribute("for", p.key);
    lab.textContent = p.label || "Answer";
    const inp = document.createElement("textarea");
    inp.id = p.key; inp.name = p.key; inp.placeholder = "Answer...";
    inp.addEventListener("input", () => maybeAttachExplain(p, inp));
    div.appendChild(lab);
    div.appendChild(inp);
    $("#qaFields").appendChild(div);
  });

  readStart = performance.now();
}

function onDoneReading() {
  $("#qaForm").classList.remove("hidden");
  $("#readnote").classList.add("hidden");
  $("#doneReading").disabled = true;
}

/* Attach explain field if triggers hit or a question mark appears */
function maybeAttachExplain(promptSpec, inputEl) {
  const val = (inputEl.value || "").toLowerCase();
  const triggers = (promptSpec.followupTriggers || []).map(s => String(s).toLowerCase());
  const needs = val.includes("?") || triggers.some(tr => val.includes(tr));
  const existing = inputEl.parentElement.querySelector(`#${promptSpec.key}_explain`);
  if (needs && !existing) {
    const ex = document.createElement("textarea");
    ex.id = `${promptSpec.key}_explain`;
    ex.className = "explain";
    ex.placeholder = "Please explain your answer...";
    inputEl.parentElement.appendChild(ex);
  } else if (!needs && existing) {
    existing.remove();
  }
}

function onSubmit(ev) {
  ev.preventDefault();
  const item = seq[ptr];
  const t = trialByItem.get(item);
  const readMs = Math.round(performance.now() - readStart);

  // Collect response text
  const resp = {};
  t.prompts.forEach(p => {
    resp[p.key] = ($("#" + p.key).value || "").trim();
    const ex = $("#" + p.key + "_explain");
    if (ex) resp[p.key + "_explain"] = ex.value.trim();
  });

  // Score 2, 1, or 0
  const { points, maxPoints, detail } = scoreItem(t, resp);

  // Update streak and totals
  totalPoints += points;
  if (t.discontinueEligible && points === 0) zeroStreak += 1; else if (points > 0) zeroStreak = 0;

  // Save row
  results.push({
    pid, edu, item, read_ms: readMs,
    points_item: points, points_item_max: maxPoints,
    points_total_after: totalPoints,
    zero_streak_after: zeroStreak,
    responses: JSON.stringify(resp),
    score_detail: detail,
    timestamp_iso: new Date().toISOString()
  });

  // Branching if gate failed
  const rule = START_RULES[edu];
  if (t.scoring && t.scoring.gate && points === 0) {
    // Insert remedial 75-93 then jump to 99, or 94-107 then jump to 113
    const [lo, hi] = rule.remedialRange;
    const remedials = range(lo, hi).filter(n => trialByItem.has(n));
    spliceAfter(ptr, remedials);
    scheduleJumpAfterRemedial(rule.jumpTo, remedials);
  }

  // Discontinue
  if (zeroStreak >= DISCONTINUE_STREAK) {
    finish("Discontinued", "Stopped due to consecutive zero scores.");
    return;
  }

  // Next
  ptr++;
  showCurrent();
}

function onSkip() {
  const item = seq[ptr];
  const t = trialByItem.get(item);
  const readMs = Math.round(performance.now() - readStart);

  // Skips count as zero on eligible items
  if (t.discontinueEligible) zeroStreak += 1;
  results.push({
    pid, edu, item, read_ms: readMs,
    points_item: 0, points_item_max: 2,
    points_total_after: totalPoints,
    zero_streak_after: zeroStreak,
    responses: JSON.stringify({ skipped: true }),
    score_detail: "skipped",
    timestamp_iso: new Date().toISOString()
  });

  if (zeroStreak >= DISCONTINUE_STREAK) {
    finish("Discontinued", "Stopped due to consecutive zero scores.");
    return;
  }
  ptr++;
  showCurrent();
}

/* ===========================
   Scoring
   =========================== */
function scoreItem(t, resp) {
  if (!t.scoring) return { points: 0, maxPoints: 0, detail: "readaloud" };
  const txt = Object.values(resp).filter((_,i)=>i%2===0).join(" ").toLowerCase(); // join answers, ignore explanations
  const S = t.scoring;
  let points = 0, detail = "";

  if (S.countMode === "count") {
    const hits = countHits(txt, S.two.concat(S.one));
    if (hits >= (S.minTwo || 1) && anyHit(txt, S.two)) { points = 2; detail = `count hits:${hits} two-hit`; }
    else if (hits >= (S.minOne || 1) && (anyHit(txt, S.one) || hits > 0)) { points = 1; detail = `count hits:${hits} one-hit`; }
    else { points = 0; detail = `count hits:${hits} none`; }
  } else {
    const hit2 = anyHit(txt, S.two);
    const hit1 = anyHit(txt, S.one);
    if (hit2) { points = 2; detail = "keyword 2pt"; }
    else if (hit1) { points = 1; detail = "keyword 1pt"; }
    else { points = 0; detail = "no keyword"; }
  }

  return { points, maxPoints: 2, detail };
}

function norm(s) { return String(s).toLowerCase().trim(); }
function anyHit(text, list) {
  if (!list || !list.length) return false;
  return list.some(k => {
    const key = norm(k);
    if (key.startsWith("danger:")) {
      // Example pattern tag, treat the part after colon as keyword
      return text.includes(key.split("danger:")[1]);
    }
    return text.includes(key);
  });
}
function countHits(text, list) {
  let c = 0;
  const seen = new Set();
  (list||[]).forEach(k => {
    const key = norm(k);
    if (key.startsWith("danger:")) {
      const kw = key.split("danger:")[1];
      if (!seen.has(kw) && text.includes(kw)) { c++; seen.add(kw); }
    } else {
      if (!seen.has(key) && text.includes(key)) { c++; seen.add(key); }
    }
  });
  return c;
}

/* ===========================
   Remedial insertion and jump
   =========================== */
function spliceAfter(index, nums) {
  const head = seq.slice(0, index + 1);
  const tail = seq.slice(index + 1);
  // Avoid duplicates that already appear later
  const filtered = nums.filter(n => !tail.includes(n));
  seq = head.concat(filtered, tail);
}
function scheduleJumpAfterRemedial(jumpTo, remedials) {
  const last = remedials[remedials.length - 1];
  const prevShow = showCurrent.bind(this);
  showCurrent = function wrappedShowCurrent() {
    const itemNext = seq[ptr];
    if (itemNext > last) {
      // Rebuild tail starting at jumpTo
      const all = [...TRIALS].sort((a,b)=>a.item-b.item).map(t=>t.item);
      const j = all.findIndex(n => n >= jumpTo);
      const newTail = j >= 0 ? all.slice(j) : [];
      seq = seq.slice(0, ptr).concat(newTail);
      // restore original function after jump scheduled
      showCurrent = prevShow;
    }
    return prevShow();
  }.bind(this);
}

/* ===========================
   Finish and export
   =========================== */
function finish(title, msg) {
  showScreen("finish");
  $("#finishTitle").textContent = title;
  $("#finishMsg").textContent = msg;
}

function downloadCSV() {
  const cols = ["pid","edu","item","read_ms","points_item","points_item_max","points_total_after","zero_streak_after","responses","score_detail","timestamp_iso"];
  const header = cols.join(",");
  const body = results.map(r => cols.map(k => csvSafe(r[k])).join(",")).join("\n");
  const csv = header + "\n" + body;
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${pid || "participant"}_reading_task.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function csvSafe(v) {
  const s = v == null ? "" : String(v);
  if (s.includes(",") || s.includes("\"") || s.includes("\n")) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

/* ===========================
   Preview
   =========================== */
function showPreview() {
  const ul = $("#previewList");
  ul.innerHTML = "";
  [...TRIALS].sort((a,b)=>a.item-b.item).forEach(t => {
    const li = document.createElement("li");
    li.textContent = `Item ${t.item} - ${t.type} - ${t.img}`;
    ul.appendChild(li);
  });
  showScreen("preview");
}

/* ===========================
   Utils
   =========================== */
function range(a,b){ const out=[]; for(let i=a;i<=b;i++) out.push(i); return out; }

</script>
</body>
</html>
