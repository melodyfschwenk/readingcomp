<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WIAT-2 Reading Comprehension Study</title>
<style>
  body { 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; 
    margin: 0; 
    background: #f8f9fa; 
    color: #212529; 
  }
  .wrap { 
    max-width: 900px; 
    margin: 0;
    padding: 20px; 
  }
  .card { 
    background: #fff; 
    border: 1px solid #dee2e6; 
    border-radius: 4px; 
    padding: 20px; 
    margin: 12px 0; 
  }
  h1 { 
    font-size: 1.5rem; 
    margin: 0 0 12px; 
    font-weight: 400; 
  }
  h2 { 
    font-size: 1.25rem; 
    margin: 0 0 12px; 
    font-weight: 400; 
  }
  .row { 
    display: flex; 
    gap: 12px; 
    flex-wrap: wrap; 
    margin: 12px 0; 
  }
  .row > * { 
    flex: 1 1 auto; 
    min-width: 200px; 
  }
  label { 
    display: block; 
    margin: 8px 0 4px; 
    font-size: 14px; 
  }
  input[type="text"], textarea, select { 
    width: 100%; 
    border: 1px solid #ced4da; 
    border-radius: 3px; 
    padding: 6px 8px; 
    font-size: 14px; 
  }
  textarea { 
    min-height: 70px; 
    resize: vertical; 
    font-family: inherit; 
  }
  button { 
    padding: 8px 16px; 
    border-radius: 3px; 
    border: 1px solid #6c757d; 
    background: #6c757d; 
    color: #fff; 
    cursor: pointer; 
    font-size: 14px; 
  }
  button:hover { 
    background: #5a6268; 
  }
  button.primary { 
    background: #0d6efd; 
    border-color: #0d6efd; 
  }
  button.primary:hover { 
    background: #0b5ed7; 
  }
  button.danger {
    background: #dc3545;
    border-color: #dc3545;
  }
  button.danger:hover {
    background: #c82333;
  }
  button:disabled { 
    opacity: 0.6; 
    cursor: not-allowed; 
  }
  .hidden { 
    display: none !important; 
  }
  .muted { 
    color: #6c757d; 
    font-size: 13px; 
    margin: 8px 0; 
  }
  .center { 
    text-align: center; 
  }
  img.stim { 
    max-width: 100%; 
    height: auto; 
    border: 1px solid #dee2e6; 
    display: block; 
    margin: 12px auto; 
  }
  .q-block { 
    margin: 12px 0; 
    padding: 8px; 
    background: #f8f9fa; 
    border-left: 3px solid #dee2e6; 
  }
  .explain-field { 
    margin-top: 8px; 
    padding: 8px; 
    background: #fff3cd; 
    border-left: 3px solid #ffc107; 
  }
  
  /* Recording indicator */
  .recording-indicator { 
    position: fixed; 
    top: 20px; 
    right: 20px; 
    padding: 8px 12px; 
    background: #dc3545; 
    color: #fff; 
    border-radius: 4px; 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    font-size: 13px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .recording-dot { 
    width: 8px; 
    height: 8px; 
    background: #fff; 
    border-radius: 50%; 
    animation: pulse 1.5s infinite; 
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Screen-reader only utility */
.sr-only {
  position:absolute; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
}

  /* Timer display */
  .timer-display {
    font-family: monospace;
    font-size: 18px;
    color: #495057;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 3px;
    display: inline-block;
  }
  
  /* Progress bar */
  .progress-bar {
    height: 3px;
    background: #e9ecef;
    margin: 20px 0;
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: #0d6efd;
    transition: width 0.3s ease;
  }
  
  /* Item display */
  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
  }
  .item-info { 
    font-size: 13px; 
    color: #6c757d; 
  }
  
  /* Admin panel */
  .admin-panel {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: rgba(255,255,255,0.95);
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    font-size: 11px;
    color: #6c757d;
    display: none;
  }
  .admin-mode .admin-panel { 
    display: block; 
  }
  
  /* Upload status */
  .status-box {
    padding: 12px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #0d6efd;
    margin: 12px 0;
  }
  .status-box.success {
    border-left-color: #28a745;
    background: #d4edda;
  }
  .status-box.error {
    border-left-color: #dc3545;
    background: #f8d7da;
  }
  .status-box.warning {
    border-left-color: #ffc107;
    background: #fff3cd;
  }
  .status-message {
    font-size: 14px;
    color: #495057;
  }
  .success .status-message {
    color: #155724;
  }
  .error .status-message {
    color: #721c24;
  }
  .warning .status-message {
    color: #856404;
  }
  
  /* Participant group info */
  .group-info {
    background: #e9ecef;
    padding: 15px;
    border-radius: 4px;
    margin: 15px 0;
  }
  .group-info h3 {
    font-size: 14px;
    margin: 0 0 10px;
    font-weight: 600;
  }
  .radio-group {
    margin: 10px 0;
  }
  .radio-group label {
    display: flex;
    align-items: center;
    margin: 8px 0;
    cursor: pointer;
  }
  .radio-group input[type="radio"] {
    width: auto;
    margin-right: 10px;
  }
  
  /* Recording setup info */
  .recording-info {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 4px;
    margin: 15px 0;
    border: 1px solid #dee2e6;
  }
  .recording-info.video {
    border-color: #0d6efd;
    background: #e7f3ff;
  }
  .recording-info.audio {
    border-color: #28a745;
    background: #e6f4ea;
  }
  
  /* Recording controls */
  .recording-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
  }
  .recording-timer {
    font-family: monospace;
    font-size: 18px;
    color: #dc3545;
    padding: 4px 8px;
    background: #f8f9fa;
    border-radius: 3px;
  }
  
  /* Connection status */
  .connection-status {
    position: fixed;
    bottom: 10px;
    left: 10px;
    padding: 5px 10px;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    font-size: 11px;
  }
  .connection-status.connected {
    border-color: #28a745;
    color: #28a745;
  }
  .connection-status.error {
    border-color: #dc3545;
    color: #dc3545;
  }
  
  /* Video preview */
  .video-preview-wrapper {
    text-align: center;
    margin: 20px 0;
  }
  .video-preview {
    width: 100%;
    max-width: 480px;
    height: auto;
    background: #000;
    border: 2px solid #dee2e6;
    border-radius: 4px;
  }
  
  /* Read aloud instructions */
  .read-aloud-box {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    padding: 15px;
    margin: 15px 0;
  }
  .read-aloud-box h4 {
    margin: 0 0 10px;
    font-size: 14px;
    color: #856404;
  }
  
  /* Modality selection */
  .modality-selection {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    margin: 15px 0;
  }
  
  /* Accessibility note for deaf participants */
  .accessibility-note {
    background: #e7f3ff;
    border: 1px solid #0d6efd;
    border-radius: 4px;
    padding: 10px;
    margin: 10px 0;
    font-size: 13px;
  }
  .tip-box{
  background:#eef7ff;
  border:1px solid #cfe2ff;
  border-radius:4px;
  padding:12px;
  margin:12px 0;
  font-size:14px;
}
.tip-box ul{ margin:8px 0 0 18px; }
.kbd{
  border:1px solid #ced4da; border-bottom-width:2px;
  padding:2px 6px; border-radius:3px; font-family:monospace; font-size:12px;
}
.comfort-options{
  background:#f8f9fa; border:1px solid #e9ecef; border-radius:4px; padding:12px; margin:12px 0;
}
.video-preview.hidden-selfview{ visibility:hidden; }
@media (max-width: 480px) {
  body { font-size: 16px; }
  .row { flex-direction: column; gap: 6px; }
  button { font-size: 16px; padding: 12px 16px; }
  .video-preview { max-width: 100%; height: auto; }
  .recording-indicator { bottom: 8px; right: 8px; top: auto; }
  .connection-status { display: none; }
}

</style>
</head>
<body>
<div class="wrap">
  <div id="sr-live" class="sr-only" aria-live="assertive" aria-atomic="true"></div>


  <!-- Welcome Screen -->
  <div id="screen-welcome" class="card">
    <h1>WIAT-2 Reading Comprehension Study</h1>
    <p class="muted">Please enter your information to begin.</p>
    
    <div class="row">
      <div>
        <label for="pid">Participant Code</label>
        <input id="pid" type="text" placeholder="Enter initials" required />
      </div>
      <div>
        <label for="edu">Education Level</label>
        <select id="edu" required>
          <option value="">Select...</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
          <option value="13+">College or higher</option>
        </select>
      </div>
    </div>
    
    <div class="group-info">
      <h3>Participant Group</h3>
      <div class="radio-group">
        <label>
          <input type="radio" name="participant-group" value="deaf-fluent" />
          <span>Deaf - Fluent ASL signer</span>
        </label>
        <label>
          <input type="radio" name="participant-group" value="hearing-fluent" />
          <span>Hearing - Fluent ASL signer</span>
        </label>
        <label>
          <input type="radio" name="participant-group" value="deaf-nonfluent" />
          <span>Deaf - Non-fluent ASL signer</span>
        </label>
        <label>
          <input type="radio" name="participant-group" value="hearing-nonfluent" />
          <span>Hearing - Non-fluent ASL signer</span>
        </label>
        <label>
          <input type="radio" name="participant-group" value="hearing-nonsigner" />
          <span>Hearing - Non-signer</span>
        </label>
      </div>
    </div>
    
    <div id="modality-selection" class="modality-selection hidden">
      <h3 style="font-size: 14px; margin: 0 0 10px;">Communication Preference for "Read Aloud" Items</h3>
      <p class="muted" style="margin: 0 0 10px;">How would you prefer to "read aloud"?</p>
      <div id="deaf-note" class="accessibility-note hidden">
        <strong>Note for deaf participants:</strong> You may choose to sign in ASL (video recording) or use spoken language (audio recording) based on your preference and comfort level.
      </div>
      <div class="radio-group">
        <label>
          <input type="radio" name="read-modality" value="sign" />
          <span>Sign (ASL) - Video recording</span>
        </label>
        <label>
          <input type="radio" name="read-modality" value="speak" />
          <span>Speak - Audio recording</span>
        </label>
      </div>
    </div>
    
<div id="config-warning" class="status-box error hidden" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="status-message">
    <strong>Setup Required:</strong> Google Drive integration not configured. 
    Please update GOOGLE_SCRIPT_URL in the code.
  </div>
</div>

    
    <div style="margin-top: 20px;">
      <button id="begin" class="primary" disabled>Continue to Setup</button>
    </div>
  </div>


  <!-- Setup Screen -->
  <div id="screen-setup" class="card hidden">
    <h2>Recording Setup</h2>
    
    <div id="recording-method-info" class="recording-info">
      <div class="status-message" id="recording-method-text" role="status" aria-live="polite" aria-atomic="true">
  Setting up recording...
</div>
    </div>
    <div class="comfort-options">
  <label style="display:flex;align-items:center;gap:8px;">
    <input type="checkbox" id="pref-hide-timer" />
    <span>Hide the reading timer during passages</span>
  </label>
  <label id="pref-hide-selfview" class="hidden" style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    <input type="checkbox" id="toggle-selfview" />
    <span>Hide my camera preview during recording</span>
  </label>
  <p class="muted" style="margin:8px 0 0;">You can change these anytime.</p>
</div>

    <div id="video-setup" class="hidden">
      <p class="muted">For ASL "read aloud" items, we need to set up video recording.</p>
      <div class="video-preview-wrapper">
        <video id="preview" class="video-preview" autoplay muted playsinline></video>
      </div>
      <p id="video-status" class="muted center" role="status" aria-live="polite" aria-atomic="true">Requesting camera access...</p>

    </div>
    
    <div id="audio-setup" class="hidden">
      <p class="muted">For spoken "read aloud" items, we need to set up audio recording.</p>
      <div class="recording-controls">
        <button id="test-audio-record" class="danger">Test Audio Recording</button>
        <button id="stop-test-audio" class="hidden">Stop Test</button>
        <span class="recording-timer hidden" id="test-audio-timer">00:00</span>
      </div>
      <audio id="test-audio-playback" controls class="hidden" style="width: 100%; max-width: 400px; margin: 10px auto; display: block;"></audio>
      <p id="audio-status" class="muted center" role="status" aria-live="polite" aria-atomic="true">Click "Test Audio Recording" to verify your microphone is working.</p>
    </div>
    
    <div id="setup-status" class="status-box" style="margin-top: 20px;">
<div class="status-message" id="setup-status-text" role="status" aria-live="polite" aria-atomic="true">Initializing...</div>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
      <button id="start-study" class="primary" disabled>Start Assessment</button>
    </div>
  </div>

  <!-- Item Screen -->
  <div id="screen-item" class="card hidden">
    <div class="recording-indicator hidden" id="rec-indicator">
      <span class="recording-dot"></span>
      <span id="rec-type">Recording</span>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width: 0%"></div>
    </div>
    
    <div class="item-header">
      <div class="item-info">
        <span id="item-number"></span> | Item <span id="actual-item-number"></span>
      </div>
      <div id="timer-container" class="hidden">
        <span class="timer-display" id="timer">00:00</span>
      </div>
    </div>
    
    <div id="stim-container" class="center">
      <img id="stim" class="stim" alt="Reading material" />
    </div>
    
    <div id="instructions" class="muted center" style="margin: 16px 0;">
      <span id="instruction-text"></span>
    </div>
    
    <!-- Read Aloud Instructions Box -->
    <div id="read-aloud-instructions" class="read-aloud-box hidden">
      <h4 id="read-aloud-title">Read Aloud Instructions</h4>
      <p id="read-aloud-text" class="muted" style="margin: 0;"></p>
    </div>
    
    <!-- Recording controls for read-aloud items -->
    <div id="recording-controls" class="recording-controls hidden">
      <button id="start-recording" class="danger">Start Recording</button>
      <button id="stop-recording" class="hidden">Stop Recording</button>
      <span class="recording-timer hidden" id="recording-timer">00:00</span>
    </div>
    
    <!-- Standard reading controls -->
    <div id="reading-controls" class="center hidden" style="margin: 16px 0;">
      <button id="start-reading" class="primary">Start Reading</button>
      <button id="done-reading" class="hidden">Done Reading</button>
    </div>
    
    <form id="qa-form" class="hidden">
      <div id="qa-fields"></div>
      <div style="margin-top: 16px;">
        <button type="submit" class="primary">Submit</button>
        <button type="button" id="skip">Skip</button>
      </div>
    </form>
  </div>

  <!-- Finish Screen -->
  <div id="screen-finish" class="card hidden">
    <h2>Assessment Complete</h2>
<p id="finish-msg" class="muted" role="status" aria-live="polite" aria-atomic="true">Thank you for participating.</p>
    
    <div id="upload-status" class="status-box">
<div class="status-message" id="upload-progress" role="status" aria-live="polite" aria-atomic="true">Saving your data...</div>
    </div>
    
    <div id="final-stats" class="hidden" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px;">
      <h3 style="font-size: 14px; margin: 0 0 10px;">Session Summary</h3>
      <div id="stats-content"></div>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
      <button id="retry-upload" class="primary hidden">Retry Upload</button>
      <button id="download-backup" class="hidden">Download Backup</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="admin-panel">
    <div>Group: <span id="admin-group">-</span></div>
    <div>Item: <span id="admin-item">-</span></div>
    <div>Score: <span id="admin-score">0</span></div>
    <div>Zeros: <span id="admin-zeros">0</span></div>
    <div>Status: <span id="admin-status">Active</span></div>
  </div>

  <!-- Connection Status -->
  <div class="connection-status" id="connection-status">
<span id="connection-text" role="status" aria-live="polite" aria-atomic="true">Not connected</span>
  </div>

</div>

<script>
/* ===========================
   CONFIGURATION
   =========================== */
// IMPORTANT: Replace this with your actual Google Apps Script Web App URL
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX6yfgjIVSzmL2nL73IxIWPCV4RPbxfjPTDOxB-_Ax6siB2vmKJXnCpwLP4-PUA4MCpQ/exec';

/* ===========================
   State Management
   =========================== */
let state = {
  // Session info
  pid: '',
  edu: '',
  participantGroup: '', // deaf-fluent, hearing-fluent, deaf-nonfluent, hearing-nonfluent, hearing-nonsigner
  readModality: '', // sign or speak (for all participants who can choose)
  sessionStartTime: null,
  
  // Progress tracking
  currentIndex: 0,
  totalPoints: 0,
  consecutiveZeros: 0,
  gateItemsFailed: [],

  // Results storage
  results: [],
  sequence: [],
  
  // Timers
  timerInterval: null,
  readingStartTime: null,
  itemStartTime: null,
  recordingTimerInterval: null,
  
  // Recording
  useVideoRecording: false,
  useAudioRecording: false,
  mediaRecorder: null,
  recordedChunks: [],
  stream: null,
  
  // Admin and upload
  adminMode: false,
  uploadAttempts: 0,
  savedData: null,
  connectionStatus: false,

    reviewQueue: [],
  scoringMetrics: {
    highConfidence: 0,
    mediumConfidence: 0,
    lowConfidence: 0,
    manualReviewNeeded: 0
  },
};

/* ===========================
   WIAT-2 Scoring Reference
   =========================== */

// Replace your entire SCORING_REFERENCE with this:
const SCORING_REFERENCE = {
  /* =======================
     Turtle Brothers (75–80)
     ======================= */
  q75: {
    twoPoint: {
      patterns: [/great\s+spirit/i, /\bgod\b/i, /deity/i, /creator/i, /divine\s+being/i, /supreme\s+being/i]
    },
    onePoint: {
      patterns: [/spirit\b/i, /supernatural/i]
    },
    notes: "Must indicate a divine/supreme being for 2 points."
  },
  q76: {
    twoPoint: { patterns: [/\b7\b/, /\bseven\b/i] },
    notes: "Must be exactly 7."
  },
  q77: {
    twoPoint: { patterns: [/soil.*turtle/i, /turtle.*soil/i, /earth.*turtle/i] },
    onePoint: { patterns: [/earth/i, /brush/i, /bush/i] }
  },
  q78: {
    twoPoint: { patterns: [/earthquake/i] },
    onePoint: { patterns: [/land.*quake/i, /ground.*quiver/i] }
  },
  q79: {
    twoPoint: { patterns: [/california.*back/i, /california.*made/i] },
    onePoint: { patterns: [/part.*land/i] }
  },
  q80: {
    twoPoint: { patterns: [/think\s+about/i, /form.*plan/i, /ponder/i] },
    onePoint: { patterns: [/think\s+hard/i, /\bthink\b/i] }
  },

  /* =======================
     Avalanche (82–83)
     ======================= */
  q82: {
    twoPoint: { patterns: [/road.*covered.*debris/i, /traffic.*stop/i] },
    onePoint: { patterns: [/snow.*covered.*road/i, /avalanche.*covered/i] }
  },
  q83: {
    twoPoint: { patterns: [/tree.*branch/i, /\bdirt\b/i, /\brock/i, /\bmud\b/i, /junk/i] },
    onePoint: { patterns: [/\bsnow\b/i, /rubbish/i] }
  },

  /* =======================
     Fancy (85)
     ======================= */
  q85: {
    twoPoint: { patterns: [/like.*better/i, /prefer/i, /\blike\b/i] },
    onePoint: { patterns: [/adore/i, /enjoy/i] }
  },

  /* =======================
     Track Meet (87–88)
     ======================= */
  q87: {
    twoPoint: { patterns: [/bad.*weather.*cancel/i, /weather.*long.*distance/i] },
    onePoint: { patterns: [/bad.*weather/i, /cancel/i] }
  },
  q88: {
  twoPoint: {
    patterns: [
      /\binclement\b/i,                           // echoes the key word
      /(bad|severe|stormy|harsh|rough|foul|nasty)\s+(weather|storm|conditions)/i,
      /(unpleasant|poor)\s+weather/i
    ]
  },
  notes: "Full = clearly 'bad/severe/stormy weather'. Partial = mentions weather conditions without stating severity."
},


  /* =======================
     Yukon Gold (89–93)
     ======================= */
  q89: {
    onePoint: {
      patterns: [
        /(cold|freez|blizzard|snowstorm)/i,
        /(bear|wolf|wolves|animal attack|wildlife)/i,
        /(starv|hunger|food shortage|lack of food)/i,
        /(rapid|river|ice.*break|thin ice|avalanche|landslide)/i,
        /(sick|illness|injur|exhaustion|fatigue)/i
      ]
    },
    notes: "Give 2 if two clear journey dangers are named; 1 for one credible danger. Often needs review."
  },
  q90: {
    twoPoint: {
      patterns: [
        /(does\s*not|doesn't|didn't)\s+want.*(go|yukon).*(cold|freez|danger|hard|difficult|long trip)/i,
        /(reluctant|unwilling|afraid|fear).*go.*(cold|freez|danger|hard|difficult)/i
      ]
    },
    onePoint: { patterns: [/(does\s*not|doesn't|didn't)\s+want.*go/i, /(afraid|fear|scared)/i, /(cold|freez)/i] },
    notes: "Full credit if his reason is the cold/dangers/hardship noted by Diana."
  },
  q91: {
    onePoint: {
      patterns: [
        /(surviv|persever|endure|overcome)/i,
        /(family|together|teamwork|loyalty)/i,
        /(courage|brave|risk|adventure)/i
      ]
    },
    notes: "Give 2 for two accurate themes tied to the text; 1 for one plausible theme (review recommended)."
  },
  q92: {
    twoPoint: { patterns: [/(predictabl|hackneyed|clich[eé]|unoriginal|stale|trite)/i, /(same old|formula(ic)?)/i] },
    onePoint: { patterns: [/(plot|story).*weak|bad/i, /(boring|dull)/i] },
    notes: "Gary disliked that it was unoriginal/predictable."
  },
  q93: {
    twoPoint: { patterns: [/(overused|trite|clich[eé]|worn[- ]?out|stale|banal|unoriginal)/i] },
    onePoint: { patterns: [/(commonplace|old|familiar)/i] },
    notes: "Meaning of 'hackneyed'."
  },

  /* =======================
     Words of Wisdom (94–98)
     ======================= */
  q94: {
    twoPoint: { patterns: [/(written|document|recorded|chronicle|account)s?\b/i] },
    onePoint: { patterns: [/(history|facts|notes|information)/i] },
    notes: "‘Records’ = written accounts/documents."
  },
  q95: {
    twoPoint: {
      patterns: [
        /(collected|compiled|gathered|borrowed|took)\s+(from\s+)?(others|folk|people|sayings|maxims|aphorisms)/i,
        /(traditional|folk)\s+(proverb|saying)s?/i
      ]
    },
    onePoint: { patterns: [/(books|almanacs?|newspapers|sources)/i] },
    notes: "He collected existing proverbs."
  },
  q96: {
    twoPoint: { patterns: [/(rush|haste|hurry).*(mistake|waste|redo|do it again|sloppy|error)/i] },
    onePoint: { patterns: [/(don'?t|do not)\s+rush/i, /(take your time|be careful)/i] }
  },
  q97: {
    twoPoint: {
      patterns: [
        /(short|brief|simple|concise).*(sayings|proverbs)/i,
        /(easy\s+to\s+remember|memorable)/i,
        /(wisdom|truth|advice|lesson)/i
      ]
    },
    onePoint: { patterns: [/(people|most).*(like|enjoy).*(proverb|saying)/i] }
  },
  q98: {
    notes: "Selects the proverb that comments on modern technology. Mark for manual review (no scoring patterns here)."
  },

  /* =======================
     Mammals vs Saurian (100) & Dust Bowl (102)
     ======================= */
  q100: {
    twoPoint: { patterns: [/(mammal).*(warm[- ]?blood)/i, /(saurian|reptile).*(cold[- ]?blood)/i] },
    onePoint: { patterns: [/(warm[- ]?blood|cold[- ]?blood)/i, /(mammal|saurian|reptile)/i] }
  },
  q102: {
    twoPoint: { patterns: [/(long|several|many)\s+(years|period).*(no|little)\s+rain/i, /\bdrought\b/i] },
    onePoint: { patterns: [/(dust\s*storm|sand\s*storm)s?/i] }
  },

  /* =======================
     Kristi Yamaguchi (103–107)
     ======================= */
  q103: {
    twoPoint: { patterns: [/(health|medical|therapy|exercise)/i, /(turned[- ]in\s+(hips|feet)|foot\s+problem|hip\s+problem)/i] },
    onePoint: { patterns: [/(to\s+exercise|for\s+her\s+health)/i] }
  },
  q104: {
    semantic: {
      full: [
        ["daily routine", "everyday routine", "habit", "regular schedule", "usual activities", "day-to-day"],
        ["skating routine", "performance routine", "program", "choreograph", "set sequence", "planned moves"]
      ],
      partial: ["daily", "habit", "schedule", "program", "performance", "choreographed"]
    },
    notes: "First = everyday schedule; next = choreographed program/performance."
  },
  q105: {
    twoPoint: {
      patterns: [
        /(did|skated?)\s+both\s+(pairs|pair)\s+and\s+(singles|single)/i,
        /(pairs|pair)\s+and\s+(singles|single)\s+at\s+the\s+same\s+time/i
      ]
    },
    onePoint: { patterns: [/(too\s+much\s+work|many\s+events|double\s+workload)/i] }
  },
  q106: {
    twoPoint: { patterns: [/(kristi|yamaguchi).*(rudy|galindo)/i] },
    notes: "Kristi Yamaguchi & Rudy Galindo."
  },
  q107: {
    twoPoint: { patterns: [/(choreograph(y|ic)|artistry|presentation|style|grace|expression)/i] },
    onePoint: { patterns: [/(not\s+just\s+jumps|technique|balance|control)/i] },
    notes: "She compensated with choreography/artistry."
  },

  /* =======================
     Humpback Whales (108–112)
     ======================= */
  q108: {
    twoPoint: { patterns: [/(death|dying|end|extinction|downfall|ruin)/i] },
    onePoint: { patterns: [/(decline|fall|reduce|less)/i] }
  },
  q109: {
    semantic: {
      full: [
        ["hunt", "hunted", "whale", "whaling", "killed"],
        ["net", "fishing net", "entangle", "caught", "bycatch", "pollution", "ship strike"]
      ],
      partial: ["hunted", "whaling", "nets", "entangled", "pollution", "bycatch", "ships"]
    },
    notes: "Two ways: (1) hunting/whaling; (2) nets/entanglement (pollution/ship strikes may count if text supports)."
  },
  q110: {
    twoPoint: { patterns: [/(we)\s+can\s+(protect|save|help|conserve)/i, /(awareness|understand).*(protect|conserve|laws|action)/i] },
    onePoint: { patterns: [/(important|know|learn)/i] }
  },
  q111: {
    semantic: {
      full: [
        ["drown", "suffocate", "asphyxiate"],
        ["starve", "starvation"]
      ],
      partial: ["drown", "suffocate", "starve"]
    },
    notes: "Two things: drown and starve."
  },
  q112: {
    twoPoint: { patterns: [/(become|go)\s+extinct/i, /(die\s+out)/i] },
    onePoint: { patterns: [/(decline|decrease|fall)\s+in\s+numbers/i, /(endangered|at\s+risk)/i] }
  },

  /* =======================
     Peach Prices (114)
     ======================= */
  q114: {
    twoPoint: {
      patterns: [
        /(in\s+season|harvest|summer|supply.*high).*price(s)?\s+(low|lower|drop)/i,
        /(off[- ]season|winter|supply.*low).*price(s)?\s+(rise|higher|increase)/i
      ]
    },
    onePoint: { patterns: [/(supply).*affect(s|ed)?.*price/i, /(season|harvest)/i] },
    notes: "Seasonal supply explains price changes."
  },

  /* =======================
     Zoo Admission (115–119)
     ======================= */
  q115: {
    twoPoint: { patterns: [/\$?\s*3(\.00)?\b/i, /\bthree\s*dollars?\b/i] },
    onePoint: { patterns: [/(less|cheaper|lower)/i] }
  },
  q116: {
    twoPoint: {
      patterns: [
        /(main|primary)\s+reason.*(support|position)/i,
        /(because|since|as)\s+(costs|expenses|budget|funds|money).*(need|require)/i
      ]
    },
    onePoint: { patterns: [/(money|costs|budget)/i] },
    notes: "Tom’s main reason: costs/finances; raising price covers expenses."
  },
  q117: {
    twoPoint: {
      patterns: [
        /(take\s+up\s+the\s+slack)\s*=\s*(compensate|cover|make\s+up|fill\s+in|carry\s+the\s+load)/i,
        /(compensate|cover|make\s+up).*(for\s+others|shortfall|lack)/i
      ]
    },
    onePoint: { patterns: [/(help\s+out|do\s+more|pick\s+up\s+the\s+slack)/i] }
  },
  q118: {
    twoPoint: {
      patterns: [
        /(acquisition|acquisitions)\s*=\s*(purchases|things\s+the\s+zoo\s+buys|new\s+animals|items\s+obtained)/i,
        /(purchase|buy|obtain)\s+(animals|exhibits|items)/i
      ]
    },
    onePoint: { patterns: [/(new\s+animals|new\s+exhibits|purchases)/i] }
  },
  q119: {
    onePoint: {
      patterns: [
        /(fewer|no)\s+(acquisitions|new\s+animals|new\s+exhibits)/i,
        /(reduce(d)?|cut)\s+(hours|services|staff|care|maintenance)/i,
        /(close|closure)/i,
        /(lack\s+of\s+funds|budget\s+shortfall)/i
      ]
    },
    notes: "Give 2 if three stated consequences are listed; 1 for one–two. Often needs review."
  },

  /* =======================
     The King (121–122)
     ======================= */
  q121: {
    twoPoint: { patterns: [/(the\s+)?king\s+(has\s+)?(died|is\s+dead|passed\s+away|was\s+assassinated)/i] },
    onePoint: { patterns: [/(the\s+)?king\s+(is\s+gone|no\s+longer|not\s+alive)/i] }
  },
  q122: {
    twoPoint: { patterns: [/(new\s+king|succession|heir|prince\s+becomes\s+king)/i, /(funeral|mourning|power\s+struggle|war|chaos)/i] },
    onePoint: { patterns: [/(someone\s+else\s+will\s+rule|change\s+of\s+power)/i] }
  },

  /* =======================
     Central Asiatic Expedition (123–127)
     ======================= */
  q123: {
    twoPoint: { patterns: [/(first|initial)\s+discovery.*(skull|skulls)/i, /(flaming\s+cliffs|bayanzag|gobi)/i] },
    onePoint: { patterns: [/(dinosaur|fossil)/i] }
  },
  q124: {
    onePoint: { patterns: [/(adventure|expedition|voyage|journey|exploration)/i] },
    notes: "Give 2 if three specific pre-Gobi adventures are correctly named; 1 for one–two (manual review)."
  },
  q125: {
    twoPoint: { patterns: [/(gobi\s+desert|mongolia|flaming\s+cliffs)/i, /(nest|nests|eggs)/i] },
    onePoint: { patterns: [/(desert|sand|cliffs)/i] }
  },
  q126: {
    twoPoint: { patterns: [/(proved|showed|demonstrated)\s+that\s+dinosaurs?\s+(laid|lay)\s+eggs/i, /(first|new)\s+dinosaur\s+eggs?\s+discovered/i] },
    onePoint: { patterns: [/(changed|altered)\s+scientific\s+knowledge/i] }
  },
  q127: {
    twoPoint: { patterns: [/(brigands?)\s*=\s*(bandits?|robbers?|thieves?)/i] },
    onePoint: { patterns: [/(outlaws?|criminals?)/i] }
  },

  /* =======================
     Longevity (129–130)
     ======================= */
  q129: {
    twoPoint: { patterns: [/(longevity)\s*=\s*(length\s+of\s+life|life\s*span|how\s+long\s+people\s+live)/i] },
    onePoint: { patterns: [/(old|older|age)/i] }
  },
  q130: {
    twoPoint: { patterns: [/(life\s+expectancy|longevity)\s+(has\s+)?(risen|increased|gone\s+up|grown)\b/i, /(trend|graph|chart).*(upward|increase|rise)/i] },
    onePoint: { patterns: [/(people\s+live\s+longer)/i] }
  },

  /* =======================
     Life Stages (131–135)
     ======================= */
  q131: {
    twoPoint: { patterns: [/(young|early)\s+adult(hood)?/i, /(begin|start)\s+a\s+career/i] },
    onePoint: { patterns: [/\badult\b/i] }
  },
  q132: {
    twoPoint: { patterns: [/(reassess|re[- ]?evaluate|reconsider|question).*(goals|career|life|relationships?)/i, /(change|adjust|redirect).*(life|career|path|relationships?)/i] },
    onePoint: { patterns: [/(mid[- ]?life).*(change|question|reassess)/i] }
  },
  q133: {
    twoPoint: { patterns: [/(mid[- ]?life\s+rebirth)/i] },
    onePoint: { patterns: [/(mid[- ]?life|reassessment)/i] }
  },
  q134: {
    twoPoint: { patterns: [/(lack|missing|fail(ed)?\s+to\s+develop).*(independence|self[- ]?reliance)/i, /(remain|stay)\s+(dependent|immature|tied)/i] },
    onePoint: { patterns: [/(problems|issues)\s+with\s+(independence|identity)/i] }
  },
  q135: {
    twoPoint: { patterns: [/(mentor|guide|teach|advise|give\s+back)/i, /(reflect|wisdom|insight|legacy|purpose|meaning)/i] },
    onePoint: { patterns: [/(help\s+others|share\s+experience|reflection)/i] }
  },

  /* =======================
     The Rock (136–140)
     ======================= */
  q136: {
    twoPoint: { patterns: [/(fissure)\s*=\s*(narrow|thin)\s+(crack|split|opening)\s+in\s+rock/i] },
    onePoint: { patterns: [/(crack|split|opening)/i] }
  },
  q137: {
    twoPoint: { patterns: [/(sheer|vertical)\s+(wall|face|escarpment)/i, /(sudden(ly)?)\s+(steep|drop|cliff)/i] },
    onePoint: { patterns: [/(harder|difficult|steeper)/i] }
  },
  q138: {
    twoPoint: { patterns: [/(fatigue|exhaustion|very\s+tired)/i] },
    onePoint: { patterns: [/(fear|scared|mental|mindset|discouraged)/i] }
  },
  q139: {
    twoPoint: { patterns: [/(determination|willpower|resolve|too\s+far\s+to\s+quit|couldn'?t\s+turn\s+back)/i] },
    onePoint: { patterns: [/(close\s+to\s+the\s+top|almost\s+there|came\s+so\s+far)/i] }
  },
  q140: {
    twoPoint: { patterns: [/(focus(ed)?\s+on\s+herself|needed\s+to\s+concentrate|had\s+to\s+get\s+herself\s+to\s+the\s+top)/i] },
    onePoint: { patterns: [/(afraid|fear|if\s+she\s+looked\s+down|discouraged|didn'?t\s+want\s+to\s+look\s+back)/i] }
  }
};

/* ===========================
   TRIALS Configuration - COMPLETE
   =========================== */
const TRIALS = [
  // Turtle Brothers passage
  {
    item: 75,
    image: "1.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q75",
      text: "Who is Kwawar?",
      scoringKey: "q75"
    }]
  },
  {
    item: 76,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q76",
      text: "In all, how many Turtle Brothers were needed to fulfill Kwawar's request?",
      scoringKey: "q76"
    }]
  },
  {
    item: 77,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q77",
      text: "What caused the mountains to arise?",
      scoringKey: "q77"
    }]
  },
  {
    item: 78,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q78",
      text: "What natural event does the Turtle Brothers' quarreling explain?",
      scoringKey: "q78"
    }]
  },
  {
    item: 79,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q79",
      text: "What great gift did Kwawr give the Turtle Brothers?",
      scoringKey: "q79"
    }]
  },
  {
    item: 80,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q80",
      text: "What is the meaning of contemplated in the story?",
      scoringKey: "q80"
    }]
  },
  
  // Avalanche passage (read aloud)
  {
    item: 81,
    image: "2.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 82,
    image: "2.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q82",
      text: "Tell me in your own words, what has happened as a result of the avalanche?",
      scoringKey: "q82"
    }]
  },
  {
    item: 83,
    image: "2.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q83",
      text: "What does the word debris mean in this sentence?",
      scoringKey: "q83"
    }]
  },
  
  // Fancy passage (read aloud)
  {
    item: 84,
    image: "3.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 85,
    image: "3.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q85",
      text: "What does the word fancy mean in this sentence?",
      scoringKey: "q85"
    }]
  },
  
  // Track meet passage (read aloud)
  {
    item: 86,
    image: "4.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 87,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q87",
      text: "Why did the track meet end earlier than expected?",
      scoringKey: "q87"
    }]
  },
  {
    item: 88,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q88",
      text: "What does the word inclement mean in this sentence?",
      scoringKey: "q88"
    }]
  },
  
  // Yukon Gold passage
  {
    item: 89,
    image: "5.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q89",
      text: "What were two dangers encountered by the family on their journey?",
      scoringKey: "q89"
    }]
  },
  {
    item: 90,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q90",
      text: "According to Diana, why doesn't Charlie want to go to Yukon?",
      scoringKey: "q90"
    }]
  },
  {
    item: 91,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q91",
      text: "According to the reviewers, what are two main themes or ideas in Yukon Gold?",
      scoringKey: "q91"
    }]
  },
  {
    item: 92,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q92",
      text: "Diana gave Yukon Gold four stars although Gary gave it two. What did Gary dislike about the movie?",
      scoringKey: "q92"
    }]
  },
  {
    item: 93,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q93",
      text: "What is the meaning of the word hackneyed in Gary's review?",
      scoringKey: "q93"
    }]
  },
  
  // Words of Wisdom (Grades 9-12 Start)
  {
    item: 94,
    image: "6.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q94",
      text: "What is the meaning of the word records in the first paragraph?",
      scoringKey: "q94"
    }]
  },
  {
    item: 95,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q95",
      text: "Where do you think Ben Franklin found the proverbs he included in the Poor Richard's Almanack?",
      scoringKey: "q95"
    }]
  },
  {
    item: 96,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q96",
      text: "What do you think 'Haste makes waste' might mean?",
      scoringKey: "q96"
    }]
  },
  {
    item: 97,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q97",
      text: "Why do you think most people like proverbs?",
      scoringKey: "q97"
    }]
  },
  {
    item: 98,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q98",
      text: "Which of the proverbs mentioned in the passage is a comment on modern technology?",
      scoringKey: "q98"
    }]
  },
  
  // Mammals vs Saurian (read aloud)
  {
    item: 99,
    image: "7.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 100,
    image: "7.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q100",
      text: "How are mammals and saurian different?",
      scoringKey: "q100"
    }]
  },
  
  // Dust Bowl (read aloud)
  {
    item: 101,
    image: "8.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 102,
    image: "8.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q102",
      text: "What does the sentence tell you that the great Dust Bowl was?",
      scoringKey: "q102"
    }]
  },
  
  // Kristi Yamaguchi passage
  {
    item: 103,
    image: "9.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q103",
      text: "For what primary reason did Kristi's mother want her daughter to skate?",
      scoringKey: "q103"
    }]
  },
  {
    item: 104,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q104",
      text: "How does the definition of routine in the first paragraph differ from that in the next paragraph?",
      scoringKey: "q104"
    }]
  },
  {
    item: 105,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q105",
      text: "Why was Kristi's workload double that of other skaters?",
      scoringKey: "q105"
    }]
  },
  {
    item: 106,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q106",
      text: "Who won the pairs gold medal at the 1990 Nationals?",
      scoringKey: "q106"
    }]
  },
  {
    item: 107,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q107",
      text: "How was Kristi able to compensate for her athletic limitations?",
      scoringKey: "q107"
    }]
  },
  
  // Humpback whales passage
  {
    item: 108,
    image: "10.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q108",
      text: "What is the meaning of the word demise in this story?",
      scoringKey: "q108"
    }]
  },
  {
    item: 109,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q109",
      text: "In what two ways have people been the primary reason for the whales' demise?",
      scoringKey: "q109"
    }]
  },
  {
    item: 110,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q110",
      text: "Why is it important for us to know about the struggles of the humpback whales?",
      scoringKey: "q110"
    }]
  },
  {
    item: 111,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q111",
      text: "What two things might happen if a whale is caught in a fishing net?",
      scoringKey: "q111"
    }]
  },
  {
    item: 112,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q112",
      text: "According to current studies, what is likely to happen to the humpback whale in the future?",
      scoringKey: "q112"
    }]
  },
  
  // Peach prices (read aloud)
  {
    item: 113,
    image: "11.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 114,
    image: "11.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q114",
      text: "What is the most likely reason for the changes in the peach prices during the year?",
      scoringKey: "q114"
    }]
  },
  
  // Zoo admission passage
  {
    item: 115,
    image: "12.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q115",
      text: "If today's zoo admission is $4.00, what was zoo admission in January 1993?",
      scoringKey: "q115"
    }]
  },
  {
    item: 116,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q116",
      text: "What is the main reason Tom gives to support his position?",
      scoringKey: "q116"
    }]
  },
  {
    item: 117,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q117",
      text: "When he says 'take up the slack' in his sentence, what does Tom mean?",
      scoringKey: "q117"
    }]
  },
  {
    item: 118,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q118",
      text: "Tanisha uses the word 'acquisitions' in her letter. What does it mean?",
      scoringKey: "q118"
    }]
  },
  {
    item: 119,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q119",
      text: "According to Tanisha, what three things might happen if zoo prices are not raised?",
      scoringKey: "q119"
    }]
  },
  
  // King passage (read aloud)
  {
    item: 120,
    image: "13.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 121,
    image: "13.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q121",
      text: "What has happened to the king?",
      scoringKey: "q121"
    }]
  },
  {
    item: 122,
    image: "13.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q122",
      text: "What would you predict might happen as a result of the event described?",
      scoringKey: "q122"
    }]
  },
  
  // Central Asiatic Expedition passage
  {
    item: 123,
    image: "14.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q123",
      text: "What was the first discovery of the Central Asiatic Expedition?",
      scoringKey: "q123"
    }]
  },
  {
    item: 124,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q124",
      text: "Tell three adventures Andrews had experienced before going to the Gobi desert.",
      scoringKey: "q124"
    }]
  },
  {
    item: 125,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q125",
      text: "Where did the scientists discover the dinosaur eggs?",
      scoringKey: "q125"
    }]
  },
  {
    item: 126,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q126",
      text: "How did Andrew's expedition alter scientific knowledge?",
      scoringKey: "q126"
    }]
  },
  {
    item: 127,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q127",
      text: "What is the meaning of the word brigands as used in the passage?",
      scoringKey: "q127"
    }]
  },
  
  // Longevity (read aloud)
  {
    item: 128,
    image: "15.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 129,
    image: "15.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q129",
      text: "What is the meaning of the word longevity in this sentence?",
      scoringKey: "q129"
    }]
  },
  {
    item: 130,
    image: "15.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q130",
      text: "Describe the trend reported in this sentence",
      scoringKey: "q130"
    }]
  },
  
  // Life stages passage
  {
    item: 131,
    image: "16.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q131",
      text: "At what life stage is a person likely to begin a career?",
      scoringKey: "q131"
    }]
  },
  {
    item: 132,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q132",
      text: "What is the main theme of the 'Mid-life Rebirth' developmental tasks?",
      scoringKey: "q132"
    }]
  },
  {
    item: 133,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q133",
      text: "Although Rachel was recently promoted to manager of her office, she is questioning her choice of careers and regrets that she never pursued her dream of composing music. At the same time, she is reluctant to quit her job because she recently bought a new home. What developmental stage is Rachel probably in?",
      scoringKey: "q133"
    }]
  },
  {
    item: 134,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q134",
      text: "What might happen if a person did not accomplish the developmental tasks of the 'Breaking Loose' stage?",
      scoringKey: "q134"
    }]
  },
  {
    item: 135,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q135",
      text: "If the last life stage called 'Deepening Wisdom' were added to the chart, what would you predict two of the developmental tasks would be?",
      scoringKey: "q135"
    }]
  },
  
  // The Rock passage
  {
    item: 136,
    image: "17.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q136",
      text: "What is the fissure as described in the passage?",
      scoringKey: "q136"
    }]
  },
  {
    item: 137,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q137",
      text: "What suddenly made this rock climb so difficult?",
      scoringKey: "q137"
    }]
  },
  {
    item: 138,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q138",
      text: "What was the most important thing the women had to overcome in order to scale the rock?",
      scoringKey: "q138"
    }]
  },
  {
    item: 139,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q139",
      text: "What kept the women from turning back when they saw the sheer surface of the rock?",
      scoringKey: "q139"
    }]
  },
  {
    item: 140,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q140",
      text: "Why did Angela refuse to look at Sherry as she approached the summit?",
      scoringKey: "q140"
    }]
  }
];

/* ===========================
   Participant Group Configuration
   =========================== */
function determineRecordingNeeds() {
  const group = state.participantGroup;
  const modality = state.readModality;
  
  // All participants can choose their modality
  if (modality === 'sign') {
    state.useVideoRecording = true;
    state.useAudioRecording = false;
    return 'video';
  } else {
    state.useVideoRecording = false;
    state.useAudioRecording = true;
    return 'audio';
  }
}

function checkWelcomeReady() {
  const hasPid = document.getElementById('pid').value.trim().length > 0;
  const hasEdu = !!document.getElementById('edu').value;
  const hasGroup = !!state.participantGroup;
  const hasModality = !!state.readModality;
  document.getElementById('begin').disabled = !(hasPid && hasEdu && hasGroup && hasModality);
}

// call this in all these places:
document.getElementById('pid').addEventListener('input', checkWelcomeReady);
document.getElementById('edu').addEventListener('change', checkWelcomeReady);
document.querySelectorAll('input[name="participant-group"]').forEach(r => r.addEventListener('change', () => { state.participantGroup = r.value; /* existing logic... */ checkWelcomeReady(); }));
document.querySelectorAll('input[name="read-modality"]').forEach(r => r.addEventListener('change', () => { state.readModality = r.value; checkWelcomeReady(); }));

function getReadAloudInstructions() {
  const modality = state.readModality;
  
  if (modality === 'sign') {
    return {
      title: "Sign This Passage",
      text: "Please sign this passage in ASL. Click 'Start Recording' when ready to begin signing.",
      buttonText: "Start Signing"
    };
  } else {
    return {
      title: "Read This Aloud",
      text: "Please read this passage aloud. Click 'Start Recording' when ready to begin speaking.",
      buttonText: "Start Speaking"
    };
  }
}

/* ===========================
   Google Apps Script Communication
   =========================== */
async function sendToGoogle(action, data) {
  try {
    const payload = {
      action: action,
      ...data,
      participantGroup: state.participantGroup,
      readModality: state.readModality,
      timestamp: new Date().toISOString()
    };
    
    console.log('Sending to Google:', action, payload);
    
    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });
    
    updateConnectionStatus(true);
    return { status: 'success' };
    
  } catch (error) {
    console.error('Google Apps Script error:', error);
    updateConnectionStatus(false);
    throw error;
  }
}

function updateConnectionStatus(connected) {
  state.connectionStatus = connected;
  const box = document.getElementById('connection-status');
  const live = document.getElementById('connection-text');

  box.classList.toggle('connected', connected);
  box.classList.toggle('error', !connected);

  live.setAttribute('role', connected ? 'status' : 'alert');
  live.setAttribute('aria-live', connected ? 'polite' : 'assertive');
  live.textContent = connected ? 'Connected' : 'Not connected';
}


/* ===========================
   Recording Functions
   =========================== */
async function setupVideoRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' },
      audio: false
    });
    state.stream = stream;
    const preview = document.getElementById('preview');
    preview.srcObject = stream;

    const mime = pickMime('video');        // ← choose best supported
    state.recordMime = mime || 'video/webm';
    state.mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : {});
    state.recordedChunks = [];
    state.mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) state.recordedChunks.push(e.data); };

    document.getElementById('video-status').textContent = 'Camera ready. You can see yourself above.';
    return true;
  } catch (err) {
    console.error('Video setup error:', err);
    document.getElementById('video-status').textContent = 'Error: Could not access camera. Please check permissions.';
    return false;
  }
}
    document.getElementById('video-status').textContent = 'Camera ready. You can see yourself above.';
    return true;
  } catch (err) {
    console.error('Video setup error:', err);
    document.getElementById('video-status').textContent = 'Error: Could not access camera. Please check permissions.';
    return false;
  }
}

async function setupAudioRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: true, noiseSuppression: true }
    });
    state.stream = stream;

    const mime = pickMime('audio');        // ← choose best supported
    state.recordMime = mime || 'audio/webm';
    state.mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : {});
    state.recordedChunks = [];
    state.mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) state.recordedChunks.push(e.data); };

    document.getElementById('audio-status').textContent = 'Microphone ready. Test your audio above.';
    return true;
  } catch (err) {
    console.error('Audio setup error:', err);
    document.getElementById('audio-status').textContent = 'Error: Could not access microphone. Please check permissions.';
    return false;
  }
}

function startRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state === 'inactive') {
    state.recordedChunks = [];
    state.mediaRecorder.start();

    document.getElementById('sr-live').textContent = state.useVideoRecording
  ? 'Recording video started'
  : 'Recording audio started';

    // Start recording timer
    let seconds = 0;
    const timerEl = document.getElementById('recording-timer');
    timerEl.classList.remove('hidden');
    
    state.recordingTimerInterval = setInterval(() => {
      seconds++;
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }, 1000);
    
    // Show recording indicator
    document.getElementById('rec-indicator').classList.remove('hidden');
    document.getElementById('rec-type').textContent = state.useVideoRecording ? 'Recording Video' : 'Recording Audio';
  }
}


      
   function stopRecording() {
  return new Promise((resolve) => {
    if (!state.mediaRecorder || state.mediaRecorder.state !== 'recording') {
      resolve(null);
      return;
    }

    state.mediaRecorder.onstop = () => {
      const blob = new Blob(
        state.recordedChunks,
        { type: state.recordMime || (state.useVideoRecording ? 'video/webm' : 'audio/webm') }
      );
      resolve(blob);
    };

    state.mediaRecorder.stop();
    document.getElementById('sr-live').textContent = 'Recording stopped';

    if (state.recordingTimerInterval) {
      clearInterval(state.recordingTimerInterval);
      state.recordingTimerInterval = null;
    }
    document.getElementById('recording-timer').classList.add('hidden');
    document.getElementById('rec-indicator').classList.add('hidden');
  });
}

/* ===========================
   Event Listeners
   =========================== */
// Participant group selection
document.querySelectorAll('input[name="participant-group"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    state.participantGroup = e.target.value;

    const modalityDiv = document.getElementById('modality-selection');
    const deafNote = document.getElementById('deaf-note');
    modalityDiv.classList.remove('hidden');
    if (state.participantGroup.startsWith('deaf')) deafNote.classList.remove('hidden');
    else deafNote.classList.add('hidden');

    if (state.participantGroup === 'hearing-nonsigner') {
      document.querySelector('input[name="read-modality"][value="speak"]').checked = true;
      state.readModality = 'speak';
    }
    checkWelcomeReady();
    document.getElementById('modality-selection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
});

  
// Modality selection
document.querySelectorAll('input[name="read-modality"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    state.readModality = e.target.value;
    checkWelcomeReady();
  });
});

document.getElementById('begin').addEventListener('click', async () => {
  state.pid = document.getElementById('pid').value.trim();
  state.edu = document.getElementById('edu').value;
  
  if (!state.pid || !state.edu || !state.participantGroup || !state.readModality) {
    alert('Please complete all required fields.');
    return;
  }
  
  // Check for admin mode
  if (state.pid.toLowerCase().includes('admin')) {
    state.adminMode = true;
    document.body.classList.add('admin-mode');
  }
  
  // Determine recording needs
  const recordingType = determineRecordingNeeds();
  
  // Initialize session with Google Sheets
  try {
    await sendToGoogle('session_start', {
      pid: state.pid,
      education: state.edu,
      adminMode: state.adminMode,
      hasRecording: true,
      ipAddress: '',
      userAgent: navigator.userAgent
    });
  } catch (error) {
    console.error('Failed to initialize session:', error);
  }
  
  showScreen('setup');
  setupRecording(recordingType);
});

async function setupRecording(recordingType) {
  const statusEl = document.getElementById('setup-status-text');
  const methodEl = document.getElementById('recording-method-text');
  const methodDiv = document.getElementById('recording-method-info');
  
  if (recordingType === 'video') {
    methodDiv.className = 'recording-info video';
    methodEl.textContent = 'Video recording will be used for ASL "read aloud" items.';
    document.getElementById('video-setup').classList.remove('hidden');
    document.getElementById('audio-setup').classList.add('hidden');
    
    statusEl.textContent = 'Setting up video recording...';
    const success = await setupVideoRecording();
    
    if (success) {
      statusEl.textContent = '✓ Video recording ready';
      document.getElementById('start-study').disabled = false;
    } else {
      statusEl.textContent = '✗ Video setup failed. Please refresh and try again.';
    }
  } else {
    methodDiv.className = 'recording-info audio';
    methodEl.textContent = 'Audio recording will be used for spoken "read aloud" items.';
    document.getElementById('audio-setup').classList.remove('hidden');
    document.getElementById('video-setup').classList.add('hidden');
    
    statusEl.textContent = 'Setting up audio recording...';
    const success = await setupAudioRecording();
    
    if (success) {
      statusEl.textContent = '✓ Audio recording ready';
      document.getElementById('start-study').disabled = false;
    } else {
      statusEl.textContent = '✗ Audio setup failed. Please refresh and try again.';
    }
  }
}

// Test audio recording
document.getElementById('test-audio-record').addEventListener('click', () => {
  const btn = document.getElementById('test-audio-record');
  const stopBtn = document.getElementById('stop-test-audio');
  const timerEl = document.getElementById('test-audio-timer');
  
  btn.classList.add('hidden');
  stopBtn.classList.remove('hidden');
  timerEl.classList.remove('hidden');
  
  // Start test recording
  const testChunks = [];
const mime = pickMime('audio');
const testRecorder = new MediaRecorder(state.stream, mime ? { mimeType: mime } : {});
// ...
testRecorder.onstop = () => {
  const chosen = testRecorder.mimeType || mime || 'audio/webm';
  const blob = new Blob(testChunks, { type: chosen });
  const url = URL.createObjectURL(blob);
  const playback = document.getElementById('test-audio-playback');
  playback.src = url;
  playback.classList.remove('hidden');
  document.getElementById('audio-status').textContent = 'Recording saved. Play it back to verify quality.';
};
  
  testRecorder.start();
  
  // Timer
  let seconds = 0;
  const interval = setInterval(() => {
    seconds++;
    timerEl.textContent = `${Math.floor(seconds/60).toString().padStart(2,'0')}:${(seconds%60).toString().padStart(2,'0')}`;
  }, 1000);
  
  stopBtn.onclick = () => {
    testRecorder.stop();
    clearInterval(interval);
    btn.classList.remove('hidden');
    stopBtn.classList.add('hidden');
    timerEl.classList.add('hidden');
  };
});

document.getElementById('start-study').addEventListener('click', startStudy);

async function startStudy() {
  state.sessionStartTime = Date.now();
  buildSequence();
  state.currentIndex = 0;
  showItem();
}

// Timer functions
function startTimer() {
  state.readingStartTime = Date.now();
  let seconds = 0;
  
  document.getElementById('timer-container').classList.remove('hidden');
  
  state.timerInterval = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    document.getElementById('timer').textContent = 
      `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }, 1000);
}

function stopTimer() {
  if (state.timerInterval) {
    clearInterval(state.timerInterval);
    state.timerInterval = null;
  }
  document.getElementById('timer-container').classList.add('hidden');
  const elapsed = state.readingStartTime ? Date.now() - state.readingStartTime : 0;
  state.readingStartTime = null;
  return elapsed;
}

// Item navigation
document.getElementById('start-reading').addEventListener('click', () => {
  startTimer();

  // Send reading start event
  sendToGoogle('reading_time', {
    pid: state.pid,
    itemNumber: state.sequence[state.currentIndex].item,
    imageFile: state.sequence[state.currentIndex].image,
    readingType: 'silent',
    startTime: new Date().toISOString()
  });

  document.getElementById('start-reading').classList.add('hidden');
  document.getElementById('done-reading').classList.remove('hidden');
});

document.getElementById('done-reading').addEventListener('click', async () => {
  const readingTime = stopTimer();
  const trial = state.sequence[state.currentIndex];

  // For non-scored items, just continue
  if (trial.skipScoring) {
    state.currentIndex++;
    showItem();
    return;
  }

  // Send reading complete event
  await sendToGoogle('reading_time', {
    pid: state.pid,
    itemNumber: trial.item,
    imageFile: trial.image,
    readingType: 'silent',
    startTime: new Date(Date.now() - readingTime).toISOString(),
    endTime: new Date().toISOString(),
    duration: readingTime / 1000
  });

  showQuestions(readingTime);
});

/* ---- ADD THIS NEW LISTENER (standalone) ---- */
document.getElementById('start-recording').addEventListener('click', () => {
  startRecording();
  document.getElementById('start-recording').classList.add('hidden');
  document.getElementById('stop-recording').classList.remove('hidden');
});

/* ---- REPLACE your entire stop-recording listener with THIS ---- */
document.getElementById('stop-recording').addEventListener('click', async () => {
  const blob = await stopRecording();

  document.getElementById('start-recording').classList.remove('hidden');
  document.getElementById('stop-recording').classList.add('hidden');

  const trial = state.sequence[state.currentIndex];

  // Upload recording
  if (blob) {
    uploadRecordingToGoogle(blob, trial.item);
  }

  // Move to next item or show questions
  if (trial.skipScoring) {
    state.currentIndex++;
    showItem();
  } else {
    showQuestions(0);
  }
});



document.getElementById('qa-form').addEventListener('submit', submitAnswers);
document.getElementById('skip').addEventListener('click', skipItem);
document.getElementById('retry-upload').addEventListener('click', retryUpload);
document.getElementById('download-backup').addEventListener('click', downloadBackup);

/* ===========================
   Core Functions
   =========================== */
function buildSequence() {
  const gradeNum = state.edu === "13+" ? 13 : parseInt(state.edu);
  
  const sortedTrials = TRIALS.slice().sort((a, b) => a.item - b.item);
  
  if (gradeNum >= 9) {
    const startIdx = sortedTrials.findIndex(t => t.item === 94);
    if (startIdx >= 0) {
      state.sequence = sortedTrials.slice(startIdx);
    } else {
      state.sequence = sortedTrials;
    }
  } else {
    state.sequence = sortedTrials;
  }
  
  console.log(`Built sequence with ${state.sequence.length} items for grade ${state.edu}`);
}

async function showItem() {
  if (state.currentIndex >= state.sequence.length) {
    finishAssessment();
    return;
  }
  
  // WIAT-2 discontinue rule
  if (state.consecutiveZeros >= 6) {
    finishAssessment();
    return;
  }
  
  const trial = state.sequence[state.currentIndex];
  
  // Send item started event to Google
  await sendToGoogle('item_started', {
    pid: state.pid,
    itemNumber: trial.item,
    imageFile: trial.image,
    questionText: trial.questions ? trial.questions[0].text : '',
    itemType: trial.type
  });
  
  showScreen('item');
  updateProgress();
  updateAdminPanel();
  
  document.getElementById('item-number').textContent = `Item ${state.currentIndex + 1} of ${state.sequence.length}`;
  document.getElementById('actual-item-number').textContent = trial.item;
  document.getElementById('stim').src = `stimuli/${trial.image}`;
  
  // Reset form
  document.getElementById('qa-form').classList.add('hidden');
  document.getElementById('qa-fields').innerHTML = '';
  document.getElementById('timer').textContent = '00:00';
  
  // Hide all controls initially
  document.getElementById('recording-controls').classList.add('hidden');
  document.getElementById('reading-controls').classList.add('hidden');
  document.getElementById('read-aloud-instructions').classList.add('hidden');
  
  const instruction = trial.instruction || '';
  document.getElementById('instruction-text').textContent = instruction;
  
  // Handle different item types
  if (trial.readAloud) {
    // This is a read-aloud item
    const instructions = getReadAloudInstructions();
    document.getElementById('read-aloud-title').textContent = instructions.title;
    document.getElementById('read-aloud-text').textContent = instructions.text;
    document.getElementById('read-aloud-instructions').classList.remove('hidden');
    document.getElementById('recording-controls').classList.remove('hidden');
    document.getElementById('start-recording').textContent = instructions.buttonText;
    
    if (!trial.skipScoring) {
      // Will show questions after recording
      showQuestions(0);
    }
  } else if (trial.skipScoring) {
    // Non-recording read item (shouldn't happen often)
    document.getElementById('reading-controls').classList.remove('hidden');
    document.getElementById('start-reading').classList.add('hidden');
    document.getElementById('done-reading').classList.remove('hidden');
    document.getElementById('done-reading').textContent = 'Continue';
  } else if (trial.skipReading) {
    // Question only, no reading
    showQuestions(0);
  } else {
    // Standard silent reading passage
    document.getElementById('reading-controls').classList.remove('hidden');
    document.getElementById('start-reading').classList.remove('hidden');
    document.getElementById('done-reading').classList.add('hidden');
    document.getElementById('done-reading').textContent = 'Done Reading';
  }
  
  state.itemStartTime = Date.now();
}
// Helper to pick a recorder mime type the browser actually supports
function pickMime(kind) {
  const candidates = kind === 'video'
    ? ['video/mp4;codecs=h264', 'video/webm;codecs=vp8', 'video/webm', 'video/mp4']
    : ['audio/mp4', 'audio/aac', 'audio/webm', 'audio/ogg'];
  return candidates.find(t => window.MediaRecorder && MediaRecorder.isTypeSupported(t)) || '';
}


function showQuestions(readingTime) {
  const trial = state.sequence[state.currentIndex];
  if (trial.skipScoring) {
    state.currentIndex++;
    showItem();
    return;
  }

  const form = document.getElementById('qa-form');
  const fields = document.getElementById('qa-fields');
  form.classList.remove('hidden');
  document.getElementById('reading-controls').classList.add('hidden');
  document.getElementById('recording-controls').classList.add('hidden');
  document.getElementById('read-aloud-instructions').classList.add('hidden');

  // Clear existing
  fields.innerHTML = '';

  // Add a participant-friendly tip only once per item
  const tip = document.createElement('div');
  tip.className = 'tip-box';
  tip.id = 'answer-tips';
  tip.innerHTML = `
    <div><strong>Answer tips</strong></div>
    <ul>
      <li>Type in your own words. <em>Spelling and grammar don’t matter.</em></li>
      <li>Short answers are okay (a sentence or two).</li>
      <li>If you’re unsure, write your best guess.</li>
      <li>You can use ASL gloss if that’s easier.</li>
      <li>You can skip any question.</li>
      <li><span class="kbd">Ctrl/⌘ + Enter</span> = Submit, <span class="kbd">Alt + S</span> = Skip</li>
    </ul>
  `;
  fields.appendChild(tip);

  // Build question fields
  trial.questions.forEach(q => {
    const qDiv = document.createElement('div');
    qDiv.className = 'q-block';

    const label = document.createElement('label');
    label.textContent = q.text;
    label.setAttribute('for', q.id);

    const textarea = document.createElement('textarea');
    textarea.id = q.id;
    textarea.name = q.id;
    textarea.required = true;
    // Participant-friendly typing settings
    textarea.placeholder = 'Type your answer here (short is fine)';
    textarea.setAttribute('spellcheck', 'false');
    textarea.setAttribute('autocapitalize', 'off');
    textarea.setAttribute('autocorrect', 'off');
    textarea.setAttribute('aria-describedby', 'answer-tips');

    // Optional tiny word count (non-judgmental)
    const wc = document.createElement('div');
    wc.className = 'muted';
    wc.style.marginTop = '6px';
    wc.textContent = 'Word count: 0 (no minimum)';
    textarea.addEventListener('input', () => {
      const n = textarea.value.trim() ? textarea.value.trim().split(/\s+/).length : 0;
      wc.textContent = `Word count: ${n} (no minimum)`;
    });

    qDiv.appendChild(label);
    qDiv.appendChild(textarea);
    qDiv.appendChild(wc);
    fields.appendChild(qDiv);
  });

  // Friendlier skip label each time this view shows
  const skipBtn = document.getElementById('skip');
  if (skipBtn) skipBtn.textContent = 'Skip question';

  // Keyboard shortcuts
  form.onkeydown = (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      form.requestSubmit();
    } else if (e.altKey && e.key.toLowerCase() === 's') {
      e.preventDefault();
      document.getElementById('skip').click();
    }
  };
}


  /* ===========================
   Semantic scoring helpers - universal
   =========================== */
const STOPWORDS = new Set(['a','an','the','of','to','in','on','for','with','and','or','but','is','are','was','were','be','been','being','as','by','from','that','this','those','these','it','its','at','which','who','whom','what','why','how','do','does','did','so','very','really','just','about','into','over','under','up','down','out','off','than','then','there','their','them','they','you','your']);

const NUMBER_WORDS = new Map([
  ['zero','0'], ['one','1'], ['two','2'], ['three','3'], ['four','4'],
  ['five','5'], ['six','6'], ['seven','7'], ['eight','8'], ['nine','9'],
  ['ten','10'], ['eleven','11'], ['twelve','12']
]);

// REPLACE normalizeText with this merged version
function normalizeText(t) {
  t = String(t || '').toLowerCase();
  // unify quotes
  t = t.replace(/[\u2018\u2019]/g, "'").replace(/[\u201C\u201D]/g, '"');

  // expand only true contractions (avoid turning possessives into "is")
  t = t
    .replace(/\bwon't\b/g, 'will not')
    .replace(/\bcan't\b/g, 'cannot')
    .replace(/n't\b/g, ' not')
    .replace(/\bI'm\b/gi, 'I am')
    .replace(/\byou're\b/gi, 'you are')
    .replace(/\bwe're\b/gi, 'we are')
    .replace(/\bthey're\b/gi, 'they are')
    .replace(/\bI've\b/gi, 'I have')
    .replace(/\bwe've\b/gi, 'we have')
    .replace(/\bthey've\b/gi, 'they have')
    .replace(/\bI'll\b/gi, 'I will')
    .replace(/\byou'll\b/gi, 'you will')
    .replace(/\bwe'll\b/gi, 'we will')
    .replace(/\bthey'll\b/gi, 'they will');

  // strip punctuation (keep digits/letters/spaces)
  t = t.replace(/[.,!?;:"`']/g, ' ').replace(/\s+/g, ' ').trim();
  return t;
}

function simpleStem(w) {
  if (!w) return w;
  // light stem rules; do NOT eat short words like "is"
  if (w.length > 3) {
    if (w.endsWith('ies')) return w.slice(0, -3) + 'y';
    if (/(ing|ed|ly|ers|er|est)$/.test(w)) return w.replace(/(ing|ed|ly|ers|er|est)$/,'');
    if (w.endsWith('s') && !w.endsWith('ss')) return w.slice(0, -1);
  }
  return w;
}

function tokenize(t) {
  const norm = normalizeText(t);
  const raw = norm.split(' ').map(w => NUMBER_WORDS.get(w) || w);
  const filtered = raw.filter(w => w && !STOPWORDS.has(w));
  const stemmed = filtered.map(simpleStem);
  return { tokens: stemmed, joined: ' ' + stemmed.join(' ') + ' ' };
}

function patternToTokenSet(pat) {
  const src = pat instanceof RegExp ? pat.source : String(pat || '');
  // strip common regex meta so alternations like (foo|bar) become tokens
  const deRegex = src.replace(/[\\^$.*+?()[\]{}|]/g, ' ');
  const parts = normalizeText(deRegex).split(' ');
  const toks = parts.map(simpleStem).filter(Boolean);
  return new Set(toks);
}

function tokenSetSatisfied(respTokens, tokenSet) {
  if (!tokenSet || tokenSet.size === 0) return { hits: 0, need: 0 };
  let hits = 0;
  for (const tok of tokenSet) if (respTokens.includes(tok)) hits++;
  return { hits, need: tokenSet.size };
}


  // --- Simple response quality + review helpers (used in submitAnswers) ---
function checkKeywords(response, scoringKey) {
  // Heuristic: does the response hit some tokens from any pattern in SCORING_REFERENCE?
  const scoring = SCORING_REFERENCE[scoringKey];
  if (!scoring) return false;
  const { tokens } = tokenize(response);

  const sets = [];
  const addSets = (bucket) => {
    if (bucket && Array.isArray(bucket.patterns)) {
      bucket.patterns.forEach(p => sets.push(patternToTokenSet(p)));
    }
  };
  addSets(scoring.twoPoint);
  addSets(scoring.onePoint);

  return sets.some(set => {
    let hits = 0;
    set.forEach(tok => { if (tokens.includes(tok)) hits++; });
    return hits >= Math.max(1, Math.ceil(set.size * 0.4)); // ~40% overlap counts as “has relevant keywords”
  });
}

function detectASLGloss(response) {
  const raw = String(response || '');
  const words = raw.trim().split(/\s+/);
  const upperFrac = words.length ? words.filter(w => /^[A-Z0-9-]{2,}$/.test(w)).length / words.length : 0;
  const hasGlossMarkers = /\b(IX|PRO|CL[:\-]|1P|2P|3P|NEG|PAST|FUTURE)\b/.test(raw);
  return (upperFrac >= 0.4 || hasGlossMarkers) ? 'asl_gloss' : 'english';
}

function assessResponseQuality(response, scoringKey) {
  const txt = String(response || '');
  return {
    wordCount: txt ? txt.trim().split(/\s+/).length : 0,
    hasRelevantKeywords: checkKeywords(txt, scoringKey),
    isComplete: txt.trim().length > 10,
    language: detectASLGloss(txt)
  };
}

function createReviewInterface(needsReview) {
  if (!Array.isArray(needsReview) || needsReview.length === 0) return;
  state.reviewQueue.push(...needsReview);
}

// Scoring function - semantic-first, tolerant, universal
function flexibleScore(response, scoringKey) {
  const scoring = SCORING_REFERENCE[scoringKey];
  const clean = String(response || '').trim();
  const { tokens, joined } = tokenize(clean);

  // 1) If a semantic rubric exists, try it first
  if (scoring && scoring.semantic) {
    const sem = scoring.semantic;

    const combos = [];
    if (Array.isArray(sem.full)) combos.push(sem.full);
    if (Array.isArray(sem.altFull)) combos.push(sem.altFull);

    // full-credit: any combo where each group is satisfied
    for (const combo of combos) {
      const ok = combo.every(group => {
        // group may be array of alternatives or a single key/phrase
        const alts = Array.isArray(group) ? group : [group];
        // satisfied if any alt token exists in the response
        return alts.some(alt => {
          const toks = Array.isArray(alt) ? alt : [alt];
          // treat each alt as a literal phrase or keyword bag
          const altJoined = ' ' + toks.map(x => simpleStem(normalizeText(x))).join(' ') + ' ';
          // phrase-level relaxed match
          return joined.includes(altJoined) || toks.some(t => tokens.includes(simpleStem(normalizeText(t))));
        });
      });
      if (ok) return { autoScore: 2, confidence: 'high', needsReview: false, notes: 'Semantic full-credit match' };
    }

    // partial-credit: if any defined partial set achieves at least half of its elements
    if (Array.isArray(sem.partial)) {
      const p = sem.partial;
      let hits = 0;
      for (const it of p) {
        const alts = Array.isArray(it) ? it : [it];
        const got = alts.some(a => {
          const aNorm = simpleStem(normalizeText(a));
          return joined.includes(' ' + aNorm + ' ') || tokens.includes(aNorm);
        });
        if (got) hits++;
      }
      if (hits >= Math.max(1, Math.ceil(p.length * 0.5))) {
        return { autoScore: 1, confidence: 'medium', needsReview: true, notes: 'Semantic partial-credit match' };
      }
    }
    // fall through to pattern logic if semantic did not match
  }

  // 2) No semantic rubric, or no match - apply tolerant pattern logic for any question
  if (scoring) {
    // 2a) Two-point tolerant check: every keyword in any twoPoint pattern appears
    if (scoring.twoPoint && Array.isArray(scoring.twoPoint.patterns)) {
      for (const pat of scoring.twoPoint.patterns) {
        const set = patternToTokenSet(pat);
        const { hits, need } = tokenSetSatisfied(tokens, set);
        if (need > 0 && hits === need) {
          return { autoScore: 2, confidence: 'medium', needsReview: false, notes: 'Tolerant 2-point pattern match' };
        }
      }
    }

    // 2b) One-point tolerant check: at least half of the keywords in any onePoint pattern appear
    if (scoring.onePoint && Array.isArray(scoring.onePoint.patterns)) {
      for (const pat of scoring.onePoint.patterns) {
        const set = patternToTokenSet(pat);
        const { hits, need } = tokenSetSatisfied(tokens, set);
        if (need > 0 && hits >= Math.ceil(need * 0.5)) {
          return { autoScore: 1, confidence: 'low', needsReview: true, notes: 'Tolerant 1-point pattern match' };
        }
      }
    }

    // 2c) Last-resort literal regex on normalized text (kept as a safety net)
    if (scoring.twoPoint && Array.isArray(scoring.twoPoint.patterns)) {
      for (const pat of scoring.twoPoint.patterns) {
        const rx = pat instanceof RegExp ? pat : new RegExp(String(pat), 'i');
        if (rx.test(clean.toLowerCase())) {
          return { autoScore: 2, confidence: 'low', needsReview: true, notes: 'Regex fallback 2-point' };
        }
      }
    }
    if (scoring.onePoint && Array.isArray(scoring.onePoint.patterns)) {
      for (const pat of scoring.onePoint.patterns) {
        const rx = pat instanceof RegExp ? pat : new RegExp(String(pat), 'i');
        if (rx.test(clean.toLowerCase())) {
          return { autoScore: 1, confidence: 'low', needsReview: true, notes: 'Regex fallback 1-point' };
        }
      }
    }
  }

  // 3) No scoring reference - or still no match
  return { autoScore: 0, confidence: 'none', needsReview: true, notes: 'No semantic or tolerant match' };
}

/* ==========================================
   Multi-idea override rules (q89, q91, q119)
   ========================================== */

const MULTI_IDEA_RULES = {
  // q89: 2 dangers = 2 pts; 1 danger = 1 pt
  q89: {
    minIdeasForOne: 1,
    minIdeasForTwo: 2,
    categories: [
      [/(?:cold|freez|blizzard|snowstorm)/],                            // weather/cold
      [/(?:bear|wolf|wolves|animal\s*attack|wildlife)/],               // animals
      [/(?:starv|hunger|food\s*shortage|lack\s*of\s*food)/],           // hunger
      [/(?:rapid|river|ice\s*break|thin\s*ice|avalanche|landslide)/],  // terrain/river/ice
      [/(?:sick|illness|injur|exhaustion|fatigue)/]                    // health/exhaustion
    ]
  },

  // q91: 2 themes = 2 pts; 1 theme = 1 pt
  q91: {
    minIdeasForOne: 1,
    minIdeasForTwo: 2,
    categories: [
      [/(?:surviv|persever|endure|overcome)/],                         // survival/perseverance
      [/(?:family|together|teamwork|loyalty)/],                        // family/teamwork
      [/(?:courage|brave|risk|adventure)/]                             // courage/adventure
    ]
  },

  // q119: 3 consequences = 2 pts; 1–2 = 1 pt
  q119: {
    minIdeasForOne: 1,
    minIdeasForTwo: 3,
    categories: [
      [/(?:fewer|no)\s+(?:acquisitions|new\s*animals|new\s*exhibits)/], // fewer/no acquisitions/exhibits
      [/(?:reduce(?:d)?|cut)\s+(?:hours|services|staff|care|maintenance)/], // cuts to ops
      [/(?:close|closure)/]                                              // closure
    ]
  }
};

function applyMultiIdeaOverride(scoringKey, response) {
  const rule = MULTI_IDEA_RULES[scoringKey];
  if (!rule) return { applied: false, ideas: 0, score: 0, reason: '' };

  const text = normalizeText(response || ''); // you already have normalizeText()
  let ideas = 0;

  for (const category of rule.categories) {
    const matched = category.some(rx => rx.test(text));
    if (matched) ideas++;
  }

  let score = 0;
  if (ideas >= rule.minIdeasForTwo) score = 2;
  else if (ideas >= rule.minIdeasForOne) score = 1;

  return {
    applied: score > 0,
    ideas,
    score,
    reason: `Matched ${ideas} distinct idea(s)`
  };
}

async function submitAnswers(e) {
  e.preventDefault();

  const trial = state.sequence[state.currentIndex];
  const endTime = new Date().toISOString();
  const duration = (Date.now() - state.itemStartTime) / 1000;

  let totalScore = 0;
  let anyNeedsReview = false;
  const responses = {};
  const needsReviewList = [];

  for (const q of trial.questions) {
    const response = document.getElementById(q.id).value.trim();

    // 1) Base semantic/pattern scoring
    let scoringResult = flexibleScore(response, q.scoringKey);

    // 2) Multi-idea override (q89, q91, q119)
    const override = applyMultiIdeaOverride(q.scoringKey, response);
    if (override.applied && override.score > (scoringResult.autoScore || 0)) {
      scoringResult = {
        autoScore: override.score,
        confidence: override.score === 2 ? 'high' : 'medium',
        needsReview: override.score < 2, // full 2 usually doesn’t need review; 1 still might
        notes: (scoringResult.notes ? scoringResult.notes + ' | ' : '') + `Multi-idea override: ${override.reason}`
      };
    }

    // 3) Response quality diagnostics (unchanged)
    const quality = assessResponseQuality(response, q.scoringKey);

    // 4) Review queue + metrics (now using the possibly-overridden result)
    if (scoringResult.needsReview) {
      state.scoringMetrics.manualReviewNeeded += 1;
      anyNeedsReview = true;
      needsReviewList.push({
        item: trial.item,
        questionId: q.id,
        question: q.text,
        response: response,
        scoringKey: q.scoringKey,
        scoringDetails: scoringResult
      });
    }

    if (scoringResult.confidence === 'high') state.scoringMetrics.highConfidence += 1;
    else if (scoringResult.confidence === 'medium') state.scoringMetrics.mediumConfidence += 1;
    else if (scoringResult.confidence === 'low') state.scoringMetrics.lowConfidence += 1;

    totalScore += (scoringResult.autoScore || 0);

    responses[q.id] = {
      question: q.text,
      response: response,
      autoScore: scoringResult.autoScore,
      scoringDetails: scoringResult,
      needsReview: scoringResult.needsReview,
      quality: quality
    };

    // 5) Send per-question record to Google (unchanged)
    await sendToGoogle('item_completed', {
      pid: state.pid,
      itemNumber: trial.item,
      endTime: endTime,
      duration: duration,
      response: response,
      explanation: '',
      autoScore: scoringResult.autoScore,
      scoreConfidence: scoringResult.confidence,
      needsReview: scoringResult.needsReview,
      scoringNotes: scoringResult.notes,
      finalScore: scoringResult.autoScore,
      consecutiveZeros: state.consecutiveZeros,
      scoringDetails: scoringResult,
      responseQuality: quality
    });
  }

  // Average across all questions in the item (unchanged)
  const finalScore = Math.round(totalScore / Math.max(1, trial.questions.length));

  state.totalPoints += finalScore;
  state.consecutiveZeros = finalScore === 0 ? state.consecutiveZeros + 1 : 0;

  createReviewInterface(needsReviewList);

  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    responses: responses,
    autoScoreTotal: finalScore,
    needsReview: anyNeedsReview,
    totalTime: duration * 1000,
    timestamp: endTime
  });

  state.currentIndex++;
  showItem();
}




async function skipItem() {
  const trial = state.sequence[state.currentIndex];
  
  if (!trial.skipScoring) {
    state.consecutiveZeros++;
  }
  
  // Send skip event to Google
  await sendToGoogle('item_skipped', {
    pid: state.pid,
    itemNumber: trial.item,
    imageFile: trial.image,
    questionText: trial.questions ? trial.questions[0].text : '',
    itemType: trial.type,
    reason: 'User choice',
    consecutiveZeros: state.consecutiveZeros
  });
  
  state.results.push({
    pid: state.pid,
    edu: state.edu,
    item: trial.item,
    image: trial.image,
    response: 'SKIPPED',
    autoScore: 0,
    needsReview: false,
    totalTime: Date.now() - state.itemStartTime,
    timestamp: new Date().toISOString()
  });
  
  state.currentIndex++;
  showItem();
}

function updateProgress() {
  const percent = (state.currentIndex / state.sequence.length) * 100;
  document.getElementById('progress').style.width = `${percent}%`;
}

function updateAdminPanel() {
  if (state.adminMode) {
    document.getElementById('admin-group').textContent = state.participantGroup;
    document.getElementById('admin-item').textContent = 
      state.sequence[state.currentIndex] ? state.sequence[state.currentIndex].item : '-';
    document.getElementById('admin-score').textContent = state.totalPoints;
    document.getElementById('admin-zeros').textContent = state.consecutiveZeros;
    document.getElementById('admin-status').textContent = 
      state.consecutiveZeros >= 6 ? 'Discontinue' : 'Active';
  }
}

async function finishAssessment() {
  showScreen('finish');

  const durationMin = (Date.now() - state.sessionStartTime) / 1000 / 60;
  const discontinued = state.consecutiveZeros >= 6;

  // kinder, non-judgmental language for participants
  let msg;
  if (discontinued) {
    msg = 'Thanks! We’re all set for now.'; // no mention of why it ended
  } else if (state.currentIndex >= state.sequence.length) {
    msg = `All done — thank you for your time.`;
  } else {
    msg = `Thanks for your time today.`;
  }
  document.getElementById('finish-msg').textContent = msg;

  // stop any active media tracks
  if (state.stream) {
    state.stream.getTracks().forEach(track => track.stop());
  }

  // still log the research-relevant discontinue flag & counters to Google
  await sendToGoogle('session_complete', {
    pid: state.pid,
    duration: durationMin,
    itemsCompleted: state.results.length,
    totalScore: state.totalPoints,
    consecutiveZeros: state.consecutiveZeros,
    discontinued: discontinued,
    gateItemsFailed: state.gateItemsFailed.join(',')
  });

  showSummary();
  saveLocalBackup();
}

function showSummary() {
  const statsDiv = document.getElementById('final-stats');
  const content = document.getElementById('stats-content');

  const minutes = Math.max(1, Math.round((Date.now() - state.sessionStartTime) / 1000 / 60));

  // participant-friendly view (no scores, no review/zero details)
  let html = `
    <div>Participant Group: ${state.participantGroup}</div>
    <div>Communication Mode: ${state.readModality === 'sign' ? 'ASL' : 'Spoken'}</div>
    <div>Items Completed: ${state.results.length}</div>
    <div>Approximate Session Time: ${minutes} minute${minutes === 1 ? '' : 's'}</div>
  `;

  // show research metrics only in admin mode
  if (state.adminMode) {
    const avgScore = state.results.length > 0
      ? (state.totalPoints / state.results.length).toFixed(2)
      : 0;
    const itemsReviewed = state.results.filter(r => r.needsReview).length;

    html += `
      <hr style="margin:10px 0;border:none;border-top:1px solid #e9ecef;">
      <div><strong>Research Metrics (Admin)</strong></div>
      <div>Total Auto-Score: ${state.totalPoints}</div>
      <div>Average Auto-Score: ${avgScore}</div>
      <div>Items Flagged for Review: ${itemsReviewed}</div>
      <div>High confidence: ${state.scoringMetrics.highConfidence}</div>
      <div>Medium confidence: ${state.scoringMetrics.mediumConfidence}</div>
      <div>Low confidence: ${state.scoringMetrics.lowConfidence}</div>
      <div>Manual review needed: ${state.scoringMetrics.manualReviewNeeded}</div>
      <div>Review queue length: ${state.reviewQueue.length}</div>
    `;
  }

  content.innerHTML = html;
  statsDiv.classList.remove('hidden');

  // gentler success message
  updateUploadStatus('✓ Your responses have been saved.', 'success');
  document.getElementById('download-backup').classList.remove('hidden');
}



async function uploadRecordingToGoogle(blob, itemNumber) {
  if (!blob) return;
  
  try {
    const reader = new FileReader();
    reader.onloadend = async function() {
      const base64data = reader.result.split(',')[1];
      const fileType = state.useVideoRecording ? 'video' : 'audio';
      
      await sendToGoogle('video_upload', {
  pid: state.pid,
  fileType, // 'video' or 'audio'
  videoData: base64data,
  sessionDate: new Date().toISOString().split('T')[0],
  itemNumber: `${fileType}_item_${itemNumber}`
});
    };
    reader.readAsDataURL(blob);
  } catch (error) {
    console.error('Recording upload error:', error);
  }
}

function updateUploadStatus(message, type = '') {
  const statusDiv = document.getElementById('upload-status');
  const progressDiv = document.getElementById('upload-progress');
  
  progressDiv.textContent = message;
  statusDiv.className = 'status-box' + (type ? ' ' + type : '');
  if (type === 'error') {
  progressDiv.setAttribute('role','alert');
  progressDiv.setAttribute('aria-live','assertive');
} else {
  progressDiv.setAttribute('role','status');
  progressDiv.setAttribute('aria-live','polite');
}

}

async function retryUpload() {
  state.uploadAttempts++;
  // was: attempt ${state.uploadAttempts + 1}
  updateUploadStatus(`Retrying upload (attempt ${state.uploadAttempts})...`);

  await sendToGoogle('save_backup', {
    pid: state.pid,
    allData: state.results
  });
  
  updateUploadStatus('✓ Retry successful', 'success');
}

  

function saveLocalBackup() {
  state.savedData = {
    participant: state.pid,
    education: state.edu,
    participantGroup: state.participantGroup,
    readModality: state.readModality,
    totalAutoScore: state.totalPoints,
    itemsCompleted: state.results.length,
    consecutiveZeros: state.consecutiveZeros,
    gateItemsFailed: state.gateItemsFailed,
    allResponses: state.results,
    sessionDuration: (Date.now() - state.sessionStartTime) / 1000 / 60,
    timestamp: new Date().toISOString()
  };
}

function downloadBackup() {
  if (!state.savedData) {
    saveLocalBackup();
  }
  
  // Create CSV backup
  const rows = [
    ['PID', 'Education', 'Group', 'Modality', 'Item', 'Image', 'Question', 'Response', 
     'AutoScore', 'Confidence', 'NeedsReview', 'ScoringNotes', 
     'TotalTime(ms)', 'Timestamp']
  ];
  
  state.results.forEach(r => {
    if (r.responses) {
      Object.keys(r.responses).forEach(qId => {
        const q = r.responses[qId];
        rows.push([
          r.pid,
          r.edu,
          state.participantGroup,
          state.readModality,
          r.item,
          r.image,
          q.question,
          q.response.replace(/[,\n]/g, '; '),
          q.autoScore !== null ? q.autoScore : 'REVIEW',
          q.scoringDetails ? q.scoringDetails.confidence : '',
          q.needsReview ? 'YES' : 'NO',
          q.scoringDetails ? q.scoringDetails.notes : '',
          r.totalTime || '',
          r.timestamp
        ]);
      });
    } else {
      rows.push([
        r.pid,
        r.edu,
        state.participantGroup,
        state.readModality,
        r.item,
        r.image,
        'N/A',
        r.response || 'N/A',
        r.autoScore === 'N/A' ? 'N/A' : r.autoScore,
        '',
        'NO',
        '',
        r.totalTime || '',
        r.timestamp
      ]);
    }
  });
  
  const csv = rows.map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `WIAT2_${state.pid}_${state.participantGroup}_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  
  // Also save JSON backup
  const jsonBlob = new Blob([JSON.stringify(state.savedData, null, 2)], 
    { type: 'application/json' });
  const jsonUrl = URL.createObjectURL(jsonBlob);
  const jsonLink = document.createElement('a');
  jsonLink.href = jsonUrl;
  jsonLink.download = `WIAT2_${state.pid}_${state.participantGroup}_${Date.now()}.json`;
  document.body.appendChild(jsonLink);
  jsonLink.click();
  jsonLink.remove();
  URL.revokeObjectURL(jsonUrl);
  
  updateUploadStatus('Backup files downloaded', 'success');
}

function showScreen(name) {
  document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
  document.getElementById(`screen-${name}`).classList.remove('hidden');
}

/* ===========================
   Initialization
   =========================== */

document.addEventListener('DOMContentLoaded', () => {
  showScreen('welcome');
  
  // Check if Google Script URL is configured
  if (GOOGLE_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT_URL_HERE')) {
    document.getElementById('config-warning').classList.remove('hidden');
    document.getElementById('begin').disabled = true;
  }
  
  updateConnectionStatus(false);
});
</script>
</body>
</html>
