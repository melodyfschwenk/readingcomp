<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reading Comprehension - Research Version</title>
  <meta name="description" content="Browser-based reading comprehension task with timing, video proctor option, branching rules, and CSV export. Not a standardized WIAT administration." />
  <style>
    :root { --bg:#0b0e11; --card:#12161c; --muted:#8c98a5; --text:#e8eef6; --accent:#5aa9ff; --ok:#10b981; --danger:#ff6b6b; }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 800px at 20% 0%,#111827 0%, var(--bg) 60%); color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid #1f2630;border-radius:18px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1,h2,h3{line-height:1.2;margin:0 0 10px}
    p{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .stack{display:grid;gap:14px}
    label{font-weight:600}
    input[type=text],textarea,select{width:100%;background:#0d1117;border:1px solid #233046;color:var(--text);border-radius:10px;padding:10px 12px;font-size:16px}
    textarea{min-height:100px}
    .btn{appearance:none;border:1px solid #27476a;background:linear-gradient(180deg,#1f3b57,#182a3f);color:#d6e8ff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;font-size:16px}
    .btn:hover{filter:brightness(1.05)}
    .btn.secondary{background:#101722;border-color:#2a3647;color:var(--text)}
    .btn.danger{background:#2b0e13;border-color:#5c1b25;color:#ffd7dc}
    .hint{font-size:13px;color:var(--muted)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f1723;border:1px solid #223149;font-size:12px;color:#b7c5d6}
    .center{text-align:center}
    .hidden{display:none!important}
    .img-frame{background:#0b0f16;border:1px dashed #2a3a51;border-radius:14px;padding:12px;text-align:center}
    img.stimulus{max-width:100%;height:auto;border-radius:8px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar .btn{padding:6px 10px;font-size:14px}
    .bigtext{font-size:1.2em}
    .video{width:100%;background:#0d1117;border:1px solid #223149;border-radius:12px;padding:10px}
    video{width:100%;border-radius:8px;background:#000}
    .question{border-top:1px solid #1f2630;padding-top:14px;margin-top:14px}
    .q-label{font-weight:700}
    .required{color:#ffd27a;font-weight:600}
    .footer{margin-top:24px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:14px}
    .ok{color:var(--ok)}
    .danger-txt{color:var(--danger)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="intro">
      <h1>Reading Comprehension - Research Version</h1>
      <p>This browser task measures reading time and comprehension accuracy for research. It is not a standardized WIAT administration. Video can be recorded for fidelity if enabled and consented.</p>
      <div class="toolbar" style="margin:10px 0 14px;">
        <span class="pill">Accessibility</span>
        <button class="btn secondary" id="toggle-text" type="button">Text size toggle</button>
      </div>
      <div class="stack">
        <div class="row">
          <div>
            <label for="pid">Participant ID</label>
            <input id="pid" type="text" placeholder="e.g., P1034" />
            <p class="hint">Use your assigned code. Do not enter your name.</p>
          </div>
          <div>
            <label for="edu">Highest level of education</label>
            <select id="edu">
              <option value="">Select</option>
              <option value="9-12">Grades 9-12</option>
              <option value="13-16">Grades 13-16</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        <div>
          <label><input id="consent" type="checkbox" /> I consent to participate. I understand video may be recorded for scoring fidelity if I enable it below.</label>
        </div>
        <details>
          <summary class="pill">Optional proctor video</summary>
          <div class="video">
            <p class="hint">If enabled and permitted by your IRB, the app will record your webcam and mic while you complete the task. Files are stored locally until you download or submit.</p>
            <div class="stack">
              <div class="row">
                <button class="btn" id="enable-video" type="button">Enable camera and mic</button>
                <button class="btn danger hidden" id="stop-video" type="button">Stop camera</button>
              </div>
              <video id="preview" playsinline autoplay muted class="hidden"></video>
              <p id="video-status" class="muted"></p>
            </div>
          </div>
        </details>
        <div class="footer">
          <button id="begin" class="btn" type="button">Begin task</button>
          <span class="muted">All timing occurs in the browser at millisecond precision.</span>
        </div>
      </div>
    </div>

    <div class="card hidden" id="stimulus-card">
      <div class="toolbar">
        <span class="pill" id="trial-indicator">Passage</span>
        <span class="pill" id="timer-pill">00:00.000</span>
        <span class="pill" id="status-pill">Reading</span>
      </div>
      <div class="stack" style="margin-top:10px;">
        <div id="stimulus-container" class="img-frame center"></div>
        <div class="footer center">
          <button id="done-reading" class="btn" type="button">I am done reading</button>
        </div>
      </div>
    </div>

    <div class="card hidden" id="questions-card">
      <h2>Questions</h2>
      <div id="questions"></div>
      <div class="footer">
        <button id="next-trial" class="btn" type="button">Next</button>
        <span id="qc" class="muted"></span>
      </div>
    </div>

    <div class="card hidden" id="finish">
      <h2>Finished</h2>
      <p>Thanks for completing the task. You can download your data as CSV. If you configured a submission endpoint, you can also send the data securely.</p>
      <div class="footer">
        <button id="download" class="btn" type="button">Download CSV</button>
        <button id="submit" class="btn" type="button">Submit to endpoint</button>
        <span id="submit-status" class="muted"></span>
      </div>
      <details style="margin-top:14px;">
        <summary class="pill">Debug payload</summary>
        <pre id="debug" class="mono" style="white-space:pre-wrap;">{}</pre>
      </details>
    </div>
  </div>

  <script>
    // ---------- Configuration ----------
    // Put your images in /stimuli. Each trial has: item (number), img, questions, and optional gate settings.
    // For gate items (94 and 108), provide gateQuestionKey and gateAnswers (array of acceptable strings).

    const SUBMIT_ENDPOINT = ""; // optional HTTPS endpoint

    // Minimal demo set with placeholders. Replace imgs and question/keys with your real content.
    const TRIALS = [
      // 75 (placeholder)
      trial(75, "stimuli/placeholder_75.png", [ t("q75", "Who is Kwawar?", true) ]),
      // 94 - GATE for 9-12 start
      trial(94, "stimuli/placeholder_94.png", [ t("q94", "Main idea?", true) ], { gateQuestionKey:"q94", gateAnswers:["gold rush", "family journey"] }),
      // 95..98 (optional examples)
      trial(95, "stimuli/placeholder_95.png", [ t("q95", "Detail question", true) ]),
      trial(96, "stimuli/placeholder_96.png", [ t("q96", "Vocabulary meaning", true) ]),
      trial(97, "stimuli/placeholder_97.png", [ t("q97", "Inference", true) ]),
      trial(98, "stimuli/placeholder_98.png", [ t("q98", "Why did...", true) ]),
      // 99 destination after 75-93 remedial
      trial(99, "stimuli/placeholder_99.png", [ t("q99", "Comprehension question", true) ]),
      // 108 - GATE for 13-16 start
      trial(108, "stimuli/placeholder_108.png", [ t("q108", "Synthesis question", true) ], { gateQuestionKey:"q108", gateAnswers:["theme of resilience", "perseverance"] }),
      // 109..112 (optional examples)
      trial(109, "stimuli/placeholder_109.png", [ t("q109", "Detail", true) ]),
      trial(110, "stimuli/placeholder_110.png", [ t("q110", "Inference", true) ]),
      trial(111, "stimuli/placeholder_111.png", [ t("q111", "Vocabulary", true) ]),
      trial(112, "stimuli/placeholder_112.png", [ t("q112", "Reasoning", true) ]),
      // 113 destination after 94-107 remedial
      trial(113, "stimuli/placeholder_113.png", [ t("q113", "Wrap-up question", true) ])
    ];

    function t(key, label, required=false, type='textarea'){ return { key, label, type, required }; }
    function trial(item, img, questions, extra={}){
      return Object.assign({ item, img, readingInstructions:"Read carefully. Click the button when finished.", questions }, extra);
    }

    // ---------- State ----------
    const state = {
      pid:"", edu:"", consent:false,
      trials:[], // mapped from TRIALS but with runtime fields
      currentIndex:0, // index in state.sequence
      sequence:[], // array of item numbers in order to present
      readingStart:0,
      framesStart:0,
      video:{ stream:null, recorder:null, chunks:[], enabled:false }
    };

    const $ = (s)=>document.querySelector(s);

    // Accessibility
    $('#toggle-text').addEventListener('click', ()=> document.documentElement.classList.toggle('bigtext'));

    // Video controls
    $('#enable-video').addEventListener('click', async()=>{
      try{
        const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        state.video.stream = stream; state.video.enabled = true;
        const rec = new MediaRecorder(stream); state.video.recorder = rec; state.video.chunks = [];
        rec.ondataavailable = ev => { if (ev.data.size>0) state.video.chunks.push(ev.data); };
        $('#preview').srcObject = stream; $('#preview').classList.remove('hidden');
        $('#stop-video').classList.remove('hidden'); $('#enable-video').classList.add('hidden');
        $('#video-status').textContent = 'Camera is on. Recording starts when you begin the task and stops when you finish.';
      }catch(e){ $('#video-status').textContent = 'Could not access camera or mic. Check permissions.'; }
    });
    $('#stop-video').addEventListener('click', ()=>{
      if(state.video.stream) state.video.stream.getTracks().forEach(t=>t.stop());
      state.video.enabled=false; $('#preview').classList.add('hidden'); $('#stop-video').classList.add('hidden'); $('#enable-video').classList.remove('hidden');
      $('#video-status').textContent = 'Camera stopped.';
    });

    // Begin
    $('#begin').addEventListener('click', ()=>{
      const pid = $('#pid').value.trim(); const edu = $('#edu').value; const consent = $('#consent').checked;
      if(!pid){ alert('Enter a Participant ID.'); return; }
      if(!consent){ alert('You must consent to continue.'); return; }
      state.pid = pid; state.edu = edu; state.consent = consent;

      // Runtime copy of trials
      state.trials = TRIALS.map(t=>({ ...t, timestamps:{ show_ms:0, reading_start_ms:0, reading_end_ms:0 }, responses:{}, gateHit:null }));

      // Build starting sequence per education rule
      const startItem = edu === '9-12' ? 94 : (edu === '13-16' ? 108 : TRIALS[0].item);
      state.sequence = buildDefaultSequence(startItem);
      state.currentIndex = 0;

      // start video recording
      if(state.video.enabled && state.video.recorder && state.video.recorder.state!=='recording'){
        try{ state.video.recorder.start(); }catch(_){}}

      $('#intro').classList.add('hidden');
      startCurrentTrial();
    });

    function buildDefaultSequence(startItem){
      // Default is ascending from startItem through whatever exists in TRIALS order starting at that item
      const existing = TRIALS.map(t=>t.item);
      const startIdx = existing.indexOf(startItem);
      if(startIdx === -1) return existing.slice();
      return existing.slice(startIdx);
    }

    function startCurrentTrial(){
      const itemNum = state.sequence[state.currentIndex];
      const t = byItem(itemNum);
      if(!t){ // if missing, skip forward
        goNext(); return;
      }
      // Render stimulus
      const container = $('#stimulus-container'); container.innerHTML = '';
      const tip = document.createElement('p'); tip.className='hint'; tip.textContent = t.readingInstructions || '';
      const img = document.createElement('img'); img.className='stimulus'; img.alt='Reading passage'; img.src = t.img;
      container.appendChild(img); container.appendChild(tip);

      $('#trial-indicator').textContent = `Item ${t.item} (${state.currentIndex+1}/${state.sequence.length})`;
      $('#status-pill').textContent = 'Reading';
      $('#stimulus-card').classList.remove('hidden');
      $('#questions-card').classList.add('hidden');

      // Timing
      state.readingStart = performance.now(); state.framesStart = Date.now();
      t.timestamps.show_ms = state.readingStart; t.timestamps.reading_start_ms = state.readingStart;
      tickTimer();
    }

    function tickTimer(){
      if($('#stimulus-card').classList.contains('hidden')) return;
      const elapsed = performance.now() - state.readingStart;
      $('#timer-pill').textContent = formatMS(elapsed);
      requestAnimationFrame(tickTimer);
    }

    $('#done-reading').addEventListener('click', ()=>{
      const t = byItem(state.sequence[state.currentIndex]);
      t.timestamps.reading_end_ms = performance.now();
      $('#status-pill').textContent = 'Answering';
      $('#stimulus-card').classList.add('hidden');
      renderQuestions(t);
      $('#questions-card').classList.remove('hidden');
    });

    function renderQuestions(t){
      const host = $('#questions'); host.innerHTML = '';
      let requiredCount = 0;
      t.questions.forEach((q,i)=>{
        const div = document.createElement('div'); div.className='question';
        const label = document.createElement('div'); label.className='q-label';
        label.innerHTML = `${i+1}. ${q.label} ${q.required ? '<span class="required">(required)</span>' : ''}`;
        div.appendChild(label);
        let inputEl;
        if(q.type==='textarea'){ inputEl = document.createElement('textarea'); }
        else { inputEl = document.createElement('input'); inputEl.type='text'; }
        inputEl.dataset.key = q.key; div.appendChild(inputEl); host.appendChild(div);
        if(q.required) requiredCount += 1;
      });
      $('#qc').textContent = requiredCount ? `${requiredCount} required` : '';
    }

    $('#next-trial').addEventListener('click', ()=>{
      const t = byItem(state.sequence[state.currentIndex]);
      // Collect answers
      const answers = {}; t.questions.forEach(q=>{ const el = document.querySelector(`[data-key="${q.key}"]`); answers[q.key] = el ? el.value.trim() : ''; });
      // Required check
      for(const q of t.questions){ if(q.required && !(answers[q.key])){ alert('Please answer all required questions.'); return; } }
      t.responses = answers;

      // Gate evaluation if applicable
      if(t.gateQuestionKey){
        const resp = (answers[t.gateQuestionKey]||'').toLowerCase();
        const ok = (t.gateAnswers||[]).some(a => resp.includes(String(a).toLowerCase()));
        t.gateHit = ok;
        if(!ok){
          // Insert remedial path depending on gate item
          if(t.item === 94){
            insertRemedialRangeThenJump(75, 93, 99);
          } else if(t.item === 108){
            insertRemedialRangeThenJump(94, 107, 113);
          }
        }
      }

      goNext();
    });

    function insertRemedialRangeThenJump(start, end, jumpTo){
      const needed = range(start, end).filter(n => hasItem(n));
      // Build new tail: remedial block (excluding any that are already scheduled later to avoid duplicates), followed by jump target, then any remaining items that come after jump target naturally.
      const tail = [];
      needed.forEach(n => { if(!isAlreadyScheduledAhead(n)) tail.push(n); });
      if(hasItem(jumpTo) && !isAlreadyScheduledAhead(jumpTo)) tail.push(jumpTo);
      // Splice tail right after the current index
      state.sequence.splice(state.currentIndex+1, 0, ...tail);
    }

    function isAlreadyScheduledAhead(item){
      const pos = state.sequence.indexOf(item);
      return pos !== -1 && pos > state.currentIndex;
    }

    function goNext(){
      state.currentIndex += 1;
      if(state.currentIndex >= state.sequence.length){
        finish();
      } else {
        startCurrentTrial();
      }
    }

    function byItem(item){ return state.trials.find(t => t.item === item); }
    function hasItem(item){ return TRIALS.some(t => t.item === item); }
    function range(a,b){ const out=[]; for(let i=a;i<=b;i++) out.push(i); return out; }

    function finish(){
      if(state.video.enabled && state.video.recorder && state.video.recorder.state==='recording'){
        try{ state.video.recorder.stop(); }catch(_){}
      }
      $('#stimulus-card').classList.add('hidden');
      $('#questions-card').classList.add('hidden');
      $('#finish').classList.remove('hidden');
      updateDebug();
    }

    function formatMS(ms){
      const total = Math.max(0, Math.floor(ms));
      const m = Math.floor(total/60000); const s = Math.floor((total%60000)/1000); const x = total%1000;
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(x).padStart(3,'0')}`;
    }

    function toCSV(rows){
      const esc = v => '"'+String(v??'').replace(/"/g,'""')+'"';
      const header = Object.keys(rows[0]||{}).map(esc).join(',');
      const lines = rows.map(r => Object.values(r).map(esc).join(','));
      return [header, ...lines].join('
');
    }

    function compileRows(){
      const device = { ua:navigator.userAgent, tz:Intl.DateTimeFormat().resolvedOptions().timeZone, lang:navigator.language };
      const rows = [];
      state.sequence.forEach((itemNum, idx)=>{
        const t = byItem(itemNum); if(!t) return;
        const read_ms = t.timestamps.reading_end_ms - t.timestamps.reading_start_ms;
        const base = { pid:state.pid, edu:state.edu, ordinal:idx+1, item:itemNum, read_time_ms:Math.round(read_ms), gate:t.gateQuestionKey? (t.gateHit? 'pass':'fail') : '' , started_at_iso:new Date(state.framesStart).toISOString(), finished_at_iso:new Date().toISOString(), ua:device.ua, tz:device.tz, lang:device.lang };
        const resp = t.responses || {};
        rows.push(Object.assign({}, base, resp));
      });
      return rows;
    }

    function updateDebug(){ $('#debug').textContent = JSON.stringify(compileRows(), null, 2); }

    // Download / Submit
    $('#download').addEventListener('click', ()=>{
      const rows = compileRows(); if(!rows.length) return;
      const csv = toCSV(rows); const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = `${state.pid}_reading_task.csv`; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 10000);
      if(state.video.chunks.length){ const vidBlob = new Blob(state.video.chunks,{type:'video/webm'}); const vurl = URL.createObjectURL(vidBlob); const vlink = document.createElement('a'); vlink.href=vurl; vlink.download=`${state.pid}_session.webm`; vlink.click(); setTimeout(()=>URL.revokeObjectURL(vurl), 10000); }
    });

    $('#submit').addEventListener('click', async()=>{
      if(!SUBMIT_ENDPOINT){ $('#submit-status').innerHTML = '<span class="danger-txt">No endpoint configured. Set SUBMIT_ENDPOINT.</span>'; return; }
      const payload = { meta:{ pid:state.pid, edu:state.edu }, data:compileRows() };
      try{
        const res = await fetch(SUBMIT_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if(!res.ok) throw new Error('Network error');
        $('#submit-status').innerHTML = '<span class="ok">Submitted successfully.</span>';
      }catch(e){ $('#submit-status').innerHTML = '<span class="danger-txt">Submit failed. Check endpoint.</span>'; }
    });

    // Preload images
    window.addEventListener('load', ()=>{ TRIALS.forEach(t=>{ const i = new Image(); i.src = t.img; }); });
  </script>
</body>
</html>
