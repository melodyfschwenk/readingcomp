<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Comprehension Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-text: #212121;
            --secondary-text: #616161;
            --border-light: #e0e0e0;
            --border-medium: #bdbdbd;
            --background: #ffffff;
            --surface: #fafafa;
            --primary-action: #000000;
            --danger: #d32f2f;
            --content-width: 72ch;
            --base-font-size: 19px;
            --line-height: 1.7;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: var(--base-font-size);
            line-height: var(--line-height);
            color: var(--primary-text);
            background: var(--background);
            min-height: 100vh;
        }
        
        /* ===== ACTION BAR ===== */
        .action-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--background);
            border-bottom: 1px solid var(--border-light);
            padding: 16px 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            min-height: 88px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .action-bar.hidden {
            display: none;
        }
        
        .action-bar .primary-action {
            background: var(--primary-action);
            color: white;
            border: none;
            padding: 18px 48px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            min-height: 56px;
            border-radius: 4px;
            transition: opacity 0.2s ease;
        }
        
        .action-bar .primary-action:hover:not(:disabled) {
            opacity: 0.85;
        }
        
        .action-bar .primary-action:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .action-bar .secondary-action {
            background: transparent;
            color: var(--secondary-text);
            border: 1px solid var(--border-medium);
            padding: 16px 32px;
            font-size: 16px;
            cursor: pointer;
            min-height: 48px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .action-bar .secondary-action:hover {
            background: var(--surface);
            border-color: var(--primary-text);
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px 80px;
        }
        
        .content-column {
            max-width: var(--content-width);
            margin: 0 auto;
        }
        
        .wide-content {
            max-width: 100%;
        }
        
        /* ===== CARDS ===== */
        .card {
            background: var(--background);
            padding: 40px;
            margin: 0 auto;
        }
        
        .card.hidden {
            display: none;
        }
        
        /* ===== NEUTRAL HEADERS ===== */
        .page-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: 32px;
            text-align: center;
        }
        
        .section-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--secondary-text);
            margin-bottom: 24px;
            text-align: center;
            text-transform: none;
            letter-spacing: normal;
        }
        
        /* ===== TYPOGRAPHY ===== */
        h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
            line-height: 1.3;
        }
        
        h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        p, .text-content {
            font-size: var(--base-font-size);
            line-height: var(--line-height);
            margin-bottom: 16px;
            text-align: left;
        }
        
        .muted {
            color: var(--secondary-text);
            font-size: 16px;
        }
        
        /* ===== FORMS ===== */
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 500;
            color: var(--primary-text);
            text-transform: none;
        }
        
        input[type="text"], 
        input[type="email"], 
        select, 
        textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 17px;
            border: 1px solid var(--border-medium);
            background: var(--background);
            border-radius: 4px;
            transition: border-color 0.2s ease;
        }
        
        input:focus, 
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: var(--primary-action);
        }
        
        textarea {
            min-height: 120px;
            line-height: 1.6;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        /* ===== RADIO/CHECKBOX ===== */
        .radio-group {
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 8px;
            background: var(--surface);
        }
        
        .radio-group label,
        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 16px;
            margin: 4px;
            background: var(--background);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-weight: normal;
        }
        
        .radio-group label:hover,
        .checkbox-label:hover {
            background: var(--surface);
        }
        
        .radio-group label:has(input:checked) {
            background: var(--primary-text);
            color: white;
        }
        
        input[type="radio"],
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        /* ===== BUTTONS (NON-ACTION-BAR) ===== */
        button {
            min-height: 56px;
            padding: 16px 40px;
            font-size: 17px;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: none;
            letter-spacing: normal;
        }
        
        button.primary {
            background: var(--primary-action);
            color: white;
        }
        
        button.primary:hover:not(:disabled) {
            opacity: 0.85;
        }
        
        button.secondary {
            background: transparent;
            color: var(--primary-text);
            border: 1px solid var(--border-medium);
        }
        
        button.secondary:hover:not(:disabled) {
            background: var(--surface);
            border-color: var(--primary-text);
        }
        
        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        button:focus-visible {
            outline: 2px solid var(--primary-action);
            outline-offset: 2px;
        }
        
        /* ===== RECORDING BUTTON ===== */
        .record-button {
            background: var(--danger);
            color: white;
            min-height: 64px;
            min-width: 200px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 32px auto;
        }
        
        .record-button:hover:not(:disabled) {
            opacity: 0.9;
        }
        
        .record-button .record-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* ===== STIMULUS IMAGE ===== */
        .stimulus-container {
            margin: 40px auto;
            text-align: center;
            position: relative;
        }
        
        .stimulus-image {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            cursor: zoom-in;
            transition: transform 0.3s ease;
        }
        
        .stimulus-image.zoomed {
            cursor: zoom-out;
            transform: scale(1.5);
            z-index: 50;
            position: relative;
        }
        
        .zoom-hint {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stimulus-container:hover .zoom-hint {
            opacity: 1;
        }
        
        /* ===== STATUS MESSAGES ===== */
        .status-message {
            padding: 16px 24px;
            border-radius: 4px;
            margin: 24px 0;
            font-size: 16px;
            text-align: center;
        }
        
        .status-neutral {
            background: var(--surface);
            color: var(--primary-text);
            border: 1px solid var(--border-light);
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }
        
        /* ===== RECORDING INDICATOR ===== */
        .recording-status {
            position: fixed;
            top: 104px;
            right: 24px;
            background: var(--danger);
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .recording-status.hidden {
            display: none;
        }
        
        .recording-timer {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--danger);
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--danger);
            border-radius: 4px;
            display: inline-block;
            margin-left: 16px;
        }
        
        /* ===== VIDEO PREVIEW ===== */
        .video-preview-container {
            margin: 32px auto;
            max-width: 600px;
            position: relative;
        }
        
        .video-preview {
            width: 100%;
            height: auto;
            background: #000;
            border-radius: 4px;
            transition: opacity 0.3s ease;
        }
        
        .video-preview.hidden-preview {
            opacity: 0.05;
            pointer-events: none;
        }
        
        .preview-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            border: none;
        }
        
        /* ===== Q&A SECTIONS ===== */
        .question-block {
            background: var(--surface);
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 4px;
            border: 1px solid var(--border-light);
        }
        
        .question-block label {
            font-size: 18px;
            margin-bottom: 12px;
            color: var(--primary-text);
        }
        
        /* ===== HELP/TIPS ===== */
        .tips-container {
            background: #fffde7;
            border: 1px solid #f9a825;
            border-radius: 4px;
            padding: 16px 20px;
            margin: 24px 0;
            font-size: 15px;
            color: #6a4c00;
        }
        
        .tips-container ul {
            margin: 12px 0 0 20px;
            line-height: 1.8;
        }
        
        /* ===== MINIMAL FIELDSET ===== */
        fieldset {
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 24px;
            margin: 24px 0;
        }
        
        legend {
            font-weight: 500;
            font-size: 16px;
            padding: 0 12px;
            background: var(--background);
            color: var(--primary-text);
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .center {
            text-align: center;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== HELP LINK ===== */
        .help-link {
            position: fixed;
            bottom: 16px;
            right: 16px;
            color: var(--secondary-text);
            font-size: 14px;
            text-decoration: none;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .help-link:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        /* ===== ADMIN PANEL (Hidden by default) ===== */
        .admin-panel {
            display: none;
        }
        
        body.admin-mode .admin-panel {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            display: block;
        }
        
        /* ===== CONNECTION STATUS (hidden by default) ===== */
        .connection-status {
            display: none;
        }
        
        body.admin-mode .connection-status {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 12px;
            display: block;
        }
        
        /* ===== COMFORT OPTIONS DRAWER ===== */
        .comfort-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background);
            border-top: 1px solid var(--border-light);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 90;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .comfort-drawer.open {
            transform: translateY(0);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .comfort-drawer-toggle {
            position: fixed;
            bottom: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .comfort-drawer-toggle:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        .comfort-content {
            padding: 24px;
        }
        
        .comfort-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .comfort-option:last-child {
            border-bottom: none;
        }
        
        .comfort-option label {
            margin: 0;
            flex: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--border-medium);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-action);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        /* ===== TIMER (MINIMAL) ===== */
        .minimal-timer {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 14px;
            color: var(--secondary-text);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 4px;
            position: fixed;
            top: 104px;
            left: 24px;
            opacity: 0.7;
        }
        
        .minimal-timer.hidden {
            display: none;
        }
        
        /* ===== SHORTCUTS PANEL ===== */
        .shortcuts-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--background);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 32px;
            max-width: 400px;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .shortcuts-panel.visible {
            display: block;
        }
        
        .shortcuts-panel h3 {
            margin: 0 0 16px;
            font-size: 18px;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .shortcut-key {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: var(--surface);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--border-light);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 190;
        }
        
        .overlay.visible {
            display: block;
        }
        
        /* ===== ENHANCED FOCUS STATES ===== */
        *:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 2px;
        }
        
        button:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 4px;
        }
        
        /* ===== ICON LABELS ===== */
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .sr-only-mobile {
            display: inline;
        }
        
        @media (max-width: 768px) {
            .sr-only-mobile {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }
        }
        
        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 768px) {
            .action-bar {
                bottom: 0;
                top: auto;
                border-top: 1px solid var(--border-light);
                border-bottom: none;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            }
            
            .action-bar .primary-action,
            .action-bar .secondary-action {
                width: 100%;
                min-height: 56px;
            }
            
            .comfort-drawer-toggle {
                bottom: 80px;
            }
            
            .minimal-timer {
                top: 16px;
                left: 16px;
            }
            
            .recording-status {
                top: 16px;
                right: 16px;
            }
        }
        
        /* ===== NEUTRAL INSTRUCTIONS ===== */
        .item-instructions {
            font-size: 16px;
            color: var(--secondary-text);
            text-align: center;
            margin: 16px 0;
            padding: 0 24px;
        }
        
        /* ===== COMPLETION SCREEN ===== */
        .completion-message {
            text-align: center;
            padding: 48px 24px;
        }
        
        .completion-message h2 {
            font-size: 24px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .completion-message p {
            color: var(--secondary-text);
            margin-bottom: 24px;
        }
        
        .details-link {
            color: var(--primary-action);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .details-link:hover {
            background: var(--surface);
            border-color: var(--border-medium);
        }
        
        .details-panel {
            display: none;
            margin-top: 32px;
            padding: 24px;
            background: var(--surface);
            border-radius: 4px;
            text-align: left;
        }
        
        .details-panel.visible {
            display: block;
        }
        
        /* ===== HELP/TIPS ===== */
        .tips-container {
            background: #fffde7;
            border: 1px solid #f9a825;
            border-radius: 4px;
            padding: 16px 20px;
            margin: 24px 0;
            font-size: 15px;
            color: #6a4c00;
        }
        
        .tips-container ul {
            margin: 12px 0 0 20px;
            line-height: 1.8;
        }
        
        /* ===== MINIMAL FIELDSET ===== */
        fieldset {
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 24px;
            margin: 24px 0;
        }
        
        legend {
            font-weight: 500;
            font-size: 16px;
            padding: 0 12px;
            background: var(--background);
            color: var(--primary-text);
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .center {
            text-align: center;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== HELP LINK ===== */
        .help-link {
            position: fixed;
            bottom: 16px;
            right: 16px;
            color: var(--secondary-text);
            font-size: 14px;
            text-decoration: none;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .help-link:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        /* ===== ADMIN PANEL (Hidden by default) ===== */
        .admin-panel {
            display: none;
        }
        
        body.admin-mode .admin-panel {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            display: block;
        }
        
        /* ===== CONNECTION STATUS (hidden by default) ===== */
        .connection-status {
            display: none;
        }
        
        body.admin-mode .connection-status {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 12px;
            display: block;
        }
        
        /* ===== COMFORT OPTIONS DRAWER ===== */
        .comfort-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background);
            border-top: 1px solid var(--border-light);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 90;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .comfort-drawer.open {
            transform: translateY(0);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .comfort-drawer-toggle {
            position: fixed;
            bottom: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .comfort-drawer-toggle:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        .comfort-content {
            padding: 24px;
        }
        
        .comfort-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .comfort-option:last-child {
            border-bottom: none;
        }
        
        .comfort-option label {
            margin: 0;
            flex: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--border-medium);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-action);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        /* ===== TIMER (MINIMAL) ===== */
        .minimal-timer {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 14px;
            color: var(--secondary-text);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 4px;
            position: fixed;
            top: 104px;
            left: 24px;
            opacity: 0.7;
        }
        
        .minimal-timer.hidden {
            display: none;
        }
        
        /* ===== SHORTCUTS PANEL ===== */
        .shortcuts-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--background);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 32px;
            max-width: 400px;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .shortcuts-panel.visible {
            display: block;
        }
        
        .shortcuts-panel h3 {
            margin: 0 0 16px;
            font-size: 18px;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .shortcut-key {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: var(--surface);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--border-light);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 190;
        }
        
        .overlay.visible {
            display: block;
        }
        
        /* ===== ENHANCED FOCUS STATES ===== */
        *:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 2px;
        }
        
        button:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 4px;
        }
        
        /* ===== ICON LABELS ===== */
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .sr-only-mobile {
            display: inline;
        }
        
        @media (max-width: 768px) {
            .sr-only-mobile {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }
        }
        
        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 768px) {
            .action-bar {
                bottom: 0;
                top: auto;
                border-top: 1px solid var(--border-light);
                border-bottom: none;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            }
            
            .action-bar .primary-action,
            .action-bar .secondary-action {
                width: 100%;
                min-height: 56px;
            }
            
            .comfort-drawer-toggle {
                bottom: 80px;
            }
            
            .minimal-timer {
                top: 16px;
                left: 16px;
            }
            
            .recording-status {
                top: 16px;
                right: 16px;
            }
        }
        
        /* ===== NEUTRAL INSTRUCTIONS ===== */
        .item-instructions {
            font-size: 16px;
            color: var(--secondary-text);
            text-align: center;
            margin: 16px 0;
            padding: 0 24px;
        }
        
        /* ===== COMPLETION SCREEN ===== */
        .completion-message {
            text-align: center;
            padding: 48px 24px;
        }
        
        .completion-message h2 {
            font-size: 24px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .completion-message p {
            color: var(--secondary-text);
            margin-bottom: 24px;
        }
        
        .details-link {
            color: var(--primary-action);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .details-link:hover {
            background: var(--surface);
            border-color: var(--border-medium);
        }
        
        .details-panel {
            display: none;
            margin-top: 32px;
            padding: 24px;
            background: var(--surface);
            border-radius: 4px;
            text-align: left;
        }
        
        .details-panel.visible {
            display: block;
        }
        
        /* ===== HELP/TIPS ===== */
        .tips-container {
            background: #fffde7;
            border: 1px solid #f9a825;
            border-radius: 4px;
            padding: 16px 20px;
            margin: 24px 0;
            font-size: 15px;
            color: #6a4c00;
        }
        
        .tips-container ul {
            margin: 12px 0 0 20px;
            line-height: 1.8;
        }
        
        /* ===== MINIMAL FIELDSET ===== */
        fieldset {
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 24px;
            margin: 24px 0;
        }
        
        legend {
            font-weight: 500;
            font-size: 16px;
            padding: 0 12px;
            background: var(--background);
            color: var(--primary-text);
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .center {
            text-align: center;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== HELP LINK ===== */
        .help-link {
            position: fixed;
            bottom: 16px;
            right: 16px;
            color: var(--secondary-text);
            font-size: 14px;
            text-decoration: none;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .help-link:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        /* ===== ADMIN PANEL (Hidden by default) ===== */
        .admin-panel {
            display: none;
        }
        
        body.admin-mode .admin-panel {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            display: block;
        }
        
        /* ===== CONNECTION STATUS (hidden by default) ===== */
        .connection-status {
            display: none;
        }
        
        body.admin-mode .connection-status {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 12px;
            display: block;
        }
        
        /* ===== COMFORT OPTIONS DRAWER ===== */
        .comfort-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background);
            border-top: 1px solid var(--border-light);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 90;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .comfort-drawer.open {
            transform: translateY(0);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .comfort-drawer-toggle {
            position: fixed;
            bottom: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .comfort-drawer-toggle:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        .comfort-content {
            padding: 24px;
        }
        
        .comfort-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .comfort-option:last-child {
            border-bottom: none;
        }
        
        .comfort-option label {
            margin: 0;
            flex: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--border-medium);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-action);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        /* ===== TIMER (MINIMAL) ===== */
        .minimal-timer {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 14px;
            color: var(--secondary-text);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 4px;
            position: fixed;
            top: 104px;
            left: 24px;
            opacity: 0.7;
        }
        
        .minimal-timer.hidden {
            display: none;
        }
        
        /* ===== SHORTCUTS PANEL ===== */
        .shortcuts-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--background);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 32px;
            max-width: 400px;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .shortcuts-panel.visible {
            display: block;
        }
        
        .shortcuts-panel h3 {
            margin: 0 0 16px;
            font-size: 18px;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .shortcut-key {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: var(--surface);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--border-light);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 190;
        }
        
        .overlay.visible {
            display: block;
        }
        
        /* ===== ENHANCED FOCUS STATES ===== */
        *:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 2px;
        }
        
        button:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 4px;
        }
        
        /* ===== ICON LABELS ===== */
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .sr-only-mobile {
            display: inline;
        }
        
        @media (max-width: 768px) {
            .sr-only-mobile {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }
        }
        
        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 768px) {
            .action-bar {
                bottom: 0;
                top: auto;
                border-top: 1px solid var(--border-light);
                border-bottom: none;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            }
            
            .action-bar .primary-action,
            .action-bar .secondary-action {
                width: 100%;
                min-height: 56px;
            }
            
            .comfort-drawer-toggle {
                bottom: 80px;
            }
            
            .minimal-timer {
                top: 16px;
                left: 16px;
            }
            
            .recording-status {
                top: 16px;
                right: 16px;
            }
        }
        
        /* ===== NEUTRAL INSTRUCTIONS ===== */
        .item-instructions {
            font-size: 16px;
            color: var(--secondary-text);
            text-align: center;
            margin: 16px 0;
            padding: 0 24px;
        }
        
        /* ===== COMPLETION SCREEN ===== */
        .completion-message {
            text-align: center;
            padding: 48px 24px;
        }
        
        .completion-message h2 {
            font-size: 24px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .completion-message p {
            color: var(--secondary-text);
            margin-bottom: 24px;
        }
        
        .details-link {
            color: var(--primary-action);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .details-link:hover {
            background: var(--surface);
            border-color: var(--border-medium);
        }
        
        .details-panel {
            display: none;
            margin-top: 32px;
            padding: 24px;
            background: var(--surface);
            border-radius: 4px;
            text-align: left;
        }
        
        .details-panel.visible {
            display: block;
        }
        
        /* ===== HELP/TIPS ===== */
        .tips-container {
            background: #fffde7;
            border: 1px solid #f9a825;
            border-radius: 4px;
            padding: 16px 20px;
            margin: 24px 0;
            font-size: 15px;
            color: #6a4c00;
        }
        
        .tips-container ul {
            margin: 12px 0 0 20px;
            line-height: 1.8;
        }
        
        /* ===== MINIMAL FIELDSET ===== */
        fieldset {
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 24px;
            margin: 24px 0;
        }
        
        legend {
            font-weight: 500;
            font-size: 16px;
            padding: 0 12px;
            background: var(--background);
            color: var(--primary-text);
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .center {
            text-align: center;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== HELP LINK ===== */
        .help-link {
            position: fixed;
            bottom: 16px;
            right: 16px;
            color: var(--secondary-text);
            font-size: 14px;
            text-decoration: none;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .help-link:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        /* ===== ADMIN PANEL (Hidden by default) ===== */
        .admin-panel {
            display: none;
        }
        
        body.admin-mode .admin-panel {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            display: block;
        }
        
        /* ===== CONNECTION STATUS (hidden by default) ===== */
        .connection-status {
            display: none;
        }
        
        body.admin-mode .connection-status {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 12px;
            display: block;
        }
        
        /* ===== COMFORT OPTIONS DRAWER ===== */
        .comfort-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background);
            border-top: 1px solid var(--border-light);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 90;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .comfort-drawer.open {
            transform: translateY(0);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .comfort-drawer-toggle {
            position: fixed;
            bottom: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .comfort-drawer-toggle:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        .comfort-content {
            padding: 24px;
        }
        
        .comfort-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .comfort-option:last-child {
            border-bottom: none;
        }
        
        .comfort-option label {
            margin: 0;
            flex: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--border-medium);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-action);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        /* ===== TIMER (MINIMAL) ===== */
        .minimal-timer {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 14px;
            color: var(--secondary-text);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 4px;
            position: fixed;
            top: 104px;
            left: 24px;
            opacity: 0.7;
        }
        
        .minimal-timer.hidden {
            display: none;
        }
        
        /* ===== SHORTCUTS PANEL ===== */
        .shortcuts-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--background);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 32px;
            max-width: 400px;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .shortcuts-panel.visible {
            display: block;
        }
        
        .shortcuts-panel h3 {
            margin: 0 0 16px;
            font-size: 18px;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .shortcut-key {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: var(--surface);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--border-light);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 190;
        }
        
        .overlay.visible {
            display: block;
        }
        
        /* ===== ENHANCED FOCUS STATES ===== */
        *:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 2px;
        }
        
        button:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 4px;
        }
        
        /* ===== ICON LABELS ===== */
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .sr-only-mobile {
            display: inline;
        }
        
        @media (max-width: 768px) {
            .sr-only-mobile {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }
        }
        
        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 768px) {
            .action-bar {
                bottom: 0;
                top: auto;
                border-top: 1px solid var(--border-light);
                border-bottom: none;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            }
            
            .action-bar .primary-action,
            .action-bar .secondary-action {
                width: 100%;
                min-height: 56px;
            }
            
            .comfort-drawer-toggle {
                bottom: 80px;
            }
            
            .minimal-timer {
                top: 16px;
                left: 16px;
            }
            
            .recording-status {
                top: 16px;
                right: 16px;
            }
        }
        
        /* ===== NEUTRAL INSTRUCTIONS ===== */
        .item-instructions {
            font-size: 16px;
            color: var(--secondary-text);
            text-align: center;
            margin: 16px 0;
            padding: 0 24px;
        }
        
        /* ===== COMPLETION SCREEN ===== */
        .completion-message {
            text-align: center;
            padding: 48px 24px;
        }
        
        .completion-message h2 {
            font-size: 24px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .completion-message p {
            color: var(--secondary-text);
            margin-bottom: 24px;
        }
        
        .details-link {
            color: var(--primary-action);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .details-link:hover {
            background: var(--surface);
            border-color: var(--border-medium);
        }
        
        .details-panel {
            display: none;
            margin-top: 32px;
            padding: 24px;
            background: var(--surface);
            border-radius: 4px;
            text-align: left;
        }
        
        .details-panel.visible {
            display: block;
        }
        
        /* ===== HELP/TIPS ===== */
        .tips-container {
            background: #fffde7;
            border: 1px solid #f9a825;
            border-radius: 4px;
            padding: 16px 20px;
            margin: 24px 0;
            font-size: 15px;
            color: #6a4c00;
        }
        
        .tips-container ul {
            margin: 12px 0 0 20px;
            line-height: 1.8;
        }
        
        /* ===== MINIMAL FIELDSET ===== */
        fieldset {
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 24px;
            margin: 24px 0;
        }
        
        legend {
            font-weight: 500;
            font-size: 16px;
            padding: 0 12px;
            background: var(--background);
            color: var(--primary-text);
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .center {
            text-align: center;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== HELP LINK ===== */
        .help-link {
            position: fixed;
            bottom: 16px;
            right: 16px;
            color: var(--secondary-text);
            font-size: 14px;
            text-decoration: none;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .help-link:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        /* ===== ADMIN PANEL (Hidden by default) ===== */
        .admin-panel {
            display: none;
        }
        
        body.admin-mode .admin-panel {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            display: block;
        }
        
        /* ===== CONNECTION STATUS (hidden by default) ===== */
        .connection-status {
            display: none;
        }
        
        body.admin-mode .connection-status {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 12px;
            display: block;
        }
        
        /* ===== COMFORT OPTIONS DRAWER ===== */
        .comfort-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background);
            border-top: 1px solid var(--border-light);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 90;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .comfort-drawer.open {
            transform: translateY(0);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .comfort-drawer-toggle {
            position: fixed;
            bottom: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .comfort-drawer-toggle:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        .comfort-content {
            padding: 24px;
        }
        
        .comfort-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .comfort-option:last-child {
            border-bottom: none;
        }
        
        .comfort-option label {
            margin: 0;
            flex: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--border-medium);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-action);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        /* ===== TIMER (MINIMAL) ===== */
        .minimal-timer {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 14px;
            color: var(--secondary-text);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 4px;
            position: fixed;
            top: 104px;
            left: 24px;
            opacity: 0.7;
        }
        
        .minimal-timer.hidden {
            display: none;
        }
        
        /* ===== SHORTCUTS PANEL ===== */
        .shortcuts-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--background);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 32px;
            max-width: 400px;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .shortcuts-panel.visible {
            display: block;
        }
        
        .shortcuts-panel h3 {
            margin: 0 0 16px;
            font-size: 18px;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .shortcut-key {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: var(--surface);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--border-light);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 190;
        }
        
        .overlay.visible {
            display: block;
        }
        
        /* ===== ENHANCED FOCUS STATES ===== */
        *:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 2px;
        }
        
        button:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 4px;
        }
        
        /* ===== ICON LABELS ===== */
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .sr-only-mobile {
            display: inline;
        }
        
        @media (max-width: 768px) {
            .sr-only-mobile {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }
        }
        
        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 768px) {
            .action-bar {
                bottom: 0;
                top: auto;
                border-top: 1px solid var(--border-light);
                border-bottom: none;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            }
            
            .action-bar .primary-action,
            .action-bar .secondary-action {
                width: 100%;
                min-height: 56px;
            }
            
            .comfort-drawer-toggle {
                bottom: 80px;
            }
            
            .minimal-timer {
                top: 16px;
                left: 16px;
            }
            
            .recording-status {
                top: 16px;
                right: 16px;
            }
        }
        
        /* ===== NEUTRAL INSTRUCTIONS ===== */
        .item-instructions {
            font-size: 16px;
            color: var(--secondary-text);
            text-align: center;
            margin: 16px 0;
            padding: 0 24px;
        }
        
        /* ===== COMPLETION SCREEN ===== */
        .completion-message {
            text-align: center;
            padding: 48px 24px;
        }
        
        .completion-message h2 {
            font-size: 24px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .completion-message p {
            color: var(--secondary-text);
            margin-bottom: 24px;
        }
        
        .details-link {
            color: var(--primary-action);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .details-link:hover {
            background: var(--surface);
            border-color: var(--border-medium);
        }
        
        .details-panel {
            display: none;
            margin-top: 32px;
            padding: 24px;
            background: var(--surface);
            border-radius: 4px;
            text-align: left;
        }
        
        .details-panel.visible {
            display: block;
        }
        
        /* ===== HELP/TIPS ===== */
        .tips-container {
            background: #fffde7;
            border: 1px solid #f9a825;
            border-radius: 4px;
            padding: 16px 20px;
            margin: 24px 0;
            font-size: 15px;
            color: #6a4c00;
        }
        
        .tips-container ul {
            margin: 12px 0 0 20px;
            line-height: 1.8;
        }
        
        /* ===== MINIMAL FIELDSET ===== */
        fieldset {
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 24px;
            margin: 24px 0;
        }
        
        legend {
            font-weight: 500;
            font-size: 16px;
            padding: 0 12px;
            background: var(--background);
            color: var(--primary-text);
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .center {
            text-align: center;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== HELP LINK ===== */
        .help-link {
            position: fixed;
            bottom: 16px;
            right: 16px;
            color: var(--secondary-text);
            font-size: 14px;
            text-decoration: none;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .help-link:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        /* ===== ADMIN PANEL (Hidden by default) ===== */
        .admin-panel {
            display: none;
        }
        
        body.admin-mode .admin-panel {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            display: block;
        }
        
        /* ===== CONNECTION STATUS (hidden by default) ===== */
        .connection-status {
            display: none;
        }
        
        body.admin-mode .connection-status {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 12px;
            display: block;
        }
        
        /* ===== COMFORT OPTIONS DRAWER ===== */
        .comfort-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background);
            border-top: 1px solid var(--border-light);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 90;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .comfort-drawer.open {
            transform: translateY(0);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .comfort-drawer-toggle {
            position: fixed;
            bottom: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .comfort-drawer-toggle:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        .comfort-content {
            padding: 24px;
        }
        
        .comfort-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .comfort-option:last-child {
            border-bottom: none;
        }
        
        .comfort-option label {
            margin: 0;
            flex: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--border-medium);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-action);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        /* ===== TIMER (MINIMAL) ===== */
        .minimal-timer {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 14px;
            color: var(--secondary-text);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 4px;
            position: fixed;
            top: 104px;
            left: 24px;
            opacity: 0.7;
        }
        
        .minimal-timer.hidden {
            display: none;
        }
        
        /* ===== SHORTCUTS PANEL ===== */
        .shortcuts-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--background);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 32px;
            max-width: 400px;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .shortcuts-panel.visible {
            display: block;
        }
        
        .shortcuts-panel h3 {
            margin: 0 0 16px;
            font-size: 18px;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .shortcut-key {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: var(--surface);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--border-light);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 190;
        }
        
        .overlay.visible {
            display: block;
        }
        
        /* ===== ENHANCED FOCUS STATES ===== */
        *:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 2px;
        }
        
        button:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 4px;
        }
        
        /* ===== ICON LABELS ===== */
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .sr-only-mobile {
            display: inline;
        }
        
        @media (max-width: 768px) {
            .sr-only-mobile {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }
        }
        
        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 768px) {
            .action-bar {
                bottom: 0;
                top: auto;
                border-top: 1px solid var(--border-light);
                border-bottom: none;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            }
            
            .action-bar .primary-action,
            .action-bar .secondary-action {
                width: 100%;
                min-height: 56px;
            }
            
            .comfort-drawer-toggle {
                bottom: 80px;
            }
            
            .minimal-timer {
                top: 16px;
                left: 16px;
            }
            
            .recording-status {
                top: 16px;
                right: 16px;
            }
        }
        
        /* ===== NEUTRAL INSTRUCTIONS ===== */
        .item-instructions {
            font-size: 16px;
            color: var(--secondary-text);
            text-align: center;
            margin: 16px 0;
            padding: 0 24px;
        }
        
        /* ===== COMPLETION SCREEN ===== */
        .completion-message {
            text-align: center;
            padding: 48px 24px;
        }
        
        .completion-message h2 {
            font-size: 24px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .completion-message p {
            color: var(--secondary-text);
            margin-bottom: 24px;
        }
        
        .details-link {
            color: var(--primary-action);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .details-link:hover {
            background: var(--surface);
            border-color: var(--border-medium);
        }
        
        .details-panel {
            display: none;
            margin-top: 32px;
            padding: 24px;
            background: var(--surface);
            border-radius: 4px;
            text-align: left;
        }
        
        .details-panel.visible {
            display: block;
        }
        
        /* ===== HELP/TIPS ===== */
        .tips-container {
            background: #fffde7;
            border: 1px solid #f9a825;
            border-radius: 4px;
            padding: 16px 20px;
            margin: 24px 0;
            font-size: 15px;
            color: #6a4c00;
        }
        
        .tips-container ul {
            margin: 12px 0 0 20px;
            line-height: 1.8;
        }
        
        /* ===== MINIMAL FIELDSET ===== */
        fieldset {
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 24px;
            margin: 24px 0;
        }
        
        legend {
            font-weight: 500;
            font-size: 16px;
            padding: 0 12px;
            background: var(--background);
            color: var(--primary-text);
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .center {
            text-align: center;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== HELP LINK ===== */
        .help-link {
            position: fixed;
            bottom: 16px;
            right: 16px;
            color: var(--secondary-text);
            font-size: 14px;
            text-decoration: none;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .help-link:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        /* ===== ADMIN PANEL (Hidden by default) ===== */
        .admin-panel {
            display: none;
        }
        
        body.admin-mode .admin-panel {
            position: fixed;
            bottom: 16px;
            left: 16px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            display: block;
        }
        
        /* ===== CONNECTION STATUS (hidden by default) ===== */
        .connection-status {
            display: none;
        }
        
        body.admin-mode .connection-status {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 12px;
            display: block;
        }
        
        /* ===== COMFORT OPTIONS DRAWER ===== */
        .comfort-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--background);
            border-top: 1px solid var(--border-light);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 90;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .comfort-drawer.open {
            transform: translateY(0);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .comfort-drawer-toggle {
            position: fixed;
            bottom: 16px;
            left: 16px;
            padding: 8px 12px;
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .comfort-drawer-toggle:hover {
            background: var(--background);
            border-color: var(--border-medium);
        }
        
        .comfort-content {
            padding: 24px;
        }
        
        .comfort-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .comfort-option:last-child {
            border-bottom: none;
        }
        
        .comfort-option label {
            margin: 0;
            flex: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--border-medium);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-action);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        /* ===== TIMER (MINIMAL) ===== */
        .minimal-timer {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 14px;
            color: var(--secondary-text);
            background: var(--surface);
            padding: 4px 8px;
            border-radius: 4px;
            position: fixed;
            top: 104px;
            left: 24px;
            opacity: 0.7;
        }
        
        .minimal-timer.hidden {
            display: none;
        }
        
        /* ===== SHORTCUTS PANEL ===== */
        .shortcuts-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--background);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 32px;
            max-width: 400px;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .shortcuts-panel.visible {
            display: block;
        }
        
        .shortcuts-panel h3 {
            margin: 0 0 16px;
            font-size: 18px;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .shortcut-key {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: var(--surface);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--border-light);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 190;
        }
        
        .overlay.visible {
            display: block;
        }
        
        /* ===== ENHANCED FOCUS STATES ===== */
        *:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 2px;
        }
        
        button:focus-visible {
            outline: 3px solid var(--primary-action);
            outline-offset: 4px;
        }
        
        /* ===== ICON LABELS ===== */
        .icon-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .sr-only_mobile {
            display: none;
        }
        
        @media (max-width: 768px) {
            .sr-only_mobile {
                display: inline;
            }
        }
    </style>
</head>
<body>
<div class="wrap">
  <div id="sr-live" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

  <!-- Top Action Bar (hidden initially) -->
  <div id="action-bar" class="action-bar hidden" role="toolbar" aria-label="Assessment controls">
    <button id="action-primary" class="primary-action" tabindex="1">Continue</button>
    <button id="action-secondary" class="secondary-action hidden" tabindex="2">Skip</button>
  </div>
  
  <div class="main-content">
    <!-- Welcome Screen -->
    <div id="screen-welcome" class="card">
      <div class="content-column">
        <h1 class="page-title">Reading Comprehension Study</h1>
        <p class="muted center">Please enter your information to begin.</p>

        <div class="form-row">
          <div class="form-group">
            <label for="pid">Participant code</label>
            <input id="pid" type="text" placeholder="Enter initials" required
                   maxlength="20"
                   pattern="[A-Za-z0-9_-]{1,20}"
                   title="Use letters, numbers, underscores, and hyphens only (max 20)"
                   inputmode="latin"
                   autocomplete="off"
                   autocapitalize="off"
                   spellcheck="false" />
          </div>
          <div class="form-group">
            <label for="edu">Education level</label>
            <select id="edu" required>
              <option value="">Select...</option>
              <option value="9">Grade 9</option>
              <option value="10">Grade 10</option>
              <option value="11">Grade 11</option>
              <option value="12">Grade 12</option>
              <option value="13+">College or higher</option>
            </select>
          </div>
        </div>

        <fieldset>
          <legend>Participant group</legend>
          <div class="radio-group">
            <label>
              <input type="radio" name="participant-group" value="deaf-fluent" />
              <span>Deaf - Fluent ASL signer</span>
            </label>
            <label>
              <input type="radio" name="participant-group" value="hearing-fluent" />
              <span>Hearing - Fluent ASL signer</span>
            </label>
            <label>
              <input type="radio" name="participant-group" value="deaf-nonfluent" />
              <span>Deaf - Non-fluent ASL signer</span>
            </label>
            <label>
              <input type="radio" name="participant-group" value="hearing-nonfluent" />
              <span>Hearing - Non-fluent ASL signer</span>
            </label>
            <label>
              <input type="radio" name="participant-group" value="hearing-nonsigner" />
              <span>Hearing - Non-signer</span>
            </label>
          </div>
        </fieldset>

        <div id="modality-selection" class="hidden">
          <fieldset>
            <legend>Communication preference</legend>
            <p class="muted" style="margin: 0 0 16px;">How would you prefer to respond to spoken items?</p>
            <div id="deaf-note" class="status-message status-info hidden">
              <strong>Note:</strong> You may choose ASL (video) or spoken language (audio) based on your preference.
            </div>
            <div class="radio-group">
              <label>
                <input type="radio" name="read-modality" value="sign" />
                <span>Sign (ASL) - Video recording</span>
              </label>
              <label>
                <input type="radio" name="read-modality" value="speak" />
                <span>Speak - Audio recording</span>
              </label>
            </div>
          </fieldset>
        </div>

        <label class="checkbox-label" style="margin: 24px 0;">
          <input type="checkbox" id="consent" />
          <span>I consent to audio/video recording for this research study.</span>
        </label>

        <div class="center" style="margin-top: 32px;">
          <button id="begin" class="primary" disabled>Continue to setup</button>
        </div>
      </div>
    </div>

    <!-- Setup Screen -->
    <div id="screen-setup" class="card hidden">
      <div class="content-column">
        <h2 class="page-title">Setup</h2>

        <div id="recording-method-info" class="status-message status-neutral">
          <span id="recording-method-text">Preparing recording...</span>
        </div>

        <div id="video-setup" class="hidden">
          <p class="muted center">Camera setup for ASL responses</p>
          <div class="video-preview-container">
            <video id="preview" class="video-preview" autoplay muted playsinline></video>
            <button id="toggle-preview" class="preview-toggle">Hide preview</button>
          </div>
          <p id="video-status" class="muted center">Requesting camera access...</p>
        </div>

        <div id="audio-setup" class="hidden">
          <p class="muted center">Microphone setup for spoken responses</p>
          <div class="center" style="margin: 32px 0;">
            <button id="test-audio-record" class="secondary">Test microphone</button>
            <button id="stop-test-audio" class="hidden secondary">Stop test</button>
            <span class="recording-timer hidden" id="test-audio-timer">00:00</span>
          </div>
          <audio id="test-audio-playback" controls class="hidden" style="width: 100%; max-width: 400px; margin: 16px auto; display: block;"></audio>
          <p id="audio-status" class="muted center">Click "Test microphone" to verify your setup.</p>
        </div>

        <div id="setup-status" class="status-message status-neutral" style="margin-top: 32px;">
          <span id="setup-status-text">Initializing...</span>
        </div>

        <div class="center" style="margin-top: 32px;">
          <button id="start-study" class="primary" disabled>Begin assessment</button>
        </div>
      </div>
    </div>

    <!-- Item Screen -->
    <div id="screen-item" class="card hidden">
        <div class="recording-status hidden" id="rec-indicator" role="status" aria-live="polite">
            <span class="record-dot"></span>
            <span>Recording</span>
        </div>
        
        <div class="minimal-timer hidden" id="minimal-timer" role="timer" aria-live="off">00:00</div>
        
        <div class="section-label" id="item-label">Reading Task</div>
        
        <div class="wide-content">
            <div id="stim-container" class="stimulus-container">
                <img id="stim" class="stimulus-image" alt="Reading material" tabindex="3" />
                <div class="zoom-hint" aria-hidden="true">Click to zoom</div>
            </div>
        </div>
        
        <div class="content-column">
            <div class="item-instructions" id="item-instructions">
                <span id="instruction-text">Answer in your own words. You may skip.</span>
            </div>
            
            <!-- Q&A Form -->
            <form id="qa-form" class="hidden" role="form">
                <div id="qa-fields"></div>
            </form>
        </div>
    </div>

    <!-- Finish Screen -->
    <div id="screen-finish" class="card hidden">
        <div class="content-column">
            <div class="completion-message">
                <h2>Thank you</h2>
                <p id="save-status">Saving...</p>
                <a href="#" class="details-link" id="view-details" onclick="toggleDetails(event)">View details</a>
            </div>
            
            <div class="details-panel" id="details-panel">
                <div id="upload-status" class="status-message status-neutral">
                    <span id="upload-progress">Processing...</span>
                </div>
                <div class="center" style="margin-top: 24px;">
                    <button id="retry-upload" class="secondary hidden">Retry upload</button>
                    <button id="download-backup" class="secondary hidden">Download backup</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comfort Options Drawer -->
    <button class="comfort-drawer-toggle" onclick="toggleComfort()" aria-label="Comfort options">
        Options
    </button>
    
    <div class="comfort-drawer" id="comfort-drawer" role="region" aria-label="Comfort options">
        <div class="comfort-content">
            <h3 style="margin: 0 0 16px; font-size: 16px;">Comfort Options</h3>
            
            <div class="comfort-option">
                <label for="show-timer">Show timer</label>
                <div class="toggle-switch" id="show-timer" role="switch" aria-checked="false" onclick="toggleTimer()" tabindex="0"></div>
            </div>
            
            <div class="comfort-option" id="video-preview-option" style="display: none;">
                <label for="show-preview">Show camera preview</label>
                <div class="toggle-switch" id="show-preview" role="switch" aria-checked="false" onclick="toggleVideoPreview()" tabindex="0"></div>
            </div>
            
            <div class="comfort-option">
                <label>Keyboard shortcuts</label>
                <button class="secondary" style="padding: 4px 12px; font-size: 14px;" onclick="showShortcuts()">View</button>
            </div>
        </div>
    </div>
    
    <!-- Shortcuts Panel -->
    <div class="overlay" id="shortcuts-overlay" onclick="hideShortcuts()"></div>
    <div class="shortcuts-panel" id="shortcuts-panel" role="dialog" aria-label="Keyboard shortcuts">
        <h3>Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Submit answer</span>
            <span class="shortcut-key">Ctrl + Enter</span>
        </div>
        <div class="shortcut-item">
            <span>Skip question</span>
            <span class="shortcut-key">Alt + S</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle options</span>
            <span class="shortcut-key">Alt + O</span>
        </div>
        <button class="secondary" style="width: 100%; margin-top: 16px;" onclick="hideShortcuts()">Close</button>
    </div>
  </div>

  <!-- Help Link -->
  <a href="#" class="help-link" onclick="event.preventDefault(); alert('For technical assistance, please contact the research team.');">Help</a>

  <!-- Admin Panel (hidden by default) -->
  <div class="admin-panel">
    <div>Group: <span id="admin-group">-</span></div>
    <div>Item: <span id="admin-item">-</span></div>
    <div>Score: <span id="admin-score">0</span></div>
    <div>Zeros: <span id="admin-zeros">0</span></div>
    <div>Status: <span id="admin-status">Active</span></div>
  </div>

  <!-- Connection Status (hidden by default) -->
  <div class="connection-status" id="connection-status">
    <span id="connection-text">Not connected</span>
  </div>
</div>

<script>
/* ===========================
   CONFIGURATION
   =========================== */
// IMPORTANT: Replace this with your actual Google Apps Script Web App URL
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX6yfgjIVSzmL2nL73IxIWPCV4RPbxfjPTDOxB-_Ax6siB2vmKJXnCpwLP4-PUA4MCpQ/exec';

// Add: Secondary backup endpoint (serverless function you control)
// Example: https://your-worker.example.com/wiat-backup
const GITHUB_BACKUP_URL = 'https://readingcomp-f3ii59o6j-melodys-projects-8b5cbe18.vercel.app/'; // Vercel backup endpoint
const GOOGLE_TIMEOUT_MS = 3500; // consider as "slow"
const BACKUP_TIMEOUT_MS = 3500;

// Add: GitHub repo/path hints for your backup endpoint (non-sensitive, safe in client)
const BACKUP_REPO_OWNER = 'melodyfschwenk';
const BACKUP_REPO_NAME = 'readingcomp';
const BACKUP_DIR_HINT = 'data/sessions';

// Tunable discontinue threshold
const DISCONTINUE_AFTER_ZEROS = 6;

// Add: stable session id to help dedupe on the server side
const SESSION_ID = (() => {
  try { return crypto.randomUUID(); }
  catch { return 'sid_' + Date.now() + '_' + Math.random().toString(36).slice(2); }
})();

/* ===========================
   Debug helper (conditional console logging)
   =========================== */
function debugLog(message, data = null) {
  if (window.location.hostname === 'localhost' || window.location.search.includes('debug=1')) {
    if (data !== null) console.log(message, data);
    else console.log(message);
  }
}

/* ===========================
   State Management
   =========================== */
let state = {
  // Session info
  pid: '',
  edu: '',
  participantGroup: '', // deaf-fluent, hearing-fluent, deaf-nonfluent, hearing-nonfluent, hearing-nonsigner
  readModality: '', // sign or speak (for all participants who can choose)
  sessionStartTime: null,
  
  // Progress tracking
  currentIndex: 0,
  totalPoints: 0,
  consecutiveZeros: 0,
  gateItemsFailed: [],

  // Results storage
  results: [],
  sequence: [],
  
  // Timers
  timers: {
    reading: null,
    recording: null,
    test: null,
    // New: fast connectivity heartbeat timer
    heartbeat: null
  },
  readingStartTime: null,
  itemStartTime: null,
  
  // Recording
  useVideoRecording: false,
  useAudioRecording: false,
  mediaRecorder: null,
  recordedChunks: [],
  stream: null,
  recordMime: '', // FIXED: Add missing property
  adminMode: false,
  uploadAttempts: 0,
  savedData: null,
  connectionStatus: false,

  reviewQueue: [],
  scoringMetrics: {
    highConfidence: 0,
    mediumConfidence: 0,
    lowConfidence: 0,
    manualReviewNeeded: 0
  }
};

// Test recording timer variables (global scope to prevent memory leaks)
let testTimerSeconds = 0;  // FIXED: Changed from testTimerSeconds to match usage

/* ===========================
   WIAT-2 Scoring Reference
   =========================== */

const SCORING_REFERENCE = {
  /* =======================
     Turtle Brothers (75–80)
     ======================= */
  q75: {
    twoPoint: {
      patterns: [/great\s+spirit/i, /\bgod\b/i, /deity/i, /creator/i, /divine\s+being/i, /supreme\s+being/i]
    },
    onePoint: {
      patterns: [/spirit\b/i, /supernatural/i]
    },
    notes: "Must indicate a divine/supreme being for 2 points."
  },
  q76: {
    twoPoint: { patterns: [/\b7\b/, /\bseven\b/i] },
    notes: "Must be exactly 7."
  },
  q77: {
    twoPoint: { patterns: [/soil.*turtle/i, /turtle.*soil/i, /earth.*turtle/i] },
    onePoint: { patterns: [/earth/i, /brush/i, /bush/i] }
  },
  q78: {
    twoPoint: { patterns: [/earthquake/i] },
    onePoint: { patterns: [/land.*quake/i, /ground.*quiver/i] }
  },
  q79: {
    twoPoint: { patterns: [/california.*back/i, /california.*made/i] },
    onePoint: { patterns: [/part.*land/i] }
  },
  q80: {
    twoPoint: { patterns: [/think\s+about/i, /form.*plan/i, /ponder/i] },
    onePoint: { patterns: [/think\s+hard/i, /\bthink\b/i] }
  },

  /* =======================
     Avalanche (82–83)
     ======================= */
  q82: {
    twoPoint: { patterns: [/road.*covered.*debris/i, /traffic.*stop/i] },
    onePoint: { patterns: [/snow.*covered.*road/i, /avalanche.*covered/i] }
  },
  q83: {
    twoPoint: { patterns: [/tree.*branch/i, /\bdirt\b/i, /\brock/i, /\bmud\b/i, /junk/i] },
    onePoint: { patterns: [/\bsnow\b/i, /rubbish/i] }
  },

  /* =======================
     Fancy (85)
     ======================= */
  q85: {
    twoPoint: { patterns: [/like.*better/i, /prefer/i, /\blike\b/i] },
    onePoint: { patterns: [/adore/i, /enjoy/i] }
  },

  /* =======================
     Track Meet (87–88)
     ======================= */
  q87: {
    twoPoint: { patterns: [/bad.*weather.*cancel/i, /weather.*long.*distance/i] },
    onePoint: { patterns: [/bad.*weather/i, /cancel/i] }
  },
  q88: {
    twoPoint: {
      patterns: [
        /\binclement\b/i,                           // echoes the key word
        /(bad|severe|stormy|harsh|rough|foul|nasty)\s+(weather|storm|conditions)/i,
        /(unpleasant|poor)\s+weather/i
      ]
    },
    notes: "Full = clearly 'bad/severe/stormy weather'. Partial = mentions weather conditions without stating severity."
  },

  /* =======================
     Yukon Gold (89–93)
     ======================= */
  q89: {
    onePoint: {
      patterns: [
        /(cold|freez|blizzard|snowstorm)/i,
        /(bear|wolf|wolves|animal attack|wildlife)/i,
        /(starv|hunger|food shortage|lack of food)/i,
        /(rapid|river|ice.*break|thin ice|avalanche|landslide)/i,
        /(sick|illness|injur|exhaustion|fatigue)/i
      ]
    },
    notes: "Give 2 if two clear journey dangers are named; 1 for one credible danger. Often needs review."
  },
  q90: {
    twoPoint: {
      patterns: [
        /(does\s*not|doesn't|didn't)\s+want.*(go|yukon).*(cold|freez|danger|hard|difficult|long trip)/i,
        /(reluctant|unwilling|afraid|fear).*go.*(cold|freez|danger|hard|difficult)/i
      ]
    },
    onePoint: { patterns: [/(does\s*not|doesn't|didn't)\s+want.*go/i, /(afraid|fear|scared)/i, /(cold|freez)/i] },
    notes: "Full credit if his reason is the cold/dangers/hardship noted by Diana."
  },
  q91: {
    onePoint: {
      patterns: [
        /(surviv|persever|endure|overcome)/i,
        /(family|together|teamwork|loyalty)/i,
        /(courage|brave|risk|adventure)/i
      ]
    },
    notes: "Give 2 for two accurate themes tied to the text; 1 for one plausible theme (review recommended)."
  },
  q92: {
    twoPoint: { patterns: [/(predictabl|hackneyed|clich[eé]|unoriginal|stale|trite)/i, /(same old|formula(ic)?)/i] },
    onePoint: { patterns: [/(plot|story).*weak|bad/i, /(boring|dull)/i] },
    notes: "Gary disliked that it was unoriginal/predictable."
  },
  q93: {
    twoPoint: { patterns: [/(overused|trite|clich[eé]|worn[- ]?out|stale|banal|unoriginal)/i] },
    onePoint: { patterns: [/(commonplace|old|familiar)/i] },
    notes: "Meaning of 'hackneyed'."
  },

  /* =======================
     Words of Wisdom (94–98)
     ======================= */
  q94: {
    twoPoint: { patterns: [/(written|document|recorded|chronicle|account)s?\b/i] },
    onePoint: { patterns: [/(history|facts|notes|information)/i] },
    notes: "'Records' = written accounts/documents."
  },
  q95: {
    twoPoint: {
      patterns: [
        /(collected|compiled|gathered|borrowed|took)\s+(from\s+)?(others|folk|people|sayings|maxims|aphorisms)/i,
        /(traditional|folk)\s+(proverb|saying)s?/i
      ]
    },
    onePoint: { patterns: [/(books|almanacs?|newspapers|sources)/i] },
    notes: "He collected existing proverbs."
  },
  q96: {
    twoPoint: { patterns: [/(rush|haste|hurry).*(mistake|waste|redo|do it again|sloppy|error)/i] },
    onePoint: { patterns: [/(don'?t|do not)\s+rush/i, /(take your time|be careful)/i] }
  },
  q97: {
    twoPoint: {
      patterns: [
        /(short|brief|simple|concise).*(sayings|proverbs)/i,
        /(easy\s+to\s+remember|memorable)/i,
        /(wisdom|truth|advice|lesson)/i
      ]
    },
    onePoint: { patterns: [/(people|most).*(like|enjoy).*(proverb|saying)/i] }
  },
  q98: {
    notes: "Selects the proverb that comments on modern technology. Mark for manual review (no scoring patterns here)."
  },

  /* =======================
     Mammals vs Saurian (100) & Dust Bowl (102)
     ======================= */
  q100: {
    twoPoint: { patterns: [/(mammal).*(warm[- ]?blood)/i, /(saurian|reptile).*(cold[- ]?blood)/i] },
    onePoint: { patterns: [/(warm[- ]?blood|cold[- ]?blood)/i, /(mammal|saurian|reptile)/i] }
  },
  q102: {
    twoPoint: { patterns: [/(long|several|many)\s+(years|period).*(no|little)\s+rain/i, /\bdrought\b/i] },
    onePoint: { patterns: [/(dust\s*storm|sand\s*storm)s?/i] }
  },

  /* =======================
     Kristi Yamaguchi (103–107)
     ======================= */
  q103: {
    twoPoint: { patterns: [/(health|medical|therapy|exercise)/i, /(turned[- ]in\s+(hips|feet)|foot\s+problem|hip\s+problem)/i] },
    onePoint: { patterns: [/(to\s+exercise|for\s+her\s+health)/i] }
  },
  q104: {
    semantic: {
      full: [
        ["daily routine", "everyday routine", "habit", "regular schedule", "usual activities", "day-to-day"],
        ["skating routine", "performance routine", "program", "choreograph", "set sequence", "planned moves"]
      ],
      partial: ["daily", "habit", "schedule", "program", "performance", "choreographed"]
    },
    notes: "First = everyday schedule; next = choreographed program/performance."
  },
  q105: {
    twoPoint: {
      patterns: [
        /(did|skated?)\s+both\s+(pairs|pair)\s+and\s+(singles|single)/i,
        /(pairs|pair)\s+and\s+(singles|single)\s+at\s+the\s+same\s+time/i
      ]
    },
    onePoint: { patterns: [/(too\s+much\s+work|many\s+events|double\s+workload)/i] }
  },
  q106: {
    twoPoint: { patterns: [/(kristi|yamaguchi).*(rudy|galindo)/i] },
    notes: "Kristi Yamaguchi & Rudy Galindo."
  },
  q107: {
    twoPoint: { patterns: [/(choreograph(y|ic)|artistry|presentation|style|grace|expression)/i] },
    onePoint: { patterns: [/(not\s+just\s+jumps|technique|balance|control)/i] },
    notes: "She compensated with choreography/artistry."
  },

  /* =======================
     Humpback Whales (108–112)
     ======================= */
  q108: {
    twoPoint: { patterns: [/(death|dying|end|extinction|downfall|ruin)/i] },
    onePoint: { patterns: [/(decline|fall|reduce|less)/i] }
  },
  q109: {
    semantic: {
      full: [
        ["hunt", "hunted", "whale", "whaling", "killed"],
        ["net", "fishing net", "entangle", "caught", "bycatch", "pollution", "ship strike"]
      ],
      partial: ["hunted", "whaling", "nets", "entangled", "pollution", "bycatch", "ships"]
    },
    notes: "Two ways: (1) hunting/whaling; (2) nets/entanglement (pollution/ship strikes may count if text supports)."
  },
  q110: {
    twoPoint: { patterns: [/(we)\s+can\s+(protect|save|help|conserve)/i, /(awareness|understand).*(protect|conserve|laws|action)/i] },
    onePoint: { patterns: [/(important|know|learn)/i] }
  },
  q111: {
    semantic: {
      full: [
        ["drown", "suffocate", "asphyxiate"],
        ["starve", "starvation"]
      ],
      partial: ["drown", "suffocate", "starve"]
    },
    notes: "Two things: drown and starve."
  },
  q112: {
    twoPoint: { patterns: [/(become|go)\s+extinct/i, /(die\s+out)/i] },
    onePoint: { patterns: [/(decline|decrease|fall)\s+in\s+numbers/i, /(endangered|at\s+risk)/i] }
  },

  /* =======================
     Peach Prices (114)
     ======================= */
  q114: {
    twoPoint: {
      patterns: [
        /(in\s+season|harvest|summer|supply.*high).*price(s)?\s+(low|lower|drop)/i,
        /(off[- ]season|winter|supply.*low).*price(s)?\s+(rise|higher|increase)/i
      ]
    },
    onePoint: { patterns: [/(supply).*affect(s|ed)?.*price/i, /(season|harvest)/i] },
    notes: "Seasonal supply explains price changes."
  },

  /* =======================
     Zoo Admission (115–119)
     ======================= */
  q115: {
    twoPoint: { patterns: [/\$?\s*3(\.00)?\b/i, /\bthree\s*dollars?\b/i] },
    onePoint: { patterns: [/(less|cheaper|lower)/i] }
  },
  q116: {
    twoPoint: {
      patterns: [
        /(main|primary)\s+reason.*(support|position)/i,
        /(because|since|as)\s+(costs|expenses|budget|funds|money).*(need|require)/i
      ]
    },
    onePoint: { patterns: [/(money|costs|budget)/i] },
    notes: "Tom's main reason: costs/finances; raising price covers expenses."
  },
  q117: {
    twoPoint: {
      patterns: [
        /(take\s+up\s+the\s+slack)\s*=\s*(compensate|cover|make\s+up|fill\s+in|carry\s+the\s+load)/i,
        /(compensate|cover|make\s+up).*(for\s+others|shortfall|lack)/i
      ]
    },
    onePoint: { patterns: [/(help\s+out|do\s+more|pick\s+up\s+the\s+slack)/i] }
  },
  q118: {
    twoPoint: {
      patterns: [
        /(acquisition|acquisitions)\s*=\s*(purchases|things\s+the\s+zoo\s+buys|new\s+animals|items\s+obtained)/i,
        /(purchase|buy|obtain)\s+(animals|exhibits|items)/i
      ]
    },
    onePoint: { patterns: [/(new\s+animals|new\s+exhibits|purchases)/i] }
  },
  q119: {
    onePoint: {
      patterns: [
        /(fewer|no)\s+(acquisitions|new\s+animals|new\s+exhibits)/i,
        /(reduce(d)?|cut)\s+(hours|services|staff|care|maintenance)/i,
        /(close|closure)/i,
        /(lack\s+of\s+funds|budget\s+shortfall)/i
      ]
    },
    notes: "Give 2 if three stated consequences are listed; 1 for one–two. Often needs review."
  },

  /* =======================
     The King (121–122)
     ======================= */
  q121: {
    twoPoint: { patterns: [/(the\s+)?king\s+(has\s+)?(died|is\s+dead|passed\s+away|was\s+assassinated)/i] },
    onePoint: { patterns: [/(the\s+)?king\s+(is\s+gone|no\s+longer|not\s+alive)/i] }
  },
  q122: {
    twoPoint: { patterns: [/(new\s+king|succession|heir|prince\s+becomes\s+king)/i, /(funeral|mourning|power\s+struggle|war|chaos)/i] },
    onePoint: { patterns: [/(someone\s+else\s+will\s+rule|change\s+of\s+power)/i] }
  },

  /* =======================
     Central Asiatic Expedition (123–127)
     ======================= */
  q123: {
    twoPoint: { patterns: [/(first|initial)\s+discovery.*(skull|skulls)/i, /(flaming\s+cliffs|bayanzag|gobi)/i] },
    onePoint: { patterns: [/(dinosaur|fossil)/i] }
  },
  q124: {
    onePoint: { patterns: [/(adventure|expedition|voyage|journey|exploration)/i] },
    notes: "Give 2 if three specific pre-Gobi adventures are correctly named; 1 for one–two (manual review)."
  },
  q125: {
    twoPoint: { patterns: [/(gobi\s+desert|mongolia|flaming\s+cliffs)/i, /(nest|nests|eggs)/i] },
    onePoint: { patterns: [/(desert|sand|cliffs)/i] }
  },
  q126: {
    twoPoint: { patterns: [/(proved|showed|demonstrated)\s+that\s+dinosaurs?\s+(laid|lay)\s+eggs/i, /(first|new)\s+dinosaur\s+eggs?\s+discovered/i] },
    onePoint: { patterns: [/(changed|altered)\s+scientific\s+knowledge/i] }
  },
  q127: {
    twoPoint: { patterns: [/(brigands?)\s*=\s*(bandits?|robbers?|thieves?)/i] },
    onePoint: { patterns: [/(outlaws?|criminals?)/i] }
  },

  /* =======================
     Longevity (129–130)
     ======================= */
  q129: {
    twoPoint: { patterns: [/(longevity)\s*=\s*(length\s+of\s+life|life\s*span|how\s+long\s+people\s+live)/i] },
    onePoint: { patterns: [/(old|older|age)/i] }
  },
  q130: {
    twoPoint: { patterns: [/(life\s+expectancy|longevity)\s+(has\s+)?(risen|increased|gone\s+up|grown)\b/i, /(trend|graph|chart).*(upward|increase|rise)/i] },
    onePoint: { patterns: [/(people\s+live\s+longer)/i] }
  },

  /* =======================
     Life Stages (131–135)
     ======================= */
  q131: {
    twoPoint: { patterns: [/(young|early)\s+adult(hood)?/i, /(begin|start)\s+a\s+career/i] },
    onePoint: { patterns: [/\badult\b/i] }
  },
  q132: {
    twoPoint: { patterns: [/(reassess|re[- ]?evaluate|reconsider|question).*(goals|career|life|relationships?)/i, /(change|adjust|redirect).*(life|career|path|relationships?)/i] },
    onePoint: { patterns: [/(mid[- ]?life).*(change|question|reassess)/i] }
  },
  q133: {
    twoPoint: { patterns: [/(mid[- ]?life\s+rebirth)/i] },
    onePoint: { patterns: [/(mid[- ]?life|reassessment)/i] }
  },
  q134: {
    twoPoint: { patterns: [/(lack|missing|fail(ed)?\s+to\s+develop).*(independence|self[- ]?reliance)/i, /(remain|stay)\s+(dependent|immature|tied)/i] },
    onePoint: { patterns: [/(problems|issues)\s+with\s+(independence|identity)/i] }
  },
  q135: {
    twoPoint: { patterns: [/(mentor|guide|teach|advise|give\s+back)/i, /(reflect|wisdom|insight|legacy|purpose|meaning)/i] },
    onePoint: { patterns: [/(help\s+others|share\s+experience|reflection)/i] }
  },

  /* =======================
     The Rock (136–140)
     ======================= */
  q136: {
    twoPoint: { patterns: [/(fissure)\s*=\s*(narrow|thin)\s+(crack|split|opening)\s+in\s+rock/i] },
    onePoint: { patterns: [/(crack|split|opening)/i] }
  },
  q137: {
    twoPoint: { patterns: [/(sheer|vertical)\s+(wall|face|escarpment)/i, /(sudden(ly)?)\s+(steep|drop|cliff)/i] },
    onePoint: { patterns: [/(harder|difficult|steeper)/i] }
  },
  q138: {
    twoPoint: { patterns: [/(fatigue|exhaustion|very\s+tired)/i] },
    onePoint: { patterns: [/(fear|scared|mental|mindset|discouraged)/i] }
  },
  q139: {
    twoPoint: { patterns: [/(determination|willpower|resolve|too\s+far\s+to\s+quit|couldn'?t\s+turn\s+back)/i] },
    onePoint: { patterns: [/(close\s+to\s+the\s+top|almost\s+there|came\s+so\s+far)/i] }
  },
  q140: {
    twoPoint: { patterns: [/(focus(ed)?\s+on\s+herself|needed\s+to\s+concentrate|had\s+to\s+get\s+herself\s+to\s+the\s+top)/i] },
    onePoint: { patterns: [/(afraid|fear|if\s+she\s+looked\s+down|discouraged|didn'?t\s+want\s+to\s+look\s+back)/i] }
  }
};

/* ===========================
   TRIALS Configuration - COMPLETE
   =========================== */
const TRIALS = [
  // Turtle Brothers passage
  {
    item: 75,
    image: "1.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q75",
      text: "Who is Kwawar?",
      scoringKey: "q75"
    }]
  },
  {
    item: 76,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q76",
      text: "In all, how many Turtle Brothers were needed to fulfill Kwawar's request?",
      scoringKey: "q76"
    }]
  },
  {
    item: 77,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q77",
      text: "What caused the mountains to arise?",
      scoringKey: "q77"
    }]
  },
  {
    item: 78,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q78",
      text: "What natural event does the Turtle Brothers' quarreling explain?",
      scoringKey: "q78"
    }]
  },
  {
    item: 79,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q79",
      text: "What great gift did Kwawar give the Turtle Brothers?",
      scoringKey: "q79"
    }]
  },
  {
    item: 80,
    image: "1.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q80",
      text: "What is the meaning of contemplated in the story?",
      scoringKey: "q80"
    }]
  },
  
  // Avalanche passage (read aloud)
  {
    item: 81,
    image: "2.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 82,
    image: "2.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q82",
      text: "Tell me in your own words, what has happened as a result of the avalanche?",
      scoringKey: "q82"
    }]
  },
  {
    item: 83,
    image: "2.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q83",
      text: "What does the word debris mean in this sentence?",
      scoringKey: "q83"
    }]
  },
  
  // Fancy passage (read aloud)
  {
    item: 84,
    image: "3.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 85,
    image: "3.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q85",
      text: "What does the word fancy mean in this sentence?",
      scoringKey: "q85"
    }]
  },
  
  // Track meet passage (read aloud)
  {
    item: 86,
    image: "4.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 87,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q87",
      text: "Why did the track meet end earlier than expected?",
      scoringKey: "q87"
    }]
  },
  {
    item: 88,
    image: "4.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q88",
      text: "What does the word inclement mean in this sentence?",
      scoringKey: "q88"
    }]
  },
  
  // Yukon Gold passage
  {
    item: 89,
    image: "5.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q89",
      text: "What were two dangers encountered by the family on their journey?",
      scoringKey: "q89"
    }]
  },
  {
    item: 90,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q90",
      text: "According to Diana, why doesn't Charlie want to go to Yukon?",
      scoringKey: "q90"
    }]
  },
  {
    item: 91,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q91",
      text: "According to the reviewers, what are two main themes or ideas in Yukon Gold?",
      scoringKey: "q91"
    }]
  },
  {
    item: 92,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q92",
      text: "Diana gave Yukon Gold four stars although Gary gave it two. What did Gary dislike about the movie?",
      scoringKey: "q92"
    }]
  },
  {
    item: 93,
    image: "5.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q93",
      text: "What is the meaning of the word hackneyed in Gary's review?",
      scoringKey: "q93"
    }]
  },
  
  // Words of Wisdom (Grades 9-12 Start)
  {
    item: 94,
    image: "6.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q94",
      text: "What is the meaning of the word records in the first paragraph?",
      scoringKey: "q94"
    }]
  },
  {
    item: 95,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q95",
      text: "Where do you think Ben Franklin found the proverbs he included in the Poor Richard's Almanack?",
      scoringKey: "q95"
    }]
  },
  {
    item: 96,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q96",
      text: "What do you think 'Haste makes waste' might mean?",
      scoringKey: "q96"
    }]
  },
  {
    item: 97,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q97",
      text: "Why do you think most people like proverbs?",
      scoringKey: "q97"
    }]
  },
  {
    item: 98,
    image: "6.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q98",
      text: "Which of the proverbs mentioned in the passage is a comment on modern technology?",
      scoringKey: "q98"
    }]
  },
  
  // Mammals vs Saurian (read aloud)
  {
    item: 99,
    image: "7.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 100,
    image: "7.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q100",
      text: "How are mammals and saurian different?",
      scoringKey: "q100"
    }]
  },
  
  // Dust Bowl (read aloud)
  {
    item: 101,
    image: "8.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 102,
    image: "8.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q102",
      text: "What does the sentence tell you that the great Dust Bowl was?",
      scoringKey: "q102"
    }]
  },
  
  // Kristi Yamaguchi passage
  {
    item: 103,
    image: "9.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q103",
      text: "For what primary reason did Kristi's mother want her daughter to skate?",
      scoringKey: "q103"
    }]
  },
  {
    item: 104,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q104",
      text: "How does the definition of routine in the first paragraph differ from that in the next paragraph?",
      scoringKey: "q104"
    }]
  },
  {
    item: 105,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q105",
      text: "Why was Kristi's workload double that of other skaters?",
      scoringKey: "q105"
    }]
  },
  {
    item: 106,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q106",
      text: "Who won the pairs gold medal at the 1990 Nationals?",
      scoringKey: "q106"
    }]
  },
  {
    item: 107,
    image: "9.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q107",
      text: "How was Kristi able to compensate for her athletic limitations?",
      scoringKey: "q107"
    }]
  },
  
  // Humpback whales passage
  {
    item: 108,
    image: "10.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q108",
      text: "What is the meaning of the word demise in this story?",
      scoringKey: "q108"
    }]
  },
  {
    item: 109,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q109",
      text: "In what two ways have people been the primary reason for the whales' demise?",
      scoringKey: "q109"
    }]
  },
  {
    item: 110,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q110",
      text: "Why is it important for us to know about the struggles of the humpback whales?",
      scoringKey: "q110"
    }]
  },
  {
    item: 111,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q111",
      text: "What two things might happen if a whale is caught in a fishing net?",
      scoringKey: "q111"
    }]
  },
  {
    item: 112,
    image: "10.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q112",
      text: "According to current studies, what is likely to happen to the humpback whale in the future?",
      scoringKey: "q112"
    }]
  },
  
  // Peach prices (read aloud)
  {
    item: 113,
    image: "11.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 114,
    image: "11.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q114",
      text: "What is the most likely reason for the changes in the peach prices during the year?",
      scoringKey: "q114"
    }]
  },
  
  // Zoo admission passage
  {
    item: 115,
    image: "12.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q115",
      text: "If today's zoo admission is $4.00, what was zoo admission in January 1993?",
      scoringKey: "q115"
    }]
  },
  {
    item: 116,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q116",
      text: "What is the main reason Tom gives to support his position?",
      scoringKey: "q116"
    }]
  },
  {
    item: 117,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q117",
      text: "When he says 'take up the slack' in his sentence, what does Tom mean?",
      scoringKey: "q117"
    }]
  },
  {
    item: 118,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q118",
      text: "Tanisha uses the word 'acquisitions' in her letter. What does it mean?",
      scoringKey: "q118"
    }]
  },
  {
    item: 119,
    image: "12.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q119",
      text: "According to Tanisha, what three things might happen if zoo prices are not raised?",
      scoringKey: "q119"
    }]
  },
  
  // King passage (read aloud)
  {
    item: 120,
    image: "13.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 121,
    image: "13.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q121",
      text: "What has happened to the king?",
      scoringKey: "q121"
    }]
  },
  {
    item: 122,
    image: "13.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q122",
      text: "What would you predict might happen as a result of the event described?",
      scoringKey: "q122"
    }]
  },
  
  // Central Asiatic Expedition passage
  {
    item: 123,
    image: "14.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q123",
      text: "What was the first discovery of the Central Asiatic Expedition?",
      scoringKey: "q123"
    }]
  },
  {
    item: 124,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q124",
      text: "Tell three adventures Andrew's had experienced before going to the Gobi desert.",
      scoringKey: "q124"
    }]
  },
  {
    item: 125,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q125",
      text: "Where did the scientists discover the dinosaur eggs?",
      scoringKey: "q125"
    }]
  },
  {
    item: 126,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q126",
      text: "How did Andrew's expedition alter scientific knowledge?",
      scoringKey: "q126"
    }]
  },
  {
    item: 127,
    image: "14.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q127",
      text: "What is the meaning of the word brigands as used in the passage?",
      scoringKey: "q127"
    }]
  },
  
  // Longevity (read aloud)
  {
    item: 128,
    image: "15.jpeg",
    type: "read-aloud",
    readAloud: true,
    instruction: "Read this aloud.",
    skipScoring: true
  },
  {
    item: 129,
    image: "15.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q129",
      text: "What is the meaning of the word longevity in this sentence?",
      scoringKey: "q129"
    }]
  },
  {
    item: 130,
    image: "15.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q130",
      text: "Describe the trend reported in this sentence",
      scoringKey: "q130"
    }]
  },
  
  // Life stages passage
  {
    item: 131,
    image: "16.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q131",
      text: "At what life stage is a person likely to begin a career?",
      scoringKey: "q131"
    }]
  },
  {
    item: 132,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q132",
      text: "What is the main theme of the 'Mid-life Rebirth' developmental tasks?",
      scoringKey: "q132"
    }]
  },
  {
    item: 133,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q133",
      text: "Although Rachel was recently promoted to manager of her office, she is questioning her choice of careers and regrets that she never pursued her dream of composing music. At the same time, she is reluctant to quit her job because she recently bought a new home. What developmental stage is Rachel probably in?",
      scoringKey: "q133"
    }]
  },
  {
    item: 134,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q134",
      text: "What might happen if a person did not accomplish the developmental tasks of the 'Breaking Loose' stage?",
      scoringKey: "q134"
    }]
  },
  {
    item: 135,
    image: "16.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q135",
      text: "If the last life stage called 'Deepening Wisdom' were added to the chart, what would you predict two of the developmental tasks would be?",
      scoringKey: "q135"
    }]
  },
  
  // The Rock passage
  {
    item: 136,
    image: "17.jpeg",
    type: "passage",
    instruction: "Read the passage. Click 'Start Reading' when ready.",
    questions: [{
      id: "q136",
      text: "What is the fissure as described in the passage?",
      scoringKey: "q136"
    }]
  },
  {
    item: 137,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q137",
      text: "What suddenly made this rock climb so difficult?",
      scoringKey: "q137"
    }]
  },
  {
    item: 138,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q138",
      text: "What was the most important thing the women had to overcome in order to scale the rock?",
      scoringKey: "q138"
    }]
  },
  {
    item: 139,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q139",
      text: "What kept the women from turning back when they saw the sheer surface of the rock?",
      scoringKey: "q139"
    }]
  },
  {
    item: 140,
    image: "17.jpeg",
    type: "question",
    skipReading: true,
    questions: [{
      id: "q140",
      text: "Why did Angela refuse to look at Sherry as she approached the summit?",
      scoringKey: "q140"
    }]
  }
];

function getReadAloudInstructions() {
  if (state.useVideoRecording) {
    return {
      title: 'ASL read aloud',
      text: 'When you are ready, sign the passage clearly on camera. You can pause briefly to think.',
      buttonText: 'Start video recording'
    };
  } else {
    return {
      title: 'Spoken read aloud',
      text: 'When you are ready, read the passage out loud into the microphone. You can speak at a natural pace.',
      buttonText: 'Start audio recording'
    };
  }
}

/* ===========================
   Participant Group Configuration
   =========================== */
function determineRecordingNeeds() {
  const group = state.participantGroup;
  const modality = state.readModality;
  
  // All participants can choose their modality
  if (modality === 'sign') {
    state.useVideoRecording = true;
    state.useAudioRecording = false;
    return 'video';
  } else {
    state.useVideoRecording = false;
    state.useAudioRecording = true;
    return 'audio';
  }
}

// FIXED: Single, clean function
function checkWelcomeReady() {
  const hasPid = document.getElementById('pid').value.trim().length > 0;
  const hasEdu = !!document.getElementById('edu').value;
  const hasGroup = !!state.participantGroup;
  const hasModality = !!state.readModality;
  const hasConsent = document.getElementById('consent').checked;
  
  const isReady = hasPid && hasEdu && hasGroup && hasModality && hasConsent;
  document.getElementById('begin').disabled = !isReady;
}

// Bind welcome screen inputs so the Continue button can enable
document.getElementById('pid').addEventListener('input', (e) => {
  // Sanitize input - remove special characters, limit length
  let value = e.target.value.replace(/[^a-zA-Z0-9_-]/g, '').substring(0, 20);
  e.target.value = value;
  state.pid = value.trim();
  checkWelcomeReady();
});

document.getElementById('edu').addEventListener('change', (e) => {
  state.edu = e.target.value;
  checkWelcomeReady();
});

document.querySelectorAll('input[name="participant-group"]').forEach((radio) => {
  radio.addEventListener('change', (e) => {
    state.participantGroup = e.target.value;
    // Reveal modality options and deaf note if applicable
    document.getElementById('modality-selection').classList.remove('hidden');
    const deafNote = document.getElementById('deaf-note');
    if (e.target.value.startsWith('deaf')) deafNote.classList.remove('hidden');
    else deafNote.classList.add('hidden');
    checkWelcomeReady();
  });
});

document.querySelectorAll('input[name="read-modality"]').forEach((radio) => {
  radio.addEventListener('change', (e) => {
    state.readModality = e.target.value;
    checkWelcomeReady();
  });
});

// Listen for consent changes to enable/disable Continue
document.getElementById('consent').addEventListener('change', checkWelcomeReady);

// Move from welcome to setup once all fields are ready
document.getElementById('begin').addEventListener('click', async () => {
  const beginBtn = document.getElementById('begin');
  if (beginBtn.disabled) return;
  
  // Prevent double-clicks
  beginBtn.disabled = true;
  
  try {
    // Hide welcome, show setup
    document.getElementById('screen-welcome').classList.add('hidden');
    document.getElementById('screen-setup').classList.remove('hidden');
    
    // Setup recording based on choices
    const recordingType = determineRecordingNeeds();
    
    document.getElementById('recording-method-text').textContent = 
      recordingType === 'video' 
        ? 'Setting up video recording for ASL...' 
        : 'Setting up audio recording for spoken responses...';
    
    let setupSuccess = false;
    
    if (recordingType === 'video') {
      document.getElementById('video-setup').classList.remove('hidden');
      document.getElementById('pref-hide-selfview').classList.remove('hidden');
      setupSuccess = await setupVideoRecording();
    } else {
      document.getElementById('audio-setup').classList.remove('hidden');
      setupSuccess = await setupAudioRecording();
    }
    
    if (setupSuccess) {
      document.getElementById('setup-status').className = 'status-message status-info';
      document.getElementById('setup-status-text').textContent = 'Setup complete! Ready to begin.';
      document.getElementById('start-study').disabled = false;
    } else {
      document.getElementById('setup-status').className = 'status-message status-danger';
      document.getElementById('setup-status-text').textContent = 'Setup failed. Please check permissions and refresh.';
    }
  } catch (error) {
    console.error('Setup error:', error);
    document.getElementById('setup-status').className = 'status-message status-danger';
    document.getElementById('setup-status-text').textContent = 'Setup failed. Please check permissions and refresh.';
  } finally {
    // Don't re-enable begin button after navigation
    // Only re-enable if there was an error and user is still on welcome screen
    if (!document.getElementById('screen-welcome').classList.contains('hidden')) {
      beginBtn.disabled = false;
    }
  }
});

/* ===========================
   Recording Functions - OPTIMIZED
   =========================== */

// Media support guard (Safari/old browsers + missing mediaDevices)
function ensureMediaRecorder() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    throw new Error('mediaDevices unsupported');
  }
  if (!('MediaRecorder' in window)) {
    throw new Error('MediaRecorder unsupported');
  }
}

async function setupVideoRecording() {
  // Disable buttons during setup to prevent race conditions
  const startButton = document.getElementById('start-study');
  const beginButton = document.getElementById('begin');
  const originalStartState = startButton.disabled;
  
  startButton.disabled = true;
  beginButton.disabled = true;
  
  try {
    ensureMediaRecorder(); // capability check first

    // Clean up any existing stream
    if (state.stream) {
      state.stream.getTracks().forEach(track => track.stop());
    }
    
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' },
      audio: false
    });
    state.stream = stream;
    const preview = document.getElementById('preview');
    preview.srcObject = stream;

    const mime = pickMime('video');
    state.recordMime = mime || 'video/webm';
    state.mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : {});
    state.recordedChunks = [];
    state.mediaRecorder.ondataavailable = (e) => { 
      if (e.data.size > 0) state.recordedChunks.push(e.data); 
    };

    document.getElementById('video-status').textContent = 'Camera ready. You can see yourself above.';
    return true;
  } catch (err) {
    console.error('Video setup error:', err);
    const statusEl = document.getElementById('video-status');
    if (err && err.message === 'mediaDevices unsupported') {
      statusEl.textContent = 'This browser does not support camera access. Please use the latest Chrome, Edge, or Firefox.';
    } else if (err && err.message === 'MediaRecorder unsupported') {
      statusEl.textContent = 'Recording is not supported in this browser. Please use the latest Chrome, Edge, or Firefox.';
    } else if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
      statusEl.textContent = 'Camera permission is blocked. Please allow camera access in your browser settings and retry.';
    } else if (err && (err.name === 'NotFoundError' || err.name === 'OverconstrainedError')) {
      statusEl.textContent = 'No camera was found or it is in use by another app. Please check your device and try again.';
    } else {
      statusEl.textContent = 'Error: Could not access camera. Please check permissions.';
    }
    return false;
  } finally {
    // Re-enable buttons after setup completes
    startButton.disabled = originalStartState;
    beginButton.disabled = false;
  }
}

async function setupAudioRecording() {
  // Disable buttons during setup to prevent race conditions
  const startButton = document.getElementById('start-study');
  const beginButton = document.getElementById('begin');
  const testRecordButton = document.getElementById('test-audio-record');
  const originalStartState = startButton.disabled;
  
  startButton.disabled = true;
  beginButton.disabled = true;
  testRecordButton.disabled = true;
  
  try {
    ensureMediaRecorder(); // capability check first

    // Clean up any existing stream
    if (state.stream) {
      state.stream.getTracks().forEach(track => track.stop());
    }
    
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: true, noiseSuppression: true }
    });
    state.stream = stream;

    const mime = pickMime('audio');
    state.recordMime = mime || 'audio/webm';
    state.mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : {});
    state.recordedChunks = [];
    state.mediaRecorder.ondataavailable = (e) => { 
      if (e.data.size > 0) state.recordedChunks.push(e.data); 
    };

    document.getElementById('audio-status').textContent = 'Microphone ready. Test your audio above.';
    return true;
  } catch (err) {
    console.error('Audio setup error:', err);
    const statusEl = document.getElementById('audio-status');
    if (err && err.message === 'mediaDevices unsupported') {
      statusEl.textContent = 'This browser does not support microphone access. Please use the latest Chrome, Edge, or Firefox.';
    } else if (err && err.message === 'MediaRecorder unsupported') {
      statusEl.textContent = 'Recording is not supported in this browser. Please use the latest Chrome, Edge, or Firefox.';
    } else if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
      statusEl.textContent = 'Microphone permission is blocked. Please allow microphone access in your browser settings and retry.';
    } else if (err && (err.name === 'NotFoundError' || err.name === 'OverconstrainedError')) {
      statusEl.textContent = 'No microphone was found or it is in use by another app. Please check your device and try again.';
    } else {
      statusEl.textContent = 'Error: Could not access microphone. Please check permissions.';
    }
    return false;
  } finally {
    // Re-enable buttons after setup completes
    startButton.disabled = originalStartState;
    beginButton.disabled = false;
    testRecordButton.disabled = false;
  }
}

/* ===========================
   Core Functions
   =========================== */
function buildSequence() {
  const gradeNum = state.edu === "13+" ? 13 : parseInt(state.edu);
  
  const sortedTrials = TRIALS.slice().sort((a, b) => a.item - b.item);
  
  if (gradeNum >= 9) {
    const startIdx = sortedTrials.findIndex(t => t.item === 94);
    if (startIdx >= 0) {
      state.sequence = sortedTrials.slice(startIdx);
    } else {
      state.sequence = sortedTrials;
    }
  } else {
    state.sequence = sortedTrials;
  }
  
  debugLog(`Built sequence with ${state.sequence.length} items for grade ${state.edu}`);
}

async function showItem() {
  if (state.currentIndex >= state.sequence.length) {
    finishAssessment();
    return;
  }
  
  if (state.consecutiveZeros >= DISCONTINUE_AFTER_ZEROS) {
    finishAssessment();
    return;
  }
  
  const trial = state.sequence[state.currentIndex];
  
  // Hide all screens except item
  document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
  document.getElementById('screen-item').classList.remove('hidden');
  
  // Reset action bar
  const actionBar = document.getElementById('action-bar');
  const primaryBtn = document.getElementById('action-primary');
  const secondaryBtn = document.getElementById('action-secondary');
  
  actionBar.classList.remove('hidden');
  primaryBtn.disabled = false;
  secondaryBtn.classList.add('hidden');
  
  // Update section label (neutral, no item numbers)
  const labelEl = document.getElementById('item-label');
  if (trial.readAloud) {
    labelEl.textContent = 'Speaking Task';
  } else {
    labelEl.textContent = 'Reading Task';
  }
  
  // Set up image with zoom capability
  const img = document.getElementById('stim');
  img.src = `images/${trial.image}`;
  img.classList.remove('zoomed');
  img.onclick = () => {
    img.classList.toggle('zoomed');
  };
  
  // Clear previous Q&A
  document.getElementById('qa-form').classList.add('hidden');
  document.getElementById('qa-fields').innerHTML = '';
  
  // Configure based on item type
  if (trial.readAloud) {
    // Read aloud items
    const instructions = getReadAloudInstructions();
    document.getElementById('instruction-text').textContent = instructions.text;
    
    primaryBtn.textContent = 'Begin Recording';
    primaryBtn.onclick = () => {
      startRecording();
    };
    
  } else if (trial.skipReading) {
    // Question-only items (hide action bar, show questions immediately)
    actionBar.classList.add('hidden');
    showQuestions(0);
    
  } else {
    // Regular reading items
    document.getElementById('instruction-text').textContent = 'Read the passage at your own pace.';
    
    primaryBtn.textContent = 'Begin Reading';
    primaryBtn.onclick = () => {
      state.readingStartTime = Date.now();
      
      // Show minimal timer if enabled
      if (document.getElementById('show-timer').classList.contains('active')) {
        startMinimalTimer();
      }
      
      // Update button for when done reading
      primaryBtn.textContent = 'Done Reading';
      primaryBtn.onclick = () => {
        stopMinimalTimer();
        const readingTime = Date.now() - state.readingStartTime;
        showQuestions(readingTime);
      };
    };
  }
  
  state.itemStartTime = Date.now();
  updateAdminPanel();
}

function showQuestions(readingTime) {
  const trial = state.sequence[state.currentIndex];
  
  if (trial.skipScoring) {
    state.currentIndex++;
    showItem();
    return;
  }
  
  const form = document.getElementById('qa-form');
  const fields = document.getElementById('qa-fields');
  
  form.classList.remove('hidden');
  fields.innerHTML = '';
  
  // Update instruction text
  document.getElementById('instruction-text').textContent = 
    'Answer in your own words. You may skip if needed.';
  
  // Configure action bar for questions
  const actionBar = document.getElementById('action-bar');
  const primaryBtn = document.getElementById('action-primary');
  const secondaryBtn = document.getElementById('action-secondary');
  
  actionBar.classList.remove('hidden');
  primaryBtn.textContent = 'Submit';
  primaryBtn.onclick = () => {
    form.requestSubmit();
  };
  
  // Show skip button
  secondaryBtn.classList.remove('hidden');
  secondaryBtn.textContent = 'Skip';
  secondaryBtn.onclick = () => {
    sendEventSafely('item_skipped', {
      itemNumber: trial.item,
      reason: 'User choice'
    });
    
    state.consecutiveZeros++;
    state.currentIndex++;
    showItem();
  };
  
  // Add minimal tips
  const tip = document.createElement('div');
  tip.className = 'tips-container';
  tip.innerHTML = `
    <strong>Response tips</strong>
    <ul>
      <li>Type in your own words</li>
      <li>Short answers are fine</li>
      <li>ASL gloss is acceptable</li>
    </ul>
  `;
  fields.appendChild(tip);
  
  // Build question fields
  trial.questions.forEach(q => {
    const qDiv = document.createElement('div');
    qDiv.className = 'question-block';
    
    const label = document.createElement('label');
    label.textContent = q.text;
    label.setAttribute('for', q.id);
    
    const textarea = document.createElement('textarea');
    textarea.id = q.id;
    textarea.name = q.id;
    textarea.required = false;
    textarea.placeholder = 'Type your answer here';
    textarea.setAttribute('spellcheck', 'false');
    textarea.setAttribute('autocapitalize', 'off');
    textarea.setAttribute('autocorrect', 'off');
    
    qDiv.appendChild(label);
    qDiv.appendChild(textarea);
    fields.appendChild(qDiv);
  });
  
  // Handle form submission
  form.onsubmit = (e) => {
    e.preventDefault();
    
    const answers = {};
    let allEmpty = true;
    
    trial.questions.forEach(q => {
      const answer = document.getElementById(q.id).value.trim();
      answers[q.id] = answer;
      if (answer) allEmpty = false;
    });
    
    // Score and save
    let totalScore = 0;
    if (!allEmpty) {
      trial.questions.forEach(q => {
        const score = scoreAnswer(answer, q.scoringKey);
        totalScore += score;
      });
    }
    
    state.results.push({
      itemNumber: trial.item,
      answers: answers,
      score: totalScore,
      readingTime: readingTime,
      responseTime: Date.now() - state.itemStartTime
    });
    
    // Update consecutive zeros
    if (totalScore === 0) {
      state.consecutiveZeros++;
    } else {
      state.consecutiveZeros = 0;
    }
    
    state.totalPoints += totalScore;
    state.currentIndex++;
    showItem();
  };
}

function startRecording() {
  if (!state.mediaRecorder) {
    alert('Recording setup required. Please return to setup.');
    return;
  }
  
  state.recordedChunks = [];
  
  try {
    state.mediaRecorder.start(200);
  } catch (e) {
    alert('Recording not available in this browser.');
    return;
  }
  
  // Update UI
  document.getElementById('rec-indicator').classList.remove('hidden');
  
  // Update action bar
  const primaryBtn = document.getElementById('action-primary');
  primaryBtn.textContent = 'Stop Recording';
  primaryBtn.onclick = stopRecording;
  
  // Start recording timer
  let recTimerSec = 0;
  const timerEl = document.getElementById('recording-timer');
  timerEl.classList.remove('hidden');
  timerEl.textContent = '00:00';
  
  state.timers.recording = setInterval(() => {
    recTimerSec++;
    const m = String(Math.floor(recTimerSec/60)).padStart(2,'0');
    const s = String(recTimerSec%60).padStart(2,'0');
    timerEl.textContent = `${m}:${s}`;
  }, 1000);
}

function stopRecording() {
  if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
    state.mediaRecorder.stop();
  }
  
  // Hide recording indicator
  document.getElementById('rec-indicator').classList.add('hidden');
  document.getElementById('recording-timer').classList.add('hidden');
  
  // Clear timer
  if (state.timers.recording) {
    clearInterval(state.timers.recording);
    state.timers.recording = null;
  }
  
  // Save recording data
  setTimeout(() => {
    const trial = state.sequence[state.currentIndex];
    const blob = new Blob(state.recordedChunks, { type: state.recordMime });
    
    state.results.push({
      itemNumber: trial.item,
      recordingBlob: blob,
      recordingType: state.useVideoRecording ? 'video' : 'audio',
      responseTime: Date.now() - state.itemStartTime
    });
    
    state.currentIndex++;
    showItem();
  }, 500);
}

function finishAssessment() {
  // Hide action bar
  document.getElementById('action-bar').classList.add('hidden');
  
  // Show finish screen
  document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
  document.getElementById('screen-finish').classList.remove('hidden');
  
  // Update status
  document.getElementById('save-status').textContent = 'Saving your responses...';
  
  // Prepare and upload data
  prepareAndUploadData();
}

// Minimal timer functions
function startMinimalTimer() {
  let seconds = 0;
  const timerEl = document.getElementById('minimal-timer');
  timerEl.classList.remove('hidden');
  timerEl.textContent = '00:00';
  
  state.timers.reading = setInterval(() => {
    seconds++;
    const m = String(Math.floor(seconds/60)).padStart(2,'0');
    const s = String(seconds%60).padStart(2,'0');
    timerEl.textContent = `${m}:${s}`;
  }, 1000);
}

function stopMinimalTimer() {
  if (state.timers.reading) {
    clearInterval(state.timers.reading);
    state.timers.reading = null;
  }
  document.getElementById('minimal-timer').classList.add('hidden');
}

// Comfort options functions
function toggleComfort() {
  const drawer = document.getElementById('comfort-drawer');
  drawer.classList.toggle('open');
}

function toggleTimer() {
  const toggle = document.getElementById('show-timer');
  toggle.classList.toggle('active');
  toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
}

function toggleVideoPreview() {
  const toggle = document.getElementById('show-preview');
  const preview = document.getElementById('preview');
  
  toggle.classList.toggle('active');
  toggle.setAttribute('aria-checked', toggle.classList.contains('active'));
  
  if (toggle.classList.contains('active')) {
    preview.classList.remove('hidden-preview');
  } else {
    preview.classList.add('hidden-preview');
  }
}

function showShortcuts() {
  document.getElementById('shortcuts-overlay').classList.add('visible');
  document.getElementById('shortcuts-panel').classList.add('visible');
}

function hideShortcuts() {
  document.getElementById('shortcuts-overlay').classList.remove('visible');
  document.getElementById('shortcuts-panel').classList.remove('visible');
}

function toggleDetails(event) {
  event.preventDefault();
  const panel = document.getElementById('details-panel');
  panel.classList.toggle('visible');
  event.target.textContent = panel.classList.contains('visible') ? 'Hide details' : 'View details';
}

// Update admin panel
function updateAdminPanel() {
  if (!state.adminMode) return;
  
  const trial = state.sequence[state.currentIndex];
  document.getElementById('admin-group').textContent = state.participantGroup;
  document.getElementById('admin-item').textContent = trial ? trial.item : '-';
  document.getElementById('admin-score').textContent = state.totalPoints;
  document.getElementById('admin-zeros').textContent = state.consecutiveZeros;
  document.getElementById('admin-status').textContent = 
    state.consecutiveZeros >= DISCONTINUE_AFTER_ZEROS ? 'Discontinuing' : 'Active';
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Ctrl+Enter to submit
  if (e.ctrlKey && e.key === 'Enter') {
    const form = document.getElementById('qa-form');
    if (!form.classList.contains('hidden')) {
      form.requestSubmit();
    }
  }
  
  // Alt+S to skip
  if (e.altKey && e.key === 's') {
    const skipBtn = document.getElementById('action-secondary');
    if (!skipBtn.classList.contains('hidden')) {
      skipBtn.click();
    }
  }
  
  // Alt+O for options
  if (e.altKey && e.key === 'o') {
    toggleComfort();
  }
  
  // ? for shortcuts (when shift+/)
  if (e.shiftKey && e.key === '?') {
    showShortcuts();
  }
});

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', () => {
  // Check for admin mode
  if (window.location.search.includes('admin=1')) {
    document.body.classList.add('admin-mode');
    state.adminMode = true;
  }
  
  // Setup video preview toggle
  const toggleBtn = document.getElementById('toggle-preview');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      const preview = document.getElementById('preview');
      preview.classList.toggle('hidden-preview');
      toggleBtn.textContent = preview.classList.contains('hidden-preview') 
        ? 'Show preview' 
        : 'Hide preview';
    });
  }
  
  // Set up video preview option visibility based on recording type
  if (state.useVideoRecording) {
    document.getElementById('video-preview-option').style.display = 'flex';
  }
  
  // Test audio recording buttons
  document.getElementById('test-audio-record')?.addEventListener('click', startTestRecording);
  document.getElementById('stop-test-audio')?.addEventListener('click', stopTestRecording);
  
  // Start study button
  document.getElementById('start-study').addEventListener('click', () => {
    buildSequence();
    state.sessionStartTime = Date.now();
    showItem();
  });
});
</script>
</body>
</html>
